import{r as c,j as e}from"./vendor-react-CCyQGCED.js";import{B as C,e as m,s as o}from"./index-D0023jFM.js";import{A as P,a as U}from"./alert-Dlgyh2fF.js";import{C as x,a as u,b as h,c as f,d as j}from"./card-CDguRyHx.js";import{P as _}from"./progress-BcnjzSlC.js";import{S as N}from"./skeleton-CAOG8cB0.js";import{D as $,L as g,Y as X,u as Y,C as R,ai as k,V as A,g as D,y as I}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";async function T(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function L(s){return s?new Date(s).toLocaleString("en-IN",{dateStyle:"medium",timeStyle:"short",timeZone:"Asia/Kolkata"}):"Never"}function z(s){if(s===null)return"N/A";if(s<60)return`${s} seconds`;const d=Math.floor(s/60),t=s%60;return`${d}m ${t}s`}function J(s){switch(s){case"success":return"text-green-500";case"downloading":return"text-blue-500";case"error":return"text-red-500";case"pending":return"text-yellow-500";default:return"text-muted-foreground"}}function K(s){switch(s){case"success":return e.jsx(R,{className:"h-5 w-5 text-green-500"});case"downloading":return e.jsx(g,{className:"h-5 w-5 text-blue-500 animate-spin"});case"error":return e.jsx(I,{className:"h-5 w-5 text-red-500"});case"pending":return e.jsx(A,{className:"h-5 w-5 text-yellow-500"});default:return e.jsx(I,{className:"h-5 w-5 text-muted-foreground"})}}function ne(){const[s,d]=c.useState(null),[t,F]=c.useState(null),[H,M]=c.useState(!0),[w,y]=c.useState(!1),[v,b]=c.useState(!1),[l,p]=c.useState(null),i=c.useCallback(async()=>{try{const a=await fetch("/api/master-contract/smart-status",{credentials:"include"});if(a.ok){const n=await a.json();if(d(n),n.status==="downloading"&&!l){const r=setInterval(i,2e3);p(r)}else n.status!=="downloading"&&l&&(clearInterval(l),p(null))}}catch{}finally{M(!1)}},[l]),S=c.useCallback(async()=>{try{const a=await fetch("/api/cache/health",{credentials:"include"});if(a.ok){const n=await a.json();F(n)}}catch{}},[]);c.useEffect(()=>{i(),S()},[]),c.useEffect(()=>()=>{l&&clearInterval(l)},[l]);const B=async()=>{y(!0);try{const a=await T(),r=await(await fetch("/api/master-contract/download",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":a},credentials:"include",body:JSON.stringify({force:!0})})).json();if(r.status==="success"||r.started){o.success("Master contract download started");const O=setInterval(i,2e3);p(O),i()}else r.status==="skipped"?o.info(r.message):o.error(r.message||"Failed to start download")}catch{o.error("Failed to start download")}finally{y(!1)}},E=async()=>{b(!0);try{const a=await T(),r=await(await fetch("/api/cache/reload",{method:"POST",headers:{"X-CSRFToken":a},credentials:"include"})).json();r.status==="success"?(o.success("Cache reloaded successfully"),S()):o.error(r.message||"Failed to reload cache")}catch{o.error("Failed to reload cache")}finally{b(!1)}};return H?e.jsxs("div",{className:"container mx-auto py-6 px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(N,{className:"h-10 w-64 mb-2"}),e.jsx(N,{className:"h-5 w-96"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsx(N,{className:"h-64"}),e.jsx(N,{className:"h-64"})]})]}):e.jsxs("div",{className:"container mx-auto py-6 px-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx($,{className:"h-8 w-8"}),"Master Contract"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage master contract data and symbol cache"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(C,{variant:"outline",onClick:E,disabled:v||s?.status==="downloading",children:[v?e.jsx(g,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(X,{className:"h-4 w-4 mr-2"}),"Reload Cache"]}),e.jsxs(C,{onClick:B,disabled:w||s?.status==="downloading",children:[w||s?.status==="downloading"?e.jsx(g,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Force Download"]})]})]}),s?.smart_download&&!s.smart_download.should_download&&e.jsxs(P,{className:"mb-6",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsxs(U,{children:[e.jsx("strong",{children:"Smart Download:"})," ",s.smart_download.reason]})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),"Download Status"]}),e.jsx(f,{children:"Current master contract download status"})]}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[K(s?.status||"unknown"),e.jsx("span",{className:`font-medium capitalize ${J(s?.status||"unknown")}`,children:s?.status||"Unknown"})]})]}),s?.status==="downloading"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{value:void 0,className:"h-2"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Downloading master contract data..."})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Broker"}),e.jsx(m,{variant:"outline",children:s?.broker||"N/A"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Ready"}),e.jsx(m,{variant:s?.is_ready?"default":"secondary",children:s?.is_ready?"Yes":"No"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Symbols"}),e.jsx("span",{className:"font-mono",children:s?.total_symbols?Number(s.total_symbols).toLocaleString():"N/A"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Last Updated"}),e.jsx("span",{className:"text-sm",children:L(s?.last_updated||null)})]}),s?.message&&e.jsx("div",{className:"pt-2 border-t",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:s.message})})]})]}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5"}),"Download History"]}),e.jsx(f,{children:"Last successful download information"})]}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Last Download"}),e.jsx("span",{className:"text-sm",children:L(s?.last_download_time||null)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Download Date"}),e.jsx("span",{className:"text-sm",children:s?.download_date||"N/A"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Download Duration"}),e.jsx("span",{className:"font-mono text-sm",children:z(s?.download_duration_seconds||null)})]}),e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(D,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Smart Download Cutoff"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Downloads after"," ",e.jsxs("span",{className:"font-medium",children:[s?.smart_download?.cutoff_time||"08:00"," IST"]})," ","are cached for the day. Login after cutoff reuses cached data."]})]})]})]}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-5 w-5"}),"Exchange Statistics"]}),e.jsx(f,{children:"Symbol count per exchange"})]}),e.jsx(j,{children:s?.exchange_stats&&Object.keys(s.exchange_stats).length>0?e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Object.entries(s.exchange_stats).sort(([,a],[,n])=>n-a).map(([a,n])=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:[e.jsx("span",{className:"font-medium",children:a}),e.jsx(m,{variant:"secondary",children:n.toLocaleString()})]},a))}):e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"No exchange statistics available"})})]}),e.jsxs(x,{children:[e.jsxs(u,{children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),"Cache Health"]}),e.jsx(f,{children:"In-memory symbol cache status"})]}),e.jsxs(j,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Health Score"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{value:t?.health_score||0,className:"w-24 h-2"}),e.jsxs("span",{className:"font-mono text-sm",children:[t?.health_score||0,"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Status"}),e.jsx(m,{variant:t?.status==="healthy"?"default":t?.status==="degraded"?"secondary":"destructive",children:t?.status||"Unknown"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cached Symbols"}),e.jsx("span",{className:"font-mono",children:t?.total_symbols?.toLocaleString()||"N/A"})]}),t?.hit_rate&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Hit Rate"}),e.jsx("span",{className:"font-mono text-sm",children:t.hit_rate})]}),t?.memory_usage_mb&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Memory Usage"}),e.jsxs("span",{className:"font-mono text-sm",children:[t.memory_usage_mb," MB"]})]}),t?.recommendations&&t.recommendations.length>0&&e.jsx("div",{className:"pt-2 border-t",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:t.recommendations[0]})}),t?.message&&e.jsx("div",{className:"pt-2 border-t",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})})]})]})]})]})}export{ne as default};
