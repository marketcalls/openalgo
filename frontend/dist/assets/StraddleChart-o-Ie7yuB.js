import{r as s,j as t}from"./vendor-react-CCyQGCED.js";import{q as Ce,K as we,W as Ee,n as Z}from"./lightweight-charts.production-EcMg1Lek.js";import{w as pe,u as $e,d as ke,s as ee,B as Ie}from"./index-Bat6d_-L.js";import{o as De}from"./option-chain-CNhN_2ic.js";import{C as Fe,a as Te,b as Me,d as Re}from"./card-CIKcPOuA.js";import{S as H,a as _,b as V,c as B,d as U}from"./select-ptGUKsSf.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const ue={getStraddleData:async u=>(await pe.post("/straddle/api/straddle-data",u)).data,getIntervals:async()=>(await pe.get("/straddle/api/intervals")).data},W=[{value:"NIFTY",label:"NIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"BANKNIFTY",label:"BANKNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"SENSEX",label:"SENSEX",exchange:"BFO",brokerExchange:"BSE_INDEX"},{value:"FINNIFTY",label:"FINNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"MIDCPNIFTY",label:"MIDCPNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"}],fe=500;function Le(u){if(!u)return"";const f=u.split("-");return f.length===3?`${f[0]}${f[1].toUpperCase()}${f[2].slice(-2)}`:u.replace(/-/g,"").toUpperCase()}function He(u){const f=new Date(u*1e3),h=new Date(f.getTime()+5.5*60*60*1e3),$=h.getUTCDate().toString().padStart(2,"0"),y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][h.getUTCMonth()],I=h.getUTCHours().toString().padStart(2,"0"),D=h.getUTCMinutes().toString().padStart(2,"0"),A=h.getUTCHours()>=12?"PM":"AM";return{date:`${$} ${y}`,time:`${I}:${D} ${A}`}}function Xe(){const{mode:u,appMode:f}=$e(),h=u==="dark",$=f==="analyzer",{apiKey:k}=ke(),[y,I]=s.useState(!1),[D,A]=s.useState(W[0].value),[he,te]=s.useState([]),[F,z]=s.useState(""),[me,se]=s.useState([]),[T,re]=s.useState("1m"),[S,xe]=s.useState("3"),[v,ge]=s.useState(null),[j,be]=s.useState(!0),[N,ye]=s.useState(!1),[C,Se]=s.useState(!1),P=s.useRef(null),d=s.useRef(null),M=s.useRef(null),R=s.useRef(null),L=s.useRef(null),w=s.useRef(null),b=s.useRef(null),O=s.useRef(null),ae=s.useRef(new Map),x=W.find(e=>e.value===D)||W[0],a=s.useMemo(()=>$?{text:"#d4bfff",grid:"rgba(139, 92, 246, 0.1)",border:"rgba(139, 92, 246, 0.2)",crosshair:"rgba(139, 92, 246, 0.5)",crosshairLabel:"#4c1d95",spot:"#e2e8f0",straddle:"#a78bfa",synthetic:"#60a5fa",watermark:"rgba(139, 92, 246, 0.12)",tooltipBg:"rgba(30, 15, 60, 0.92)",tooltipBorder:"rgba(139, 92, 246, 0.3)",tooltipText:"#d4bfff",tooltipMuted:"#a78bfa"}:h?{text:"#a6adbb",grid:"rgba(166, 173, 187, 0.1)",border:"rgba(166, 173, 187, 0.2)",crosshair:"rgba(166, 173, 187, 0.5)",crosshairLabel:"#1f2937",spot:"#e2e8f0",straddle:"#4ade80",synthetic:"#60a5fa",watermark:"rgba(166, 173, 187, 0.12)",tooltipBg:"rgba(17, 24, 39, 0.92)",tooltipBorder:"rgba(166, 173, 187, 0.2)",tooltipText:"#e2e8f0",tooltipMuted:"#9ca3af"}:{text:"#333",grid:"rgba(0, 0, 0, 0.1)",border:"rgba(0, 0, 0, 0.2)",crosshair:"rgba(0, 0, 0, 0.3)",crosshairLabel:"#2563eb",spot:"#1e293b",straddle:"#16a34a",synthetic:"#2563eb",watermark:"rgba(0, 0, 0, 0.06)",tooltipBg:"rgba(255, 255, 255, 0.95)",tooltipBorder:"rgba(0, 0, 0, 0.15)",tooltipText:"#1e293b",tooltipMuted:"#6b7280"},[h,$]),ne=s.useRef(a);ne.current=a;const oe=s.useCallback(()=>{if(!P.current)return;d.current&&(d.current.remove(),d.current=null);const e=P.current,n=w.current;e.innerHTML="",n&&e.appendChild(n);const i=Ce(e,{width:e.offsetWidth,height:fe,layout:{background:{type:Ee.Solid,color:"transparent"},textColor:a.text},grid:{vertLines:{color:a.grid,style:1,visible:!0},horzLines:{color:a.grid,style:1,visible:!0}},leftPriceScale:{visible:!0,borderColor:a.border,scaleMargins:{top:.05,bottom:.05}},rightPriceScale:{visible:!0,borderColor:a.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:a.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:l=>{const c=new Date(l*1e3),g=new Date(c.getTime()+5.5*60*60*1e3),p=g.getUTCHours().toString().padStart(2,"0"),o=g.getUTCMinutes().toString().padStart(2,"0");if(parseInt(S)>1){const J=g.getUTCDate().toString().padStart(2,"0"),q=(g.getUTCMonth()+1).toString().padStart(2,"0");return`${J}/${q} ${p}:${o}`}return`${p}:${o}`}},crosshair:{mode:we.Normal,vertLine:{width:1,color:a.crosshair,style:2,labelVisible:!1},horzLine:{width:1,color:a.crosshair,style:2,labelBackgroundColor:a.crosshairLabel}}}),r=document.createElement("div");if(r.style.cssText=`position:absolute;z-index:2;font-family:Arial,sans-serif;font-size:48px;font-weight:bold;user-select:none;pointer-events:none;color:${a.watermark}`,r.textContent="OpenAlgo",e.appendChild(r),b.current=r,setTimeout(()=>{r.style.left=`${e.offsetWidth/2-r.offsetWidth/2}px`,r.style.top=`${e.offsetHeight/2-r.offsetHeight/2}px`},0),w.current)e.appendChild(w.current);else{const l=document.createElement("div");l.style.cssText="position:absolute;z-index:10;pointer-events:none;display:none;border-radius:6px;padding:8px 12px;font-family:ui-monospace,SFMono-Regular,monospace;font-size:12px;line-height:1.6;white-space:nowrap;",e.appendChild(l),w.current=l}const K=i.addSeries(Z,{color:a.spot,lineWidth:2,priceScaleId:"left",title:"Spot",lastValueVisible:!0,priceLineVisible:!0,visible:N}),ve=i.addSeries(Z,{color:a.straddle,lineWidth:2,priceScaleId:"right",title:"Straddle",lastValueVisible:!0,priceLineVisible:!0,visible:j}),je=i.addSeries(Z,{color:a.synthetic,lineWidth:1,lineStyle:2,priceScaleId:"left",title:"Synthetic Fut",lastValueVisible:!0,priceLineVisible:!1,visible:C});d.current=i,M.current=K,R.current=ve,L.current=je,i.subscribeCrosshairMove(l=>{const c=w.current;if(!c||!e)return;if(!l.time||!l.point||l.point.x<0||l.point.y<0||l.point.x>e.offsetWidth||l.point.y>e.offsetHeight){c.style.display="none";return}const g=l.time,p=ae.current.get(g);if(!p){c.style.display="none";return}const o=ne.current,{date:J,time:q}=He(g);c.style.display="block",c.style.background=o.tooltipBg,c.style.border=`1px solid ${o.tooltipBorder}`,c.style.color=o.tooltipText,c.innerHTML=`
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.straddle};font-weight:600">Straddle Price</span>
          <span style="color:${o.straddle};font-weight:600">${p.straddle.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">&bull; ${p.atm_strike} Call:</span>
          <span>${p.ce_price.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">&bull; ${p.atm_strike} Put:</span>
          <span>${p.pe_price.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.synthetic}">Synthetic Fut</span>
          <span style="color:${o.synthetic}">${p.synthetic_future.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">Spot Price</span>
          <span>${p.spot.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px;margin-top:4px;border-top:1px solid ${o.tooltipBorder};padding-top:4px">
          <span style="color:${o.tooltipMuted}">${J}</span>
          <span style="color:${o.tooltipMuted}">${q}</span>
        </div>
      `;const le=c.offsetWidth,G=c.offsetHeight,ce=l.point.x,Ne=l.point.y,de=16;let Q=ce+de;Q+le>e.offsetWidth&&(Q=ce-le-de);let E=Ne-G/2;E<0&&(E=0),E+G>e.offsetHeight&&(E=e.offsetHeight-G),c.style.left=`${Q}px`,c.style.top=`${E}px`}),O.current&&Y(O.current);const ie=()=>{d.current&&e&&(d.current.applyOptions({width:e.offsetWidth}),b.current&&(b.current.style.left=`${e.offsetWidth/2-b.current.offsetWidth/2}px`,b.current.style.top=`${e.offsetHeight/2-b.current.offsetHeight/2}px`))};return window.addEventListener("resize",ie),()=>{window.removeEventListener("resize",ie)}},[a,S,j,N,C]),Y=s.useCallback(e=>{if(!e.series||e.series.length===0)return;const n=[...e.series].sort((r,K)=>r.time-K.time),i=new Map;for(const r of n)i.set(r.time,r);ae.current=i,M.current&&M.current.setData(n.map(r=>({time:r.time,value:r.spot}))),R.current&&R.current.setData(n.map(r=>({time:r.time,value:r.straddle}))),L.current&&L.current.setData(n.map(r=>({time:r.time,value:r.synthetic_future}))),d.current&&d.current.timeScale().fitContent()},[]);s.useEffect(()=>{const e=oe();return()=>{e?.(),d.current&&(d.current.remove(),d.current=null)}},[oe]),s.useEffect(()=>{M.current?.applyOptions({visible:N})},[N]),s.useEffect(()=>{R.current?.applyOptions({visible:j})},[j]),s.useEffect(()=>{L.current?.applyOptions({visible:C})},[C]),s.useEffect(()=>{(async()=>{try{const n=await ue.getIntervals();if(n.status==="success"&&n.data){const i=[...n.data.seconds||[],...n.data.minutes||[],...n.data.hours||[]];se(i.length>0?i:["1m","3m","5m","10m","15m","30m","1h"]),i.length>0&&!i.includes(T)&&re(i.includes("1m")?"1m":i[0])}}catch{se(["1m","3m","5m","10m","15m","30m","1h"])}})()},[]),s.useEffect(()=>{(async()=>{if(k)try{const n=await De.getExpiries(k,x.value,x.exchange,"options");n.status==="success"&&n.data&&(te(n.data),n.data.length>0&&z(n.data[0]))}catch{ee.error("Failed to fetch expiry dates","positions")}})()},[k,x.value,x.exchange]);const X=s.useCallback(async()=>{if(F){I(!0);try{const e=await ue.getStraddleData({underlying:x.value,exchange:x.brokerExchange,expiry_date:Le(F),interval:T,days:parseInt(S)});e.status==="success"&&e.data?(O.current=e.data,ge(e.data),Y(e.data)):ee.error(e.message||"Failed to load straddle data","positions")}catch{ee.error("Failed to fetch straddle data","positions")}finally{I(!1)}}},[F,T,S,x,Y]);s.useEffect(()=>{X()},[X]);const m=s.useMemo(()=>v?.series?.length?v.series[v.series.length-1]:null,[v]);return t.jsx("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:t.jsxs(Fe,{children:[t.jsx(Te,{className:"pb-4",children:t.jsx(Me,{className:"text-xl font-semibold",children:"Straddle Chart"})}),t.jsxs(Re,{children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[t.jsxs(H,{value:D,onValueChange:e=>{A(e),z(""),te([])},children:[t.jsx(_,{className:"w-[140px]",children:t.jsx(V,{placeholder:"Underlying"})}),t.jsx(B,{children:W.map(e=>t.jsx(U,{value:e.value,children:e.label},e.value))})]}),t.jsxs(H,{value:F,onValueChange:z,children:[t.jsx(_,{className:"w-[140px]",children:t.jsx(V,{placeholder:"Expiry"})}),t.jsx(B,{children:he.map(e=>t.jsx(U,{value:e,children:e},e))})]}),t.jsxs(H,{value:T,onValueChange:re,children:[t.jsx(_,{className:"w-[100px]",children:t.jsx(V,{placeholder:"Interval"})}),t.jsx(B,{children:me.map(e=>t.jsx(U,{value:e,children:e},e))})]}),t.jsxs(H,{value:S,onValueChange:xe,children:[t.jsx(_,{className:"w-[100px]",children:t.jsx(V,{placeholder:"Days"})}),t.jsx(B,{children:["1","3","5"].map(e=>t.jsxs(U,{value:e,children:[e," ",e==="1"?"Day":"Days"]},e))})]}),t.jsx(Ie,{variant:"outline",size:"sm",onClick:X,disabled:y,children:y?"Loading...":"Refresh"})]}),m&&v&&t.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-1 mb-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Straddle Price "}),t.jsx("span",{className:"font-semibold",style:{color:a.straddle},children:m.straddle.toFixed(2)})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Spot "}),t.jsx("span",{className:"font-medium",children:m.spot.toFixed(2)})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Straddle Strike "}),t.jsx("span",{className:"font-medium",children:m.atm_strike})]}),t.jsxs("div",{children:[t.jsxs("span",{className:"text-muted-foreground",children:[m.atm_strike," CE"," "]}),t.jsx("span",{className:"font-medium",children:m.ce_price.toFixed(2)})]}),t.jsxs("div",{children:[t.jsxs("span",{className:"text-muted-foreground",children:[m.atm_strike," PE"," "]}),t.jsx("span",{className:"font-medium",children:m.pe_price.toFixed(2)})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx("div",{ref:P,className:"relative w-full rounded-lg border border-border/50",style:{height:fe}}),y&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-background/60 rounded-lg",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Loading straddle data..."]})})]}),t.jsxs("div",{className:"flex items-center justify-center gap-4 mt-3",children:[t.jsxs("button",{type:"button",onClick:()=>be(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${j?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded",style:{backgroundColor:a.straddle}}),"Straddle"]}),t.jsxs("button",{type:"button",onClick:()=>ye(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${N?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded",style:{backgroundColor:a.spot}}),"Spot"]}),t.jsxs("button",{type:"button",onClick:()=>Se(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${C?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded border-dashed border-t-2",style:{borderColor:a.synthetic,backgroundColor:"transparent"}}),"Synthetic Fut"]})]})]})]})})}export{Xe as default};
