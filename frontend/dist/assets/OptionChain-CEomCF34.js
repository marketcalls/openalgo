import{r as m,j as e}from"./vendor-react--vsXx8_n.js";import{g as he,D as ye,h as Ne,B as Y,i as Ce,v as ae,x as xe,y as se,k as ue,z as pe,c as k,d as we,e as Se,t as fe}from"./index-B4Y48dxY.js";import{u as _e,a as De}from"./useMarketData-BkCpnkL6.js";import{g as ke,$ as Ee,am as Oe,aP as Te,aQ as Ie,R as ge,c as Ve,ax as Pe,az as Le}from"./vendor-icons-CO2QJpXs.js";import{D as Ue,a as Fe,b as Be,c as Me,d as Re,e as Ae,f as qe,g as We}from"./dialog-CprsjGQ7.js";import{S as be}from"./scroll-area-Cmts9scP.js";import{C as Q,d as K}from"./card-B90vC-im.js";import{S as re,a as ne,b as le,c as ie,d as ce}from"./select-DB-uwn8r.js";import{T as $e,a as ze,b as me,c as J,d as Xe,e as oe}from"./table-uCuC-cio.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CiBIGs7t.js";import"./vendor-radix-CodNzUU3.js";function Ye(s,t,r,a,c,o={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:i,refreshInterval:v=3e4,pauseWhenHidden:x=!0}=o,{isVisible:h}=_e(),[V,d]=m.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),u=m.useRef(null),_=m.useRef(null),b=i&&(!x||h),w=m.useCallback(async()=>{if(!(!s||!t||!r||!a)&&!_.current){d(N=>({...N,isLoading:!0}));try{const N=new AbortController;_.current=N;const D=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:s,underlying:t,exchange:r,expiry_date:a,strike_count:c}),signal:N.signal});if(!D.ok)throw new Error(`HTTP error! status: ${D.status}`);const n=await D.json();n.status==="success"?d(C=>({...C,data:n,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):d(C=>({...C,isLoading:!1,error:n.message||"Failed to fetch option chain"}))}catch(N){N instanceof Error&&(N.name==="AbortError"?_.current===null&&d(D=>({...D,isLoading:!1})):d(D=>({...D,isLoading:!1,error:N.message||"Connection error",isConnected:!1})))}finally{_.current=null}}},[s,t,r,a,c]);m.useEffect(()=>{if(!b){u.current&&(clearInterval(u.current),u.current=null),d(N=>({...N,isPaused:!!i}));return}return d(N=>({...N,isConnected:!0,isPaused:!1})),w(),u.current=setInterval(w,v),()=>{u.current&&(clearInterval(u.current),u.current=null),_.current&&(_.current.abort(),_.current=null)}},[b,w,v,i]);const P=m.useCallback(()=>{w()},[w]);return{...V,refetch:P}}function He(s,t,r,a,c,o,i={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:v,oiRefreshInterval:x=3e4,pauseWhenHidden:h=!0}=i,[V,d]=m.useState(null),[u,_]=m.useState(null),{data:b,isLoading:w,isConnected:P,isPaused:N,error:D,lastUpdate:n,refetch:C}=Ye(s,t,r,c,o,{enabled:v,refreshInterval:x,pauseWhenHidden:h}),S=m.useMemo(()=>{const U=[],M=a==="BFO"?"BSE_INDEX":"NSE_INDEX";if(U.push({symbol:t,exchange:M}),b?.chain)for(const R of b.chain)R.ce?.symbol&&U.push({symbol:R.ce.symbol,exchange:a}),R.pe?.symbol&&U.push({symbol:R.pe.symbol,exchange:a});return U},[b?.chain,a,t]),{data:O,isConnected:p,isAuthenticated:$,isPaused:B}=De({symbols:S,mode:"Depth",enabled:v&&S.length>0,pauseWhenHidden:h});m.useEffect(()=>{if(!b){d(null);return}if(O.size===0){d(b);return}const U=b.chain.map(f=>{const te={...f};if(f.ce?.symbol){const q=`${a}:${f.ce.symbol}`,y=O.get(q);if(y?.data){const z=y.data.depth?.buy?.[0],X=y.data.depth?.sell?.[0];te.ce={...f.ce,ltp:y.data.ltp??f.ce.ltp,bid:z?.price??y.data.bid_price??f.ce.bid,ask:X?.price??y.data.ask_price??f.ce.ask,bid_qty:z?.quantity??y.data.bid_size??f.ce.bid_qty??0,ask_qty:X?.quantity??y.data.ask_size??f.ce.ask_qty??0}}}if(f.pe?.symbol){const q=`${a}:${f.pe.symbol}`,y=O.get(q);if(y?.data){const z=y.data.depth?.buy?.[0],X=y.data.depth?.sell?.[0];te.pe={...f.pe,ltp:y.data.ltp??f.pe.ltp,bid:z?.price??y.data.bid_price??f.pe.bid,ask:X?.price??y.data.ask_price??f.pe.ask,bid_qty:z?.quantity??y.data.bid_size??f.pe.bid_qty??0,ask_qty:X?.quantity??y.data.ask_size??f.pe.ask_qty??0}}}return te});let M=!1;for(const[,f]of O)if(f.lastUpdate&&(!u||f.lastUpdate>u.getTime())){M=!0;break}M&&_(new Date);const j=`${a==="BFO"?"BSE_INDEX":"NSE_INDEX"}:${t}`,A=O.get(j)?.data?.ltp??b.underlying_ltp;d({...b,underlying_ltp:A,chain:U})},[b,O,a,t,u]);const ee=p&&$&&S.length>0,H=N||B,G=m.useMemo(()=>!n&&!u?null:n?u&&u>n?u:n:u,[n,u]);return{data:V,isLoading:w,isConnected:P,isStreaming:ee,isPaused:H,error:D,lastUpdate:G,streamingSymbols:S.length,refetch:C}}const I=[{key:"ce_oi",label:"OI",side:"ce",width:"w-20",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_volume",label:"Volume",side:"ce",width:"w-20",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_bid_qty",label:"Bid Qty",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_bid",label:"Bid",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ltp",label:"LTP",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ask",label:"Ask",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ask_qty",label:"Ask Qty",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_spread",label:"Spread",side:"ce",width:"w-14",align:"right",defaultVisible:!0,formatter:"spread"},{key:"strike",label:"Strike",side:"center",width:"w-20",align:"center",defaultVisible:!0,formatter:"none"},{key:"pe_spread",label:"Spread",side:"pe",width:"w-14",align:"left",defaultVisible:!0,formatter:"spread"},{key:"pe_ask_qty",label:"Ask Qty",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_ask",label:"Ask",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_ltp",label:"LTP",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_bid",label:"Bid",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_bid_qty",label:"Bid Qty",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_volume",label:"Volume",side:"pe",width:"w-20",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_oi",label:"OI",side:"pe",width:"w-20",align:"left",defaultVisible:!0,formatter:"number"}],Ge=I.map(s=>s.key),Qe=I.filter(s=>s.defaultVisible).map(s=>s.key),L={visibleColumns:Qe,columnOrder:Ge,strikeCount:10,selectedUnderlying:"NIFTY",barDataSource:"oi",barStyle:"gradient"},ve="openalgo_option_chain_prefs";function Ke(){if(typeof window>"u")return L;try{const s=localStorage.getItem(ve);if(!s)return L;const t=JSON.parse(s),r=new Set(I.map(i=>i.key)),a=Array.isArray(t.visibleColumns)?t.visibleColumns.filter(i=>r.has(i)):L.visibleColumns;a.includes("strike")||a.push("strike");const c=Array.isArray(t.columnOrder)?t.columnOrder.filter(i=>r.has(i)):L.columnOrder,o=new Set(c);return L.columnOrder.forEach(i=>{o.has(i)||c.push(i)}),{visibleColumns:a,columnOrder:c,strikeCount:typeof t.strikeCount=="number"&&t.strikeCount>0?t.strikeCount:L.strikeCount,selectedUnderlying:typeof t.selectedUnderlying=="string"&&t.selectedUnderlying?t.selectedUnderlying:L.selectedUnderlying,barDataSource:t.barDataSource==="oi"||t.barDataSource==="volume"?t.barDataSource:L.barDataSource,barStyle:t.barStyle==="gradient"||t.barStyle==="solid"?t.barStyle:L.barStyle}}catch{return L}}function Je(s){if(!(typeof window>"u"))try{localStorage.setItem(ve,JSON.stringify(s))}catch{}}function Ze(){const[s,t]=m.useState(()=>Ke());m.useEffect(()=>{Je(s)},[s]);const r=m.useCallback(d=>{d!=="strike"&&t(u=>{const b=u.visibleColumns.includes(d)?u.visibleColumns.filter(w=>w!==d):[...u.visibleColumns,d];return{...u,visibleColumns:b}})},[]),a=m.useCallback(d=>{t(u=>({...u,columnOrder:d}))},[]),c=m.useCallback(d=>{t(u=>({...u,strikeCount:d}))},[]),o=m.useCallback(d=>{t(u=>({...u,selectedUnderlying:d}))},[]),i=m.useCallback(d=>{t(u=>({...u,barDataSource:d}))},[]),v=m.useCallback(d=>{t(u=>({...u,barStyle:d}))},[]),x=m.useCallback(()=>{t(L)},[]),h=m.useCallback(d=>s.visibleColumns.includes(d),[s.visibleColumns]),V=m.useCallback(()=>s.columnOrder.filter(d=>s.visibleColumns.includes(d)),[s.columnOrder,s.visibleColumns]);return{preferences:s,visibleColumns:s.visibleColumns,columnOrder:s.columnOrder,strikeCount:s.strikeCount,selectedUnderlying:s.selectedUnderlying,barDataSource:s.barDataSource,barStyle:s.barStyle,toggleColumn:r,reorderColumns:a,setStrikeCount:c,setSelectedUnderlying:o,setBarDataSource:i,setBarStyle:v,resetToDefaults:x,isColumnVisible:h,getOrderedVisibleColumns:V}}const et={getOptionChain:async(s,t,r,a,c)=>(await he.post("/optionchain",{apikey:s,underlying:t,exchange:r,expiry_date:a,strike_count:c??20})).data,getExpiries:async(s,t,r,a="options")=>(await he.post("/expiry",{apikey:s,symbol:t,exchange:r,instrumenttype:a})).data};function tt({barDataSource:s,barStyle:t,onBarDataSourceChange:r,onBarStyleChange:a}){return e.jsxs(ye,{children:[e.jsx(Ne,{asChild:!0,children:e.jsxs(Y,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Bar settings"})]})}),e.jsxs(Ce,{align:"end",className:"w-48",children:[e.jsx(ae,{children:"Bar Data"}),e.jsxs(xe,{value:s,onValueChange:c=>r(c),children:[e.jsx(se,{value:"oi",children:"Open Interest"}),e.jsx(se,{value:"volume",children:"Volume"})]}),e.jsx(ue,{}),e.jsx(ae,{children:"Bar Style"}),e.jsxs(xe,{value:t,onValueChange:c=>a(c),children:[e.jsx(se,{value:"gradient",children:"Gradient"}),e.jsx(se,{value:"solid",children:"Solid"})]})]})]})}function st({visibleColumns:s,onToggleColumn:t,onResetToDefaults:r}){const a=I.filter(i=>i.side==="ce"),c=I.filter(i=>i.side==="pe"),o=i=>s.includes(i);return e.jsxs(ye,{children:[e.jsx(Ne,{asChild:!0,children:e.jsxs(Y,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Column settings"})]})}),e.jsxs(Ce,{align:"end",className:"w-48",children:[e.jsx(ae,{children:"CALLS Columns"}),a.map(i=>e.jsx(pe,{checked:o(i.key),onCheckedChange:()=>t(i.key),children:i.label},i.key)),e.jsx(ue,{}),e.jsx(ae,{children:"PUTS Columns"}),c.map(i=>e.jsx(pe,{checked:o(i.key),onCheckedChange:()=>t(i.key),children:i.label},i.key)),e.jsx(ue,{}),e.jsxs(Y,{variant:"ghost",size:"sm",className:"w-full justify-start px-2",onClick:r,children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Reset to Defaults"]})]})]})}function je({columnKey:s,label:t,side:r,isVisible:a,isDragging:c,onDragStart:o,onDragOver:i,onDrop:v,onDragEnd:x}){return e.jsxs("div",{draggable:!0,onDragStart:h=>o(h,s),onDragOver:i,onDrop:h=>v(h,s),onDragEnd:x,className:k("flex items-center gap-2 rounded-md border px-3 py-2 cursor-grab active:cursor-grabbing transition-all",c&&"opacity-50 border-dashed",a?"bg-card":"bg-muted/50 opacity-60",r==="ce"?"border-l-2 border-l-green-500":"border-r-2 border-r-red-500"),children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm flex-1",children:t}),e.jsx("span",{className:k("text-xs px-1.5 py-0.5 rounded",r==="ce"?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"),children:r==="ce"?"CE":"PE"})]})}function at({columnOrder:s,visibleColumns:t,onReorderColumns:r}){const[a,c]=m.useState(s),[o,i]=m.useState(null),[v,x]=m.useState(!1),h=a.filter(n=>I.find(S=>S.key===n)?.side==="ce"),V=a.filter(n=>I.find(S=>S.key===n)?.side==="pe"),d=n=>I.find(S=>S.key===n)?.label??n,u=n=>I.find(S=>S.key===n)?.side==="pe"?"pe":"ce",_=(n,C)=>{i(C),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",C)},b=n=>{n.preventDefault(),n.dataTransfer.dropEffect="move"},w=(n,C)=>{if(n.preventDefault(),!o||o===C)return;const S=u(o),O=u(C);if(S!==O)return;const p=[...a],$=p.indexOf(o),B=p.indexOf(C);p.splice($,1),p.splice(B,0,o),c(p)},P=()=>{i(null)},N=()=>{r(a),x(!1)},D=n=>{x(n),n&&c(s)};return e.jsxs(Ue,{open:v,onOpenChange:D,children:[e.jsx(Fe,{asChild:!0,children:e.jsxs(Y,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(Te,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Reorder columns"})]})}),e.jsxs(Be,{className:"sm:max-w-md",children:[e.jsxs(Me,{children:[e.jsx(Re,{children:"Reorder Columns"}),e.jsx(Ae,{children:"Drag columns to reorder them. CE and PE columns can only be reordered within their respective sections."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2 text-green-500",children:"CALLS (CE)"}),e.jsx(be,{className:"h-64 pr-2",children:e.jsx("div",{className:"space-y-1.5",children:h.map(n=>e.jsx(je,{columnKey:n,label:d(n),side:"ce",isVisible:t.includes(n),isDragging:o===n,onDragStart:_,onDragOver:b,onDrop:w,onDragEnd:P},n))})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2 text-red-500",children:"PUTS (PE)"}),e.jsx(be,{className:"h-64 pr-2",children:e.jsx("div",{className:"space-y-1.5",children:V.map(n=>e.jsx(je,{columnKey:n,label:d(n),side:"pe",isVisible:t.includes(n),isDragging:o===n,onDragStart:_,onDragOver:b,onDrop:w,onDragEnd:P},n))})})]})]}),e.jsxs(qe,{className:"gap-2 sm:gap-0",children:[e.jsx(We,{asChild:!0,children:e.jsx(Y,{variant:"outline",children:"Cancel"})}),e.jsx(Y,{onClick:N,children:"Save Order"})]})]})]})}const de=[{value:"NIFTY",label:"NIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"BANKNIFTY",label:"BANKNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"SENSEX",label:"SENSEX",exchange:"BFO",brokerExchange:"BSE_INDEX"},{value:"FINNIFTY",label:"FINNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"MIDCPNIFTY",label:"MIDCPNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"}],rt=[{value:5,label:"5 strikes"},{value:10,label:"10 strikes"},{value:15,label:"15 strikes"},{value:20,label:"20 strikes"},{value:25,label:"25 strikes"}],E={ce_oi:80,ce_volume:80,ce_bid_qty:60,ce_bid:70,ce_ltp:80,ce_ask:70,ce_ask_qty:60,ce_spread:60,strike:80,pe_spread:60,pe_ask_qty:60,pe_ask:70,pe_ltp:80,pe_bid:70,pe_bid_qty:60,pe_volume:80,pe_oi:80};function Z(s){if(s==null||s===0)return"0";const t=s/1e5;if(t>=100)return t.toFixed(0)+"L";if(t>=10)return t.toFixed(1)+"L";if(t>=1)return t.toFixed(2)+"L";{const r=s/1e3;return r>=1?r.toFixed(1)+"K":s.toLocaleString()}}function F(s){return s==null?"0.00":s.toFixed(2)}function nt(s){if(!s)return"";const t=s.split("-");return t.length===3?`${t[0]}${t[1].toUpperCase()}${t[2].slice(-2)}`:s.replace(/-/g,"").toUpperCase()}function lt(s){let t=0,r=0;return s.forEach(a=>{a.ce?.oi&&(t+=a.ce.oi),a.pe?.oi&&(r+=a.pe?.oi??0)}),t===0?0:r/t}function it(s){let t=0,r=0,a=0,c=0;return s.forEach(o=>{o.ce&&(t+=o.ce.volume??0,a+=o.ce.oi??0),o.pe&&(r+=o.pe.volume??0,c+=o.pe.oi??0)}),{ceVolume:t,peVolume:r,ceOi:a,peOi:c}}function ct(s,t){let r=0;return s.forEach(a=>{const c=t==="oi"?a.ce?.oi:a.ce?.volume,o=t==="oi"?a.pe?.oi:a.pe?.volume;c&&c>r&&(r=c),o&&o>r&&(r=o)}),r||1}function ot({strike:s,previousData:t,maxBarValue:r,visibleCeColumns:a,visiblePeColumns:c,barDataSource:o,barStyle:i}){const v=t.get(s.strike),x=s.ce,h=s.pe,V=x?.label??h?.label??"",d=V==="ATM",u=V.startsWith("OTM"),_=V.startsWith("ITM"),b=v?.ce?.ltp!==x?.ltp,w=v?.pe?.ltp!==h?.ltp,P=b?x&&v?.ce&&x.ltp>v.ce.ltp?"bg-green-500/30":"bg-red-500/30":"",N=w?h&&v?.pe&&h.ltp>v.pe.ltp?"bg-green-500/30":"bg-red-500/30":"",D=x&&x.bid>0&&x.ask>0?x.ask-x.bid:0,n=h&&h.bid>0&&h.ask>0?h.ask-h.bid:0,C=D<=1?"text-green-500":D<=2?"text-yellow-500":"text-red-500",S=n<=1?"text-green-500":n<=2?"text-yellow-500":"text-red-500",O=o==="oi"?x?.oi:x?.volume,p=o==="oi"?h?.oi:h?.volume,$=O?Math.min(O/r*100,100):0,B=p?Math.min(p/r*100,100):0,ee=i==="gradient"?"bg-gradient-to-r from-green-500/25 to-transparent":"bg-green-500/20",H=i==="gradient"?"bg-gradient-to-l from-red-500/25 to-transparent":"bg-red-500/20",G=j=>{switch(j){case"ce_oi":return e.jsx("span",{className:"font-mono text-xs",children:Z(x?.oi)});case"ce_volume":return e.jsx("span",{className:"font-mono text-xs",children:Z(x?.volume)});case"ce_bid_qty":return e.jsx("span",{className:"text-xs",children:x?.bid_qty??0});case"ce_bid":return e.jsx("span",{className:"text-red-500 text-xs",children:F(x?.bid)});case"ce_ltp":return e.jsx("span",{className:k("font-semibold text-xs",P),children:F(x?.ltp)});case"ce_ask":return e.jsx("span",{className:"text-green-500 text-xs",children:F(x?.ask)});case"ce_ask_qty":return e.jsx("span",{className:"text-xs",children:x?.ask_qty??0});case"ce_spread":return e.jsx("span",{className:k("text-xs",C),children:F(D)});default:return null}},U=j=>{switch(j){case"pe_oi":return e.jsx("span",{className:"font-mono text-xs",children:Z(h?.oi)});case"pe_volume":return e.jsx("span",{className:"font-mono text-xs",children:Z(h?.volume)});case"pe_bid_qty":return e.jsx("span",{className:"text-xs",children:h?.bid_qty??0});case"pe_bid":return e.jsx("span",{className:"text-red-500 text-xs",children:F(h?.bid)});case"pe_ltp":return e.jsx("span",{className:k("font-semibold text-xs",N),children:F(h?.ltp)});case"pe_ask":return e.jsx("span",{className:"text-green-500 text-xs",children:F(h?.ask)});case"pe_ask_qty":return e.jsx("span",{className:"text-xs",children:h?.ask_qty??0});case"pe_spread":return e.jsx("span",{className:k("text-xs",S),children:F(n)});default:return null}},M=a.reduce((j,T)=>j+E[T],0),R=c.reduce((j,T)=>j+E[T],0);return e.jsxs(me,{className:k("hover:bg-muted/50 relative"),"data-strike":s.strike,"data-label":V,children:[a.length>0&&e.jsxs(oe,{className:k("p-0 relative",u&&!d&&"bg-amber-500/5"),style:{width:M},children:[e.jsx("div",{className:k("absolute left-0 top-0 bottom-0 pointer-events-none z-0 transition-all duration-300",ee),style:{width:`${$}%`}}),e.jsx("div",{className:"relative z-10 flex",children:a.map(j=>{const T=I.find(A=>A.key===j);return e.jsx("div",{className:k("px-2 py-1.5",T?.align==="right"&&"text-right",T?.align==="center"&&"text-center",T?.align==="left"&&"text-left"),style:{width:E[j],minWidth:E[j]},children:G(j)},j)})})]}),e.jsx(oe,{className:k("text-center font-bold px-2 py-1.5 text-sm",d?"bg-primary/15":"bg-muted/30"),style:{width:E.strike,minWidth:E.strike},children:s.strike}),c.length>0&&e.jsxs(oe,{className:k("p-0 relative",_&&!d&&"bg-amber-500/5"),style:{width:R},children:[e.jsx("div",{className:k("absolute right-0 top-0 bottom-0 pointer-events-none z-0 transition-all duration-300",H),style:{width:`${B}%`}}),e.jsx("div",{className:"relative z-10 flex",children:c.map(j=>{const T=I.find(A=>A.key===j);return e.jsx("div",{className:k("px-2 py-1.5",T?.align==="right"&&"text-right",T?.align==="center"&&"text-center",T?.align==="left"&&"text-left"),style:{width:E[j],minWidth:E[j]},children:U(j)},j)})})]})]})}function Ct(){const{apiKey:s}=we(),{visibleColumns:t,columnOrder:r,strikeCount:a,selectedUnderlying:c,barDataSource:o,barStyle:i,toggleColumn:v,reorderColumns:x,setStrikeCount:h,setSelectedUnderlying:V,setBarDataSource:d,setBarStyle:u,resetToDefaults:_}=Ze(),[b,w]=m.useState(""),[P,N]=m.useState([]),[D,n]=m.useState(new Map),C=de.find(l=>l.value===c),S=C?.brokerExchange??"NSE_INDEX",O=C?.exchange??"NFO",{data:p,isConnected:$,isStreaming:B,isPaused:ee,error:H,lastUpdate:G,refetch:U,isLoading:M,streamingSymbols:R}=He(s,c,S,O,nt(b),a,{enabled:!!b,oiRefreshInterval:3e4,pauseWhenHidden:!0});m.useEffect(()=>{(async()=>{if(!(!s||!c))try{const g=await et.getExpiries(s,c,O);g.status==="success"&&g.data.length>0?(N(g.data),b||w(g.data[0])):fe.error(g.message||"Failed to load expiries")}catch(g){console.error("Error loading expiries:",g),fe.error("Failed to load expiry dates")}})()},[s,c,O,b]),m.useEffect(()=>{if(p?.chain){const l=new Map;p.chain.forEach(g=>{l.set(g.strike,g)}),n(l)}},[p?.chain]);const j=l=>{de.find(W=>W.value===l)&&(V(l),w(""),N([]))},T=()=>{U()},A=m.useMemo(()=>p?.chain?lt(p.chain):0,[p?.chain]),f=m.useMemo(()=>p?.chain?it(p.chain):{ceVolume:0,peVolume:0,ceOi:0,peOi:0},[p?.chain]),te=m.useMemo(()=>p?.chain?ct(p.chain,o):1,[p?.chain,o]),q=m.useMemo(()=>r.filter(l=>I.find(W=>W.key===l)?.side==="ce"&&t.includes(l)),[r,t]),y=m.useMemo(()=>r.filter(l=>I.find(W=>W.key===l)?.side==="pe"&&t.includes(l)),[r,t]),z=q.reduce((l,g)=>l+E[g],0),X=y.reduce((l,g)=>l+E[g],0);return H?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(Q,{className:"max-w-md",children:e.jsx(K,{className:"p-6",children:e.jsxs("div",{className:"text-center text-red-500",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Error Loading Option Chain"}),e.jsx("p",{children:H}),e.jsxs(Y,{onClick:T,className:"mt-4",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Retry"]})]})})})}):e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-3xl font-bold",children:"Option Chain"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(re,{value:c,onValueChange:j,children:[e.jsx(ne,{className:"w-36",children:e.jsx(le,{placeholder:"Select Underlying"})}),e.jsx(ie,{children:de.map(l=>e.jsx(ce,{value:l.value,children:l.label},l.value))})]}),e.jsxs(re,{value:b,onValueChange:w,disabled:P.length===0,children:[e.jsx(ne,{className:"w-36",children:e.jsx(le,{placeholder:"Select Expiry"})}),e.jsx(ie,{children:P.map(l=>e.jsx(ce,{value:l,children:l},l))})]}),e.jsxs(re,{value:String(a),onValueChange:l=>h(Number(l)),children:[e.jsx(ne,{className:"w-36",children:e.jsx(le,{placeholder:"Strike Count"})}),e.jsx(ie,{children:rt.map(l=>e.jsx(ce,{value:String(l.value),children:l.label},l.value))})]}),e.jsx(tt,{barDataSource:o,barStyle:i,onBarDataSourceChange:d,onBarStyleChange:u}),e.jsx(st,{visibleColumns:t,onToggleColumn:v,onResetToDefaults:_}),e.jsx(at,{columnOrder:r,visibleColumns:t,onReorderColumns:x}),e.jsxs(Y,{onClick:T,disabled:!b||M,children:[e.jsx(ge,{className:`h-4 w-4 mr-2 ${M?"animate-spin":""}`}),"Refresh"]})]})]}),p&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(Q,{children:e.jsxs(K,{className:"p-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[c," Spot"]}),e.jsx("div",{className:"text-2xl font-bold text-primary",children:F(p.underlying_ltp)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Prev Close: ",F(p.underlying_prev_close)]})]})}),e.jsx(Q,{children:e.jsxs(K,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"ATM Strike"}),e.jsx("div",{className:"text-2xl font-bold",children:p.atm_strike}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Expiry: ",p.expiry_date]})]})}),e.jsx(Q,{children:e.jsxs(K,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"PCR"}),e.jsx("div",{className:`text-2xl font-bold ${A>1?"text-green-500":"text-yellow-500"}`,children:A.toFixed(2)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Put/Call Ratio"})]})}),e.jsx(Q,{children:e.jsxs(K,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total OI"}),e.jsxs("div",{className:"text-sm mt-1",children:[e.jsx("span",{className:"text-green-500 font-mono",children:Z(f.ceOi)}),e.jsx("span",{className:"mx-2 text-muted-foreground",children:"|"}),e.jsx("span",{className:"text-red-500 font-mono",children:Z(f.peOi)})]}),e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-primary transition-all duration-500",style:{width:f.ceOi+f.peOi>0?`${f.ceOi/(f.ceOi+f.peOi)*100}%`:"0%"}})}),e.jsx("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:e.jsxs("span",{children:["PCR: ",A.toFixed(2)]})})]})})]}),e.jsx(Q,{children:e.jsx(K,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($e,{className:"w-full table-fixed",children:[e.jsxs(ze,{children:[e.jsxs(me,{className:"bg-muted/30 border-b-0",children:[q.length>0&&e.jsx(J,{className:"text-center text-green-500 font-bold text-sm border-r border-border",style:{width:z},children:"CALLS"}),e.jsx(J,{className:"text-center",style:{width:E.strike}}),y.length>0&&e.jsx(J,{className:"text-center text-red-500 font-bold text-sm border-l border-border",style:{width:X},children:"PUTS"})]}),e.jsxs(me,{className:"bg-muted/50",children:[q.length>0&&e.jsx(J,{className:"p-0 border-r border-border",style:{width:z},children:e.jsx("div",{className:"flex",children:q.map(l=>{const g=I.find(W=>W.key===l);return e.jsx("div",{className:k("px-2 py-2 text-xs font-medium",g?.align==="right"&&"text-right",g?.align==="center"&&"text-center",g?.align==="left"&&"text-left"),style:{width:E[l],minWidth:E[l]},children:g?.label},l)})})}),e.jsx(J,{className:"text-center bg-muted/30 text-xs",style:{width:E.strike},children:"Strike"}),y.length>0&&e.jsx(J,{className:"p-0 border-l border-border",style:{width:X},children:e.jsx("div",{className:"flex",children:y.map(l=>{const g=I.find(W=>W.key===l);return e.jsx("div",{className:k("px-2 py-2 text-xs font-medium",g?.align==="right"&&"text-right",g?.align==="center"&&"text-center",g?.align==="left"&&"text-left"),style:{width:E[l],minWidth:E[l]},children:g?.label},l)})})})]})]}),e.jsx(Xe,{children:p.chain.map(l=>e.jsx(ot,{strike:l,previousData:D,maxBarValue:te,visibleCeColumns:q,visiblePeColumns:y,barDataSource:o,barStyle:i},l.strike))})]})})})}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[B?e.jsx(Pe,{className:"h-4 w-4 text-green-500"}):e.jsx(Le,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Se,{variant:B?"default":$?"secondary":"destructive",children:ee?"Paused":B?`Streaming ${R} symbols`:$?"Polling":"Disconnected"})]}),e.jsxs("div",{className:"text-xs",children:["Bar: ",o==="oi"?"OI":"Volume"," (",i,")"]})]}),e.jsxs("div",{children:["Last Update: ",G?G.toLocaleTimeString():"-"]})]})]}),!p&&!H&&e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})]})}export{Ct as default};
