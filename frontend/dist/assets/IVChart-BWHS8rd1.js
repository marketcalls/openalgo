import{r as n,j as t}from"./vendor-react--vsXx8_n.js";import{K as re,W as ne,q as le,n as oe}from"./lightweight-charts.production-EcMg1Lek.js";import{w as $,u as ie,d as ce,s as V}from"./index-Ce3evt5i.js";import{o as de}from"./option-chain-Hn1kYtX6.js";import{C as me,a as ue,b as fe,d as he}from"./card-CTYErYIc.js";import{S as C,a as T,b as S,c as I,d as w}from"./select-BtUEZ2w-.js";import{T as pe,a as xe,b as ge}from"./tabs-CJFUmVwF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-CHcGIKxc.js";import"./vendor-router-CiBIGs7t.js";import"./vendor-radix-DkDlinVE.js";const G={getIVData:async l=>(await $.post("/ivchart/api/iv-data",l)).data,getDefaultSymbols:async l=>(await $.post("/ivchart/api/default-symbols",l)).data,getIntervals:async()=>(await $.get("/ivchart/api/intervals")).data},k=[{value:"NIFTY",label:"NIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"BANKNIFTY",label:"BANKNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"SENSEX",label:"SENSEX",exchange:"BFO",brokerExchange:"BSE_INDEX"},{value:"FINNIFTY",label:"FINNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"MIDCPNIFTY",label:"MIDCPNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"}],b=["iv","delta","theta","vega","gamma"],v={iv:{label:"IV",ceTitle:"CE IV",peTitle:"PE IV",formatter:l=>`${l.toFixed(2)}%`},delta:{label:"Delta",ceTitle:"CE Delta",peTitle:"PE Delta",formatter:l=>l.toFixed(4)},theta:{label:"Theta",ceTitle:"CE Theta",peTitle:"PE Theta",formatter:l=>l.toFixed(4)},vega:{label:"Vega",ceTitle:"CE Vega",peTitle:"PE Vega",formatter:l=>l.toFixed(4)},gamma:{label:"Gamma",ceTitle:"CE Gamma",peTitle:"PE Gamma",formatter:l=>l.toFixed(6)}},_=350;function be(l){if(!l)return"";const i=l.split("-");return i.length===3?`${i[0]}${i[1].toUpperCase()}${i[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function De(){const{mode:l}=ie(),i=l==="dark",{apiKey:D}=ce(),[X,L]=n.useState(!1),[P,B]=n.useState("iv"),[M,K]=n.useState(k[0].value),[q,J]=n.useState([]),[N,W]=n.useState(""),[Q,A]=n.useState([]),[j,R]=n.useState("5m"),[p,Z]=n.useState("1"),[m,ee]=n.useState(null),f=n.useRef(new Map),u=n.useRef(new Map),F=n.useRef(null),h=k.find(e=>e.value===M)||k[0],O=n.useMemo(()=>{const e={};for(const s of b)for(const a of["ce","pe"]){const r=`${s}-${a}`;e[r]=o=>{o?f.current.set(r,o):f.current.delete(r)}}return e},[]),U=n.useCallback(e=>({width:e,height:_,layout:{background:{type:ne.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0},horzLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0}},rightPriceScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:s=>{const a=new Date(s*1e3),r=new Date(a.getTime()+5.5*60*60*1e3),o=r.getUTCHours().toString().padStart(2,"0"),c=r.getUTCMinutes().toString().padStart(2,"0");if(parseInt(p)>1){const x=r.getUTCDate().toString().padStart(2,"0"),d=(r.getUTCMonth()+1).toString().padStart(2,"0");return`${x}/${d} ${o}:${c}`}return`${o}:${c}`}},crosshair:{mode:re.Normal,vertLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelVisible:!1},horzLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#2563eb"}}}),[i,p]),Y=n.useCallback(e=>{const s=document.createElement("div");s.style.cssText=`position:absolute;z-index:2;font-family:Arial,sans-serif;font-size:28px;font-weight:bold;user-select:none;pointer-events:none;color:${i?"rgba(166,173,187,0.12)":"rgba(0,0,0,0.06)"}`,s.textContent="OpenAlgo",e.appendChild(s),setTimeout(()=>{s.style.left=`${e.offsetWidth/2-s.offsetWidth/2}px`,s.style.top=`${e.offsetHeight/2-s.offsetHeight/2}px`},0)},[i]),y=n.useCallback(e=>{for(const s of b)for(const a of["CE","PE"]){const r=`${s}-${a.toLowerCase()}`,o=u.current.get(r);if(!o)continue;const c=e.series.find(d=>d.option_type===a);if(!c)continue;const x=c.iv_data.filter(d=>d[s]!==null).map(d=>({time:d.time,value:d[s]})).sort((d,g)=>d.time-g.time);o.series.setData(x),o.chart.timeScale().fitContent()}},[]);n.useEffect(()=>{for(const[,a]of u.current)a.chart.remove();u.current.clear();for(const[,a]of f.current)a.innerHTML="";const s=f.current.get("iv-ce")?.offsetWidth||500;for(const a of b)for(const r of["ce","pe"]){const o=`${a}-${r}`,c=f.current.get(o);if(!c)continue;const x=c.offsetWidth>0?c.offsetWidth:s,d=r==="ce"?"#22c55e":"#ef4444",g=v[a],se=r==="ce"?g.ceTitle:g.peTitle,z=le(c,U(x)),ae=z.addSeries(oe,{color:d,lineWidth:2,priceScaleId:"right",title:se,priceFormat:{type:"custom",formatter:g.formatter}});Y(c),u.current.set(o,{chart:z,series:ae})}return F.current&&y(F.current),()=>{for(const[,a]of u.current)a.chart.remove();u.current.clear()}},[U,Y,y]),n.useEffect(()=>{const e=()=>{for(const[s,a]of u.current){const r=f.current.get(s);r&&r.offsetWidth>0&&a.chart.applyOptions({width:r.offsetWidth})}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const s=await G.getIntervals();if(s.status==="success"&&s.data){const a=[...s.data.seconds||[],...s.data.minutes||[],...s.data.hours||[]];A(a.length>0?a:["1m","3m","5m","10m","15m","30m","1h"]),a.length>0&&!a.includes(j)&&R(a.includes("5m")?"5m":a[0])}}catch{A(["1m","3m","5m","10m","15m","30m","1h"])}})()},[]),n.useEffect(()=>{(async()=>{if(D)try{const s=await de.getExpiries(D,h.value,h.exchange,"options");s.status==="success"&&s.data&&(J(s.data),s.data.length>0&&W(s.data[0]))}catch{V.error("Failed to fetch expiry dates","positions")}})()},[D,h.value,h.exchange]);const H=n.useCallback(async()=>{if(N){L(!0);try{const e=await G.getIVData({underlying:h.value,exchange:h.brokerExchange,expiry_date:be(N),interval:j,days:parseInt(p)});e.status==="success"&&e.data?(F.current=e.data,ee(e.data),y(e.data)):V.error(e.message||"Failed to load data","positions")}catch{V.error("Failed to fetch data","positions")}finally{L(!1)}}},[N,j,p,h,y]);n.useEffect(()=>{H()},[H]);const te=e=>{B(e),requestAnimationFrame(()=>{for(const s of["ce","pe"]){const a=`${e}-${s}`,r=u.current.get(a),o=f.current.get(a);r&&o&&o.offsetWidth>0&&(r.chart.applyOptions({width:o.offsetWidth}),r.chart.timeScale().fitContent())}})},E=(e,s)=>{if(!m)return"--";const a=m.series.find(c=>c.option_type===e);if(!a)return"--";const r=a.iv_data.filter(c=>c[s]!==null);if(r.length===0)return"--";const o=r[r.length-1][s];return o===null?"--":v[s].formatter(o)};return t.jsx("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:t.jsxs(me,{children:[t.jsx(ue,{className:"pb-4",children:t.jsx(fe,{className:"text-xl font-semibold",children:"Option Greeks"})}),t.jsxs(he,{children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[t.jsxs(C,{value:M,onValueChange:K,children:[t.jsx(T,{className:"w-[140px]",children:t.jsx(S,{placeholder:"Underlying"})}),t.jsx(I,{children:k.map(e=>t.jsx(w,{value:e.value,children:e.label},e.value))})]}),t.jsxs(C,{value:N,onValueChange:W,children:[t.jsx(T,{className:"w-[140px]",children:t.jsx(S,{placeholder:"Expiry"})}),t.jsx(I,{children:q.map(e=>t.jsx(w,{value:e,children:e},e))})]}),t.jsxs(C,{value:j,onValueChange:R,children:[t.jsx(T,{className:"w-[100px]",children:t.jsx(S,{placeholder:"Interval"})}),t.jsx(I,{children:Q.map(e=>t.jsx(w,{value:e,children:e},e))})]}),t.jsxs(C,{value:p,onValueChange:Z,children:[t.jsx(T,{className:"w-[100px]",children:t.jsx(S,{placeholder:"Days"})}),t.jsx(I,{children:["1","5","10","15"].map(e=>t.jsxs(w,{value:e,children:[e," ",e==="1"?"Day":"Days"]},e))})]}),X&&t.jsx("span",{className:"text-sm text-muted-foreground ml-2",children:"Loading..."})]}),m&&t.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-1 mb-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"ATM Strike: "}),t.jsx("span",{className:"font-medium",children:m.atm_strike})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"LTP: "}),t.jsx("span",{className:"font-medium",children:m.underlying_ltp?.toFixed(2)})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-green-500"}),t.jsx("span",{className:"text-muted-foreground",children:"CE: "}),t.jsx("span",{className:"font-medium",children:m.ce_symbol}),t.jsx("span",{className:"text-green-600 dark:text-green-400 font-medium ml-1",children:E("CE","iv")})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-red-500"}),t.jsx("span",{className:"text-muted-foreground",children:"PE: "}),t.jsx("span",{className:"font-medium",children:m.pe_symbol}),t.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium ml-1",children:E("PE","iv")})]})]}),t.jsx(pe,{value:P,onValueChange:te,children:t.jsx(xe,{className:"grid w-full max-w-md grid-cols-5",children:b.map(e=>t.jsx(ge,{value:e,children:v[e].label},e))})}),t.jsx("div",{className:"mt-4",children:b.map(e=>t.jsx("div",{className:P!==e?"h-0 overflow-hidden pointer-events-none":"",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:[m?.ce_symbol||"CE"," ",v[e].label]}),t.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:E("CE",e)})]}),t.jsx("div",{ref:O[`${e}-ce`],className:"relative w-full rounded-lg border border-border/50",style:{height:_}})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-sm font-medium text-red-600 dark:text-red-400",children:[m?.pe_symbol||"PE"," ",v[e].label]}),t.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:E("PE",e)})]}),t.jsx("div",{ref:O[`${e}-pe`],className:"relative w-full rounded-lg border border-border/50",style:{height:_}})]})]})},e))})]})]})})}export{De as default};
