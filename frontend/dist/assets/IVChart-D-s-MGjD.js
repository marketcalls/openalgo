import{r as n,j as t}from"./vendor-react-CCyQGCED.js";import{K as le,W as ie,q as ce,n as oe}from"./lightweight-charts.production-EcMg1Lek.js";import{w as j,u as de,s as W,B as ue}from"./index-DLrRZEmO.js";import{C as me,a as fe,b as he,d as pe}from"./card-BHRAREBW.js";import{S as C,a as N,b as E,c as T,d as S}from"./select-CSWw-9Vv.js";import{T as xe,a as ge,b as be}from"./tabs-CKmFU_4i.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const L={getIVData:async l=>(await j.post("/ivchart/api/iv-data",l)).data,getDefaultSymbols:async l=>(await j.post("/ivchart/api/default-symbols",l)).data,getIntervals:async()=>(await j.get("/ivchart/api/intervals")).data,getUnderlyings:async l=>(await j.get(`/search/api/underlyings?exchange=${l}`)).data,getExpiries:async(l,i)=>(await j.get(`/search/api/expiries?exchange=${l}&underlying=${i}`)).data},ve=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],X={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},w=["iv","delta","theta","vega","gamma"],I={iv:{label:"IV",ceTitle:"CE IV",peTitle:"PE IV",formatter:l=>`${l.toFixed(2)}%`},delta:{label:"Delta",ceTitle:"CE Delta",peTitle:"PE Delta",formatter:l=>l.toFixed(4)},theta:{label:"Theta",ceTitle:"CE Theta",peTitle:"PE Theta",formatter:l=>l.toFixed(4)},vega:{label:"Vega",ceTitle:"CE Vega",peTitle:"PE Vega",formatter:l=>l.toFixed(4)},gamma:{label:"Gamma",ceTitle:"CE Gamma",peTitle:"PE Gamma",formatter:l=>l.toFixed(6)}},A=350;function ye(l){if(!l)return"";const i=l.split("-");return i.length===3?`${i[0]}${i[1].toUpperCase()}${i[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function $e(){const{mode:l}=de(),i=l==="dark",[U,M]=n.useState(!1),[R,J]=n.useState("iv"),[f,Q]=n.useState("NFO"),[Z,H]=n.useState(X.NFO),[p,O]=n.useState("NIFTY"),[ee,F]=n.useState([]),[k,x]=n.useState(""),[te,z]=n.useState([]),[$,B]=n.useState("5m"),[g,se]=n.useState("1"),[u,_]=n.useState(null),h=n.useRef(new Map),m=n.useRef(new Map),b=n.useRef(null),G=n.useMemo(()=>{const e={};for(const a of w)for(const s of["ce","pe"]){const r=`${a}-${s}`;e[r]=c=>{c?h.current.set(r,c):h.current.delete(r)}}return e},[]),Y=n.useCallback(e=>({width:e,height:A,layout:{background:{type:ie.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0},horzLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0}},rightPriceScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:a=>{const s=new Date(a*1e3),r=new Date(s.getTime()+5.5*60*60*1e3),c=r.getUTCHours().toString().padStart(2,"0"),o=r.getUTCMinutes().toString().padStart(2,"0");if(parseInt(g)>1){const v=r.getUTCDate().toString().padStart(2,"0"),d=(r.getUTCMonth()+1).toString().padStart(2,"0");return`${v}/${d} ${c}:${o}`}return`${c}:${o}`}},crosshair:{mode:le.Normal,vertLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelVisible:!1},horzLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#2563eb"}}}),[i,g]),q=n.useCallback(e=>{const a=document.createElement("div");a.style.cssText=`position:absolute;z-index:2;font-family:Arial,sans-serif;font-size:28px;font-weight:bold;user-select:none;pointer-events:none;color:${i?"rgba(166,173,187,0.12)":"rgba(0,0,0,0.06)"}`,a.textContent="OpenAlgo",e.appendChild(a),setTimeout(()=>{a.style.left=`${e.offsetWidth/2-a.offsetWidth/2}px`,a.style.top=`${e.offsetHeight/2-a.offsetHeight/2}px`},0)},[i]),D=n.useCallback(e=>{for(const a of w)for(const s of["CE","PE"]){const r=`${a}-${s.toLowerCase()}`,c=m.current.get(r);if(!c)continue;const o=e.series.find(d=>d.option_type===s);if(!o)continue;const v=o.iv_data.filter(d=>d[a]!==null).map(d=>({time:d.time,value:d[a]})).sort((d,y)=>d.time-y.time);c.series.setData(v),c.chart.timeScale().fitContent()}},[]);n.useEffect(()=>{for(const[,s]of m.current)s.chart.remove();m.current.clear();for(const[,s]of h.current)s.innerHTML="";const a=h.current.get("iv-ce")?.offsetWidth||500;for(const s of w)for(const r of["ce","pe"]){const c=`${s}-${r}`,o=h.current.get(c);if(!o)continue;const v=o.offsetWidth>0?o.offsetWidth:a,d=r==="ce"?"#22c55e":"#ef4444",y=I[s],re=r==="ce"?y.ceTitle:y.peTitle,K=ce(o,Y(v)),ne=K.addSeries(oe,{color:d,lineWidth:2,priceScaleId:"right",title:re,priceFormat:{type:"custom",formatter:y.formatter}});q(o),m.current.set(c,{chart:K,series:ne})}return b.current&&D(b.current),()=>{for(const[,s]of m.current)s.chart.remove();m.current.clear()}},[Y,q,D]),n.useEffect(()=>{const e=()=>{for(const[a,s]of m.current){const r=h.current.get(a);r&&r.offsetWidth>0&&s.chart.applyOptions({width:r.offsetWidth})}};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),n.useEffect(()=>{(async()=>{try{const a=await L.getIntervals();if(a.status==="success"&&a.data){const s=[...a.data.seconds||[],...a.data.minutes||[],...a.data.hours||[]];z(s.length>0?s:["1m","3m","5m","10m","15m","30m","1h"]),s.length>0&&!s.includes($)&&B(s.includes("5m")?"5m":s[0])}}catch{z(["1m","3m","5m","10m","15m","30m","1h"])}})()},[]),n.useEffect(()=>{const e=X[f]||[];H(e),O(e[0]||""),F([]),x(""),_(null),b.current=null;let a=!1;return(async()=>{try{const r=await L.getUnderlyings(f);if(a)return;r.status==="success"&&r.underlyings.length>0&&(H(r.underlyings),r.underlyings.includes(e[0])||O(r.underlyings[0]))}catch{}})(),()=>{a=!0}},[f]),n.useEffect(()=>{if(!p)return;F([]),x(""),_(null),b.current=null;let e=!1;return(async()=>{try{const s=await L.getExpiries(f,p);if(e)return;s.status==="success"&&s.expiries.length>0?(F(s.expiries),x(s.expiries[0])):(F([]),x(""))}catch{if(e)return;W.error("Failed to fetch expiry dates","positions")}})(),()=>{e=!0}},[p]);const P=n.useCallback(async()=>{if(k){M(!0);try{const e=await L.getIVData({underlying:p,exchange:f,expiry_date:ye(k),interval:$,days:parseInt(g)});e.status==="success"&&e.data?(b.current=e.data,_(e.data),D(e.data)):W.error(e.message||"Failed to load data","positions")}catch{W.error("Failed to fetch data","positions")}finally{M(!1)}}},[k,$,g,p,f,D]);n.useEffect(()=>{P()},[P]);const ae=e=>{J(e),requestAnimationFrame(()=>{for(const a of["ce","pe"]){const s=`${e}-${a}`,r=m.current.get(s),c=h.current.get(s);r&&c&&c.offsetWidth>0&&(r.chart.applyOptions({width:c.offsetWidth}),r.chart.timeScale().fitContent())}})},V=(e,a)=>{if(!u)return"--";const s=u.series.find(o=>o.option_type===e);if(!s)return"--";const r=s.iv_data.filter(o=>o[a]!==null);if(r.length===0)return"--";const c=r[r.length-1][a];return c===null?"--":I[a].formatter(c)};return t.jsx("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:t.jsxs(me,{children:[t.jsx(fe,{className:"pb-4",children:t.jsx(he,{className:"text-xl font-semibold",children:"Option Greeks"})}),t.jsxs(pe,{children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[t.jsxs(C,{value:f,onValueChange:Q,children:[t.jsx(N,{className:"w-[100px]",children:t.jsx(E,{placeholder:"Exchange"})}),t.jsx(T,{children:ve.map(e=>t.jsx(S,{value:e.value,children:e.label},e.value))})]}),t.jsxs(C,{value:p,onValueChange:O,children:[t.jsx(N,{className:"w-[140px]",children:t.jsx(E,{placeholder:"Underlying"})}),t.jsx(T,{children:Z.map(e=>t.jsx(S,{value:e,children:e},e))})]}),t.jsxs(C,{value:k,onValueChange:x,children:[t.jsx(N,{className:"w-[140px]",children:t.jsx(E,{placeholder:"Expiry"})}),t.jsx(T,{children:ee.map(e=>t.jsx(S,{value:e,children:e},e))})]}),t.jsxs(C,{value:$,onValueChange:B,children:[t.jsx(N,{className:"w-[100px]",children:t.jsx(E,{placeholder:"Interval"})}),t.jsx(T,{children:te.map(e=>t.jsx(S,{value:e,children:e},e))})]}),t.jsxs(C,{value:g,onValueChange:se,children:[t.jsx(N,{className:"w-[100px]",children:t.jsx(E,{placeholder:"Days"})}),t.jsx(T,{children:["1","5","10","15"].map(e=>t.jsxs(S,{value:e,children:[e," ",e==="1"?"Day":"Days"]},e))})]}),t.jsx(ue,{variant:"outline",size:"sm",onClick:P,disabled:U,children:U?"Loading...":"Refresh"})]}),u&&t.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-1 mb-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"ATM Strike: "}),t.jsx("span",{className:"font-medium",children:u.atm_strike})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"LTP: "}),t.jsx("span",{className:"font-medium",children:u.underlying_ltp?.toFixed(2)})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-green-500"}),t.jsx("span",{className:"text-muted-foreground",children:"CE: "}),t.jsx("span",{className:"font-medium",children:u.ce_symbol}),t.jsx("span",{className:"text-green-600 dark:text-green-400 font-medium ml-1",children:V("CE","iv")})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-red-500"}),t.jsx("span",{className:"text-muted-foreground",children:"PE: "}),t.jsx("span",{className:"font-medium",children:u.pe_symbol}),t.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium ml-1",children:V("PE","iv")})]})]}),t.jsx(xe,{value:R,onValueChange:ae,children:t.jsx(ge,{className:"grid w-full max-w-md grid-cols-5",children:w.map(e=>t.jsx(be,{value:e,children:I[e].label},e))})}),t.jsx("div",{className:"mt-4",children:w.map(e=>t.jsx("div",{className:R!==e?"h-0 overflow-hidden pointer-events-none":"",children:t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:[u?.ce_symbol||"CE"," ",I[e].label]}),t.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:V("CE",e)})]}),t.jsx("div",{ref:G[`${e}-ce`],className:"relative w-full rounded-lg border border-border/50",style:{height:A}})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-sm font-medium text-red-600 dark:text-red-400",children:[u?.pe_symbol||"PE"," ",I[e].label]}),t.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:V("PE",e)})]}),t.jsx("div",{ref:G[`${e}-pe`],className:"relative w-full rounded-lg border border-border/50",style:{height:A}})]})]})},e))})]})]})})}export{$e as default};
