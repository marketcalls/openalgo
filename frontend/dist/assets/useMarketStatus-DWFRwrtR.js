import{r as e}from"./vendor-react--vsXx8_n.js";function K(){const[t,b]=e.useState(()=>typeof document<"u"?document.visibilityState==="visible":!0),[u,S]=e.useState(!1),[R,$]=e.useState(Date.now()),[l,r]=e.useState(0),[n,o]=e.useState(0),c=e.useRef(t),m=e.useRef(null),w=e.useRef(Date.now()),_=e.useRef(t);e.useEffect(()=>{_.current=t},[t]);const C=e.useCallback(()=>{const g=Date.now();_.current?(r(g-w.current),o(0)):(o(m.current?g-m.current:0),r(0))},[]);return e.useEffect(()=>{if(typeof document>"u")return;const g=()=>{const v=document.visibilityState==="visible",f=Date.now();v&&!c.current?(S(!0),w.current=f,m.current&&o(f-m.current)):v||(m.current=f,S(!1)),c.current=v,b(v),$(f),C()};document.addEventListener("visibilitychange",g);const F=()=>{c.current||g()},y=()=>{c.current&&document.visibilityState==="hidden"&&g()};window.addEventListener("focus",F),window.addEventListener("blur",y);const T=setInterval(C,1e3);return()=>{document.removeEventListener("visibilitychange",g),window.removeEventListener("focus",F),window.removeEventListener("blur",y),clearInterval(T)}},[C]),e.useEffect(()=>{if(u){const g=setTimeout(()=>S(!1),100);return()=>clearTimeout(g)}},[u]),{isVisible:t,wasHidden:u,timeSinceVisible:l,timeSinceHidden:n,lastVisibilityChange:R}}async function X(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function q({symbols:t,mode:b="LTP",enabled:u=!0,autoReconnect:S=!0,pauseWhenHidden:R=!0,pauseDelay:$=5e3}){const[l,r]=e.useState(new Map),[n,o]=e.useState(!1),[c,m]=e.useState(!1),[w,_]=e.useState(!1),[C,g]=e.useState(!1),[F,y]=e.useState(null),{isVisible:T,wasHidden:v}=K(),f=e.useRef(null),x=e.useRef(null),E=e.useRef(null),V=e.useRef(!1),M=e.useRef(new Set),I=e.useRef([]),N=e.useCallback(async()=>X(),[]),L=e.useCallback(h=>{if(!f.current||f.current.readyState!==WebSocket.OPEN||!c){I.current=h;return}const i=h.filter(a=>{const p=`${a.exchange}:${a.symbol}`;return!M.current.has(p)});i.length!==0&&(f.current.send(JSON.stringify({action:"subscribe",symbols:i,mode:b})),i.forEach(a=>{const p=`${a.exchange}:${a.symbol}`;M.current.add(p),r(k=>{const s=new Map(k);return s.has(p)||s.set(p,{symbol:a.symbol,exchange:a.exchange,data:{}}),s})}))},[c,b]),z=e.useCallback(h=>{!f.current||f.current.readyState!==WebSocket.OPEN||h.length===0||(f.current.send(JSON.stringify({action:"unsubscribe",symbols:h})),h.forEach(i=>{const a=`${i.exchange}:${i.symbol}`;M.current.delete(a)}),r(i=>{const a=new Map(i);return h.forEach(p=>{const k=`${p.exchange}:${p.symbol}`;a.delete(k)}),a}))},[]),A=e.useCallback(h=>{try{const i=JSON.parse(h.data);switch(i.type||i.status){case"auth":i.status==="success"?(m(!0),y(null),I.current.length>0&&setTimeout(()=>{L(I.current),I.current=[]},100)):y(`Authentication failed: ${i.message}`);break;case"market_data":{const p=i.symbol.toUpperCase(),k=i.exchange,s=i.data||{},j=`${k}:${p}`;r(D=>{const W=D.get(j);if(!W)return D;const J=new Map(D),d={...W.data};return Object.assign(d,{ltp:s.ltp??d.ltp,open:s.open??d.open,high:s.high??d.high,low:s.low??d.low,close:s.close??d.close,volume:s.volume??d.volume,change:s.change??d.change,change_percent:s.change_percent??d.change_percent,timestamp:s.timestamp??d.timestamp,bid_price:s.bid_price??d.bid_price,ask_price:s.ask_price??d.ask_price,bid_size:s.bid_size??d.bid_size,ask_size:s.ask_size??d.ask_size,depth:s.depth??d.depth}),J.set(j,{...W,data:d,lastUpdate:Date.now()}),J});break}case"subscribe":break;case"error":y(`WebSocket error: ${i.message}`);break}}catch{}},[L]),P=e.useCallback(async()=>{if(f.current?.readyState!==WebSocket.OPEN){_(!0),y(null);try{const h=await N(),a=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":h},credentials:"include"})).json();if(a.status!=="success")throw new Error("Failed to get WebSocket configuration");const p=a.websocket_url,k=new WebSocket(p);k.onopen=async()=>{o(!0),_(!1);try{const s=await N(),D=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":s},credentials:"include"})).json();D.status==="success"&&D.api_key?k.send(JSON.stringify({action:"authenticate",api_key:D.api_key})):y("No API key found - please generate one at /apikey")}catch(s){y(`Authentication error: ${s}`)}},k.onclose=s=>{o(!1),_(!1),m(!1),M.current.clear(),S&&!s.wasClean&&u&&(!R||document.visibilityState==="visible")&&(x.current=setTimeout(P,3e3))},k.onerror=()=>{y("WebSocket connection error"),_(!1)},k.onmessage=A,f.current=k}catch(h){y(`Connection failed: ${h}`),_(!1)}}},[N,A,S,u,R]),O=e.useCallback(()=>{x.current&&(clearTimeout(x.current),x.current=null),f.current&&(f.current.close(1e3,"User disconnect"),f.current=null),o(!1),m(!1),M.current.clear()},[]);e.useEffect(()=>(u&&t.length>0&&!n&&!w&&P(),()=>{x.current&&clearTimeout(x.current)}),[u,t.length,n,w,P]);const H=e.useRef([]);return e.useEffect(()=>{if(!c)return;const h=new Set(t.map(a=>`${a.exchange}:${a.symbol}`)),i=H.current.filter(a=>!h.has(`${a.exchange}:${a.symbol}`));i.length>0&&z(i),t.length>0&&L(t),H.current=[...t]},[c,t,L,z]),e.useEffect(()=>()=>{O()},[O]),e.useEffect(()=>{if(R)return!T&&n?(V.current=!0,E.current=setTimeout(()=>{V.current=!1,g(!0),O()},$)):T&&(E.current&&(clearTimeout(E.current),E.current=null,V.current=!1),C&&u&&t.length>0&&(V.current=!1,g(!1),P())),()=>{E.current&&(clearTimeout(E.current),E.current=null,V.current=!1)}},[T,n,C,R,$,u,t.length,P,O]),e.useEffect(()=>{v&&T&&c&&t.length>0&&(M.current.clear(),L(t))},[v,T,c,t,L]),{data:l,isConnected:n,isAuthenticated:c,isConnecting:w,isPaused:C,error:F,connect:P,disconnect:O}}async function B(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function G(){const[t,b]=e.useState({timings:[],holidays:[],isLoading:!0,error:null});e.useEffect(()=>{(async()=>{try{const n={"X-CSRFToken":await B(),"Content-Type":"application/json"},[o,c]=await Promise.all([fetch("/admin/api/timings",{headers:n,credentials:"include"}),fetch("/admin/api/holidays",{headers:n,credentials:"include"})]),m=await o.json(),w=await c.json();b({timings:m.status==="success"?m.market_status||[]:[],holidays:w.status==="success"?w.data||[]:[],isLoading:!1,error:null})}catch(r){b(n=>({...n,isLoading:!1,error:`Failed to fetch market status: ${r}`}))}})()},[]);const u=e.useCallback(l=>{const r=new Date().toISOString().split("T")[0],n=t.holidays.find(o=>o.date===r);if(!n)return!1;if(n.closed_exchanges.includes(l)){const o=n.open_exchanges.find(c=>c.exchange===l);if(o){const c=Date.now();return!(c>=o.start_time&&c<=o.end_time)}return!0}return!1},[t.holidays]),S=e.useCallback(l=>{if(u(l))return!1;const r=t.timings.find(o=>o.exchange===l);if(!r)return!1;const n=Date.now();return n>=r.start_time&&n<=r.end_time},[t.timings,u]),R=e.useCallback(()=>t.timings.some(l=>{const r=Date.now();return r>=l.start_time&&r<=l.end_time&&!u(l.exchange)}),[t.timings,u]),$=e.useCallback(l=>{if(u(l))return"closed";const r=t.timings.find(c=>c.exchange===l);if(!r)return"closed";const n=Date.now(),o=900*1e3;return n<r.start_time-o?"closed":n<r.start_time?"pre-market":n<=r.end_time?"open":"post-market"},[t.timings,u]);return{isMarketOpen:S,isAnyMarketOpen:R,isHolidayForExchange:u,getMarketStatus:$,timings:t.timings,holidays:t.holidays,isLoading:t.isLoading,error:t.error}}export{G as a,q as b,K as u};
