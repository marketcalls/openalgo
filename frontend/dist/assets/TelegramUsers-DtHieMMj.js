import{r as t,j as e}from"./vendor-react-CCyQGCED.js";import{w as y,s as r,e as b,B as u}from"./index-D0023jFM.js";import{A as E,b as H,c as $,d as z,e as Q,f as R,g as J,h as P}from"./alert-dialog-BDgJ3H--.js";import{C as x,d as h,a as q,b as G,c as K}from"./card-CDguRyHx.js";import{D as V,b as W,c as X,d as Y,e as Z,f as ee}from"./dialog-ZgnPSmJp.js";import{I as se}from"./input-D8_g_dg9.js";import{L as ae}from"./label-BgxgrBuS.js";import{T as te,a as re,b as w,c as d,d as le,e as n}from"./table-BKP8E0nV.js";import{T as ne}from"./textarea-Cdbakixx.js";import{N as ie,ax as ce,S as oe,B as de,bl as me,ag as xe,an as he}from"./vendor-icons-CCn_k3dF.js";import{L as ge}from"./vendor-router-Dzc1xxhr.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-radix-CYVJEJRR.js";function _e(){const[i,T]=t.useState([]),[j,f]=t.useState([]),[A,D]=t.useState([]),[l,L]=t.useState(""),[F,M]=t.useState(!0),[c,g]=t.useState(null),[m,p]=t.useState(""),[v,C]=t.useState(!1),[o,N]=t.useState(null),[S,U]=t.useState(!1);t.useEffect(()=>{k()},[]),t.useEffect(()=>{if(l){const s=i.filter(a=>a.telegram_username?.toLowerCase().includes(l.toLowerCase())||a.openalgo_username?.toLowerCase().includes(l.toLowerCase())||a.first_name?.toLowerCase().includes(l.toLowerCase()));f(s)}else f(i)},[l,i]);const k=async()=>{try{const s=await y.get("/telegram/api/users"),a=Array.isArray(s.data.data?.users)?s.data.data.users:[],I=Array.isArray(s.data.data?.stats)?s.data.data.stats:[];T(a),f(a),D(I)}catch{r.error("Failed to load users","telegram")}finally{M(!1)}},B=async()=>{if(!c||!m.trim()){r.error("Please enter a message","telegram");return}C(!0);try{const s=await y.post("/telegram/send-message",{telegram_id:c.telegram_id,message:m});s.data.status==="success"?(r.success("Message sent successfully","telegram"),g(null),p("")):r.error(s.data.message||"Failed to send message","telegram")}catch(s){const a=s;r.error(a.response?.data?.message||"Failed to send message","telegram")}finally{C(!1)}},O=async()=>{if(o){U(!0);try{const s=await y.post(`/telegram/user/${o.telegram_id}/unlink`);s.data.status==="success"?(r.success("User unlinked successfully","telegram"),N(null),k()):r.error(s.data.message||"Failed to unlink user","telegram")}catch(s){const a=s;r.error(a.response?.data?.message||"Failed to unlink user","telegram")}finally{U(!1)}}},_=s=>s?new Date(s).toLocaleString():"-";return F?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ge,{to:"/telegram",className:"text-muted-foreground hover:text-foreground",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ce,{className:"h-6 w-6"}),"Telegram Users"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"Manage users linked to the Telegram bot"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Users"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.filter(s=>s.notifications_enabled).length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Notifications On"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.filter(s=>s.openalgo_username).length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Linked Accounts"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:A.reduce((s,a)=>s+a.count,0)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Commands (30d)"})]})})]}),e.jsxs(x,{children:[e.jsxs(q,{children:[e.jsx(G,{children:"User List"}),e.jsxs(K,{children:[j.length," users total"]})]}),e.jsxs(h,{children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"Search by username...",value:l,onChange:s=>L(s.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(te,{children:[e.jsx(re,{children:e.jsxs(w,{children:[e.jsx(d,{children:"Telegram User"}),e.jsx(d,{children:"OpenAlgo Account"}),e.jsx(d,{children:"Notifications"}),e.jsx(d,{children:"Joined"}),e.jsx(d,{children:"Last Active"}),e.jsx(d,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(le,{children:j.length===0?e.jsx(w,{children:e.jsx(n,{colSpan:6,className:"text-center text-muted-foreground py-8",children:l?"No matching users found":"No users registered yet"})}):j.map(s=>e.jsxs(w,{children:[e.jsx(n,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.telegram_username?`@${s.telegram_username}`:s.first_name||"Unknown"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["ID: ",s.telegram_id]})]})}),e.jsx(n,{children:s.openalgo_username?e.jsx(b,{variant:"outline",children:s.openalgo_username}):e.jsx("span",{className:"text-muted-foreground",children:"Not linked"})}),e.jsx(n,{children:s.notifications_enabled?e.jsxs(b,{className:"bg-green-500 hover:bg-green-600",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"On"]}):e.jsxs(b,{variant:"secondary",children:[e.jsx(me,{className:"h-3 w-3 mr-1"}),"Off"]})}),e.jsx(n,{className:"text-sm",children:_(s.created_at)}),e.jsx(n,{className:"text-sm",children:_(s.last_active)}),e.jsx(n,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{g(s),p("")},title:"Send message",children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(u,{size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>N(s),title:"Unlink user",children:e.jsx(he,{className:"h-4 w-4"})})]})})]},s.telegram_id))})]})})]})]}),e.jsx(V,{open:!!c,onOpenChange:()=>g(null),children:e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Send Message"}),e.jsxs(Z,{children:["Send a message to"," ",c?.telegram_username?`@${c.telegram_username}`:c?.first_name]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"Message"}),e.jsx(ne,{placeholder:"Enter your message...",value:m,onChange:s=>p(s.target.value),rows:4}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[m.length,"/4096 characters"]})]})}),e.jsxs(ee,{children:[e.jsx(u,{variant:"outline",onClick:()=>g(null),children:"Cancel"}),e.jsx(u,{onClick:B,disabled:v||!m.trim(),children:v?"Sending...":"Send Message"})]})]})}),e.jsx(E,{open:!!o,onOpenChange:()=>N(null),children:e.jsxs(H,{children:[e.jsxs($,{children:[e.jsx(z,{children:"Unlink User?"}),e.jsxs(Q,{children:["Are you sure you want to unlink"," ",o?.telegram_username?`@${o.telegram_username}`:o?.first_name,"? They will need to re-register with /start to receive notifications again."]})]}),e.jsxs(R,{children:[e.jsx(J,{children:"Cancel"}),e.jsx(P,{onClick:O,disabled:S,children:S?"Unlinking...":"Unlink"})]})]})})]})}export{_e as default};
