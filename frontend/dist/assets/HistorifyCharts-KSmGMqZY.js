import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as ge,t as k,c as $,B as f,e as H}from"./index-DcrNioGU.js";import{C as g,a as p}from"./card-DOn4SGeJ.js";import{P as pe,a as je,b as ve,C as be,c as Se,d as Ne,e as ye,f as we,g as Ce}from"./popover-BF3OPH_0.js";import{I as B}from"./input-BBfzpU5n.js";import{S as De,a as Ee,b as Le,c as ke,d as Ie}from"./select-B1tfEtlE.js";import{q as Me,K as Fe,W as Re,R as ze,V as Te}from"./lightweight-charts.production-BQUuleWj.js";import{A as Pe,D as W,S as Ve,ai as Oe,R as $e,aF as He,aG as Be,k as We,l as _e}from"./vendor-icons-Ca5eNZvr.js";import{c as qe,d as Ue,L as _}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-CXZqcLdW.js";import"./vendor-radix-gKv__6YA.js";function as(){const{mode:q,toggleMode:U}=ge(),i=q==="dark",{symbol:A}=qe(),[I,M]=Ue(),[x,G]=t.useState([]),[h,K]=t.useState(null),[F,R]=t.useState(!1),[S,N]=t.useState(!1),[l,J]=t.useState(A||""),[o,Q]=t.useState(I.get("exchange")||"NSE"),[d,X]=t.useState(I.get("interval")||"D"),[Y,z]=t.useState(!1),[j,T]=t.useState(""),[y,Z]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[w,ee]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,se]=t.useState([]),[v,te]=t.useState(null),u=t.useRef(null),m=t.useRef(null),ae=t.useRef(null),re=t.useRef(null),ne=t.useMemo(()=>h?[...h.seconds,...h.minutes,...h.hours,...h.days,...h.weeks,...h.months]:["D"],[h]),C=t.useMemo(()=>{const s=new Map;return x.forEach(a=>{const n=`${a.symbol}:${a.exchange}`;s.has(n)?s.get(n).intervals.push(a.interval):s.set(n,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[x]),le=t.useMemo(()=>{if(!j)return C;const s=j.toLowerCase();return C.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[C,j]);t.useEffect(()=>{oe(),ce()},[]),t.useEffect(()=>{l&&o&&d&&M({exchange:o,interval:d})},[l,o,d,M]),t.useEffect(()=>{l&&o&&d&&(P(),ie())},[l,o,d]),t.useEffect(()=>{if(!u.current)return;const s=setTimeout(()=>{if(!u.current)return;m.current&&(m.current.remove(),m.current=null);const n=u.current,he=n.offsetWidth||800,ue=n.offsetHeight||600,b=Me(n,{width:he,height:Math.max(ue,500),layout:{background:{type:Re.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:E=>{const L=new Date(E*1e3),c=5.5*60*60*1e3,O=new Date(L.getTime()+c),xe=O.getUTCHours().toString().padStart(2,"0"),fe=O.getUTCMinutes().toString().padStart(2,"0");return`${xe}:${fe}`}},crosshair:{mode:Fe.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),V=b.addSeries(ze,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),D=b.addSeries(Te,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(D.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),m.current=b,ae.current=V,re.current=D,r.length>0){const E=r.map(c=>({time:c.timestamp,open:c.open,high:c.high,low:c.low,close:c.close}));V.setData(E);const L=r.map(c=>({time:c.timestamp,value:c.volume,color:c.close>=c.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));D.setData(L),b.timeScale().fitContent()}},100),a=()=>{if(m.current&&u.current){const n=u.current;m.current.applyOptions({width:n.offsetWidth,height:n.offsetHeight})}};return window.addEventListener("resize",a),()=>{clearTimeout(s),window.removeEventListener("resize",a),m.current&&(m.current.remove(),m.current=null)}},[i,r,S]);const oe=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&G(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},ce=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&K(a.data)}catch(s){console.error("Error loading intervals:",s)}},P=t.useCallback(async()=>{if(!(!l||!o)){R(!0);try{const s=new URLSearchParams({symbol:l,exchange:o,interval:d,start_date:y,end_date:w}),n=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();n.status==="success"?(se(n.data||[]),n.count===0&&k.info("No data available for this range")):k.error(n.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),k.error("Failed to load chart data")}finally{R(!1)}}},[l,o,d,y,w]),ie=t.useCallback(()=>{const s=x.find(a=>a.symbol===l&&a.exchange===o&&a.interval===d);te(s||null)},[x,l,o,d]),de=(s,a)=>{J(s),Q(a),z(!1),T("")},me=()=>{document.fullscreenElement?(document.exitFullscreen(),N(!1)):(document.documentElement.requestFullscreen(),N(!0))};return t.useEffect(()=>{const s=()=>{N(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:$("h-full flex flex-col bg-background text-foreground",S&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(_,{to:"/historify",children:e.jsx(Pe,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(W,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(pe,{open:Y,onOpenChange:z,children:[e.jsx(je,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[l?e.jsxs("span",{children:[l,":",o]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(Ve,{className:"h-4 w-4 ml-2"})]})}),e.jsx(ve,{className:"w-64 p-0",align:"start",children:e.jsxs(be,{children:[e.jsx(Se,{placeholder:"Search symbols...",value:j,onValueChange:T}),e.jsxs(Ne,{children:[e.jsx(ye,{children:"No symbols found"}),e.jsx(we,{children:le.slice(0,20).map(s=>e.jsxs(Ce,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>de(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(H,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(De,{value:d,onValueChange:X,children:[e.jsx(Ee,{className:"w-24",children:e.jsx(Le,{})}),e.jsx(ke,{children:ne.map(s=>e.jsx(Ie,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(B,{type:"date",value:y,onChange:s=>Z(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(B,{type:"date",value:w,onChange:s=>ee(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:P,disabled:F,children:e.jsx($e,{className:$("h-4 w-4",F&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:me,children:S?e.jsx(He,{className:"h-4 w-4"}):e.jsx(Be,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:U,children:i?e.jsx(We,{className:"h-4 w-4"}):e.jsx(_e,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:l?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[l,":",o]}),e.jsx(H,{variant:"outline",children:d}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),v&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",v.first_date," - ",v.last_date]}),e.jsxs("span",{children:[v.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden",children:e.jsx("div",{ref:u,className:"w-full h-full"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(W,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),x.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(_,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{as as default};
