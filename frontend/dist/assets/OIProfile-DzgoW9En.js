import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{u as me,s as M,B as R,e as v}from"./index-D0023jFM.js";import{o as E}from"./oi-profile-Bf0_8E67.js";import{C as he,d as fe}from"./card-CDguRyHx.js";import{P as ue,a as ge,b as ye,C as ve,c as be,d as Se,e as je,f as Ce,g as Ie}from"./popover-BKWWulwW.js";import{S as F,a as _,b as z,c as T,d as B}from"./select-DXT-lI-N.js";import{P as Ne}from"./react-plotly-DV3gd5yC.js";import{aV as Ee,m as we}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const Oe=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],V={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},Pe={"1m":1,"5m":5,"15m":7};function Y(h){if(!h)return"";const d=h.split("-");return d.length===3?`${d[0]}${d[1].toUpperCase()}${d[2].slice(-2)}`:h.replace(/-/g,"").toUpperCase()}function ke(h){const d=h.timestamp??h.time;if(!d)return"";if(typeof d=="number"){const i=d>1e12?d:d*1e3,l=new Date(i),b=String(l.getDate()).padStart(2,"0"),S=l.toLocaleString("en",{month:"short"}),u=String(l.getHours()).padStart(2,"0"),C=String(l.getMinutes()).padStart(2,"0");return`${b}-${S} ${u}:${C}`}const f=String(d);try{const i=new Date(f);if(!Number.isNaN(i.getTime())){const l=String(i.getDate()).padStart(2,"0"),b=i.toLocaleString("en",{month:"short"}),S=String(i.getHours()).padStart(2,"0"),u=String(i.getMinutes()).padStart(2,"0");return`${l}-${b} ${S}:${u}`}}catch{}return f}function Re(){const{mode:h,appMode:d}=me(),f=d==="analyzer",i=h==="dark"||f,[l,b]=n.useState("NFO"),[S,u]=n.useState(V.NFO),[C,D]=n.useState(!1),[x,w]=n.useState("NIFTY"),[L,j]=n.useState([]),[m,g]=n.useState(""),[H,G]=n.useState(["5m"]),[y,$]=n.useState("5m"),[o,O]=n.useState(null),[P,A]=n.useState(!1),I=n.useRef(0);n.useEffect(()=>{(async()=>{try{const r=await E.getIntervals();r.status==="success"&&r.data?.intervals.length&&(G(r.data.intervals),r.data.intervals.includes(y)||$(r.data.intervals[0]))}catch{}})()},[]),n.useEffect(()=>{const t=V[l]||[];u(t),w(t[0]||""),j([]),g(""),O(null);let r=!1;return(async()=>{try{const p=await E.getUnderlyings(l);if(r)return;p.status==="success"&&p.underlyings.length>0&&(u(p.underlyings),p.underlyings.includes(t[0])||w(p.underlyings[0]))}catch{}})(),()=>{r=!0}},[l]),n.useEffect(()=>{if(!x)return;j([]),g(""),O(null);let t=!1;return(async()=>{try{const c=await E.getExpiries(l,x);if(t)return;c.status==="success"&&c.expiries.length>0?(j(c.expiries),g(c.expiries[0])):(j([]),g(""))}catch{if(t)return;j([]),g("")}})(),()=>{t=!0}},[x]);const U=n.useCallback(async()=>{if(!m)return;const t=++I.current;A(!0);try{const r=Y(m),c=Pe[y]||5,p=await E.getProfileData({underlying:x,exchange:l,expiry_date:r,interval:y,days:c});if(I.current!==t)return;p.status==="success"?O(p):M.error(p.message||"Failed to fetch OI Profile data")}catch{if(I.current!==t)return;M.error("Failed to fetch OI Profile data")}finally{I.current===t&&A(!1)}},[x,m,l,y]);n.useEffect(()=>{m&&U()},[m,y]);const s=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:i?"#e0e0e0":"#333333",grid:i?f?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceOI:"#22c55e",peOI:"#ef4444",ceChange:"#86efac",peChange:"#fca5a5",atmLine:"#eab308",hoverBg:i?f?"#2d2545":"#1e293b":"#ffffff",hoverFont:i?"#e0e0e0":"#333333",hoverBorder:i?f?"#7c3aed":"#475569":"#e2e8f0",increasing:"#22c55e",decreasing:"#ef4444"}),[i,f]),X=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),k=n.useMemo(()=>{if(!o?.oi_chain||!o.candles?.length)return{data:[],layout:{}};const t=o.candles,r=o.oi_chain,c=o.atm_strike,p=t.map(ke),q=t.map(a=>a.open),K=t.map(a=>a.high),J=t.map(a=>a.low),Q=t.map(a=>a.close),N=r.map(a=>a.strike),W=r.map(a=>a.ce_oi),Z=r.map(a=>-a.pe_oi),ee=r.map(a=>a.ce_oi_change),te=r.map(a=>-a.pe_oi_change),se=r.map(a=>a.pe_oi),ae=r.map(a=>a.pe_oi_change),re=p.length,ne=Math.max(1,Math.floor(re/10)),oe=p.filter((a,xe)=>xe%ne===0),ie=[{x:p,open:q,high:K,low:J,close:Q,type:"candlestick",name:o.futures_symbol||"Futures",xaxis:"x",yaxis:"y",increasing:{line:{color:s.increasing}},decreasing:{line:{color:s.decreasing}},showlegend:!1},{y:N,x:W,type:"bar",orientation:"h",name:"CE OI",marker:{color:s.ceOI},xaxis:"x2",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>OI: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:Z,type:"bar",orientation:"h",name:"PE OI",marker:{color:s.peOI},xaxis:"x2",yaxis:"y",customdata:se,hovertemplate:"<b>%{y} PE</b><br>OI: %{customdata:,.0f}<extra></extra>",showlegend:!1},{y:N,x:ee,type:"bar",orientation:"h",name:"CE Change",marker:{color:s.ceChange},xaxis:"x3",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>Change: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:te,type:"bar",orientation:"h",name:"PE Change",marker:{color:s.peChange},xaxis:"x3",yaxis:"y",customdata:ae,hovertemplate:"<b>%{y} PE</b><br>Change: %{customdata:,.0f}<extra></extra>",showlegend:!1}],le=Y(m),ce=c?[{type:"line",x0:0,x1:1,xref:"paper",y0:c,y1:c,line:{color:s.atmLine,width:2,dash:"dash"}}]:[],de=c?[{x:0,xref:"paper",y:c,text:`ATM ${c}`,showarrow:!1,font:{color:s.atmLine,size:11},xanchor:"left",yanchor:"bottom"}]:[],pe={title:{text:`${x} ${le} - Futures with OI Profile`,font:{color:s.text,size:14}},paper_bgcolor:s.paper,plot_bgcolor:s.bg,font:{color:s.text,family:"system-ui, sans-serif"},barmode:"overlay",bargap:.1,showlegend:!1,margin:{l:60,r:30,t:50,b:60},hoverlabel:{bgcolor:s.hoverBg,font:{color:s.hoverFont,size:12},bordercolor:s.hoverBorder},xaxis:{domain:[0,.48],type:"category",tickmode:"array",tickvals:oe,tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"Time",font:{color:s.text,size:11}},rangeslider:{visible:!1}},xaxis2:{domain:[.5,.74],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE OI",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},xaxis3:{domain:[.76,1],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE Change (D)",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},yaxis:{title:{text:"Price / Strike",font:{color:s.text,size:11}},tickfont:{color:s.text,size:10},gridcolor:s.grid,showgrid:!0},shapes:ce,annotations:de};return{data:ie,layout:pe}},[o,s,m,x]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"OI Profile"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(F,{value:l,onValueChange:b,children:[e.jsx(_,{className:"w-[100px]",children:e.jsx(z,{placeholder:"Exchange"})}),e.jsx(T,{children:Oe.map(t=>e.jsx(B,{value:t.value,children:t.label},t.value))})]}),e.jsxs(ue,{open:C,onOpenChange:D,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(R,{variant:"outline",role:"combobox","aria-expanded":C,className:"w-[160px] justify-between",children:[x||"Underlying",e.jsx(Ee,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ye,{className:"w-48 p-0",align:"start",children:e.jsxs(ve,{children:[e.jsx(be,{placeholder:"Search underlying..."}),e.jsxs(Se,{children:[e.jsx(je,{children:"No underlying found"}),e.jsx(Ce,{children:S.map(t=>e.jsxs(Ie,{value:t,onSelect:()=>{w(t),D(!1)},children:[e.jsx(we,{className:`mr-2 h-4 w-4 ${x===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(F,{value:m,onValueChange:g,disabled:L.length===0,children:[e.jsx(_,{className:"w-[160px]",children:e.jsx(z,{placeholder:"Expiry"})}),e.jsx(T,{children:L.map(t=>e.jsx(B,{value:t,children:t},t))})]}),e.jsxs(F,{value:y,onValueChange:$,children:[e.jsx(_,{className:"w-[100px]",children:e.jsx(z,{placeholder:"Interval"})}),e.jsx(T,{children:H.map(t=>e.jsx(B,{value:t,children:t},t))})]}),e.jsx(R,{variant:"outline",size:"sm",onClick:U,disabled:P,children:P?"Loading...":"Refresh"})]})]}),o&&o.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",o.spot_price?.toFixed(1)]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",o.atm_strike]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",o.lot_size]}),o.futures_symbol&&e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",o.futures_symbol]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Interval: ",o.interval]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Candles: ",o.candles?.length||0]})]}),e.jsx(he,{children:e.jsx(fe,{className:"p-2 sm:p-4",children:P&&!o?e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:"Loading OI Profile data..."}):k.data.length>0?e.jsx(Ne,{data:k.data,layout:k.layout,config:X,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:m?"No data available":"Select an underlying and expiry to view OI Profile"})})})]})}export{Re as default};
