import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as ue,t as E,c as V,B as f,e as O}from"./index-B1W8MyTx.js";import{C as g,a as p}from"./card-CC05vWSG.js";import{P as xe,a as fe,b as ge,C as pe,c as je,d as ve,e as be,f as Se,g as Ne}from"./popover-Cz3hy3IP.js";import{I as T}from"./input-CHQpsPEq.js";import{S as ye,a as we,b as Ce,c as De,d as Ee}from"./select-CASQdwVl.js";import{q as Le,K as Ie,W as ke,R as Me,V as Re}from"./lightweight-charts.production-BQUuleWj.js";import{A as Fe,D as $,S as ze,ai as Pe,R as Ve,aF as Oe,aG as Te,k as $e,l as He}from"./vendor-icons-Ca5eNZvr.js";import{c as We,d as _e,L as H}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-D6hV6JR3.js";import"./vendor-radix-gKv__6YA.js";function es(){const{mode:W,toggleMode:_}=ue(),h=W==="dark",{symbol:q}=We(),[L,I]=_e(),[x,A]=t.useState([]),[m,B]=t.useState(null),[k,M]=t.useState(!1),[S,N]=t.useState(!1),[l,G]=t.useState(q||""),[o,U]=t.useState(L.get("exchange")||"NSE"),[c,K]=t.useState(L.get("interval")||"D"),[J,R]=t.useState(!1),[j,F]=t.useState(""),[y,Q]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[w,X]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,Y]=t.useState([]),[v,Z]=t.useState(null),u=t.useRef(null),d=t.useRef(null),ee=t.useRef(null),se=t.useRef(null),te=t.useMemo(()=>m?[...m.seconds,...m.minutes,...m.hours,...m.days,...m.weeks,...m.months]:["D"],[m]),C=t.useMemo(()=>{const s=new Map;return x.forEach(a=>{const n=`${a.symbol}:${a.exchange}`;s.has(n)?s.get(n).intervals.push(a.interval):s.set(n,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[x]),ae=t.useMemo(()=>{if(!j)return C;const s=j.toLowerCase();return C.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[C,j]);t.useEffect(()=>{re(),ne()},[]),t.useEffect(()=>{l&&o&&c&&I({exchange:o,interval:c})},[l,o,c,I]),t.useEffect(()=>{l&&o&&c&&(z(),le())},[l,o,c]),t.useEffect(()=>{if(!u.current)return;const s=setTimeout(()=>{if(!u.current)return;d.current&&(d.current.remove(),d.current=null);const n=u.current,ie=n.offsetWidth||800,de=n.offsetHeight||600,b=Le(n,{width:ie,height:Math.max(de,500),layout:{background:{type:ke.Solid,color:"transparent"},textColor:h?"#a6adbb":"#333"},grid:{vertLines:{color:h?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:h?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},rightPriceScale:{borderColor:h?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:h?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:!0,secondsVisible:!1},crosshair:{mode:Ie.Normal}}),P=b.addSeries(Me,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),D=b.addSeries(Re,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(D.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),d.current=b,ee.current=P,se.current=D,r.length>0){const me=r.map(i=>({time:i.timestamp,open:i.open,high:i.high,low:i.low,close:i.close}));P.setData(me);const he=r.map(i=>({time:i.timestamp,value:i.volume,color:i.close>=i.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));D.setData(he),b.timeScale().fitContent()}},100),a=()=>{if(d.current&&u.current){const n=u.current;d.current.applyOptions({width:n.offsetWidth,height:n.offsetHeight})}};return window.addEventListener("resize",a),()=>{clearTimeout(s),window.removeEventListener("resize",a),d.current&&(d.current.remove(),d.current=null)}},[h,r,S]);const re=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&A(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},ne=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&B(a.data)}catch(s){console.error("Error loading intervals:",s)}},z=t.useCallback(async()=>{if(!(!l||!o)){M(!0);try{const s=new URLSearchParams({symbol:l,exchange:o,interval:c,start_date:y,end_date:w}),n=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();n.status==="success"?(Y(n.data||[]),n.count===0&&E.info("No data available for this range")):E.error(n.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),E.error("Failed to load chart data")}finally{M(!1)}}},[l,o,c,y,w]),le=t.useCallback(()=>{const s=x.find(a=>a.symbol===l&&a.exchange===o&&a.interval===c);Z(s||null)},[x,l,o,c]),oe=(s,a)=>{G(s),U(a),R(!1),F("")},ce=()=>{document.fullscreenElement?(document.exitFullscreen(),N(!1)):(document.documentElement.requestFullscreen(),N(!0))};return t.useEffect(()=>{const s=()=>{N(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:V("h-full flex flex-col bg-background text-foreground",S&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(H,{to:"/historify",children:e.jsx(Fe,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(xe,{open:J,onOpenChange:R,children:[e.jsx(fe,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[l?e.jsxs("span",{children:[l,":",o]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(ze,{className:"h-4 w-4 ml-2"})]})}),e.jsx(ge,{className:"w-64 p-0",align:"start",children:e.jsxs(pe,{children:[e.jsx(je,{placeholder:"Search symbols...",value:j,onValueChange:F}),e.jsxs(ve,{children:[e.jsx(be,{children:"No symbols found"}),e.jsx(Se,{children:ae.slice(0,20).map(s=>e.jsxs(Ne,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>oe(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(O,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(ye,{value:c,onValueChange:K,children:[e.jsx(we,{className:"w-24",children:e.jsx(Ce,{})}),e.jsx(De,{children:te.map(s=>e.jsx(Ee,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(T,{type:"date",value:y,onChange:s=>Q(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(T,{type:"date",value:w,onChange:s=>X(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:z,disabled:k,children:e.jsx(Ve,{className:V("h-4 w-4",k&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:ce,children:S?e.jsx(Oe,{className:"h-4 w-4"}):e.jsx(Te,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:_,children:h?e.jsx($e,{className:"h-4 w-4"}):e.jsx(He,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:l?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[l,":",o]}),e.jsx(O,{variant:"outline",children:c}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),v&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",v.first_date," - ",v.last_date]}),e.jsxs("span",{children:[v.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden",children:e.jsx("div",{ref:u,className:"w-full h-full"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(g,{children:e.jsxs(p,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx($,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),x.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(H,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{es as default};
