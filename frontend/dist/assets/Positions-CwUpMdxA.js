import{r as l,j as e,a as Te}from"./vendor-react-RhKMXzW9.js";import{d as Me,o as Oe,l as Ae,e as v,B as j,c as p,t as P,s as C}from"./index-B2ztJKGu.js";import{t as V}from"./trading-Cm3Zs4gI.js";import{A as Le,a as Fe,b as Re,c as qe,d as _e,e as Ie,f as Ge,g as $e,h as Be}from"./alert-dialog-DZkNTHSV.js";import{C as D,b as F,d as R,c as q,a as Ue}from"./card-Cb9BEsKk.js";import{D as ze,a as He,b as We,c as Ve,d as Xe,e as Je,f as Qe}from"./dialog-BK7UbIdW.js";import{L as _}from"./label-g5mTb1MO.js";import{T as Ye,a as Ze,b as I,c as E,d as Ke,e as i,f as et}from"./table-BrB7PLSU.js";import{u as tt,a as st}from"./useMarketStatus-B27EKIuh.js";import{V as nt,W as rt,R as at,p as lt,X as de,L as ct,x as it,Y as ot,c as dt,_ as xt,$ as ut}from"./vendor-icons-D08EYFn4.js";import"./vendor-router-DdyOoyPF.js";import"./vendor-radix-Cue1hf3Z.js";const xe="openalgo_positions_prefs";function T(d){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(d)}function pt(d,u){if(u==="NSE"||u==="BSE")return{underlying:d,expiry:null,strike:null,optionType:null};const y=d.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})FUT$/i);if(y)return{underlying:y[1],expiry:y[2],strike:null,optionType:"FUT"};const b=d.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})(\d+\.?\d*)(CE|PE)$/i);return b?{underlying:b[1],expiry:b[2],strike:b[3],optionType:b[4]}:{underlying:d,expiry:null,strike:null,optionType:null}}function ue(d){const u=d.average_price||0,y=d.quantity||0,b=d.pnl||0;if(u===0||y===0)return 0;const S=Math.abs(u*y);return S>0?b/S*100:0}const ht={NSE:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",BSE:"bg-slate-500/20 text-slate-600 border-slate-500/30",NFO:"bg-purple-500/20 text-purple-600 border-purple-500/30",BFO:"bg-amber-500/20 text-amber-600 border-amber-500/30",MCX:"bg-blue-500/20 text-blue-600 border-blue-500/30",CDS:"bg-teal-500/20 text-teal-600 border-teal-500/30"},mt={CNC:"bg-purple-500/20 text-purple-600 border-purple-500/30",MIS:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",NRML:"bg-slate-500/20 text-slate-600 border-slate-500/30"};function Dt(){const{apiKey:d}=Me(),[u,y]=l.useState([]),[b,S]=l.useState(!0),[X,J]=l.useState(!1),[Q,G]=l.useState(null),[x,$]=l.useState("none"),[c,B]=l.useState({product:[],direction:[],exchange:[]}),[pe,U]=l.useState(new Set),[M,he]=l.useState(null),[O,Y]=l.useState("asc"),[me,Z]=l.useState(!1),{isMarketOpen:K,isAnyMarketOpen:ge}=tt(),ee=ge(),fe=l.useMemo(()=>u.map(t=>({symbol:t.symbol,exchange:t.exchange})),[u]),{data:te,isConnected:je}=st({symbols:fe,mode:"LTP",enabled:u.length>0&&ee}),z=je&&ee,se=l.useMemo(()=>u.map(t=>{const s=`${t.exchange}:${t.symbol}`,n=te.get(s),r=t.quantity||0,a=t.average_price||0,o=K(t.exchange)&&n?.data?.ltp&&n.lastUpdate&&Date.now()-n.lastUpdate<5e3;if(r===0){const L=o?n.data.ltp:t.ltp;return{...t,ltp:L??t.ltp}}if(o&&n?.data?.ltp){const L=n.data.ltp,ie=(L-a)*r,oe=Math.abs(a*r),Ee=oe>0?ie/oe*100:0;return{...t,ltp:L,pnl:ie,pnlpercent:Ee}}const Pe=t.pnl||0,ce=Math.abs(a*r),De=t.pnlpercent??(ce>0?Pe/ce*100:0);return{...t,pnlpercent:De}}),[u,te,K]);l.useEffect(()=>{try{const t=localStorage.getItem(xe);if(t){const s=JSON.parse(t);s.grouping&&$(s.grouping),s.filters&&B({product:s.filters.product||[],direction:s.filters.direction||[],exchange:s.filters.exchange||[]})}}catch(t){console.error("Error loading preferences:",t)}},[]);const ne=l.useCallback(()=>{localStorage.setItem(xe,JSON.stringify({grouping:x,filters:c}))},[x,c]);l.useEffect(()=>{ne()},[ne]);const h=l.useCallback(async(t=!1)=>{if(!d){S(!1);return}t&&J(!0);try{const s=await V.getPositions(d);s.status==="success"&&s.data?(y(s.data),G(null)):G(s.message||"Failed to fetch positions")}catch{G("Failed to fetch positions")}finally{S(!1),J(!1)}},[d]);l.useEffect(()=>{h();const s=setInterval(()=>h(),z?3e4:1e4);return()=>clearInterval(s)},[h,z]),l.useEffect(()=>{const t=Oe(()=>{h()});return()=>t()},[h]);const re=l.useRef(null);l.useEffect(()=>{const t=window.location.protocol,s=window.location.hostname,n=window.location.port;re.current=Ae(`${t}//${s}:${n}`,{transports:["websocket","polling"]});const r=re.current;return r.on("order_event",()=>{setTimeout(()=>h(),500)}),r.on("analyzer_update",()=>{setTimeout(()=>h(),500)}),r.on("close_position_event",()=>{setTimeout(()=>h(),500)}),()=>{r.disconnect()}},[h]);const ae=l.useCallback(t=>{const s=t.exchange,n=t.product;if(s==="NSE"||s==="BSE"){if(n==="CNC")return"Equity (Delivery)";if(n==="MIS")return"Equity (Intraday)"}const r=pt(t.symbol,s);return x==="underlying"?r.underlying:x==="underlying_expiry"&&r.expiry?`${r.underlying} - ${r.expiry}`:r.underlying},[x]),f=l.useMemo(()=>se.filter(t=>{if(c.product.length>0&&!c.product.includes(t.product))return!1;const s=t.quantity||0;if(c.direction.length>0){const n=s>0,r=s<0;if(c.direction.includes("LONG")&&!c.direction.includes("SHORT")&&!n||c.direction.includes("SHORT")&&!c.direction.includes("LONG")&&!r)return!1}return!(c.exchange.length>0&&!c.exchange.includes(t.exchange))}),[se,c]),H=l.useMemo(()=>M===null?f:[...f].sort((t,s)=>{let n,r;switch(M){case 0:n=t.symbol,r=s.symbol;break;case 3:n=t.quantity||0,r=s.quantity||0;break;case 4:n=t.average_price||0,r=s.average_price||0;break;case 6:n=t.pnl||0,r=s.pnl||0;break;case 7:n=ue(t),r=ue(s);break;default:return 0}return typeof n=="string"?O==="asc"?n.localeCompare(r):r.localeCompare(n):O==="asc"?n-r:r-n}),[f,M,O]),le=l.useMemo(()=>{if(x==="none")return{_all:H};const t={};return H.forEach(s=>{const n=ae(s);t[n]||(t[n]=[]),t[n].push(s)}),t},[H,x,ae]),N=l.useMemo(()=>{const t=f.length,s=f.filter(a=>(a.quantity||0)>0).length,n=f.filter(a=>(a.quantity||0)<0).length,r=f.reduce((a,m)=>a+(m.pnl||0),0);return{total:t,long:s,short:n,totalPnl:r}},[f]),be=t=>{M===t?Y(O==="asc"?"desc":"asc"):(he(t),Y("asc"))},ye=(t,s)=>{B(n=>{const r=n[t];return r.indexOf(s)>-1?{...n,[t]:r.filter(m=>m!==s)}:{...n,[t]:[...r,s]}})},W=()=>{B({product:[],direction:[],exchange:[]}),$("none"),U(new Set)},Ne=t=>{U(s=>{const n=new Set(s);return n.has(t)?n.delete(t):n.add(t),n})},A=c.product.length>0||c.direction.length>0||c.exchange.length>0||x!=="none",ve=async t=>{try{const s=await V.closePosition(t.symbol,t.exchange,t.product);s.status==="success"?h(!0):P.error(s.message||"Failed to close position")}catch(s){console.error("Close position error:",s),P.error("Failed to close position")}},Ce=async()=>{try{const t=await V.closeAllPositions();t.status==="success"?(P.success("All positions closed"),h(!0)):P.error(t.message||"Failed to close all positions")}catch(t){console.error("Close all positions error:",t),P.error("Failed to close all positions")}},we=()=>{const t=["Symbol","Exchange","Product","Quantity","Avg Price","LTP","P&L","P&L %"],s=f.map(o=>[C(o.symbol),C(o.exchange),C(o.product),C(o.quantity),C(o.average_price),C(o.ltp),C(o.pnl),C(o.pnlpercent)]),n=[t,...s].map(o=>o.join(",")).join(`
`),r=new Blob([n],{type:"text/csv"}),a=URL.createObjectURL(r),m=document.createElement("a");m.href=a,m.download=`positions_${new Date().toISOString().split("T")[0]}.csv`,m.click()},w=t=>t>=0,g=({type:t,value:s,label:n})=>e.jsx(j,{variant:c[t].includes(s)?"default":"outline",size:"sm",className:p("rounded-full",c[t].includes(s)&&"bg-pink-500 hover:bg-pink-600"),onClick:()=>ye(t,s),children:n}),k=({column:t,label:s,className:n})=>e.jsx(E,{className:p("cursor-pointer hover:bg-muted/50 select-none",n),onClick:()=>be(t),children:e.jsxs("div",{className:p("flex items-center gap-1 w-full",n?.includes("text-right")&&"justify-end"),children:[s,e.jsx(ut,{className:"h-3 w-3 opacity-50"})]})}),Se=t=>{let s=0,n=0;t.forEach(a=>{s+=a.pnl||0;const m=a.average_price||0,o=Math.abs(a.quantity||0);n+=m*o});const r=n>0?s/n*100:0;return{totalPnl:s,pnlPercent:r,count:t.length}},ke=Object.keys(le).sort((t,s)=>t.startsWith("Equity")&&!s.startsWith("Equity")?-1:!t.startsWith("Equity")&&s.startsWith("Equity")?1:t.localeCompare(s));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Positions"}),z&&e.jsxs(v,{variant:"outline",className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/30 gap-1",children:[e.jsx(nt,{className:"h-3 w-3 animate-pulse"}),"Live"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor and manage your active trading positions"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(ze,{open:me,onOpenChange:Z,children:[e.jsx(He,{asChild:!0,children:e.jsxs(j,{variant:A?"default":"outline",size:"sm",className:"relative",children:[e.jsx(rt,{className:"h-4 w-4 mr-2"}),"Settings",A&&e.jsx("span",{className:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"})]})}),e.jsxs(We,{className:"max-w-md",children:[e.jsxs(Ve,{children:[e.jsx(Xe,{children:"Position Settings"}),e.jsx(Je,{children:"Configure grouping and filters"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Grouping"}),e.jsx("div",{className:"space-y-2",children:[{value:"none",label:"None"},{value:"underlying",label:"Underlying"},{value:"underlying_expiry",label:"Underlying & Expiry"}].map(t=>e.jsxs("label",{className:p("flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-muted",x===t.value&&"bg-pink-500/10 border border-pink-500/30"),children:[e.jsx("input",{type:"radio",name:"grouping",checked:x===t.value,onChange:()=>{$(t.value),U(new Set)},className:"accent-pink-500"}),e.jsx("span",{className:p(x===t.value&&"text-pink-500 font-semibold"),children:t.label})]},t.value))})]}),e.jsx("div",{className:"border-t"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Product Type"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(g,{type:"product",value:"CNC",label:"CNC"}),e.jsx(g,{type:"product",value:"MIS",label:"MIS"}),e.jsx(g,{type:"product",value:"NRML",label:"NRML"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Direction"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(g,{type:"direction",value:"LONG",label:"Long"}),e.jsx(g,{type:"direction",value:"SHORT",label:"Short"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Exchange"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(g,{type:"exchange",value:"NSE",label:"NSE"}),e.jsx(g,{type:"exchange",value:"BSE",label:"BSE"}),e.jsx(g,{type:"exchange",value:"NFO",label:"NFO"}),e.jsx(g,{type:"exchange",value:"BFO",label:"BFO"}),e.jsx(g,{type:"exchange",value:"MCX",label:"MCX"}),e.jsx(g,{type:"exchange",value:"CDS",label:"CDS"})]})]})]}),e.jsxs(Qe,{children:[e.jsx(j,{variant:"ghost",onClick:W,children:"Clear All"}),e.jsx(j,{onClick:()=>Z(!1),children:"Done"})]})]})]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>h(!0),disabled:X,children:[e.jsx(at,{className:p("h-4 w-4 mr-2",X&&"animate-spin")}),"Refresh"]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:we,children:[e.jsx(lt,{className:"h-4 w-4 mr-2"}),"Export"]}),e.jsxs(Le,{children:[e.jsx(Fe,{asChild:!0,children:e.jsxs(j,{variant:"destructive",size:"sm",disabled:u.length===0,children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Close All"]})}),e.jsxs(Re,{children:[e.jsxs(qe,{children:[e.jsx(_e,{children:"Close All Positions?"}),e.jsxs(Ie,{children:["This will close all ",u.length," open positions at market price. This action cannot be undone."]})]}),e.jsxs(Ge,{children:[e.jsx($e,{children:"Cancel"}),e.jsx(Be,{onClick:Ce,children:"Close All"})]})]})]})]})]}),A&&e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Active Filters:"}),x!=="none"&&e.jsxs(v,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:["Grouped: ",x==="underlying"?"Underlying":"Underlying & Expiry"]}),c.product.map(t=>e.jsx(v,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:t},t)),c.direction.map(t=>e.jsx(v,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:t},t)),c.exchange.map(t=>e.jsx(v,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:t},t)),e.jsx(j,{variant:"outline",size:"sm",className:"text-red-500 border-red-500/50 hover:bg-red-500/10",onClick:W,children:"Clear All"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(D,{children:e.jsxs(F,{className:"pb-2",children:[e.jsx(R,{children:"Open Positions"}),e.jsx(q,{className:"text-2xl",children:N.total})]})}),e.jsx(D,{children:e.jsxs(F,{className:"pb-2",children:[e.jsx(R,{children:"Long"}),e.jsx(q,{className:"text-2xl text-green-600",children:N.long})]})}),e.jsx(D,{children:e.jsxs(F,{className:"pb-2",children:[e.jsx(R,{children:"Short"}),e.jsx(q,{className:"text-2xl text-red-600",children:N.short})]})}),e.jsx(D,{children:e.jsxs(F,{className:"pb-2",children:[e.jsx(R,{children:"Total P&L"}),e.jsx(q,{className:p("text-2xl",w(N.totalPnl)?"text-green-600":"text-red-600"),children:T(N.totalPnl)})]})})]}),e.jsx(D,{children:e.jsx(Ue,{className:"p-0",children:b?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ct,{className:"h-8 w-8 animate-spin"})}):Q?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:Q}):f.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx("p",{className:"mb-4",children:"No positions match your filters"}),A&&e.jsx(j,{variant:"ghost",size:"sm",onClick:W,children:"Clear Filters"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ye,{children:[e.jsx(Ze,{children:e.jsxs(I,{children:[e.jsx(k,{column:0,label:"Symbol",className:"w-[140px]"}),e.jsx(E,{className:"w-[80px]",children:"Exchange"}),e.jsx(E,{className:"w-[80px]",children:"Product"}),e.jsx(k,{column:3,label:"Qty",className:"w-[80px] text-right"}),e.jsx(k,{column:4,label:"Avg Price",className:"w-[120px] text-right"}),e.jsx(E,{className:"w-[120px] text-right",children:"LTP"}),e.jsx(k,{column:6,label:"P&L",className:"w-[120px] text-right"}),e.jsx(k,{column:7,label:"P&L %",className:"w-[100px] text-right"}),e.jsx(E,{className:"w-[60px] text-right",children:"Action"})]})}),e.jsx(Ke,{children:ke.map(t=>{const s=le[t],n=pe.has(t),r=Se(s);return e.jsxs(Te.Fragment,{children:[x!=="none"&&e.jsxs(I,{className:"bg-muted/50 cursor-pointer hover:bg-muted",onClick:()=>Ne(t),children:[e.jsx(i,{colSpan:6,children:e.jsxs("div",{className:"flex items-center gap-3 py-1 font-semibold",children:[n?e.jsx(it,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(ot,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:t}),e.jsx(v,{variant:"outline",className:"text-xs",children:r.count})]})}),e.jsxs(i,{className:p("text-right font-bold",w(r.totalPnl)?"text-green-600":"text-red-600"),children:[r.totalPnl>=0?"+":"",r.totalPnl.toFixed(2)]}),e.jsxs(i,{className:p("text-right font-semibold",w(r.pnlPercent)?"text-green-600":"text-red-600"),children:[r.pnlPercent>=0?"+":"",r.pnlPercent.toFixed(2),"%"]}),e.jsx(i,{})]}),!n&&s.map((a,m)=>e.jsxs(I,{children:[e.jsx(i,{className:"w-[140px] font-medium",children:a.symbol}),e.jsx(i,{className:"w-[80px]",children:e.jsx(v,{variant:"outline",className:ht[a.exchange]||"",children:a.exchange})}),e.jsx(i,{className:"w-[80px]",children:e.jsx(v,{variant:"outline",className:mt[a.product]||"",children:a.product})}),e.jsx(i,{className:p("w-[80px] text-right font-medium",a.quantity>0?"text-green-600":"text-red-600"),children:a.quantity}),e.jsx(i,{className:"w-[120px] text-right font-mono",children:T(a.average_price)}),e.jsx(i,{className:"w-[120px] text-right font-mono",children:a.ltp!==void 0?T(a.ltp):"-"}),e.jsx(i,{className:p("w-[120px] text-right font-medium",w(a.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[w(a.pnl)?e.jsx(dt,{className:"h-4 w-4"}):e.jsx(xt,{className:"h-4 w-4"}),T(a.pnl)]})}),e.jsxs(i,{className:p("w-[100px] text-right",w(a.pnlpercent)?"text-green-600":"text-red-600"),children:[a.pnlpercent>=0?"+":"",a.pnlpercent?.toFixed(2)??"0.00","%"]}),e.jsx(i,{className:"w-[60px] text-right",children:e.jsx(j,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>ve(a),children:e.jsx(de,{className:"h-4 w-4"})})})]},`${a.symbol}-${a.exchange}-${m}`))]},t)})}),e.jsx(et,{children:e.jsxs(I,{className:"bg-muted/50",children:[e.jsx(i,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsxs(i,{className:p("w-[120px] text-right font-bold",w(N.totalPnl)?"text-green-600":"text-red-600"),children:[N.totalPnl>=0?"+":"",T(N.totalPnl)]}),e.jsx(i,{colSpan:2})]})})]})})})})]})}export{Dt as default};
