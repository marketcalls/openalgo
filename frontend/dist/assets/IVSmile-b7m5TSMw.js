import{r as l,j as e}from"./vendor-react-CCyQGCED.js";import{w as E,u as se,s as P,B as L,e as b}from"./index-DtIvpiE8.js";import{C as D,d as Y}from"./card-Cjjm5IsA.js";import{S as F,a as C,b as A,c as T,d as w}from"./select-C3YeeD9X.js";import{P as re}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const z={getIVSmileData:async n=>(await E.post("/ivsmile/api/iv-smile-data",n)).data,getUnderlyings:async n=>(await E.get(`/search/api/underlyings?exchange=${n}`)).data,getExpiries:async(n,o)=>(await E.get(`/search/api/expiries?exchange=${n}&underlying=${o}`)).data},ae=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],H={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},le=3e4;function X(n){if(!n)return"";const o=n.split("-");return o.length===3?`${o[0]}${o[1].toUpperCase()}${o[2].slice(-2)}`:n.replace(/-/g,"").toUpperCase()}function he(){const{mode:n,appMode:o}=se(),h=o==="analyzer",p=n==="dark"||h,[f,q]=l.useState("NFO"),[G,B]=l.useState(H.NFO),[u,I]=l.useState("NIFTY"),[M,g]=l.useState([]),[c,m]=l.useState(""),[r,S]=l.useState(null),[k,$]=l.useState(!1),[y,K]=l.useState(!1),v=l.useRef(0),j=l.useRef(null);l.useEffect(()=>{const t=H[f]||[];B(t),I(t[0]||""),g([]),m(""),S(null);let s=!1;return(async()=>{try{const d=await z.getUnderlyings(f);if(s)return;d.status==="success"&&d.underlyings.length>0&&(B(d.underlyings),d.underlyings.includes(t[0])||I(d.underlyings[0]))}catch{}})(),()=>{s=!0}},[f]),l.useEffect(()=>{if(!u)return;g([]),m(""),S(null);let t=!1;return(async()=>{try{const i=await z.getExpiries(f,u);if(t)return;i.status==="success"&&i.expiries.length>0?(g(i.expiries),m(i.expiries[0])):(g([]),m(""))}catch{if(t)return;g([]),m("")}})(),()=>{t=!0}},[u]);const N=l.useCallback(async()=>{if(!c)return;const t=++v.current;$(!0);try{const s=X(c),i=await z.getIVSmileData({underlying:u,exchange:f,expiry_date:s});if(v.current!==t)return;i.status==="success"?S(i):P.error(i.message||"Failed to fetch IV Smile data")}catch{if(v.current!==t)return;P.error("Failed to fetch IV Smile data")}finally{v.current===t&&$(!1)}},[u,c,f]);l.useEffect(()=>{c&&N()},[c]),l.useEffect(()=>(y&&c&&(j.current=setInterval(N,le)),()=>{j.current&&(clearInterval(j.current),j.current=null)}),[y,N,c]);const a=l.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:p?"#e0e0e0":"#333333",grid:p?h?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",callIV:"#3b82f6",putIV:"#ef4444",spotLine:p?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:p?h?"#2d2545":"#1e293b":"#ffffff",hoverFont:p?"#e0e0e0":"#333333",hoverBorder:p?h?"#7c3aed":"#475569":"#e2e8f0"}),[p,h]),J=l.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),_=l.useMemo(()=>{if(!r?.chain)return{data:[],layout:{}};const t=r.chain,s=r.spot_price,i=r.atm_strike,d=t.filter(x=>x.ce_iv!==null||x.pe_iv!==null);if(d.length===0)return{data:[],layout:{}};const U=d.map(x=>x.strike),Q=d.map(x=>x.ce_iv),W=d.map(x=>x.pe_iv),Z=[{x:U,y:Q,type:"scatter",mode:"lines+markers",name:"Call IV",line:{color:a.callIV,width:2.5},marker:{size:4,color:a.callIV},hovertemplate:"Strike: %{x}<br>Call IV: %{y:.2f}%<extra></extra>",connectgaps:!0},{x:U,y:W,type:"scatter",mode:"lines+markers",name:"Put IV",line:{color:a.putIV,width:2.5},marker:{size:4,color:a.putIV},hovertemplate:"Strike: %{x}<br>Put IV: %{y:.2f}%<extra></extra>",connectgaps:!0}],V=[],O=[];s&&(V.push({type:"line",x0:s,x1:s,y0:0,y1:1,yref:"paper",line:{color:a.spotLine,width:1.5,dash:"dash"}}),O.push({x:s,y:1,yref:"paper",text:`Spot ${s?.toFixed(1)}`,showarrow:!1,font:{color:a.text,size:11},yanchor:"bottom"})),i&&i!==s&&V.push({type:"line",x0:i,x1:i,y0:0,y1:1,yref:"paper",line:{color:a.spotLine,width:1,dash:"dot"}});const ee=X(c),te={title:{text:`${u} ${ee} - IV Smile`,font:{color:a.text,size:14}},paper_bgcolor:a.paper,plot_bgcolor:a.bg,font:{color:a.text,family:"system-ui, sans-serif"},hovermode:"x unified",hoverlabel:{bgcolor:a.hoverBg,font:{color:a.hoverFont,size:12},bordercolor:a.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:a.text,size:11}},margin:{l:60,r:30,t:50,b:80},xaxis:{title:{text:"Strike Price",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,tickangle:-45},yaxis:{title:{text:"Implied Volatility (%)",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,ticksuffix:"%"},annotations:O,shapes:V};return{data:Z,layout:te}},[r,a,c,u]),R=l.useMemo(()=>{if(!r?.chain||!r.atm_strike)return[];const t=r.atm_strike;return r.chain.filter(s=>Math.abs(s.strike-t)/t<=.05&&(s.ce_iv!==null||s.pe_iv!==null)).map(s=>({strike:s.strike,ce_iv:s.ce_iv,pe_iv:s.pe_iv,diff:s.ce_iv!==null&&s.pe_iv!==null?s.pe_iv-s.ce_iv:null,isATM:s.strike===t}))},[r]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"IV Smile"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(F,{value:f,onValueChange:q,children:[e.jsx(C,{className:"w-[100px]",children:e.jsx(A,{placeholder:"Exchange"})}),e.jsx(T,{children:ae.map(t=>e.jsx(w,{value:t.value,children:t.label},t.value))})]}),e.jsxs(F,{value:u,onValueChange:I,children:[e.jsx(C,{className:"w-[160px]",children:e.jsx(A,{placeholder:"Underlying"})}),e.jsx(T,{children:G.map(t=>e.jsx(w,{value:t,children:t},t))})]}),e.jsxs(F,{value:c,onValueChange:m,disabled:M.length===0,children:[e.jsx(C,{className:"w-[160px]",children:e.jsx(A,{placeholder:"Expiry"})}),e.jsx(T,{children:M.map(t=>e.jsx(w,{value:t,children:t},t))})]}),e.jsx(L,{variant:y?"default":"outline",size:"sm",onClick:()=>K(!y),children:y?"Auto: ON":"Auto: OFF"}),e.jsx(L,{variant:"outline",size:"sm",onClick:N,disabled:k,children:k?"Loading...":"Refresh"})]})]}),r&&r.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",r.spot_price?.toFixed(1)]}),e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",r.atm_strike]}),r.atm_iv!==null&&r.atm_iv!==void 0&&e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM IV: ",r.atm_iv,"%"]}),r.skew!==null&&r.skew!==void 0&&e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["Skew (25d): ",r.skew>0?"+":"",r.skew,"%"]})]}),e.jsx(D,{children:e.jsx(Y,{className:"p-2 sm:p-4",children:k&&!r?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Loading IV Smile data..."}):_.data.length>0?e.jsx(re,{data:_.data,layout:_.layout,config:J,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:c?"No IV data available":"Select an underlying and expiry to view IV Smile"})})}),R.length>0&&e.jsx(D,{children:e.jsxs(Y,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"IV Near ATM"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 px-3 font-medium text-muted-foreground",children:"Strike"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-blue-500",children:"Call IV"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-red-500",children:"Put IV"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Diff (PE-CE)"})]})}),e.jsx("tbody",{children:R.map(t=>e.jsxs("tr",{className:`border-b border-border/50 last:border-0 ${t.isATM?"bg-muted/50 font-medium":""}`,children:[e.jsxs("td",{className:"py-2 px-3",children:[t.strike,t.isATM&&e.jsx("span",{className:"ml-1 text-xs text-muted-foreground",children:"(ATM)"})]}),e.jsx("td",{className:"text-right py-2 px-3 text-blue-500",children:t.ce_iv!==null?`${t.ce_iv}%`:"-"}),e.jsx("td",{className:"text-right py-2 px-3 text-red-500",children:t.pe_iv!==null?`${t.pe_iv}%`:"-"}),e.jsx("td",{className:`text-right py-2 px-3 ${t.diff!==null&&t.diff>0?"text-red-500":t.diff!==null&&t.diff<0?"text-blue-500":"text-muted-foreground"}`,children:t.diff!==null?`${t.diff>0?"+":""}${t.diff.toFixed(2)}%`:"-"})]},t.strike))})]})})]})})]})}export{he as default};
