import{r as t}from"./vendor-react--vsXx8_n.js";import{t as A}from"./trading-CrIWpfnG.js";import{d as I,l as W}from"./index-DWmnumc2.js";async function j(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function q({symbols:e,mode:d="LTP",enabled:c=!0,autoReconnect:f=!0}){const[p,w]=t.useState(new Map),[n,a]=t.useState(!1),[s,r]=t.useState(!1),[i,y]=t.useState(!1),[D,b]=t.useState(null),S=t.useRef(null),v=t.useRef(null),x=t.useRef(new Set),O=t.useRef([]),l=t.useCallback(async()=>j(),[]),M=t.useCallback(R=>{if(!S.current||S.current.readyState!==WebSocket.OPEN||!s){O.current=R;return}const g=R.filter(k=>{const C=`${k.exchange}:${k.symbol}`;return!x.current.has(C)});g.length!==0&&(S.current.send(JSON.stringify({action:"subscribe",symbols:g,mode:d})),g.forEach(k=>{const C=`${k.exchange}:${k.symbol}`;x.current.add(C),w(u=>{const o=new Map(u);return o.has(C)||o.set(C,{symbol:k.symbol,exchange:k.exchange,data:{}}),o})}))},[s,d]),h=t.useCallback(R=>{try{const g=JSON.parse(R.data);switch(g.type||g.status){case"auth":g.status==="success"?(r(!0),b(null),O.current.length>0&&setTimeout(()=>{M(O.current),O.current=[]},100)):b(`Authentication failed: ${g.message}`);break;case"market_data":{const C=g.symbol.toUpperCase(),u=g.exchange,o=g.data||{},E=`${u}:${C}`;w($=>{const P=$.get(E);if(!P)return $;const L=new Map($),_={...P.data};return Object.assign(_,{ltp:o.ltp??_.ltp,open:o.open??_.open,high:o.high??_.high,low:o.low??_.low,close:o.close??_.close,volume:o.volume??_.volume,change:o.change??_.change,change_percent:o.change_percent??_.change_percent,timestamp:o.timestamp??_.timestamp}),L.set(E,{...P,data:_,lastUpdate:Date.now()}),L});break}case"subscribe":break;case"error":b(`WebSocket error: ${g.message}`);break}}catch{}},[M]),m=t.useCallback(async()=>{if(S.current?.readyState!==WebSocket.OPEN){y(!0),b(null);try{const R=await l(),k=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":R},credentials:"include"})).json();if(k.status!=="success")throw new Error("Failed to get WebSocket configuration");const C=k.websocket_url,u=new WebSocket(C);u.onopen=async()=>{a(!0),y(!1);try{const o=await l(),$=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":o},credentials:"include"})).json();$.status==="success"&&$.api_key?u.send(JSON.stringify({action:"authenticate",api_key:$.api_key})):b("No API key found - please generate one at /apikey")}catch(o){b(`Authentication error: ${o}`)}},u.onclose=o=>{a(!1),y(!1),r(!1),x.current.clear(),f&&!o.wasClean&&c&&(v.current=setTimeout(m,3e3))},u.onerror=()=>{b("WebSocket connection error"),y(!1)},u.onmessage=h,S.current=u}catch(R){b(`Connection failed: ${R}`),y(!1)}}},[l,h,f,c]),T=t.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=null),S.current&&(S.current.close(1e3,"User disconnect"),S.current=null),a(!1),r(!1),x.current.clear()},[]);return t.useEffect(()=>(c&&e.length>0&&!n&&!i&&m(),()=>{v.current&&clearTimeout(v.current)}),[c,e.length,n,i,m]),t.useEffect(()=>{s&&e.length>0&&M(e)},[s,e,M]),t.useEffect(()=>()=>{T()},[T]),{data:p,isConnected:n,isAuthenticated:s,isConnecting:i,error:D,connect:m,disconnect:T}}async function F(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function Q(){const[e,d]=t.useState({timings:[],holidays:[],isLoading:!0,error:null});t.useEffect(()=>{(async()=>{try{const s={"X-CSRFToken":await F(),"Content-Type":"application/json"},[r,i]=await Promise.all([fetch("/api/market-timings",{headers:s,credentials:"include"}),fetch("/api/holidays",{headers:s,credentials:"include"})]),y=await r.json(),D=await i.json();d({timings:y.status==="success"?y.data||[]:[],holidays:D.status==="success"?D.data||[]:[],isLoading:!1,error:null})}catch(a){d(s=>({...s,isLoading:!1,error:`Failed to fetch market status: ${a}`}))}})()},[]);const c=t.useCallback(n=>{const a=new Date().toISOString().split("T")[0],s=e.holidays.find(r=>r.date===a);if(!s)return!1;if(s.closed_exchanges.includes(n)){const r=s.open_exchanges.find(i=>i.exchange===n);if(r){const i=Date.now();return!(i>=r.start_time&&i<=r.end_time)}return!0}return!1},[e.holidays]),f=t.useCallback(n=>{if(c(n))return!1;const a=e.timings.find(r=>r.exchange===n);if(!a)return!1;const s=Date.now();return s>=a.start_time&&s<=a.end_time},[e.timings,c]),p=t.useCallback(()=>e.timings.some(n=>{const a=Date.now();return a>=n.start_time&&a<=n.end_time&&!c(n.exchange)}),[e.timings,c]),w=t.useCallback(n=>{if(c(n))return"closed";const a=e.timings.find(i=>i.exchange===n);if(!a)return"closed";const s=Date.now(),r=900*1e3;return s<a.start_time-r?"closed":s<a.start_time?"pre-market":s<=a.end_time?"open":"post-market"},[e.timings,c]);return{isMarketOpen:f,isAnyMarketOpen:p,isHolidayForExchange:c,getMarketStatus:w,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function K(e,d={}){const{enabled:c=!0,staleThreshold:f=5e3,useMultiQuotesFallback:p=!0,multiQuotesRefreshInterval:w=3e4}=d,{apiKey:n}=I(),{isMarketOpen:a,isAnyMarketOpen:s}=Q(),r=s(),[i,y]=t.useState(new Map),D=t.useMemo(()=>e.map(l=>({symbol:l.symbol,exchange:l.exchange})),[e]),{data:b,isConnected:S}=q({symbols:D,mode:"LTP",enabled:c&&e.length>0&&r}),v=S&&r,x=t.useCallback(async()=>{if(!(!n||e.length===0||!p))try{const l=e.map(h=>({symbol:h.symbol,exchange:h.exchange})),M=await A.getMultiQuotes(n,l);if(M.status==="success"&&M.results){const h=new Map;M.results.forEach(m=>{const T=`${m.exchange}:${m.symbol}`;m.data&&h.set(T,m.data)}),y(h)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[n,e,p]);return t.useEffect(()=>{if(!c||e.length===0||!p)return;x();const l=setInterval(x,w);return()=>clearInterval(l)},[c,e.length,p,x,w]),{data:t.useMemo(()=>e.map(l=>{const M=`${l.exchange}:${l.symbol}`,h=b.get(M),m=i.get(M),T=l.quantity||0,R=l.pnl||0,k=a(l.exchange)&&h?.data?.ltp&&h.lastUpdate&&Date.now()-h.lastUpdate<f,C=!k&&m?.ltp;let u,o="rest";if(k&&h?.data?.ltp?(u=h.data.ltp,o="websocket"):C&&m?.ltp?(u=m.ltp,o="multiquotes"):(u=l.ltp,o="rest"),T===0)return{...l,ltp:u,_dataSource:o};let E=l.average_price;return!E&&u&&T!==0&&(E=u-R/T),{...l,ltp:u,average_price:E,_dataSource:o}}),[e,b,i,a,f]),isLive:v,isConnected:S,isAnyMarketOpen:r,multiQuotes:i,refreshMultiQuotes:x}}function J(e,d){if(!d)return null;let c=0,f=0,p=0;e.forEach(n=>{c+=n.pnl||0;const a=n.average_price||0,s=n.quantity||0,r=n.ltp||a;f+=a*s,p+=r*s});const w=f>0?c/f*100:0;return{...d,totalholdingvalue:p,totalinvvalue:f,totalprofitandloss:c,totalpnlpercentage:w}}function X(e,d={}){const{events:c=["order_event","analyzer_update"],delay:f=500,enabled:p=!0}=d,w=t.useRef(null),n=t.useRef(e);t.useEffect(()=>{n.current=e},[e]),t.useEffect(()=>{if(!p)return;const a=window.location.protocol,s=window.location.hostname,r=window.location.port;w.current=W(`${a}//${s}:${r}`,{transports:["websocket","polling"]});const i=w.current,y=()=>{setTimeout(()=>n.current(),f)};return c.forEach(D=>{i.on(D,y)}),()=>{c.forEach(D=>{i.off(D,y)}),i.disconnect()}},[c,f,p])}export{X as a,J as c,K as u};
