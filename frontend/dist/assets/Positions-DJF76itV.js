import{r as a,j as e,a as pe}from"./vendor-react-RhKMXzW9.js";import{d as me,o as ge,B as f,c as x,e as w,t as k,s as v}from"./index-5A0f6rqh.js";import{t as $}from"./trading-Br-Hv0b5.js";import{A as fe,a as je,b as be,c as Ne,d as ye,e as ve,f as Ce,g as we,h as Se}from"./alert-dialog-BsP7Z8ez.js";import{C as E,b as L,d as R,c as M,a as Pe}from"./card-DQ3ML41e.js";import{D as ke,a as Ee,b as De,c as Te,d as Ae,e as Fe,f as Oe}from"./dialog-CF7I9CHU.js";import{L as q}from"./label-B4a3RivY.js";import{T as Le,a as Re,b as I,c as D,d as Me,e as c,f as qe}from"./table-DKZgCx8B.js";import{P as Ie,R as _e,D as Ge,X as ee,L as Be,w as Ue,Q as He,c as ze,V as $e,W as Ve}from"./vendor-icons-DEeYHfOp.js";import"./vendor-syntax-D6hV6JR3.js";import"./vendor-router-DdyOoyPF.js";import"./vendor-radix-hRiDuY7W.js";const se="openalgo_positions_prefs";function T(o){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(o)}function We(o,m){if(m==="NSE"||m==="BSE")return{underlying:o,expiry:null,strike:null,optionType:null};const b=o.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})FUT$/i);if(b)return{underlying:b[1],expiry:b[2],strike:null,optionType:"FUT"};const j=o.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})(\d+\.?\d*)(CE|PE)$/i);return j?{underlying:j[1],expiry:j[2],strike:j[3],optionType:j[4]}:{underlying:o,expiry:null,strike:null,optionType:null}}function te(o){const m=o.average_price||0,b=o.quantity||0,j=o.pnl||0;if(m===0||b===0)return 0;const S=Math.abs(m*b);return S>0?j/S*100:0}const Xe={NSE:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",BSE:"bg-slate-500/20 text-slate-600 border-slate-500/30",NFO:"bg-purple-500/20 text-purple-600 border-purple-500/30",BFO:"bg-amber-500/20 text-amber-600 border-amber-500/30",MCX:"bg-blue-500/20 text-blue-600 border-blue-500/30",CDS:"bg-teal-500/20 text-teal-600 border-teal-500/30"},Qe={CNC:"bg-purple-500/20 text-purple-600 border-purple-500/30",MIS:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",NRML:"bg-slate-500/20 text-slate-600 border-slate-500/30"};function cs(){const{apiKey:o}=me(),[m,b]=a.useState([]),[j,S]=a.useState(!0),[V,W]=a.useState(!1),[X,_]=a.useState(null),[d,G]=a.useState("none"),[i,B]=a.useState({product:[],direction:[],exchange:[]}),[re,U]=a.useState(new Set),[A,ne]=a.useState(null),[F,Q]=a.useState("asc"),[le,J]=a.useState(!1);a.useEffect(()=>{try{const s=localStorage.getItem(se);if(s){const t=JSON.parse(s);t.grouping&&G(t.grouping),t.filters&&B({product:t.filters.product||[],direction:t.filters.direction||[],exchange:t.filters.exchange||[]})}}catch(s){console.error("Error loading preferences:",s)}},[]);const Z=a.useCallback(()=>{localStorage.setItem(se,JSON.stringify({grouping:d,filters:i}))},[d,i]);a.useEffect(()=>{Z()},[Z]);const N=a.useCallback(async(s=!1)=>{if(!o){S(!1);return}s&&W(!0);try{const t=await $.getPositions(o);t.status==="success"&&t.data?(b(t.data),_(null)):_(t.message||"Failed to fetch positions")}catch{_("Failed to fetch positions")}finally{S(!1),W(!1)}},[o]);a.useEffect(()=>{N();const s=setInterval(()=>N(),1e4);return()=>clearInterval(s)},[N]),a.useEffect(()=>{const s=ge(()=>{N()});return()=>s()},[N]);const Y=a.useCallback(s=>{const t=s.exchange,r=s.product;if(t==="NSE"||t==="BSE"){if(r==="CNC")return"Equity (Delivery)";if(r==="MIS")return"Equity (Intraday)"}const n=We(s.symbol,t);return d==="underlying"?n.underlying:d==="underlying_expiry"&&n.expiry?`${n.underlying} - ${n.expiry}`:n.underlying},[d]),g=a.useMemo(()=>m.filter(s=>{if(i.product.length>0&&!i.product.includes(s.product))return!1;const t=s.quantity||0;if(i.direction.length>0){const r=t>0,n=t<0;if(i.direction.includes("LONG")&&!i.direction.includes("SHORT")&&!r||i.direction.includes("SHORT")&&!i.direction.includes("LONG")&&!n)return!1}return!(i.exchange.length>0&&!i.exchange.includes(s.exchange))}),[m,i]),H=a.useMemo(()=>A===null?g:[...g].sort((s,t)=>{let r,n;switch(A){case 0:r=s.symbol,n=t.symbol;break;case 3:r=s.quantity||0,n=t.quantity||0;break;case 4:r=s.average_price||0,n=t.average_price||0;break;case 6:r=s.pnl||0,n=t.pnl||0;break;case 7:r=te(s),n=te(t);break;default:return 0}return typeof r=="string"?F==="asc"?r.localeCompare(n):n.localeCompare(r):F==="asc"?r-n:n-r}),[g,A,F]),K=a.useMemo(()=>{if(d==="none")return{_all:H};const s={};return H.forEach(t=>{const r=Y(t);s[r]||(s[r]=[]),s[r].push(t)}),s},[H,d,Y]),y=a.useMemo(()=>{const s=g.length,t=g.filter(l=>(l.quantity||0)>0).length,r=g.filter(l=>(l.quantity||0)<0).length,n=g.reduce((l,p)=>l+(p.pnl||0),0);return{total:s,long:t,short:r,totalPnl:n}},[g]),ae=s=>{A===s?Q(F==="asc"?"desc":"asc"):(ne(s),Q("asc"))},ie=(s,t)=>{B(r=>{const n=r[s];return n.indexOf(t)>-1?{...r,[s]:n.filter(p=>p!==t)}:{...r,[s]:[...n,t]}})},z=()=>{B({product:[],direction:[],exchange:[]}),G("none"),U(new Set)},ce=s=>{U(t=>{const r=new Set(t);return r.has(s)?r.delete(s):r.add(s),r})},O=i.product.length>0||i.direction.length>0||i.exchange.length>0||d!=="none",oe=async s=>{try{const t=await $.closePosition(s.symbol,s.exchange,s.product);t.status==="success"?N(!0):k.error(t.message||"Failed to close position")}catch(t){console.error("Close position error:",t),k.error("Failed to close position")}},de=async()=>{try{const s=await $.closeAllPositions();s.status==="success"?(k.success("All positions closed"),N(!0)):k.error(s.message||"Failed to close all positions")}catch(s){console.error("Close all positions error:",s),k.error("Failed to close all positions")}},xe=()=>{const s=["Symbol","Exchange","Product","Quantity","Avg Price","LTP","P&L","P&L %"],t=g.map(u=>[v(u.symbol),v(u.exchange),v(u.product),v(u.quantity),v(u.average_price),v(u.ltp),v(u.pnl),v(u.pnlpercent)]),r=[s,...t].map(u=>u.join(",")).join(`
`),n=new Blob([r],{type:"text/csv"}),l=URL.createObjectURL(n),p=document.createElement("a");p.href=l,p.download=`positions_${new Date().toISOString().split("T")[0]}.csv`,p.click()},C=s=>s>=0,h=({type:s,value:t,label:r})=>e.jsx(f,{variant:i[s].includes(t)?"default":"outline",size:"sm",className:x("rounded-full",i[s].includes(t)&&"bg-pink-500 hover:bg-pink-600"),onClick:()=>ie(s,t),children:r}),P=({column:s,label:t,className:r})=>e.jsx(D,{className:x("cursor-pointer hover:bg-muted/50 select-none",r),onClick:()=>ae(s),children:e.jsxs("div",{className:x("flex items-center gap-1 w-full",r?.includes("text-right")&&"justify-end"),children:[t,e.jsx(Ve,{className:"h-3 w-3 opacity-50"})]})}),ue=s=>{let t=0,r=0;s.forEach(l=>{t+=l.pnl||0;const p=l.average_price||0,u=Math.abs(l.quantity||0);r+=p*u});const n=r>0?t/r*100:0;return{totalPnl:t,pnlPercent:n,count:s.length}},he=Object.keys(K).sort((s,t)=>s.startsWith("Equity")&&!t.startsWith("Equity")?-1:!s.startsWith("Equity")&&t.startsWith("Equity")?1:s.localeCompare(t));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Positions"}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor and manage your active trading positions"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(ke,{open:le,onOpenChange:J,children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(f,{variant:O?"default":"outline",size:"sm",className:"relative",children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Settings",O&&e.jsx("span",{className:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"})]})}),e.jsxs(De,{className:"max-w-md",children:[e.jsxs(Te,{children:[e.jsx(Ae,{children:"Position Settings"}),e.jsx(Fe,{children:"Configure grouping and filters"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(q,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Grouping"}),e.jsx("div",{className:"space-y-2",children:[{value:"none",label:"None"},{value:"underlying",label:"Underlying"},{value:"underlying_expiry",label:"Underlying & Expiry"}].map(s=>e.jsxs("label",{className:x("flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-muted",d===s.value&&"bg-pink-500/10 border border-pink-500/30"),children:[e.jsx("input",{type:"radio",name:"grouping",checked:d===s.value,onChange:()=>{G(s.value),U(new Set)},className:"accent-pink-500"}),e.jsx("span",{className:x(d===s.value&&"text-pink-500 font-semibold"),children:s.label})]},s.value))})]}),e.jsx("div",{className:"border-t"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(q,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Product Type"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{type:"product",value:"CNC",label:"CNC"}),e.jsx(h,{type:"product",value:"MIS",label:"MIS"}),e.jsx(h,{type:"product",value:"NRML",label:"NRML"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(q,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Direction"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{type:"direction",value:"LONG",label:"Long"}),e.jsx(h,{type:"direction",value:"SHORT",label:"Short"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(q,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Exchange"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(h,{type:"exchange",value:"NSE",label:"NSE"}),e.jsx(h,{type:"exchange",value:"BSE",label:"BSE"}),e.jsx(h,{type:"exchange",value:"NFO",label:"NFO"}),e.jsx(h,{type:"exchange",value:"BFO",label:"BFO"}),e.jsx(h,{type:"exchange",value:"MCX",label:"MCX"}),e.jsx(h,{type:"exchange",value:"CDS",label:"CDS"})]})]})]}),e.jsxs(Oe,{children:[e.jsx(f,{variant:"ghost",onClick:z,children:"Clear All"}),e.jsx(f,{onClick:()=>J(!1),children:"Done"})]})]})]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>N(!0),disabled:V,children:[e.jsx(_e,{className:x("h-4 w-4 mr-2",V&&"animate-spin")}),"Refresh"]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:xe,children:[e.jsx(Ge,{className:"h-4 w-4 mr-2"}),"Export"]}),e.jsxs(fe,{children:[e.jsx(je,{asChild:!0,children:e.jsxs(f,{variant:"destructive",size:"sm",disabled:m.length===0,children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Close All"]})}),e.jsxs(be,{children:[e.jsxs(Ne,{children:[e.jsx(ye,{children:"Close All Positions?"}),e.jsxs(ve,{children:["This will close all ",m.length," open positions at market price. This action cannot be undone."]})]}),e.jsxs(Ce,{children:[e.jsx(we,{children:"Cancel"}),e.jsx(Se,{onClick:de,children:"Close All"})]})]})]})]})]}),O&&e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Active Filters:"}),d!=="none"&&e.jsxs(w,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:["Grouped: ",d==="underlying"?"Underlying":"Underlying & Expiry"]}),i.product.map(s=>e.jsx(w,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),i.direction.map(s=>e.jsx(w,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),i.exchange.map(s=>e.jsx(w,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),e.jsx(f,{variant:"outline",size:"sm",className:"text-red-500 border-red-500/50 hover:bg-red-500/10",onClick:z,children:"Clear All"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(E,{children:e.jsxs(L,{className:"pb-2",children:[e.jsx(R,{children:"Open Positions"}),e.jsx(M,{className:"text-2xl",children:y.total})]})}),e.jsx(E,{children:e.jsxs(L,{className:"pb-2",children:[e.jsx(R,{children:"Long"}),e.jsx(M,{className:"text-2xl text-green-600",children:y.long})]})}),e.jsx(E,{children:e.jsxs(L,{className:"pb-2",children:[e.jsx(R,{children:"Short"}),e.jsx(M,{className:"text-2xl text-red-600",children:y.short})]})}),e.jsx(E,{children:e.jsxs(L,{className:"pb-2",children:[e.jsx(R,{children:"Total P&L"}),e.jsx(M,{className:x("text-2xl",C(y.totalPnl)?"text-green-600":"text-red-600"),children:T(y.totalPnl)})]})})]}),e.jsx(E,{children:e.jsx(Pe,{className:"p-0",children:j?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(Be,{className:"h-8 w-8 animate-spin"})}):X?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:X}):g.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx("p",{className:"mb-4",children:"No positions match your filters"}),O&&e.jsx(f,{variant:"ghost",size:"sm",onClick:z,children:"Clear Filters"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Le,{children:[e.jsx(Re,{children:e.jsxs(I,{children:[e.jsx(P,{column:0,label:"Symbol",className:"w-[140px]"}),e.jsx(D,{className:"w-[80px]",children:"Exchange"}),e.jsx(D,{className:"w-[80px]",children:"Product"}),e.jsx(P,{column:3,label:"Qty",className:"w-[80px] text-right"}),e.jsx(P,{column:4,label:"Avg Price",className:"w-[120px] text-right"}),e.jsx(D,{className:"w-[120px] text-right",children:"LTP"}),e.jsx(P,{column:6,label:"P&L",className:"w-[120px] text-right"}),e.jsx(P,{column:7,label:"P&L %",className:"w-[100px] text-right"}),e.jsx(D,{className:"w-[60px] text-right",children:"Action"})]})}),e.jsx(Me,{children:he.map(s=>{const t=K[s],r=re.has(s),n=ue(t);return e.jsxs(pe.Fragment,{children:[d!=="none"&&e.jsxs(I,{className:"bg-muted/50 cursor-pointer hover:bg-muted",onClick:()=>ce(s),children:[e.jsx(c,{colSpan:6,children:e.jsxs("div",{className:"flex items-center gap-3 py-1 font-semibold",children:[r?e.jsx(Ue,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(He,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s}),e.jsx(w,{variant:"outline",className:"text-xs",children:n.count})]})}),e.jsxs(c,{className:x("text-right font-bold",C(n.totalPnl)?"text-green-600":"text-red-600"),children:[n.totalPnl>=0?"+":"",n.totalPnl.toFixed(2)]}),e.jsxs(c,{className:x("text-right font-semibold",C(n.pnlPercent)?"text-green-600":"text-red-600"),children:[n.pnlPercent>=0?"+":"",n.pnlPercent.toFixed(2),"%"]}),e.jsx(c,{})]}),!r&&t.map((l,p)=>e.jsxs(I,{children:[e.jsx(c,{className:"w-[140px] font-medium",children:l.symbol}),e.jsx(c,{className:"w-[80px]",children:e.jsx(w,{variant:"outline",className:Xe[l.exchange]||"",children:l.exchange})}),e.jsx(c,{className:"w-[80px]",children:e.jsx(w,{variant:"outline",className:Qe[l.product]||"",children:l.product})}),e.jsx(c,{className:x("w-[80px] text-right font-medium",l.quantity>0?"text-green-600":"text-red-600"),children:l.quantity}),e.jsx(c,{className:"w-[120px] text-right font-mono",children:T(l.average_price)}),e.jsx(c,{className:"w-[120px] text-right font-mono",children:l.ltp!==void 0?T(l.ltp):"-"}),e.jsx(c,{className:x("w-[120px] text-right font-medium",C(l.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[C(l.pnl)?e.jsx(ze,{className:"h-4 w-4"}):e.jsx($e,{className:"h-4 w-4"}),T(l.pnl)]})}),e.jsxs(c,{className:x("w-[100px] text-right",C(l.pnlpercent)?"text-green-600":"text-red-600"),children:[l.pnlpercent>=0?"+":"",l.pnlpercent?.toFixed(2)??"0.00","%"]}),e.jsx(c,{className:"w-[60px] text-right",children:e.jsx(f,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>oe(l),children:e.jsx(ee,{className:"h-4 w-4"})})})]},`${l.symbol}-${l.exchange}-${p}`))]},s)})}),e.jsx(qe,{children:e.jsxs(I,{className:"bg-muted/50",children:[e.jsx(c,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsxs(c,{className:x("w-[120px] text-right font-bold",C(y.totalPnl)?"text-green-600":"text-red-600"),children:[y.totalPnl>=0?"+":"",T(y.totalPnl)]}),e.jsx(c,{colSpan:2})]})})]})})})})]})}export{cs as default};
