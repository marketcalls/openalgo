import{r as o,j as e}from"./vendor-react-CCyQGCED.js";import{u as ee,s as U,B as te,e as p}from"./index-DtIvpiE8.js";import{o as F}from"./oi-tracker-XVOtPev8.js";import{C as se,d as re}from"./card-Cjjm5IsA.js";import{S as k,a as E,b as _,c as C,d as B}from"./select-C3YeeD9X.js";import{P as ae}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const oe=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],A={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]};function $(n){if(!n)return"";const h=n.split("-");return h.length===3?`${h[0]}${h[1].toUpperCase()}${h[2].slice(-2)}`:n.replace(/-/g,"").toUpperCase()}function D(n){return n>=1e7?`${(n/1e7).toFixed(1)}Cr`:n>=1e5?`${(n/1e5).toFixed(1)}L`:n>=1e3?`${(n/1e3).toFixed(1)}K`:n.toString()}function me(){const{mode:n,appMode:h}=ee(),g=h==="analyzer",u=n==="dark"||g,[f,R]=o.useState("NFO"),[V,T]=o.useState(A.NFO),[c,b]=o.useState("NIFTY"),[w,y]=o.useState([]),[l,m]=o.useState(""),[s,I]=o.useState(null),[S,z]=o.useState(!1),N=o.useRef(0);o.useEffect(()=>{const t=A[f]||[];T(t),b(t[0]||""),y([]),m(""),I(null);let d=!1;return(async()=>{try{const x=await F.getUnderlyings(f);if(d)return;x.status==="success"&&x.underlyings.length>0&&(T(x.underlyings),x.underlyings.includes(t[0])||b(x.underlyings[0]))}catch{}})(),()=>{d=!0}},[f]),o.useEffect(()=>{if(!c)return;y([]),m(""),I(null);let t=!1;return(async()=>{try{const a=await F.getExpiries(f,c);if(t)return;a.status==="success"&&a.expiries.length>0?(y(a.expiries),m(a.expiries[0])):(y([]),m(""))}catch{if(t)return;y([]),m("")}})(),()=>{t=!0}},[c]);const L=o.useCallback(async()=>{if(!l)return;const t=++N.current;z(!0);try{const d=$(l),a=await F.getOIData({underlying:c,exchange:f,expiry_date:d});if(N.current!==t)return;a.status==="success"?I(a):U.error(a.message||"Failed to fetch OI data")}catch{if(N.current!==t)return;U.error("Failed to fetch OI data")}finally{N.current===t&&z(!1)}},[c,l,f]);o.useEffect(()=>{l&&L()},[l]);const r=o.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:u?"#e0e0e0":"#333333",grid:u?g?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceBar:"#ef4444",peBar:"#22c55e",atmLine:u?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:u?g?"#2d2545":"#1e293b":"#ffffff",hoverFont:u?"#e0e0e0":"#333333",hoverBorder:u?g?"#7c3aed":"#475569":"#e2e8f0"}),[u,g]),M=o.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.lot_size||1,d=s.atm_strike,a=s.chain,x=a.map((i,j)=>j),O=a.map(i=>i.strike.toString()),K=a.map(i=>Math.round(i.ce_oi/t)),X=a.map(i=>Math.round(i.pe_oi/t)),P=Math.max(1,Math.floor(a.length/15)),q=x.filter((i,j)=>j%P===0),G=O.filter((i,j)=>j%P===0),H=[{x,y:K,type:"bar",name:"Call Options OI (lots)",marker:{color:r.ceBar},hovertemplate:"Strike %{text}<br>CE OI: %{y:,}<extra></extra>",text:O,textposition:"none"},{x,y:X,type:"bar",name:"Put Options OI (lots)",marker:{color:r.peBar},hovertemplate:"Strike %{text}<br>PE OI: %{y:,}<extra></extra>",text:O,textposition:"none"}],J=$(l),v=d?a.findIndex(i=>i.strike===d):-1,Q=v>=0?[{x:v,y:1,yref:"paper",text:`${c} ATM Strike ${d}`,showarrow:!1,font:{color:r.text,size:12},yanchor:"bottom"}]:[],W=v>=0?[{type:"line",x0:v,x1:v,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}}]:[],Z={title:{text:`${c} ${J} - current`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},barmode:"group",bargap:.15,hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:r.text,size:11}},margin:{l:70,r:30,t:50,b:80},xaxis:{tickmode:"array",tickvals:q,ticktext:G,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Open Interest",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:Q,shapes:W};return{data:H,layout:Z}},[s,r,l,c]),Y=o.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"OI Tracker"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(k,{value:f,onValueChange:R,children:[e.jsx(E,{className:"w-[100px]",children:e.jsx(_,{placeholder:"Exchange"})}),e.jsx(C,{children:oe.map(t=>e.jsx(B,{value:t.value,children:t.label},t.value))})]}),e.jsxs(k,{value:c,onValueChange:b,children:[e.jsx(E,{className:"w-[160px]",children:e.jsx(_,{placeholder:"Underlying"})}),e.jsx(C,{children:V.map(t=>e.jsx(B,{value:t,children:t},t))})]}),e.jsxs(k,{value:l,onValueChange:m,disabled:w.length===0,children:[e.jsx(E,{className:"w-[160px]",children:e.jsx(_,{placeholder:"Expiry"})}),e.jsx(C,{children:w.map(t=>e.jsx(B,{value:t,children:t},t))})]}),e.jsx(te,{variant:"outline",size:"sm",onClick:L,disabled:S,children:S?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (OI): ",s.pcr_oi?.toFixed(2)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (Vol): ",s.pcr_volume?.toFixed(2)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Total CE OI: ",D(s.total_ce_oi||0)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Total PE OI: ",D(s.total_pe_oi||0)]})]}),e.jsx(se,{children:e.jsx(re,{className:"p-2 sm:p-4",children:S&&!s?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Loading OI data..."}):s?.chain&&s.chain.length>0?e.jsx(ae,{data:M.data,layout:M.layout,config:Y,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:l?"No OI data available":"Select an underlying and expiry to view OI data"})})})]})}export{me as default};
