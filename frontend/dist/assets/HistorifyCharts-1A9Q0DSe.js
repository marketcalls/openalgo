import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as he,d as Je,t as y,c as Z,B as f,e as $,D as Ge,h as Ye,i as Ze,p as Ke,j as K,k as Qe,m as Xe}from"./index-Dce7jNmq.js";import{C as M,a as I}from"./card-KkSfM6UR.js";import{P as es,a as ss,b as ts,C as as,c as rs,d as ns,e as os,f as ls,g as cs}from"./popover-CgBSRXLh.js";import{I as Q}from"./input-CrHMpVgn.js";import{S as xe,a as ge,b as fe,c as pe,d as F}from"./select-DYVv1iq4.js";import{q as is,K as ds,W as ms,R as us,V as hs}from"./lightweight-charts.production-BQUuleWj.js";import{A as xs,D as je,S as gs,ai as fs,R as ps,Z as ve,g as Se,L as js,k as vs,l as Ss,aF as bs,aG as Ns,N as ws,m as ys,n as Cs}from"./vendor-icons-Ca5eNZvr.js";import{a as Ds,c as Ms,d as Is,L as X}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-DzupMptF.js";import"./vendor-radix-gKv__6YA.js";function Ps(){const O=Ds(),{mode:R,toggleMode:be,appMode:u,toggleAppMode:Ne,isTogglingMode:ee}=he(),{user:U,logout:se}=Je(),i=R==="dark"||u==="analyzer",{symbol:we}=Ms(),[te,ae]=Is(),ye=async()=>{try{await Xe.logout(),se(),O("/login"),y.success("Logged out successfully")}catch{se(),O("/login")}},re=async()=>{const s=await Ne();if(s.success){const a=he.getState().appMode;y.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`)}else y.error(s.message||"Failed to toggle mode")},[C,Ce]=t.useState([]),[h,De]=t.useState(null),[ne,oe]=t.useState(!1),[V,P]=t.useState(!1),[o,Me]=t.useState(we||""),[l,Ie]=t.useState(te.get("exchange")||"NSE"),[d,Le]=t.useState(te.get("interval")||"D"),[ke,le]=t.useState(!1),[L,ce]=t.useState(""),[j,ie]=t.useState(!1),[A,Te]=t.useState("25"),[H,ze]=t.useState("m"),[B,Ee]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[_,$e]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,Fe]=t.useState([]),[k,Oe]=t.useState(null),x=t.useRef(null),m=t.useRef(null),Re=t.useRef(null),Ue=t.useRef(null),Ve=t.useMemo(()=>h?[...h.seconds,...h.minutes,...h.hours,...h.days,...h.weeks,...h.months]:["D"],[h]),v=t.useMemo(()=>j?`${A}${H}`:d,[j,A,H,d]),de=t.useMemo(()=>!!(["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(v)||j),[v,j]),W=t.useMemo(()=>{const s=new Map;return C.forEach(a=>{const c=`${a.symbol}:${a.exchange}`;s.has(c)?s.get(c).intervals.push(a.interval):s.set(c,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[C]),Pe=t.useMemo(()=>{if(!L)return W;const s=L.toLowerCase();return W.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[W,L]);t.useEffect(()=>{Ae(),He()},[]),t.useEffect(()=>{o&&l&&d&&ae({exchange:l,interval:d})},[o,l,d,ae]),t.useEffect(()=>{o&&l&&v&&(me(),Be())},[o,l,v]),t.useEffect(()=>{if(!x.current)return;const s=setTimeout(()=>{if(!x.current)return;m.current&&(m.current.remove(),m.current=null);const S=x.current,T=S.offsetWidth||800,z=S.offsetHeight||600,q=de,qe=D=>{const b=new Date(D*1e3),n=5.5*60*60*1e3,p=new Date(b.getTime()+n),g=p.getUTCDate().toString().padStart(2,"0"),N=(p.getUTCMonth()+1).toString().padStart(2,"0"),w=p.getUTCFullYear().toString().slice(-2),G=p.getUTCHours().toString().padStart(2,"0"),Y=p.getUTCMinutes().toString().padStart(2,"0");return q?`${g}/${N}/${w} ${G}:${Y}`:`${g}/${N}/${w}`},E=is(S,{width:T,height:Math.max(z,500),layout:{background:{type:ms.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:qe},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:q,secondsVisible:!1,tickMarkFormatter:(D,b)=>{const n=new Date(D*1e3),p=5.5*60*60*1e3,g=new Date(n.getTime()+p);if(q){const N=g.getUTCHours().toString().padStart(2,"0"),w=g.getUTCMinutes().toString().padStart(2,"0");return`${N}:${w}`}else{const N=g.getUTCDate(),w=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],G=g.getUTCMonth(),Y=g.getUTCFullYear();return b===0?Y.toString():b===1?w[G]:N.toString()}}},crosshair:{mode:ds.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),ue=E.addSeries(us,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),J=E.addSeries(hs,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(J.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),m.current=E,Re.current=ue,Ue.current=J,r.length>0){const D=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));ue.setData(D);const b=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));J.setData(b),E.timeScale().fitContent()}},100),a=()=>{if(m.current&&x.current){const S=x.current,T=S.offsetWidth,z=S.offsetHeight;T>0&&z>0&&m.current.applyOptions({width:T,height:z})}},c=new ResizeObserver(a);return x.current&&c.observe(x.current),window.addEventListener("resize",a),()=>{clearTimeout(s),c.disconnect(),window.removeEventListener("resize",a),m.current&&(m.current.remove(),m.current=null)}},[i,r,V,de]);const Ae=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&Ce(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},He=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&De(a.data)}catch(s){console.error("Error loading intervals:",s)}},me=t.useCallback(async()=>{if(!(!o||!l)){oe(!0);try{const s=new URLSearchParams({symbol:o,exchange:l,interval:v,start_date:B,end_date:_}),c=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();c.status==="success"?(Fe(c.data||[]),c.count===0&&y.info("No data available for this range. Make sure 1m data is downloaded for custom intervals.")):y.error(c.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),y.error("Failed to load chart data")}finally{oe(!1)}}},[o,l,v,B,_]),Be=t.useCallback(()=>{const s=C.find(a=>a.symbol===o&&a.exchange===l&&a.interval===d);Oe(s||null)},[C,o,l,d]),_e=(s,a)=>{Me(s),Ie(a),le(!1),ce("")},We=()=>{document.fullscreenElement?(document.exitFullscreen(),P(!1)):(document.documentElement.requestFullscreen(),P(!0))};return t.useEffect(()=>{const s=()=>{P(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:Z("h-full flex flex-col bg-background text-foreground",V&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(X,{to:"/historify",children:e.jsx(xs,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(es,{open:ke,onOpenChange:le,children:[e.jsx(ss,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[o?e.jsxs("span",{children:[o,":",l]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(gs,{className:"h-4 w-4 ml-2"})]})}),e.jsx(ts,{className:"w-64 p-0",align:"start",children:e.jsxs(as,{children:[e.jsx(rs,{placeholder:"Search symbols...",value:L,onValueChange:ce}),e.jsxs(ns,{children:[e.jsx(os,{children:"No symbols found"}),e.jsx(ls,{children:Pe.slice(0,20).map(s=>e.jsxs(cs,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>_e(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx($,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(xe,{value:j?"custom":d,onValueChange:s=>{s==="custom"?ie(!0):(ie(!1),Le(s))},children:[e.jsx(ge,{className:"w-24",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[Ve.map(s=>e.jsx(F,{value:s,children:s},s)),e.jsx(F,{value:"custom",children:"Custom"})]})]}),j&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Q,{type:"number",min:"1",max:"999",value:A,onChange:s=>Te(s.target.value),className:"h-9 w-16 text-center",placeholder:"25"}),e.jsxs(xe,{value:H,onValueChange:s=>ze(s),children:[e.jsx(ge,{className:"w-16 h-9",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[e.jsx(F,{value:"m",children:"min"}),e.jsx(F,{value:"h",children:"hr"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Q,{type:"date",value:B,onChange:s=>Ee(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(Q,{type:"date",value:_,onChange:s=>$e(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:me,disabled:ne,children:e.jsx(ps,{className:Z("h-4 w-4",ne&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[U?.broker&&e.jsx($,{variant:"outline",className:"text-xs",children:U.broker.toUpperCase()}),e.jsxs($,{variant:u==="live"?"default":"secondary",className:Z("text-xs cursor-pointer",u==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:re,children:[u==="live"?e.jsx(ve,{className:"h-3 w-3 mr-1"}):e.jsx(Se,{className:"h-3 w-3 mr-1"}),u==="live"?"Live":"Analyze"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:re,disabled:ee,title:`Switch to ${u==="live"?"Analyze":"Live"} mode`,children:ee?e.jsx(js,{className:"h-4 w-4 animate-spin"}):u==="live"?e.jsx(ve,{className:"h-4 w-4"}):e.jsx(Se,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:be,disabled:u!=="live",title:R==="light"?"Switch to dark mode":"Switch to light mode",children:R==="light"?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:We,children:V?e.jsx(bs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(X,{to:"/dashboard",children:[e.jsx(ws,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Ge,{children:[e.jsx(Ye,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:U?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Ze,{align:"end",className:"w-56",children:[Ke.map(s=>e.jsxs(K,{onSelect:()=>O(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(K,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Qe,{}),e.jsxs(K,{onClick:ye,className:"text-destructive focus:text-destructive",children:[e.jsx(Cs,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:o?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[o,":",l]}),e.jsx($,{variant:"outline",children:d}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),k&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",k.first_date," - ",k.last_date]}),e.jsxs("span",{children:[k.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:x,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(M,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(M,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(M,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(M,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(M,{children:e.jsxs(I,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(je,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),C.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(X,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Ps as default};
