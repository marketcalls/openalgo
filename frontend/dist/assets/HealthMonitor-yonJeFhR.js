import{r,j as e}from"./vendor-react-Df-MYEHc.js";import{w as F,B as W,c as D,e as je,s as M}from"./index-jmNeOP74.js";import{C as d,a as x,b as u,c as S,d as o}from"./card-NBBx4fP2.js";import{T as V,a as z,b as C,c as l,d as P,e as c}from"./table-C4TC1LoQ.js";import{W as fe,q as X,n as Z}from"./lightweight-charts.production-EcMg1Lek.js";import{L as ee,_ as ge,aw as Ne,v as pe,aK as ve,bx as be,D as ye,by as we,aj as Se,z as se,A as Ce,a6 as Te,aE as ke}from"./vendor-icons-nFj7rtAi.js";import"./vendor-charts-DPXZ0pfV.js";import"./vendor-router-4BT-EZah.js";import"./vendor-radix-IoylIoim.js";async function Me(){return(await F.get("/health/api/current")).data}async function _e(s=24){return(await F.get("/health/api/history",{params:{hours:s}})).data}async function De(s=24){return(await F.get("/health/api/stats",{params:{hours:s}})).data}async function Fe(){return(await F.get("/health/api/alerts")).data}async function Re(s){await F.post(`/health/api/alerts/${s}/acknowledge`)}function Ae(s=24){return`/health/export?hours=${s}`}const $e=1e4,Ee=24,He=6,G=1200;function _({title:s,icon:f,value:h,subtitle:R,status:a,loading:I}){const T={pass:"text-green-500",warn:"text-yellow-500",fail:"text-red-500",unknown:"text-primary"},B={pass:"text-green-500 opacity-20",warn:"text-yellow-500 opacity-20",fail:"text-red-500 opacity-20",unknown:"text-primary opacity-20"};return e.jsx(d,{children:e.jsx(o,{className:"p-4",children:I?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(ee,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s}),e.jsx("p",{className:D("text-2xl font-bold",T[a]),children:h}),R&&e.jsx("p",{className:"text-xs text-muted-foreground",children:R})]}),e.jsx(f,{className:D("h-8 w-8",B[a])})]})})})}function Q({status:s}){return s==="pass"?e.jsx(Ce,{className:"h-4 w-4 text-green-500"}):s==="warn"?e.jsx(se,{className:"h-4 w-4 text-yellow-500"}):s==="fail"?e.jsx(Te,{className:"h-4 w-4 text-red-500"}):e.jsx(ke,{className:"h-4 w-4 text-muted-foreground"})}const We="Asia/Kolkata";function te(s,f){const h=new Date(s);return Number.isNaN(h.getTime())?"-":new Intl.DateTimeFormat("en-IN",{timeZone:We,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0,...f}).format(h)}function Ie(s){return te(s,{year:void 0,month:void 0,day:void 0})}function Be(){return document.documentElement.classList.contains("dark")}function Ke(){const[s,f]=r.useState(null),[h,R]=r.useState([]),[a,I]=r.useState(null),[T,B]=r.useState([]),[ae,re]=r.useState(!0),[Y,q]=r.useState(!1),[k,ne]=r.useState(!0),[J,ie]=r.useState(!0),v=r.useRef(null),b=r.useRef(null),g=r.useRef(null),N=r.useRef(null),L=r.useRef(null),U=r.useRef(null),A=async(t=!1)=>{try{q(!0);const[p,$,E,H]=await Promise.all([Me(),_e(He),De(Ee),Fe()]);f(p),R($),I(E),B(H),t&&M.success("Metrics refreshed","monitoring")}catch{M.error("Failed to fetch health metrics","monitoring")}finally{re(!1),q(!1)}};r.useEffect(()=>{A()},[]),r.useEffect(()=>{if(!k||!J)return;const t=setInterval(()=>{A()},$e);return()=>clearInterval(t)},[k,J]),r.useEffect(()=>{const t=()=>{ie(!document.hidden)};return t(),document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[]),r.useEffect(()=>{if(!h.length)return;const t=Be(),p=t?"#9ca3af":"#6b7280",$=t?"#374151":"#e5e7eb",E=t?"#4b5563":"#d1d5db",H=5.5*60*60*1e3,de=n=>{const j=new Date(n*1e3),i=new Date(j.getTime()+H),y=i.getUTCHours().toString().padStart(2,"0"),m=i.getUTCMinutes().toString().padStart(2,"0");return`${y}:${m}`},oe=n=>{const j=new Date(n*1e3),i=new Date(j.getTime()+H),y=i.getUTCDate().toString().padStart(2,"0"),w=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i.getUTCMonth()],me=i.getUTCFullYear().toString().slice(-2),xe=i.getUTCHours().toString().padStart(2,"0"),ue=i.getUTCMinutes().toString().padStart(2,"0"),he=i.getUTCSeconds().toString().padStart(2,"0");return`${y} ${w} '${me} ${xe}:${ue}:${he}`},O={height:300,layout:{background:{type:fe.Solid,color:"transparent"},textColor:p},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{borderColor:E,timeVisible:!0,tickMarkFormatter:n=>de(n)},rightPriceScale:{borderColor:E},crosshair:{vertLine:{color:$},horzLine:{color:$}},localization:{timeFormatter:n=>oe(n)}};if(v.current&&!g.current){const n=X(v.current,{...O,width:v.current.clientWidth,localization:{...O.localization,priceFormatter:i=>Math.round(i).toString()}}),j=n.addSeries(Z,{color:"#3b82f6",lineWidth:2,priceLineVisible:!1,lastValueVisible:!0,priceFormat:{type:"custom",formatter:i=>Math.round(i).toString()}});g.current=n,L.current=j}if(b.current&&!N.current){const n=X(b.current,{...O,width:b.current.clientWidth}),j=n.addSeries(Z,{color:"#10b981",lineWidth:2,priceLineVisible:!1,lastValueVisible:!0});N.current=n,U.current=j}if(L.current&&U.current){const n=h.map(m=>({time:Math.floor(new Date(m.timestamp).getTime()/1e3),fd:m.fd_count,mem:m.memory_rss_mb})),j=n.length>G?Math.ceil(n.length/G):1,i=[],y=[];for(let m=0;m<n.length;m+=j){const w=n[m];i.push({time:w.time,value:w.fd}),y.push({time:w.time,value:w.mem})}L.current.setData(i),U.current.setData(y)}const K=()=>{g.current&&v.current&&g.current.applyOptions({width:v.current.clientWidth}),N.current&&b.current&&N.current.applyOptions({width:b.current.clientWidth})};return window.addEventListener("resize",K),()=>window.removeEventListener("resize",K)},[h]),r.useEffect(()=>()=>{g.current&&(g.current.remove(),g.current=null),N.current&&(N.current.remove(),N.current=null)},[]);const le=async t=>{try{await Re(t),M.success("Alert acknowledged","monitoring"),A()}catch{M.error("Failed to acknowledge alert","monitoring")}},ce=()=>{window.open(Ae(24),"_blank"),M.success("Exporting metrics to CSV","monitoring")};return ae?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(ee,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"System Health Monitor"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Real-time infrastructure monitoring â€¢ Updates every 10 seconds"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(W,{variant:"outline",size:"sm",onClick:()=>A(!0),disabled:Y,children:[e.jsx(ge,{className:D("h-4 w-4 mr-2",Y&&"animate-spin")}),"Refresh"]}),e.jsxs(W,{variant:k?"default":"outline",size:"sm",onClick:()=>ne(!k),children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Auto: ",k?"ON":"OFF"]}),e.jsxs(W,{variant:"outline",size:"sm",onClick:ce,children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),s&&e.jsxs("div",{className:D("rounded-lg border p-4 flex items-center gap-4",s.overall_status==="pass"&&"border-green-500/50 bg-green-500/10",s.overall_status==="warn"&&"border-yellow-500/50 bg-yellow-500/10",s.overall_status==="fail"&&"border-red-500/50 bg-red-500/10"),children:[e.jsx(Q,{status:s.overall_status}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold",children:["System Status: ",s.overall_status.toUpperCase()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last updated (IST): ",te(s.timestamp)]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(_,{title:"File Descriptors",icon:ve,value:s?`${s.fd.count} / ${s.fd.limit}`:"-",subtitle:s?`${s.fd.usage_percent.toFixed(1)}% used`:void 0,status:s?.fd.status||"unknown",loading:!s}),e.jsx(_,{title:"Memory Usage",icon:be,value:s?`${s.memory.rss_mb.toFixed(1)} MB`:"-",subtitle:s?`${s.memory.percent.toFixed(1)}% of system`:void 0,status:s?.memory.status||"unknown",loading:!s}),e.jsx(_,{title:"Database Connections",icon:ye,value:s?.database.total||0,subtitle:"Active connections",status:s?.database.status||"unknown",loading:!s}),e.jsx(_,{title:"WebSocket Connections",icon:we,value:s?.websocket.total||0,subtitle:s?`${s.websocket.total_symbols} symbols`:void 0,status:s?.websocket.status||"unknown",loading:!s}),e.jsx(_,{title:"Active Threads",icon:Se,value:s?.threads.count||0,subtitle:s&&s.threads.stuck>0?`${s.threads.stuck} stuck`:"None stuck",status:s?.threads.status||"unknown",loading:!s})]}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs(d,{children:[e.jsxs(x,{children:[e.jsx(u,{className:"text-lg",children:"File Descriptors (6h)"}),e.jsx(S,{children:"Historical FD usage over the last 6 hours"})]}),e.jsx(o,{children:e.jsx("div",{ref:v,className:"w-full h-[300px]"})})]}),e.jsxs(d,{children:[e.jsxs(x,{children:[e.jsx(u,{className:"text-lg",children:"Memory Usage (6h)"}),e.jsx(S,{children:"Historical memory consumption in MB over the last 6 hours"})]}),e.jsx(o,{children:e.jsx("div",{ref:b,className:"w-full h-[300px]"})})]})]}),a&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(d,{children:[e.jsx(x,{className:"pb-3",children:e.jsx(u,{className:"text-base",children:"File Descriptor Stats"})}),e.jsx(o,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Current:"}),e.jsx("dd",{className:"font-medium",children:a.fd.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Average:"}),e.jsx("dd",{className:"font-medium",children:a.fd.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Min / Max:"}),e.jsxs("dd",{className:"font-medium",children:[a.fd.min," / ",a.fd.max]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Warnings:"}),e.jsx("dd",{className:"font-medium text-yellow-600 dark:text-yellow-400",children:a.fd.warn_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Failures:"}),e.jsx("dd",{className:"font-medium text-red-600 dark:text-red-400",children:a.fd.fail_count})]})]})})]}),e.jsxs(d,{children:[e.jsx(x,{className:"pb-3",children:e.jsx(u,{className:"text-base",children:"Memory Stats"})}),e.jsx(o,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Current:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.current_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Average:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.avg_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Min / Max:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.min_mb.toFixed(1)," / ",a.memory.max_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Warnings:"}),e.jsx("dd",{className:"font-medium text-yellow-600 dark:text-yellow-400",children:a.memory.warn_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Failures:"}),e.jsx("dd",{className:"font-medium text-red-600 dark:text-red-400",children:a.memory.fail_count})]})]})})]}),e.jsxs(d,{children:[e.jsx(x,{className:"pb-3",children:e.jsx(u,{className:"text-base",children:"Connection Stats"})}),e.jsx(o,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Current:"}),e.jsx("dd",{className:"font-medium",children:a.database.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Average:"}),e.jsx("dd",{className:"font-medium",children:a.database.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Current:"}),e.jsx("dd",{className:"font-medium",children:a.websocket.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Average:"}),e.jsx("dd",{className:"font-medium",children:a.websocket.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Threads:"}),e.jsx("dd",{className:"font-medium",children:a.threads.current})]})]})})]}),e.jsxs(d,{children:[e.jsx(x,{className:"pb-3",children:e.jsx(u,{className:"text-base",children:"Status Summary"})}),e.jsx(o,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Overall (Pass/Warn/Fail):"}),e.jsx("dd",{className:"font-medium",children:a.status?.overall?`${a.status.overall.pass}/${a.status.overall.warn}/${a.status.overall.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.database?`${a.status.database.warn}/${a.status.database.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.websocket?`${a.status.websocket.warn}/${a.status.websocket.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Threads Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.threads?`${a.status.threads.warn}/${a.status.threads.fail}`:"-"})]})]})})]})]}),e.jsxs(d,{children:[e.jsxs(x,{children:[e.jsx(u,{className:"text-lg",children:"Top Memory Processes"}),e.jsx(S,{children:"Highest RSS memory usage across the host"})]}),e.jsx(o,{children:s?.processes&&s.processes.length>0?e.jsxs(V,{children:[e.jsx(z,{children:e.jsxs(C,{children:[e.jsx(l,{children:"Process"}),e.jsx(l,{className:"text-right",children:"PID"}),e.jsx(l,{className:"text-right",children:"RSS (MB)"}),e.jsx(l,{className:"text-right",children:"VMS (MB)"}),e.jsx(l,{className:"text-right",children:"Mem %"})]})}),e.jsx(P,{children:s.processes.map(t=>e.jsxs(C,{children:[e.jsx(c,{className:"font-medium",children:t.name}),e.jsx(c,{className:"text-right font-mono text-xs",children:t.pid??"-"}),e.jsx(c,{className:"text-right",children:t.rss_mb.toFixed(1)}),e.jsx(c,{className:"text-right",children:t.vms_mb.toFixed(1)}),e.jsx(c,{className:"text-right",children:t.memory_percent.toFixed(2)})]},`${t.pid}-${t.name}`))})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No process data available."})})]}),e.jsxs(d,{children:[e.jsxs(x,{children:[e.jsx(u,{className:"text-lg",children:"Thread Details"}),e.jsx(S,{children:"Recent thread snapshot from the application"})]}),e.jsx(o,{children:s?.threads.details&&s.threads.details.length>0?e.jsxs(V,{children:[e.jsx(z,{children:e.jsxs(C,{children:[e.jsx(l,{children:"Thread"}),e.jsx(l,{className:"text-right",children:"ID"}),e.jsx(l,{className:"text-right",children:"Daemon"}),e.jsx(l,{className:"text-right",children:"Alive"})]})}),e.jsx(P,{children:s.threads.details.map(t=>e.jsxs(C,{children:[e.jsx(c,{className:"font-medium",children:t.name}),e.jsx(c,{className:"text-right font-mono text-xs",children:t.id??"-"}),e.jsx(c,{className:"text-right",children:t.daemon?"Yes":"No"}),e.jsx(c,{className:"text-right",children:t.alive?"Yes":"No"})]},`${t.id}-${t.name}`))})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No thread details available."})})]}),T.length>0&&e.jsxs(d,{className:"border-destructive/50",children:[e.jsxs(x,{children:[e.jsxs(u,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(se,{className:"h-5 w-5"}),"Active Alerts (",T.length,")"]}),e.jsx(S,{children:"System health alerts requiring attention"})]}),e.jsx(o,{children:e.jsx("div",{className:"space-y-3",children:T.map(t=>e.jsxs("div",{className:D("rounded-lg border p-3 flex items-start justify-between gap-4",t.severity==="fail"&&"border-red-500/50 bg-red-500/10",t.severity==="warn"&&"border-yellow-500/50 bg-yellow-500/10"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Q,{status:t.severity}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.alert_type.replace(/_/g," ").toUpperCase()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})]})]}),!t.acknowledged&&e.jsx(W,{variant:"outline",size:"sm",onClick:()=>le(t.id),children:"Acknowledge"})]},t.id))})})]}),e.jsxs(d,{children:[e.jsxs(x,{children:[e.jsx(u,{className:"text-lg",children:"Recent Metrics"}),e.jsx(S,{children:"Last 20 samples from the monitoring system"})]}),e.jsx(o,{children:e.jsxs(V,{children:[e.jsx(z,{children:e.jsxs(C,{children:[e.jsx(l,{children:"Time"}),e.jsx(l,{className:"text-right",children:"FDs"}),e.jsx(l,{className:"text-right",children:"Memory (MB)"}),e.jsx(l,{className:"text-right",children:"DB Conns"}),e.jsx(l,{className:"text-right",children:"WS Conns"}),e.jsx(l,{className:"text-right",children:"Threads"}),e.jsx(l,{children:"Status"})]})}),e.jsx(P,{children:h.slice(-20).reverse().map((t,p)=>e.jsxs(C,{children:[e.jsx(c,{className:"font-mono text-xs",children:Ie(t.timestamp)}),e.jsx(c,{className:"text-right",children:t.fd_count}),e.jsx(c,{className:"text-right",children:t.memory_rss_mb.toFixed(1)}),e.jsx(c,{className:"text-right",children:t.db_connections}),e.jsx(c,{className:"text-right",children:t.ws_connections}),e.jsx(c,{className:"text-right",children:t.threads}),e.jsx(c,{children:e.jsx(je,{variant:t.overall_status==="pass"?"default":t.overall_status==="warn"?"secondary":"destructive",children:t.overall_status})})]},p))})]})})]})]})}export{Ke as default};
