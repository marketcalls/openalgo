import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as he,d as _e,t as y,c as J,B as p,e as R,D as Be,h as Qe,i as qe,p as Je,j as G,k as Ge,m as Ze}from"./index-B2ztJKGu.js";import{C as I,a as L}from"./card-Cb9BEsKk.js";import{P as Ke,a as Xe,b as es,C as ss,c as ts,d as as,e as rs,f as ns,g as ls}from"./popover-Bwekb3tB.js";import{I as Z}from"./input--oaNj1eO.js";import{S as xe,a as ge,b as fe,c as pe,d as j}from"./select-B5rwM_zW.js";import{q as os,K as cs,W as is,R as ds,V as ms}from"./lightweight-charts.production-BQUuleWj.js";import{A as us,D as je,S as hs,ai as xs,R as gs,Z as ve,g as Se,L as fs,k as ps,l as js,aF as vs,aG as Ss,N as bs,m as Ns,n as ws}from"./vendor-icons-D08EYFn4.js";import{a as Cs,c as ys,d as Ms,L as K}from"./vendor-router-DdyOoyPF.js";import"./vendor-radix-Cue1hf3Z.js";function Os(){const O=Cs(),{mode:U,toggleMode:be,appMode:h,toggleAppMode:Ne,isTogglingMode:X}=he(),{user:A,logout:ee}=_e(),i=U==="dark"||h==="analyzer",{symbol:we}=ys(),[se,te]=Ms(),Ce=async()=>{try{await Ze.logout(),ee(),O("/login"),y.success("Logged out successfully")}catch{ee(),O("/login")}},ae=async()=>{const s=await Ne();if(s.success){const a=he.getState().appMode;y.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`)}else y.error(s.message||"Failed to toggle mode")},[M,ye]=t.useState([]),[re,ne]=t.useState(!1),[V,P]=t.useState(!1),[l,Me]=t.useState(we||""),[o,De]=t.useState(se.get("exchange")||"NSE"),[m,Ie]=t.useState(se.get("interval")||"D"),[Le,le]=t.useState(!1),[k,oe]=t.useState(""),[x,ce]=t.useState(!1),[T,ke]=t.useState("25"),[d,Te]=t.useState("m"),[H,Ee]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[W,ze]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,$e]=t.useState([]),[E,Fe]=t.useState(null),g=t.useRef(null),u=t.useRef(null),Re=t.useRef(null),Oe=t.useRef(null),Ue=["1m","2m","3m","5m","10m","15m","30m","1h","2h","4h","D","W","M","Q","Y"],S=t.useMemo(()=>{if(x){if(["W","M","Q","Y"].includes(d)){const s=parseInt(T)||1;return s===1?d:`${s}${d}`}return`${T}${d}`}return m},[x,T,d,m]),ie=t.useMemo(()=>!!(["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(S)||x&&["m","h"].includes(d)),[S,x,d]),Y=t.useMemo(()=>{const s=new Map;return M.forEach(a=>{const c=`${a.symbol}:${a.exchange}`;s.has(c)?s.get(c).intervals.push(a.interval):s.set(c,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[M]),Ae=t.useMemo(()=>{if(!k)return Y;const s=k.toLowerCase();return Y.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[Y,k]);t.useEffect(()=>{Ve()},[]),t.useEffect(()=>{l&&o&&m&&te({exchange:o,interval:m})},[l,o,m,te]),t.useEffect(()=>{l&&o&&S&&(de(),Pe())},[l,o,S]),t.useEffect(()=>{if(!g.current)return;const s=setTimeout(()=>{if(!g.current)return;u.current&&(u.current.remove(),u.current=null);const b=g.current,z=b.offsetWidth||800,$=b.offsetHeight||600,_=ie,me=x&&["W","M","Q","Y"].includes(d),Ye=D=>{const N=new Date(D*1e3),n=me?0:5.5*60*60*1e3,v=new Date(N.getTime()+n),f=v.getUTCDate().toString().padStart(2,"0"),w=(v.getUTCMonth()+1).toString().padStart(2,"0"),C=v.getUTCFullYear().toString().slice(-2),Q=v.getUTCHours().toString().padStart(2,"0"),q=v.getUTCMinutes().toString().padStart(2,"0");return _?`${f}/${w}/${C} ${Q}:${q}`:`${f}/${w}/${C}`},F=os(b,{width:z,height:Math.max($,500),layout:{background:{type:is.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:Ye},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:_,secondsVisible:!1,tickMarkFormatter:(D,N)=>{const n=new Date(D*1e3),v=me?0:5.5*60*60*1e3,f=new Date(n.getTime()+v);if(_){const w=f.getUTCHours().toString().padStart(2,"0"),C=f.getUTCMinutes().toString().padStart(2,"0");return`${w}:${C}`}else{const w=f.getUTCDate(),C=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Q=f.getUTCMonth(),q=f.getUTCFullYear();return N===0?q.toString():N===1?C[Q]:w.toString()}}},crosshair:{mode:cs.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),ue=F.addSeries(ds,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),B=F.addSeries(ms,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(B.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),u.current=F,Re.current=ue,Oe.current=B,r.length>0){const D=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));ue.setData(D);const N=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));B.setData(N),F.timeScale().fitContent()}},100),a=()=>{if(u.current&&g.current){const b=g.current,z=b.offsetWidth,$=b.offsetHeight;z>0&&$>0&&u.current.applyOptions({width:z,height:$})}},c=new ResizeObserver(a);return g.current&&c.observe(g.current),window.addEventListener("resize",a),()=>{clearTimeout(s),c.disconnect(),window.removeEventListener("resize",a),u.current&&(u.current.remove(),u.current=null)}},[i,r,V,ie,x,d]);const Ve=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&ye(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},de=t.useCallback(async()=>{if(!(!l||!o)){ne(!0);try{const s=new URLSearchParams({symbol:l,exchange:o,interval:S,start_date:H,end_date:W}),c=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();c.status==="success"?($e(c.data||[]),c.count===0&&y.info("No data available for this range. Make sure 1m data is downloaded for custom intervals.")):y.error(c.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),y.error("Failed to load chart data")}finally{ne(!1)}}},[l,o,S,H,W]),Pe=t.useCallback(()=>{const s=M.find(a=>a.symbol===l&&a.exchange===o&&a.interval===m);Fe(s||null)},[M,l,o,m]),He=(s,a)=>{Me(s),De(a),le(!1),oe("")},We=()=>{document.fullscreenElement?(document.exitFullscreen(),P(!1)):(document.documentElement.requestFullscreen(),P(!0))};return t.useEffect(()=>{const s=()=>{P(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:J("h-full flex flex-col bg-background text-foreground",V&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(p,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(K,{to:"/historify",children:e.jsx(us,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(Ke,{open:Le,onOpenChange:le,children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:"w-64 justify-between",children:[l?e.jsxs("span",{children:[l,":",o]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(hs,{className:"h-4 w-4 ml-2"})]})}),e.jsx(es,{className:"w-64 p-0",align:"start",children:e.jsxs(ss,{children:[e.jsx(ts,{placeholder:"Search symbols...",value:k,onValueChange:oe}),e.jsxs(as,{children:[e.jsx(rs,{children:"No symbols found"}),e.jsx(ns,{children:Ae.slice(0,20).map(s=>e.jsxs(ls,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>He(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(R,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(xe,{value:x?"custom":m,onValueChange:s=>{s==="custom"?ce(!0):(ce(!1),Ie(s))},children:[e.jsx(ge,{className:"w-24",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[Ue.map(s=>e.jsx(j,{value:s,children:s},s)),e.jsx(j,{value:"custom",children:"Custom"})]})]}),x&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Z,{type:"number",min:"1",max:"999",value:T,onChange:s=>ke(s.target.value),className:"h-9 w-14 text-center",placeholder:"1"}),e.jsxs(xe,{value:d,onValueChange:s=>Te(s),children:[e.jsx(ge,{className:"w-20 h-9",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[e.jsx(j,{value:"m",children:"min"}),e.jsx(j,{value:"h",children:"hr"}),e.jsx(j,{value:"W",children:"Week"}),e.jsx(j,{value:"MO",children:"Month"}),e.jsx(j,{value:"Q",children:"Qtr"}),e.jsx(j,{value:"Y",children:"Year"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Z,{type:"date",value:H,onChange:s=>Ee(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(Z,{type:"date",value:W,onChange:s=>ze(s.target.value),className:"h-9 w-36"})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:de,disabled:re,children:e.jsx(gs,{className:J("h-4 w-4",re&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[A?.broker&&e.jsx(R,{variant:"outline",className:"text-xs",children:A.broker.toUpperCase()}),e.jsxs(R,{variant:h==="live"?"default":"secondary",className:J("text-xs cursor-pointer",h==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:ae,children:[h==="live"?e.jsx(ve,{className:"h-3 w-3 mr-1"}):e.jsx(Se,{className:"h-3 w-3 mr-1"}),h==="live"?"Live":"Analyze"]}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:ae,disabled:X,title:`Switch to ${h==="live"?"Analyze":"Live"} mode`,children:X?e.jsx(fs,{className:"h-4 w-4 animate-spin"}):h==="live"?e.jsx(ve,{className:"h-4 w-4"}):e.jsx(Se,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:be,disabled:h!=="live",title:U==="light"?"Switch to dark mode":"Switch to light mode",children:U==="light"?e.jsx(ps,{className:"h-4 w-4"}):e.jsx(js,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:We,children:V?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(K,{to:"/dashboard",children:[e.jsx(bs,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Be,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:A?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(qe,{align:"end",className:"w-56",children:[Je.map(s=>e.jsxs(G,{onSelect:()=>O(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(G,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(Ns,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Ge,{}),e.jsxs(G,{onClick:Ce,className:"text-destructive focus:text-destructive",children:[e.jsx(ws,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:l?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[l,":",o]}),e.jsx(R,{variant:"outline",children:m}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),E&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",E.first_date," - ",E.last_date]}),e.jsxs("span",{children:[E.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:g,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(I,{children:e.jsxs(L,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(I,{children:e.jsxs(L,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(I,{children:e.jsxs(L,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(I,{children:e.jsxs(L,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(I,{children:e.jsxs(L,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(je,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),M.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(K,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Os as default};
