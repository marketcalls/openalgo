import{r as i}from"./vendor-react--vsXx8_n.js";import{t as T}from"./trading-BnsD0Zhr.js";import{u as V,a as U}from"./useMarketStatus-BGHprHsG.js";import{d as W,g as K}from"./index-JRPYi7nR.js";function Y(t,g={}){const{enabled:n=!0,staleThreshold:c=5e3,useMultiQuotesFallback:s=!0,multiQuotesRefreshInterval:p=3e4,pauseWhenHidden:l=!0,pauseDelay:y=5e3}=g,{apiKey:d}=W(),{isMarketOpen:M,isAnyMarketOpen:A}=V(),{isVisible:b,wasHidden:q,timeSinceHidden:Q}=K(),S=A(),[k,C]=i.useState(new Map),D=i.useRef(Date.now()),H=i.useMemo(()=>t.map(e=>({symbol:e.symbol,exchange:e.exchange})),[t]),{data:m,isConnected:E,isPaused:L,isFallbackMode:I}=U({symbols:H,mode:"LTP",enabled:n&&t.length>0,pauseWhenHidden:l,pauseDelay:y}),$=E&&S&&!L,f=i.useCallback(async()=>{if(!(!d||t.length===0||!s))try{const e=t.map(a=>({symbol:a.symbol,exchange:a.exchange})),h=await T.getMultiQuotes(d,e);if(h.status==="success"&&h.results){const a=new Map;h.results.forEach(o=>{const r=`${o.exchange}:${o.symbol}`;o.data&&a.set(r,o.data)}),C(a)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[d,t,s]);return i.useEffect(()=>{if(!n||t.length===0||!s||l&&!b)return;f(),D.current=Date.now();const e=setInterval(()=>{f(),D.current=Date.now()},p);return()=>clearInterval(e)},[n,t.length,s,f,p,l,b]),i.useEffect(()=>{!q||!b||!s||!n||Q>p&&(f(),D.current=Date.now())},[q,b,Q,p,s,n,f]),{data:i.useMemo(()=>t.map(e=>{const h=`${e.exchange}:${e.symbol}`,a=m.get(h),o=k.get(h),r=e.quantity||0,v=e.average_price||0,O=M(e.exchange)&&a?.data?.ltp&&a.lastUpdate&&Date.now()-a.lastUpdate<c,z=!O&&o?.ltp;let u,P="rest";if(O&&a?.data?.ltp?(u=a.data.ltp,P="websocket"):z&&o?.ltp?(u=o.ltp,P="multiquotes"):(u=e.ltp,P="rest"),r===0)return{...e,_dataSource:"rest"};let w=e.pnl||0,_=e.pnlpercent||0;const F=e.today_realized_pnl||0;if(u&&v>0){let x;r>0?x=(u-v)*r:x=(v-u)*Math.abs(r),w=F+x;const R=Math.abs(v*r);_=R>0?w/R*100:0}return{...e,ltp:u,pnl:w,pnlpercent:_,_dataSource:P}}),[t,m,k,M,c]),isLive:$,isConnected:E,isPaused:L,isFallbackMode:I,isAnyMarketOpen:S,multiQuotes:k,refreshMultiQuotes:f}}function Z(t,g){if(!g)return null;let n=0,c=0,s=0;t.forEach(l=>{n+=l.pnl||0;const y=l.average_price||0,d=l.quantity||0,M=l.ltp||y;c+=y*d,s+=M*d});const p=c>0?n/c*100:0;return{...g,totalholdingvalue:s,totalinvvalue:c,totalprofitandloss:n,totalpnlpercentage:p}}export{Z as c,Y as u};
