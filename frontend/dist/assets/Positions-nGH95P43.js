import{r as l,j as e,a as we}from"./vendor-react-CCyQGCED.js";import{d as Ce,g as Se,o as Pe,e as N,B as f,c as x,s as D,h as w}from"./index-D0023jFM.js";import{t as Q}from"./trading-L0e-hk9o.js";import{A as ke,a as De}from"./alert-Dlgyh2fF.js";import{A as Te,a as Ee,b as Ae,c as Fe,d as Le,e as Oe,f as Re,g as Me,h as qe}from"./alert-dialog-BDgJ3H--.js";import{C as T,a as q,c as I,b as _,d as Ie}from"./card-CDguRyHx.js";import{D as _e,a as Ge,b as Be,c as He,d as Ue,e as $e,f as ze}from"./dialog-ZgnPSmJp.js";import{L as G}from"./label-BgxgrBuS.js";import{T as We,a as Ve,b as B,c as E,d as Xe,e as o,f as Qe}from"./table-BKP8E0nV.js";import{u as Je}from"./useLivePrice-5EMecDCh.js";import{T as Ye,$ as Ze,a0 as Ke,a1 as es,Y as ss,u as ts,X as ce,L as rs,n as as,a2 as ns,c as ls,a3 as is,a4 as cs}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";import"./useMarketStatus-B5zaupYn.js";const oe="openalgo_positions_prefs";function A(c){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(c)}function os(c,y){if(y==="NSE"||y==="BSE")return{underlying:c,expiry:null,strike:null,optionType:null};const v=c.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})FUT$/i);if(v)return{underlying:v[1],expiry:v[2],strike:null,optionType:"FUT"};const j=c.match(/^(.+?)(\d{1,2}[A-Z]{3}\d{2})(\d+\.?\d*)(CE|PE)$/i);return j?{underlying:j[1],expiry:j[2],strike:j[3],optionType:j[4]}:{underlying:c,expiry:null,strike:null,optionType:null}}function S(c){const y=Number(c.average_price)||0,v=Number(c.quantity)||0,j=Number(c.pnl)||0;if(c.pnlpercent!==void 0&&c.pnlpercent!==null)return Number(c.pnlpercent)||0;if(y===0)return 0;if(v!==0){const P=Math.abs(y*v);return P>0?j/P*100:0}return 0}const ds={NSE:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",BSE:"bg-slate-500/20 text-slate-600 border-slate-500/30",NFO:"bg-purple-500/20 text-purple-600 border-purple-500/30",BFO:"bg-amber-500/20 text-amber-600 border-amber-500/30",MCX:"bg-blue-500/20 text-blue-600 border-blue-500/30",CDS:"bg-teal-500/20 text-teal-600 border-teal-500/30"},xs={CNC:"bg-purple-500/20 text-purple-600 border-purple-500/30",MIS:"bg-cyan-500/20 text-cyan-600 border-cyan-500/30",NRML:"bg-slate-500/20 text-slate-600 border-slate-500/30"};function ks(){const{apiKey:c}=Ce(),[y,v]=l.useState([]),[j,P]=l.useState(!0),[J,Y]=l.useState(!1),[Z,H]=l.useState(null),[de,K]=l.useState(!1),{isVisible:F,wasHidden:ee,timeSinceHidden:se}=Se(),L=l.useRef(Date.now()),[d,U]=l.useState("none"),[i,$]=l.useState({product:[],direction:[],exchange:[]}),[xe,z]=l.useState(new Set),[O,ue]=l.useState(null),[R,te]=l.useState("asc"),[me,re]=l.useState(!1),{data:ae,isLive:W,isPaused:he}=Je(y,{enabled:y.length>0,useMultiQuotesFallback:!0,staleThreshold:5e3,multiQuotesRefreshInterval:3e4,pauseWhenHidden:!0});l.useEffect(()=>{try{const s=localStorage.getItem(oe);if(s){const t=JSON.parse(s);t.grouping&&U(t.grouping),t.filters&&$({product:t.filters.product||[],direction:t.filters.direction||[],exchange:t.filters.exchange||[]})}}catch{}},[]);const ne=l.useCallback(()=>{localStorage.setItem(oe,JSON.stringify({grouping:d,filters:i}))},[d,i]);l.useEffect(()=>{ne()},[ne]);const p=l.useCallback(async(s=!1)=>{if(!c){P(!1);return}s&&Y(!0);try{const t=await Q.getPositions(c);t.status==="success"&&t.data?(v(t.data),H(null)):H(t.message||"Failed to fetch positions")}catch{H("Failed to fetch positions")}finally{P(!1),Y(!1)}},[c]);l.useEffect(()=>{if(!F)return;p(),L.current=Date.now();const t=setInterval(()=>{p(),L.current=Date.now()},W?3e4:1e4);return()=>clearInterval(t)},[p,W,F]),l.useEffect(()=>{if(!ee||!F)return;const s=Date.now()-L.current;if(se>3e4||s>3e4){K(!0),p(),L.current=Date.now();const t=setTimeout(()=>K(!1),5e3);return()=>clearTimeout(t)}},[ee,F,se,p]),l.useEffect(()=>{const s=Pe(()=>{p()});return()=>s()},[p]);const le=l.useCallback(s=>{const t=s.exchange,r=s.product;if(t==="NSE"||t==="BSE"){if(r==="CNC")return"Equity (Delivery)";if(r==="MIS")return"Equity (Intraday)"}const a=os(s.symbol,t);return d==="underlying"?a.underlying:d==="underlying_expiry"&&a.expiry?`${a.underlying} - ${a.expiry}`:a.underlying},[d]),b=l.useMemo(()=>ae.filter(s=>{if(i.product.length>0&&!i.product.includes(s.product))return!1;const t=s.quantity||0;if(i.direction.length>0){const r=t>0,a=t<0;if(i.direction.includes("LONG")&&!i.direction.includes("SHORT")&&!r||i.direction.includes("SHORT")&&!i.direction.includes("LONG")&&!a)return!1}return!(i.exchange.length>0&&!i.exchange.includes(s.exchange))}),[ae,i]),V=l.useMemo(()=>O===null?b:[...b].sort((s,t)=>{let r,a;switch(O){case 0:r=s.symbol,a=t.symbol;break;case 3:r=s.quantity||0,a=t.quantity||0;break;case 4:r=s.average_price||0,a=t.average_price||0;break;case 6:r=s.pnl||0,a=t.pnl||0;break;case 7:r=S(s),a=S(t);break;default:return 0}return typeof r=="string"?R==="asc"?r.localeCompare(a):a.localeCompare(r):R==="asc"?r-a:a-r}),[b,O,R]),ie=l.useMemo(()=>{if(d==="none")return{_all:V};const s={};return V.forEach(t=>{const r=le(t);s[r]||(s[r]=[]),s[r].push(t)}),s},[V,d,le]),g=l.useMemo(()=>{const s=b.filter(n=>(n.quantity||0)>0).length,t=b.filter(n=>(n.quantity||0)<0).length,r=s+t,a=b.reduce((n,h)=>n+(h.pnl||0),0);return{total:r,long:s,short:t,totalPnl:a}},[b]),pe=s=>{O===s?te(R==="asc"?"desc":"asc"):(ue(s),te("asc"))},ge=(s,t)=>{$(r=>{const a=r[s];return a.indexOf(t)>-1?{...r,[s]:a.filter(h=>h!==t)}:{...r,[s]:[...a,t]}})},X=()=>{$({product:[],direction:[],exchange:[]}),U("none"),z(new Set)},fe=s=>{z(t=>{const r=new Set(t);return r.has(s)?r.delete(s):r.add(s),r})},M=i.product.length>0||i.direction.length>0||i.exchange.length>0||d!=="none",je=async s=>{try{const t=await Q.closePosition(s.symbol,s.exchange,s.product);t.status==="success"?(D.success(t.message||`Position closed for ${s.symbol}`,"positions"),p(!0)):D.error(t.message||"Failed to close position","positions")}catch{D.error("Failed to close position","positions")}},be=async()=>{try{const s=await Q.closeAllPositions();s.status==="success"?p(!0):D.error(s.message||"Failed to close all positions","positions")}catch{D.error("Failed to close all positions","positions")}},Ne=()=>{const s=["Symbol","Exchange","Product","Quantity","Avg Price","LTP","P&L","P&L %"],t=b.map(u=>[w(u.symbol),w(u.exchange),w(u.product),w(u.quantity),w(u.average_price),w(u.ltp),w(u.pnl),w(S(u))]),r=[s,...t].map(u=>u.join(",")).join(`
`),a=new Blob([r],{type:"text/csv"}),n=URL.createObjectURL(a),h=document.createElement("a");h.href=n,h.download=`positions_${new Date().toISOString().split("T")[0]}.csv`,h.click(),URL.revokeObjectURL(n)},C=s=>s>=0,m=({type:s,value:t,label:r})=>e.jsx(f,{variant:i[s].includes(t)?"default":"outline",size:"sm",className:x("rounded-full",i[s].includes(t)&&"bg-pink-500 hover:bg-pink-600"),onClick:()=>ge(s,t),children:r}),k=({column:s,label:t,className:r})=>e.jsx(E,{className:x("cursor-pointer hover:bg-muted/50 select-none",r),onClick:()=>pe(s),children:e.jsxs("div",{className:x("flex items-center gap-1 w-full",r?.includes("text-right")&&"justify-end"),children:[t,e.jsx(cs,{className:"h-3 w-3 opacity-50"})]})}),ye=s=>{let t=0,r=0;s.forEach(n=>{t+=n.pnl||0;const h=n.average_price||0,u=Math.abs(n.quantity||0);r+=h*u});const a=r>0?t/r*100:0;return{totalPnl:t,pnlPercent:a,count:s.length}},ve=Object.keys(ie).sort((s,t)=>s.startsWith("Equity")&&!t.startsWith("Equity")?-1:!s.startsWith("Equity")&&t.startsWith("Equity")?1:s.localeCompare(t));return e.jsxs("div",{className:"space-y-6",children:[de&&e.jsxs(ke,{variant:"default",className:"bg-amber-500/10 border-amber-500/30",children:[e.jsx(Ye,{className:"h-4 w-4 text-amber-600"}),e.jsx(De,{className:"text-amber-700 dark:text-amber-400",children:"Data is being refreshed after tab was inactive..."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Positions"}),he?e.jsxs(N,{variant:"outline",className:"bg-amber-500/10 text-amber-600 border-amber-500/30 gap-1",children:[e.jsx(Ze,{className:"h-3 w-3"}),"Paused"]}):W?e.jsxs(N,{variant:"outline",className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/30 gap-1",children:[e.jsx(Ke,{className:"h-3 w-3 animate-pulse"}),"Live"]}):null]}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor and manage your active trading positions"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(_e,{open:me,onOpenChange:re,children:[e.jsx(Ge,{asChild:!0,children:e.jsxs(f,{variant:M?"default":"outline",size:"sm",className:"relative",children:[e.jsx(es,{className:"h-4 w-4 mr-2"}),"Settings",M&&e.jsx("span",{className:"absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full"})]})}),e.jsxs(Be,{className:"max-w-md",children:[e.jsxs(He,{children:[e.jsx(Ue,{children:"Position Settings"}),e.jsx($e,{children:"Configure grouping and filters"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(G,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Grouping"}),e.jsx("div",{className:"space-y-2",children:[{value:"none",label:"None"},{value:"underlying",label:"Underlying"},{value:"underlying_expiry",label:"Underlying & Expiry"}].map(s=>e.jsxs("label",{className:x("flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-muted",d===s.value&&"bg-pink-500/10 border border-pink-500/30"),children:[e.jsx("input",{type:"radio",name:"grouping",checked:d===s.value,onChange:()=>{U(s.value),z(new Set)},className:"accent-pink-500"}),e.jsx("span",{className:x(d===s.value&&"text-pink-500 font-semibold"),children:s.label})]},s.value))})]}),e.jsx("div",{className:"border-t"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(G,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Product Type"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(m,{type:"product",value:"CNC",label:"CNC"}),e.jsx(m,{type:"product",value:"MIS",label:"MIS"}),e.jsx(m,{type:"product",value:"NRML",label:"NRML"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(G,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Direction"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(m,{type:"direction",value:"LONG",label:"Long"}),e.jsx(m,{type:"direction",value:"SHORT",label:"Short"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(G,{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Exchange"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(m,{type:"exchange",value:"NSE",label:"NSE"}),e.jsx(m,{type:"exchange",value:"BSE",label:"BSE"}),e.jsx(m,{type:"exchange",value:"NFO",label:"NFO"}),e.jsx(m,{type:"exchange",value:"BFO",label:"BFO"}),e.jsx(m,{type:"exchange",value:"MCX",label:"MCX"}),e.jsx(m,{type:"exchange",value:"CDS",label:"CDS"})]})]})]}),e.jsxs(ze,{children:[e.jsx(f,{variant:"ghost",onClick:X,children:"Clear All"}),e.jsx(f,{onClick:()=>re(!1),children:"Done"})]})]})]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>p(!0),disabled:J,children:[e.jsx(ss,{className:x("h-4 w-4 mr-2",J&&"animate-spin")}),"Refresh"]}),e.jsxs(f,{variant:"outline",size:"sm",onClick:Ne,children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),"Export"]}),e.jsxs(Te,{children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(f,{variant:"destructive",size:"sm",disabled:g.total===0,children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Close All"]})}),e.jsxs(Ae,{children:[e.jsxs(Fe,{children:[e.jsx(Le,{children:"Close All Positions?"}),e.jsxs(Oe,{children:["This will close all ",g.total," open positions at market price. This action cannot be undone."]})]}),e.jsxs(Re,{children:[e.jsx(Me,{children:"Cancel"}),e.jsx(qe,{onClick:be,children:"Close All"})]})]})]})]})]}),M&&e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Active Filters:"}),d!=="none"&&e.jsxs(N,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:["Grouped: ",d==="underlying"?"Underlying":"Underlying & Expiry"]}),i.product.map(s=>e.jsx(N,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),i.direction.map(s=>e.jsx(N,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),i.exchange.map(s=>e.jsx(N,{variant:"secondary",className:"bg-pink-500/10 text-pink-600 border-pink-500/30",children:s},s)),e.jsx(f,{variant:"outline",size:"sm",className:"text-red-500 border-red-500/50 hover:bg-red-500/10",onClick:X,children:"Clear All"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(T,{children:e.jsxs(q,{className:"pb-2",children:[e.jsx(I,{children:"Open Positions"}),e.jsx(_,{className:"text-2xl",children:g.total})]})}),e.jsx(T,{children:e.jsxs(q,{className:"pb-2",children:[e.jsx(I,{children:"Long"}),e.jsx(_,{className:"text-2xl text-green-600",children:g.long})]})}),e.jsx(T,{children:e.jsxs(q,{className:"pb-2",children:[e.jsx(I,{children:"Short"}),e.jsx(_,{className:"text-2xl text-red-600",children:g.short})]})}),e.jsx(T,{children:e.jsxs(q,{className:"pb-2",children:[e.jsx(I,{children:"Total P&L"}),e.jsx(_,{className:x("text-2xl",C(g.totalPnl)?"text-green-600":"text-red-600"),children:A(g.totalPnl)})]})})]}),e.jsx(T,{children:e.jsx(Ie,{className:"p-0",children:j?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(rs,{className:"h-8 w-8 animate-spin"})}):Z?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:Z}):b.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx("p",{className:"mb-4",children:"No positions match your filters"}),M&&e.jsx(f,{variant:"ghost",size:"sm",onClick:X,children:"Clear Filters"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(We,{children:[e.jsx(Ve,{children:e.jsxs(B,{children:[e.jsx(k,{column:0,label:"Symbol",className:"w-[140px]"}),e.jsx(E,{className:"w-[80px]",children:"Exchange"}),e.jsx(E,{className:"w-[80px]",children:"Product"}),e.jsx(k,{column:3,label:"Qty",className:"w-[80px] text-right"}),e.jsx(k,{column:4,label:"Avg Price",className:"w-[120px] text-right"}),e.jsx(E,{className:"w-[120px] text-right",children:"LTP"}),e.jsx(k,{column:6,label:"P&L",className:"w-[120px] text-right"}),e.jsx(k,{column:7,label:"P&L %",className:"w-[100px] text-right"}),e.jsx(E,{className:"w-[60px] text-right",children:"Action"})]})}),e.jsx(Xe,{children:ve.map(s=>{const t=ie[s],r=xe.has(s),a=ye(t);return e.jsxs(we.Fragment,{children:[d!=="none"&&e.jsxs(B,{className:"bg-muted/50 cursor-pointer hover:bg-muted",onClick:()=>fe(s),children:[e.jsx(o,{colSpan:6,children:e.jsxs("div",{className:"flex items-center gap-3 py-1 font-semibold",children:[r?e.jsx(as,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(ns,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s}),e.jsx(N,{variant:"outline",className:"text-xs",children:a.count})]})}),e.jsxs(o,{className:x("text-right font-bold",C(a.totalPnl)?"text-green-600":"text-red-600"),children:[a.totalPnl>=0?"+":"",a.totalPnl.toFixed(2)]}),e.jsxs(o,{className:x("text-right font-semibold",C(a.pnlPercent)?"text-green-600":"text-red-600"),children:[a.pnlPercent>=0?"+":"",a.pnlPercent.toFixed(2),"%"]}),e.jsx(o,{})]}),!r&&t.map((n,h)=>e.jsxs(B,{children:[e.jsx(o,{className:"w-[140px] font-medium",children:n.symbol}),e.jsx(o,{className:"w-[80px]",children:e.jsx(N,{variant:"outline",className:ds[n.exchange]||"",children:n.exchange})}),e.jsx(o,{className:"w-[80px]",children:e.jsx(N,{variant:"outline",className:xs[n.product]||"",children:n.product})}),e.jsx(o,{className:x("w-[80px] text-right font-medium",n.quantity>0?"text-green-600":"text-red-600"),children:n.quantity}),e.jsx(o,{className:"w-[120px] text-right font-mono",children:A(n.average_price)}),e.jsx(o,{className:"w-[120px] text-right font-mono",children:n.ltp!==void 0?A(n.ltp):"-"}),e.jsx(o,{className:x("w-[120px] text-right font-medium",C(n.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[C(n.pnl)?e.jsx(ls,{className:"h-4 w-4"}):e.jsx(is,{className:"h-4 w-4"}),A(n.pnl)]})}),e.jsxs(o,{className:x("w-[100px] text-right",C(S(n))?"text-green-600":"text-red-600"),children:[S(n)>=0?"+":"",S(n).toFixed(2),"%"]}),e.jsx(o,{className:"w-[60px] text-right",children:e.jsx(f,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>je(n),children:e.jsx(ce,{className:"h-4 w-4"})})})]},`${n.symbol}-${n.exchange}-${h}`))]},s)})}),e.jsx(Qe,{children:e.jsxs(B,{className:"bg-muted/50",children:[e.jsx(o,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsxs(o,{className:x("w-[120px] text-right font-bold",C(g.totalPnl)?"text-green-600":"text-red-600"),children:[g.totalPnl>=0?"+":"",A(g.totalPnl)]}),e.jsx(o,{colSpan:2})]})})]})})})})]})}export{ks as default};
