import{r as c,j as e,a as es}from"./vendor-react--vsXx8_n.js";import{w as re,d as Ls,B as $,t as j,e as A}from"./index-DNt4N-JN.js";import{A as Ps,b as Cs,c as Ds,d as Rs,e as Ms,f as Fs,g as As,h as Os}from"./alert-dialog-DMyv-EMo.js";import{C as ps,d as fs,a as ks,b as Us}from"./card-Dpvf5dQO.js";import{D as ss,b as ts,c as as,d as rs,e as ns,f as is}from"./dialog-DxDiEYFR.js";import{S as K,a as Z,b as J,c as ee,d as F}from"./select-Tj4QYYbK.js";import{C as ls,b as cs,a as os}from"./collapsible-BFPZ0scE.js";import{T as $s,a as Hs,b as ds,c as xs}from"./tabs-8_tqHgfY.js";import{S as us}from"./switch-CRJ_ji-Q.js";import{L as y}from"./label-C35B46J7.js";import{I as C}from"./input-CngWwNIO.js";import{T as se,a as te,b as O,c as i,d as ae,e as l}from"./table-DlhKEnAB.js";import{t as Ys}from"./trading-BAHaEXcC.js";import{u as Gs}from"./useLivePrice-Clv9qX1p.js";import{R as ms,$ as hs,k as gs,ah as Bs,c as Xs,a0 as qs,aX as Ee}from"./vendor-icons-D7CGgVJ-.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CiBIGs7t.js";import"./vendor-radix-DnptSSCf.js";async function zs(){const t=await re.get("/api/strategy-state");if(t.data.status==="error")throw new Error(t.data.message||"Failed to fetch strategy states");return t.data.data}async function Ws(t){const n=await re.delete(`/api/strategy-state/${encodeURIComponent(t)}`);if(n.data.status==="error")throw new Error(n.data.message||"Failed to delete strategy state")}async function Vs(t,n,o,x){const d=await re.post(`/api/strategy-state/${encodeURIComponent(t)}/override`,{leg_key:n,override_type:o,new_value:x});if(d.data.status==="error")throw new Error(d.data.message||"Failed to create strategy override");return{message:d.data.message||"Override created successfully"}}async function Qs(t,n){try{const o=await re.post(`/api/strategy-state/${encodeURIComponent(t)}/manual-leg`,n);if(o.data.status==="error")throw new Error(o.data.message||"Failed to add manual position");return{message:o.data.message||"Manual position added successfully"}}catch(o){if(o&&typeof o=="object"&&"response"in o){const d=o.response?.data?.message;if(d)throw new Error(d)}throw o}}async function Ks(t,n,o,x){try{const d=await re.post(`/api/strategy-state/${encodeURIComponent(t)}/leg/${encodeURIComponent(n)}/manual-exit`,{exit_price:o,exit_status:x});if(d.data.status==="error")throw new Error(d.data.message||"Failed to exit position");return{message:d.data.message||"Position exited successfully"}}catch(d){if(d&&typeof d=="object"&&"response"in d){const v=d.response?.data?.message;if(v)throw new Error(v)}throw d}}const Zs={RUNNING:"bg-green-500",PAUSED:"bg-yellow-500",COMPLETED:"bg-gray-400",ERROR:"bg-red-500"},xe={IDLE:"bg-gray-400",PENDING_ENTRY:"bg-blue-400",IN_POSITION:"bg-green-500",PENDING_EXIT:"bg-orange-400",EXITED_WAITING_REENTRY:"bg-yellow-500",EXITED_WAITING_REEXECUTE:"bg-purple-500",DONE:"bg-gray-500"},Js={SL_HIT:"bg-red-500",TARGET_HIT:"bg-green-500",HEDGE_SL_EXIT:"bg-red-400",HEDGE_TARGET_EXIT:"bg-green-400",STRATEGY_DONE:"bg-gray-500"};function et(t){if(t==null)return"â€”";const n=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(Math.abs(t));return t<0?`-${n}`:n}function T(t){return t==null?"â€”":t.toFixed(2)}function st(t){if(t.wait_trigger_price)return t.wait_trigger_price;const n=t.wait_baseline_price,o=t.wait_trade_percent;return n==null||o==null||!t.side?null:t.side==="BUY"?n*(1+o):t.side==="SELL"?n*(1-o):null}function tt(t){return t?new Date(t).toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}):"â€”"}function ue(t){if(!t)return"â€”";const n=new Date(t),o=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"})),x=new Date(o.getFullYear(),o.getMonth(),o.getDate()),d=new Date(n.toLocaleString("en-US",{timeZone:"Asia/Kolkata"})),E=new Date(d.getFullYear(),d.getMonth(),d.getDate());return x.getTime()===E.getTime()?n.toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}):n.toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"})}function k({value:t,showIcon:n=!0}){if(t==null)return e.jsx("span",{className:"text-muted-foreground",children:"-"});const o=t>=0,x=o?"text-green-600":"text-red-600";return e.jsxs("span",{className:`font-medium ${x} flex items-center gap-1`,children:[n&&(o?e.jsx(Xs,{className:"h-3 w-3"}):e.jsx(qs,{className:"h-3 w-3"})),et(t)]})}function Se(t,n){const o=t.entry_price,x=t.quantity,d=t.side;return n==null||o==null||x===null||x===void 0||!d?null:d==="BUY"?(n-o)*x:d==="SELL"?(o-n)*x:null}function at(t){return!t||t.length===0?0:t.reduce((n,o)=>n+(o.pnl||0),0)}function js({value:t,instanceId:n,legKey:o,overrideType:x,leg:d,onSuccess:E}){const[v,w]=c.useState(!1),[S,u]=c.useState(""),[a,U]=c.useState(!1),D=es.useRef(null),R=d.status==="IN_POSITION",H=()=>{R&&(u(t?.toString()??""),w(!0))};es.useEffect(()=>{v&&D.current&&(D.current.focus(),D.current.select())},[v]);const G=m=>{if(Number.isNaN(m)||m<0)return"Value must be a non-negative number";const b=d.entry_price;if(!b)return null;const I=d.side;if(x==="sl_price"){if(I==="SELL"&&m<=b)return`SL for SELL must be above entry price (${b.toFixed(2)})`;if(I==="BUY"&&m>=b)return`SL for BUY must be below entry price (${b.toFixed(2)})`}if(x==="target_price"){if(I==="SELL"&&m>=b)return`Target for SELL must be below entry price (${b.toFixed(2)})`;if(I==="BUY"&&m<=b)return`Target for BUY must be above entry price (${b.toFixed(2)})`}return null},p=async()=>{const m=Number.parseFloat(S),b=G(m);if(b){j.error(b);return}if(t!=null&&Math.abs(m-t)<.01){w(!1);return}U(!0);try{const I=await Vs(n,o,x,m);j.success(I.message),w(!1),E()}catch(I){j.error(I instanceof Error?I.message:"Failed to update")}finally{U(!1)}},f=m=>{m.key==="Enter"?(m.preventDefault(),p()):m.key==="Escape"&&w(!1)},P=()=>{w(!1)};return v?e.jsx(C,{ref:D,type:"number",step:"0.05",value:S,onChange:m=>u(m.target.value),onKeyDown:f,onBlur:P,disabled:a,className:"h-7 w-20 text-right text-sm px-1"}):e.jsx("span",{onClick:H,onKeyDown:m=>m.key==="Enter"&&H(),tabIndex:R?0:void 0,role:R?"button":void 0,className:R?"cursor-pointer hover:bg-muted px-1 py-0.5 rounded transition-colors":"",title:R?"Click to edit":void 0,children:T(t)})}function rt({legs:t,instanceId:n,onRefresh:o,liveLtpByLegKey:x,onExitLeg:d}){if(!t)return e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"});const E=Object.entries(t),v=E.filter(([u,a])=>["IN_POSITION","PENDING_EXIT"].includes(a.status)),w=E.filter(([u,a])=>["IDLE","PENDING_ENTRY","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(a.status)),S=E.filter(([u,a])=>a.status==="DONE");return E.length===0?e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"}):e.jsxs("div",{className:"space-y-4",children:[v.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4 text-green-500"}),"Open Positions (",v.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(i,{children:"Leg"}),e.jsx(i,{children:"Symbol"}),e.jsx(i,{children:"Side"}),e.jsx(i,{className:"text-right",children:"Qty"}),e.jsx(i,{className:"text-right",children:"Entry"}),e.jsx(i,{className:"text-right",children:"LTP"}),e.jsx(i,{className:"text-right",children:"SL"}),e.jsx(i,{className:"text-right",children:"Target"}),e.jsx(i,{children:"Status"}),e.jsx(i,{className:"text-right",children:"Unreal P&L"}),e.jsx(i,{className:"text-right",children:"Reentry"}),e.jsx(i,{className:"text-center",children:"Action"})]})}),e.jsx(ae,{children:v.map(([u,a])=>e.jsxs(O,{children:[e.jsx(l,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a.leg_pair_name||u}),a.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(l,{className:"font-mono text-xs",children:a.symbol}),e.jsx(l,{children:a.side?e.jsx(A,{variant:a.side==="SELL"?"destructive":"default",children:a.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(l,{className:"text-right",children:a.quantity}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:T(a.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ue(a.entry_time)})]})}),e.jsx(l,{className:"text-right",children:x?.[u]===null||x?.[u]===void 0?"-":T(x?.[u])}),e.jsx(l,{className:"text-right",children:e.jsx(js,{value:a.sl_price,instanceId:n,legKey:u,overrideType:"sl_price",leg:a,onSuccess:o})}),e.jsx(l,{className:"text-right",children:e.jsx(js,{value:a.target_price,instanceId:n,legKey:u,overrideType:"target_price",leg:a,onSuccess:o})}),e.jsx(l,{children:e.jsx(A,{className:xe[a.status],variant:"secondary",children:a.status.replace(/_/g," ")})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:Se(a,x?.[u])})}),e.jsx(l,{className:"text-right",children:a.reentry_limit===null||a.reentry_limit===void 0?"-":`${a.reentry_count??0}/${a.reentry_limit}`}),e.jsx(l,{className:"text-center",children:a.status==="IN_POSITION"&&e.jsx($,{variant:"outline",size:"sm",onClick:()=>d(u,a),className:"h-7 px-2 text-xs",children:"Exit"})})]},u))})]})})]}),w.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4 text-yellow-500"}),"Pending / Planned Trades (",w.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(i,{children:"Leg"}),e.jsx(i,{children:"Symbol"}),e.jsx(i,{children:"Side"}),e.jsx(i,{className:"text-right",children:"Qty"}),e.jsx(i,{className:"text-right",children:"LTP"}),e.jsx(i,{className:"text-right",children:"Planned Entry"}),e.jsx(i,{className:"text-right",children:"Planned SL"}),e.jsx(i,{className:"text-right",children:"Planned Target"}),e.jsx(i,{children:"Status"}),e.jsx(i,{className:"text-right",children:"Reentry"}),e.jsx(i,{className:"text-right",children:"Reexec"})]})}),e.jsx(ae,{children:w.map(([u,a])=>e.jsxs(O,{children:[e.jsx(l,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a.leg_pair_name||u}),a.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(l,{className:"font-mono text-xs",children:a.symbol}),e.jsx(l,{children:a.side?e.jsx(A,{variant:a.side==="SELL"?"destructive":"default",children:a.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(l,{className:"text-right",children:a.quantity}),e.jsx(l,{className:"text-right",children:x?.[u]===null||x?.[u]===void 0?"-":T(x?.[u])}),e.jsx(l,{className:"text-right",children:T(st(a))}),e.jsx(l,{className:"text-right",children:T(a.sl_price)}),e.jsx(l,{className:"text-right",children:T(a.target_price)}),e.jsx(l,{children:e.jsx(A,{className:xe[a.status]||"bg-gray-400",variant:"secondary",children:a.status.replace(/_/g," ")})}),e.jsx(l,{className:"text-right",children:a.reentry_limit===null||a.reentry_limit===void 0?"-":`${a.reentry_count??0}/${a.reentry_limit}`}),e.jsx(l,{className:"text-right",children:a.reexecute_limit===null||a.reexecute_limit===void 0?"-":`${a.reexecute_count??0}/${a.reexecute_limit}`})]},u))})]})})]}),S.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(Ee,{className:"h-4 w-4 text-gray-500"}),"Done Legs (",S.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(i,{children:"Leg"}),e.jsx(i,{children:"Symbol"}),e.jsx(i,{children:"Side"}),e.jsx(i,{className:"text-right",children:"Qty"}),e.jsx(i,{className:"text-right",children:"Entry"}),e.jsx(i,{className:"text-right",children:"Realized P&L"}),e.jsx(i,{className:"text-right",children:"Total P&L"}),e.jsx(i,{children:"Status"})]})}),e.jsx(ae,{children:S.map(([u,a])=>e.jsxs(O,{children:[e.jsx(l,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:a.leg_pair_name||u}),a.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(l,{className:"font-mono text-xs",children:a.symbol}),e.jsx(l,{children:a.side?e.jsx(A,{variant:a.side==="SELL"?"destructive":"default",children:a.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(l,{className:"text-right",children:a.quantity}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:T(a.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ue(a.entry_time)})]})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:a.realized_pnl})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:a.total_pnl??a.realized_pnl})}),e.jsx(l,{children:e.jsx(A,{className:xe[a.status]||"bg-gray-400",variant:"secondary",children:a.status.replace(/_/g," ")})})]},u))})]})})]})]})}function nt({trades:t}){return!t||t.length===0?e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No trade history"}):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsx("div",{className:"max-h-[50vh] overflow-y-auto",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(i,{children:"#"}),e.jsx(i,{children:"Leg"}),e.jsx(i,{children:"Symbol"}),e.jsx(i,{children:"Side"}),e.jsx(i,{className:"text-right",children:"Qty"}),e.jsx(i,{className:"text-right",children:"Entry"}),e.jsx(i,{className:"text-right",children:"Exit"}),e.jsx(i,{className:"text-right",children:"SL"}),e.jsx(i,{className:"text-right",children:"Target"}),e.jsx(i,{children:"Exit Type"}),e.jsx(i,{className:"text-right",children:"P&L"})]})}),e.jsx(ae,{children:t.map(n=>e.jsxs(O,{children:[e.jsx(l,{children:n.trade_id}),e.jsx(l,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:n.leg_pair_name||n.leg_key}),n.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(l,{className:"font-mono text-xs",children:n.symbol}),e.jsx(l,{children:e.jsx(A,{variant:n.side==="SELL"?"destructive":"default",children:n.side})}),e.jsx(l,{className:"text-right",children:n.quantity}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:T(n.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ue(n.entry_time)})]})}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:T(n.exit_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:ue(n.exit_time)})]})}),e.jsx(l,{className:"text-right",children:T(n.sl_price)}),e.jsx(l,{className:"text-right",children:T(n.target_price)}),e.jsx(l,{children:n.exit_type&&e.jsx(A,{className:Js[n.exit_type],variant:"secondary",children:n.exit_type.replace(/_/g," ")})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:n.pnl})})]},n.trade_id))})]})})})}function it({strategy:t,onDelete:n,onRefresh:o,liveLtpByLegKey:x,onAddManualLeg:d,onExitLeg:E}){const[v,w]=c.useState(!0),[S,u]=c.useState(!1),a=t.config,U=p=>{p.stopPropagation(),n(t.instance_id,t.strategy_name)},D=t.legs||{},R=c.useMemo(()=>at(t.trade_history),[t.trade_history]),H=c.useMemo(()=>{let p=0;for(const[f,P]of Object.entries(D)){if(!["IN_POSITION","PENDING_EXIT"].includes(P.status))continue;const m=Se(P,x?.[f]);m!==null&&(p+=m)}return p},[D,x]),G=R+H;return e.jsx(ls,{open:v,onOpenChange:w,children:e.jsxs(ps,{className:"mb-4",children:[e.jsx(cs,{asChild:!0,children:e.jsx(ks,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[v?e.jsx(hs,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(gs,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(Us,{className:"text-lg",children:t.strategy_name}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[a&&e.jsxs(e.Fragment,{children:[a.underlying," | Expiry: ",a.expiry_date," | Lots: ",a.lots," Ã— ",a.lot_size]}),!a&&`Instance: ${t.instance_id}`]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total P&L"}),e.jsx(k,{value:G})]}),e.jsx(A,{className:Zs[t.status]||"bg-gray-400",children:t.status}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{variant:"outline",size:"sm",onClick:p=>{p.stopPropagation(),d(t)},children:"Add Position"}),e.jsx($,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:U,title:"Delete strategy state",children:e.jsx(Bs,{className:"h-4 w-4"})})]})]})]})})}),e.jsx(os,{children:e.jsxs(fs,{className:"pt-0 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 p-4 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Open Positions"}),e.jsx("p",{className:"text-lg font-semibold",children:Object.values(t.legs||{}).filter(p=>["IN_POSITION","PENDING_EXIT"].includes(p.status)).length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pending / Planned"}),e.jsx("p",{className:"text-lg font-semibold",children:Object.values(t.legs||{}).filter(p=>["IDLE","PENDING_ENTRY","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(p.status)).length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Trades"}),e.jsx("p",{className:"text-lg font-semibold",children:t.trade_history?.length??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Realized P&L"}),e.jsx(k,{value:R,showIcon:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Unrealized P&L"}),e.jsx(k,{value:H,showIcon:!1})]})]}),e.jsxs(ls,{open:S,onOpenChange:u,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-md font-semibold",children:"Leg P&L"}),e.jsx(cs,{asChild:!0,children:e.jsxs($,{variant:"ghost",size:"sm",className:"h-8 px-2",children:[S?e.jsx(hs,{className:"h-4 w-4 mr-2"}):e.jsx(gs,{className:"h-4 w-4 mr-2"}),S?"Hide":"Show"]})})]}),e.jsx(os,{children:e.jsx("div",{className:"rounded-md border overflow-x-auto mt-2",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(i,{children:"Leg"}),e.jsx(i,{children:"Symbol"}),e.jsx(i,{children:"Status"}),e.jsx(i,{className:"text-right",children:"Realized P&L"}),e.jsx(i,{className:"text-right",children:"Unrealized P&L"}),e.jsx(i,{className:"text-right",children:"Total P&L"})]})}),e.jsx(ae,{children:Object.entries(D).map(([p,f])=>{const P=["IN_POSITION","PENDING_EXIT"].includes(f.status)?Se(f,x?.[p]):0,m=f.realized_pnl??0,b=(f.total_pnl??null)!==null&&f.total_pnl!==void 0?f.total_pnl:P===null?null:m+P;return e.jsxs(O,{children:[e.jsx(l,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:f.leg_pair_name||p}),f.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(l,{className:"font-mono text-xs",children:f.symbol}),e.jsx(l,{children:e.jsx(A,{className:xe[f.status]||"bg-gray-400",variant:"secondary",children:f.status.replace(/_/g," ")})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:f.realized_pnl,showIcon:!1})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:P,showIcon:!1})}),e.jsx(l,{className:"text-right",children:e.jsx(k,{value:b,showIcon:!1})})]},p)})})]})})})]}),t.last_updated&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last updated: ",tt(t.last_updated),t.orchestrator&&` | Cycles: ${t.orchestrator.cycle_count}`]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“Š Current Positions"}),e.jsx(rt,{legs:t.legs,instanceId:t.instance_id,onRefresh:o,liveLtpByLegKey:x,onExitLeg:(p,f)=>E(t.instance_id,p,f)})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“œ Trade History"}),e.jsx(nt,{trades:t.trade_history})]})]})})]})})}function St(){const[t,n]=c.useState([]),[o,x]=c.useState(!0),[d,E]=c.useState(!1),{apiKey:v}=Ls(),[w,S]=c.useState(!1),[u,a]=c.useState(null),[U,D]=c.useState([]),[R,H]=c.useState(!1),[G,p]=c.useState(null),[f,P]=c.useState(""),[m,b]=c.useState(""),[I,Ie]=c.useState(!0),[me,Te]=c.useState(""),[he,we]=c.useState(""),[ge,Le]=c.useState(""),[je,Pe]=c.useState(""),[Ce,pe]=c.useState(!1),[ne,De]=c.useState("TRACK"),[fe,Re]=c.useState(""),[Me,Ns]=c.useState("NFO"),[Fe,Ae]=c.useState("NRML"),[Oe,ke]=c.useState(""),[Ue,$e]=c.useState("SELL"),[Ne,He]=c.useState(""),[ye,Ye]=c.useState(""),Ge="strategy_positions_auto_refresh_enabled",Be="strategy_positions_auto_refresh_seconds",[B,Xe]=c.useState(!0),[z,qe]=c.useState(10),ie=c.useRef(!1),[Y,_e]=c.useState({open:!1,instanceId:"",strategyName:""}),[W,ze]=c.useState(!1),[We,le]=c.useState(""),[L,ce]=c.useState({open:!1,instanceId:"",legKey:"",leg:null}),[ve,oe]=c.useState(""),[de,be]=c.useState("SL_HIT"),[X,Ve]=c.useState(!1),q=async(s=!1)=>{try{const r=await zs();n(r),s&&j.success("Data refreshed")}catch(r){console.error("Error fetching strategy states:",r),j.error("Failed to fetch strategy positions")}finally{x(!1),E(!1),ie.current=!1}},ys=(s,r)=>{le(""),_e({open:!0,instanceId:s,strategyName:r})},_s=async()=>{if(Y.instanceId){ze(!0);try{await Ws(Y.instanceId),j.success(`Strategy "${Y.strategyName}" deleted successfully`),n(s=>s.filter(r=>r.instance_id!==Y.instanceId))}catch(s){console.error("Error deleting strategy:",s),j.error("Failed to delete strategy")}finally{ze(!1),_e({open:!1,instanceId:"",strategyName:""}),le("")}}},vs=We===Y.strategyName,bs=(s,r,g)=>{ce({open:!0,instanceId:s,legKey:r,leg:g}),oe(""),be("SL_HIT")},Es=async()=>{if(!L.instanceId||!L.legKey||!L.leg)return;const s=parseFloat(ve);if(isNaN(s)||s<=0){j.error("Please enter a valid exit price");return}const r=L.leg.entry_price,g=L.leg.side;if(r&&g){if(de==="TARGET_HIT"){if(g==="BUY"&&s<=r){j.error(`For BUY positions with TARGET_HIT, exit price must be greater than entry price (${r.toFixed(2)})`);return}if(g==="SELL"&&s>=r){j.error(`For SELL positions with TARGET_HIT, exit price must be less than entry price (${r.toFixed(2)})`);return}}else if(de==="SL_HIT"){if(g==="BUY"&&s>=r){j.error(`For BUY positions with SL_HIT, exit price must be less than entry price (${r.toFixed(2)})`);return}if(g==="SELL"&&s<=r){j.error(`For SELL positions with SL_HIT, exit price must be greater than entry price (${r.toFixed(2)})`);return}}}Ve(!0);try{const N=await Ks(L.instanceId,L.legKey,s,de);j.success(N.message),ce({open:!1,instanceId:"",legKey:"",leg:null}),oe(""),q(!1)}catch(N){console.error("Error exiting position:",N),j.error(N instanceof Error?N.message:"Failed to exit position")}finally{Ve(!1)}};c.useEffect(()=>{try{const s=window.localStorage.getItem(Ge);s!==null&&Xe(s==="1"||s==="true");const r=window.localStorage.getItem(Be);if(r){const g=Number.parseInt(r,10);if(!Number.isNaN(g)){const N=Math.min(300,Math.max(5,g));qe(N)}}}catch(s){console.error("Error loading strategy positions auto-refresh preferences:",s)}q()},[]),c.useEffect(()=>{try{window.localStorage.setItem(Ge,B?"1":"0"),window.localStorage.setItem(Be,String(z))}catch(s){console.error("Error saving strategy positions auto-refresh preferences:",s)}},[B,z]),c.useEffect(()=>{if(!B)return;const s=Math.min(300,Math.max(5,z)),r=window.setInterval(()=>{ie.current||(ie.current=!0,E(!0),q(!1))},s*1e3);return()=>window.clearInterval(r)},[B,z]);const Qe=c.useMemo(()=>{const s=[];for(const r of t){const g=r.config?.exchange||"NFO",N=r.legs||{};for(const[M,h]of Object.entries(N)){if(!["IN_POSITION","PENDING_EXIT","PENDING_ENTRY","IDLE","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(h.status))continue;const _=(h.symbol||"").trim();if(_)if(_.includes(":")){const[V,Q]=_.split(":",2);if(!Q)continue;s.push({instanceId:r.instance_id,legKey:M,symbol:Q,exchange:V||g,ltp:h.current_ltp??h.entry_price})}else s.push({instanceId:r.instance_id,legKey:M,symbol:_,exchange:g,ltp:h.current_ltp??h.entry_price})}}return s},[t]),{data:Ke}=Gs(Qe,{enabled:Qe.length>0,useMultiQuotesFallback:!0}),Ss=c.useMemo(()=>{const s={};for(const r of Ke)s[r.instanceId]||(s[r.instanceId]={}),s[r.instanceId][r.legKey]=r.ltp;return s},[Ke]),Is=()=>{ie.current=!0,E(!0),q(!0)},Ze=()=>{D([]),P(""),b(""),Ie(!0),Te(""),we(""),Le(""),Pe(""),p(null),pe(!1),De("TRACK"),Re(""),ke(""),He(""),Ye(""),$e("SELL"),Ae("NRML")},Ts=async s=>{if(!v){j.error("API key not available");return}a(s),S(!0),H(!0),p(null);try{const r=await Ys.getPositions(v);if(r.status!=="success"||!r.data)throw new Error(r.message||"Failed to load positions");const g=r.data.filter(N=>N.quantity!==0);D(g),g.length===0&&P("")}catch(r){p(r instanceof Error?r.message:"Failed to load positions")}finally{H(!1)}},ws=async()=>{if(!u)return;const s=me.trim()===""?null:Number.parseFloat(me),r=he.trim()===""?null:Number.parseFloat(he),g=ge.trim()===""?null:Number.parseInt(ge,10),N=je.trim()===""?null:Number.parseInt(je,10);if(s!==null&&(Number.isNaN(s)||s<=0)){j.error("SL percent must be a positive number");return}if(r!==null&&(Number.isNaN(r)||r<=0)){j.error("Target percent must be a positive number");return}if(g!==null&&(Number.isNaN(g)||g<0)){j.error("Re-entry limit must be a non-negative number");return}if(N!==null&&(Number.isNaN(N)||N<0)){j.error("Re-execute limit must be a non-negative number");return}if(!I&&m.trim()){const h=m.trim(),_=u;if(!(_?.legs&&Object.values(_.legs).some(Q=>Q.leg_pair_name===h&&Q.is_main_leg===!0))){j.error(`Leg Pair '${h}' must have at least one Main Leg trade. Please mark this as Main Leg or add a Main Leg trade first.`);return}}let M={leg_key:`MANUAL_${Date.now()}`,sl_percent:s,target_percent:r,leg_pair_name:m.trim()?m.trim():null,reentry_limit:g,reexecute_limit:N,mode:ne};if(ne==="TRACK"){const h=U.find(_=>`${_.exchange}:${_.symbol}:${_.product}:${_.quantity}`===f);if(!h){j.error("Select a position");return}M={...M,symbol:h.symbol,exchange:h.exchange,product:h.product,quantity:Math.abs(h.quantity),side:h.quantity>0?"BUY":"SELL",entry_price:h.average_price,is_main_leg:I}}else{if(!fe.trim()){j.error("Symbol is required");return}const h=parseInt(Oe);if(isNaN(h)||h<=0){j.error("Invalid quantity");return}const _=Ne.trim()?parseFloat(Ne):null,V=ye.trim()?parseFloat(ye):null;if(_!==null&&(isNaN(_)||_<=0)){j.error("Invalid wait percentage");return}if(_!==null&&V===null){j.error("Baseline price is required for Wait Entry");return}M={...M,symbol:fe.toUpperCase(),exchange:Me,product:Fe,quantity:h,side:Ue,is_main_leg:I,wait_trade_percent:_,wait_baseline_price:V}}pe(!0);try{const h=await Qs(u.instance_id,M);j.success(h.message),S(!1),Ze(),q(!1)}catch(h){j.error(h instanceof Error?h.message:"Failed to add manual position")}finally{pe(!1)}},Je=c.useMemo(()=>[...t].sort((s,r)=>{const g=(s.strategy_name||"").toLocaleLowerCase(),N=(r.strategy_name||"").toLocaleLowerCase();if(g<N)return-1;if(g>N)return 1;const M=s.created_at?new Date(s.created_at).getTime():Number.POSITIVE_INFINITY,h=r.created_at?new Date(r.created_at).getTime():Number.POSITIVE_INFINITY;return M!==h?M-h:(s.instance_id||"").localeCompare(r.instance_id||"")}),[t]);return e.jsxs("div",{className:"container mx-auto py-6 px-4 max-w-7xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Strategy Positions"}),e.jsx("p",{className:"text-muted-foreground",children:"View positions and trade history for Python strategies"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"text-xs text-muted-foreground",children:"Auto refresh"}),e.jsx(us,{checked:B,onCheckedChange:Xe})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{className:"text-xs text-muted-foreground",children:"Every (s)"}),e.jsx(C,{type:"number",min:5,max:300,step:1,value:z,onChange:s=>{const r=Number.parseInt(s.target.value,10);if(Number.isNaN(r))return;const g=Math.min(300,Math.max(5,r));qe(g)},className:"h-8 w-20",disabled:!B})]}),e.jsxs($,{variant:"outline",size:"sm",onClick:Is,disabled:d,children:[e.jsx(ms,{className:`h-4 w-4 mr-2 ${d?"animate-spin":""}`}),"Refresh"]})]}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Range: 5â€“300 seconds (saved locally)"})]})]}),o?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ms,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):Je.length===0?e.jsx(ps,{children:e.jsxs(fs,{className:"py-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"No strategy states found"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Strategy positions will appear here when you run Python strategies with state persistence."})]})}):e.jsx("div",{children:Je.map(s=>e.jsx(it,{strategy:s,onDelete:ys,onRefresh:()=>q(!1),liveLtpByLegKey:Ss[s.instance_id]||{},onAddManualLeg:Ts,onExitLeg:bs},s.instance_id))}),e.jsx(ss,{open:w,onOpenChange:s=>{S(s),s||(Ze(),a(null))},children:e.jsxs(ts,{className:"sm:max-w-xl",children:[e.jsxs(as,{children:[e.jsx(rs,{children:"Add Position to Strategy"}),e.jsxs(ns,{children:["Select a live broker position to track in ",u?.strategy_name||"this strategy","."]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs($s,{value:ne,onValueChange:s=>De(s),children:[e.jsxs(Hs,{className:"grid w-full grid-cols-2",children:[e.jsx(ds,{value:"TRACK",children:"Track Existing"}),e.jsx(ds,{value:"NEW",children:"New Trade"})]}),e.jsx(xs,{value:"TRACK",className:"pt-4 space-y-4",children:R?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading positions..."}):G?e.jsx("p",{className:"text-sm text-destructive",children:G}):U.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No open positions available."}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Position"}),e.jsxs(K,{value:f,onValueChange:P,children:[e.jsx(Z,{children:e.jsx(J,{placeholder:"Select position"})}),e.jsx(ee,{children:U.map(s=>{const r=`${s.exchange}:${s.symbol}:${s.product}:${s.quantity}`,g=s.quantity>0?"BUY":"SELL";return e.jsxs(F,{value:r,children:[s.exchange,":",s.symbol," â€¢ ",g," ",Math.abs(s.quantity)," @ ",T(s.average_price)]},r)})})]})]})}),e.jsxs(xs,{value:"NEW",className:"pt-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Symbol"}),e.jsx(C,{placeholder:"e.g. SENSEX24FEB75000PE",value:fe,onChange:s=>Re(s.target.value.toUpperCase())})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Exchange"}),e.jsxs(K,{value:Me,onValueChange:Ns,children:[e.jsx(Z,{children:e.jsx(J,{})}),e.jsxs(ee,{children:[e.jsx(F,{value:"NFO",children:"NFO"}),e.jsx(F,{value:"BFO",children:"BFO"}),e.jsx(F,{value:"MCX",children:"MCX"}),e.jsx(F,{value:"CDS",children:"CDS"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Product"}),e.jsxs(K,{value:Fe,onValueChange:Ae,children:[e.jsx(Z,{children:e.jsx(J,{})}),e.jsxs(ee,{children:[e.jsx(F,{value:"NRML",children:"NRML"}),e.jsx(F,{value:"MIS",children:"MIS"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Qty"}),e.jsx(C,{placeholder:"Qty",value:Oe,onChange:s=>ke(s.target.value),type:"number"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Side"}),e.jsxs(K,{value:Ue,onValueChange:s=>$e(s),children:[e.jsx(Z,{children:e.jsx(J,{})}),e.jsxs(ee,{children:[e.jsx(F,{value:"SELL",children:"SELL"}),e.jsx(F,{value:"BUY",children:"BUY"})]})]})]})]}),e.jsxs("div",{className:"rounded-md border p-4 space-y-3 bg-muted/20",children:[e.jsx(y,{className:"font-medium text-xs uppercase text-muted-foreground",children:"Execution Condition"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-xs",children:"Wait Trigger %"}),e.jsx(C,{placeholder:"Immediate if empty",value:Ne,onChange:s=>He(s.target.value),type:"number",step:"0.1"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-xs",children:"Baseline Price"}),e.jsx(C,{placeholder:"Required for wait",value:ye,onChange:s=>Ye(s.target.value),type:"number"})]})]})]})]})]}),e.jsxs("div",{className:"space-y-4 pt-2 border-t",children:[e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"manual-reentry-limit",children:"Re-entry Limit"}),e.jsx(C,{id:"manual-reentry-limit",type:"number",placeholder:"e.g. 1",min:"0",step:"1",value:ge,onChange:s=>Le(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"manual-reexecute-limit",children:"Re-exec Limit"}),e.jsx(C,{id:"manual-reexecute-limit",type:"number",placeholder:"e.g. 1",min:"0",step:"1",value:je,onChange:s=>Pe(s.target.value)})]})]})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"manual-leg-name",children:"Leg Pair Name"}),e.jsx(C,{id:"manual-leg-name",placeholder:"Hedge Pair",value:m,onChange:s=>b(s.target.value)})]}),e.jsxs("div",{className:"flex items-center gap-3 pt-6",children:[e.jsx(us,{checked:I,onCheckedChange:Ie,id:"manual-is-main-leg"}),e.jsx(y,{htmlFor:"manual-is-main-leg",children:"Main Leg"})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"manual-sl-percent",children:"SL Percent"}),e.jsx(C,{id:"manual-sl-percent",placeholder:"0.05",value:me,onChange:s=>Te(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"manual-target-percent",children:"Target Percent"}),e.jsx(C,{id:"manual-target-percent",placeholder:"0.1",value:he,onChange:s=>we(s.target.value)})]})]})]})]}),e.jsxs(is,{children:[e.jsx($,{variant:"ghost",onClick:()=>S(!1),children:"Cancel"}),e.jsx($,{onClick:ws,disabled:Ce||ne==="TRACK"&&(R||U.length===0),children:Ce?"Adding...":"Add Position"})]})]})}),e.jsx(Ps,{open:Y.open,onOpenChange:s=>{W||(_e(r=>({...r,open:s})),s||le(""))},children:e.jsxs(Cs,{children:[e.jsxs(Ds,{children:[e.jsx(Rs,{children:"Delete Strategy State?"}),e.jsx(Ms,{asChild:!0,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["Are you sure you want to delete the strategy state for"," ",e.jsx("strong",{children:Y.strategyName}),"? This action cannot be undone and will remove all position data and trade history for this strategy."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm",children:["To confirm, type ",e.jsx("strong",{className:"text-foreground",children:Y.strategyName})," below:"]}),e.jsx("input",{type:"text",value:We,onChange:s=>le(s.target.value),placeholder:"Type strategy name to confirm",className:"w-full px-3 py-2 text-sm border rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring",disabled:W,autoComplete:"off"})]})]})})]}),e.jsxs(Fs,{children:[e.jsx(As,{disabled:W,children:"Cancel"}),e.jsx(Os,{onClick:_s,disabled:W||!vs,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50",children:W?"Deleting...":"Delete"})]})]})}),e.jsx(ss,{open:L.open,onOpenChange:s=>{X||(ce(r=>({...r,open:s})),s||(oe(""),be("SL_HIT")))},children:e.jsxs(ts,{children:[e.jsxs(as,{children:[e.jsx(rs,{children:"Exit Position"}),e.jsxs(ns,{children:["Manually exit position for ",L.leg?.symbol," (",L.leg?.side," ",L.leg?.quantity,")"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"exit-price",children:"Exit Price *"}),e.jsx(C,{id:"exit-price",type:"number",step:"0.05",placeholder:"Enter exit price",value:ve,onChange:s=>oe(s.target.value),disabled:X}),L.leg?.entry_price&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Entry Price: ",T(L.leg.entry_price)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"exit-status",children:"Exit Status *"}),e.jsxs(K,{value:de,onValueChange:s=>be(s),disabled:X,children:[e.jsx(Z,{id:"exit-status",children:e.jsx(J,{})}),e.jsxs(ee,{children:[e.jsx(F,{value:"SL_HIT",children:"SL Hit"}),e.jsx(F,{value:"TARGET_HIT",children:"Target Hit"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Select the exit reason for this position"})]})]}),e.jsxs(is,{children:[e.jsx($,{variant:"ghost",onClick:()=>ce({open:!1,instanceId:"",legKey:"",leg:null}),disabled:X,children:"Cancel"}),e.jsx($,{onClick:Es,disabled:X||!ve,children:X?"Exiting...":"Exit Position"})]})]})})]})}export{St as default};
