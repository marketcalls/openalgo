import{r as i}from"./vendor-react-CCyQGCED.js";import{t as F}from"./trading-DOTe-XLu.js";import{u as T,a as V}from"./useMarketStatus-BcnNnqld.js";import{d as U,g as W}from"./index-a7rEZX68.js";function X(t,y={}){const{enabled:n=!0,staleThreshold:o=5e3,useMultiQuotesFallback:s=!0,multiQuotesRefreshInterval:p=3e4,pauseWhenHidden:c=!0}=y,{apiKey:d}=U(),{isMarketOpen:g,isAnyMarketOpen:P}=T(),{isVisible:M,wasHidden:q,timeSinceHidden:Q}=W(),S=P(),[k,A]=i.useState(new Map),w=i.useRef(Date.now()),C=i.useMemo(()=>t.map(e=>({symbol:e.symbol,exchange:e.exchange})),[t]),{data:m,isConnected:E,isPaused:L,isFallbackMode:H}=V({symbols:C,mode:"LTP",enabled:n&&t.length>0}),I=E&&S&&!L,f=i.useCallback(async()=>{if(!(!d||t.length===0||!s))try{const e=t.map(a=>({symbol:a.symbol,exchange:a.exchange})),h=await F.getMultiQuotes(d,e);if(h.status==="success"&&h.results){const a=new Map;h.results.forEach(l=>{const r=`${l.exchange}:${l.symbol}`;l.data&&a.set(r,l.data)}),A(a)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[d,t,s]);return i.useEffect(()=>{if(!n||t.length===0||!s||c&&!M)return;f(),w.current=Date.now();const e=setInterval(()=>{f(),w.current=Date.now()},p);return()=>clearInterval(e)},[n,t.length,s,f,p,c,M]),i.useEffect(()=>{!q||!M||!s||!n||Q>p&&(f(),w.current=Date.now())},[q,M,Q,p,s,n,f]),{data:i.useMemo(()=>t.map(e=>{const h=`${e.exchange}:${e.symbol}`,a=m.get(h),l=k.get(h),r=e.quantity||0,b=e.average_price||0,O=g(e.exchange)&&a?.data?.ltp&&a.lastUpdate&&Date.now()-a.lastUpdate<o,$=!O&&l?.ltp;let u,v="rest";if(O&&a?.data?.ltp?(u=a.data.ltp,v="websocket"):$&&l?.ltp?(u=l.ltp,v="multiquotes"):(u=e.ltp,v="rest"),r===0)return{...e,_dataSource:"rest"};let D=e.pnl||0,_=e.pnlpercent||0;const z=e.today_realized_pnl||0;if(u&&b>0){let x;r>0?x=(u-b)*r:x=(b-u)*Math.abs(r),D=z+x;const R=Math.abs(b*r);_=R>0?D/R*100:0}return{...e,ltp:u,pnl:D,pnlpercent:_,_dataSource:v}}),[t,m,k,g,o]),isLive:I,isConnected:E,isPaused:L,isFallbackMode:H,isAnyMarketOpen:S,multiQuotes:k,refreshMultiQuotes:f}}function Y(t,y){if(!y)return null;let n=0,o=0,s=0;t.forEach(c=>{n+=c.pnl||0;const d=c.average_price||0,g=c.quantity||0,P=c.ltp||d;o+=d*g,s+=P*g});const p=o>0?n/o*100:0;return{...y,totalholdingvalue:s,totalinvvalue:o,totalprofitandloss:n,totalpnlpercentage:p}}export{Y as c,X as u};
