import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as de,t as r,e as j,c as N,B as c}from"./index-LeuTUciu.js";import{C as _e,b as Pe,c as Me,a as Be}from"./card-DkQzSCvH.js";import{D as We,a as Xe,b as Ae,c as $e,d as He,e as Je,f as Ke}from"./dialog-CKefyLcx.js";import{I as S}from"./input-CfuW5BUS.js";import{L as C}from"./label-NPfbvLc5.js";import{S as qe}from"./scroll-area-D4N5ErXI.js";import{S as D,a as E,b as k,c as F,d as T}from"./select-DCqOd9Rl.js";import{q as Ze,K as Ge,W as Qe,R as Ye}from"./lightweight-charts.production-BVaGrqvA.js";import{D as he,Z as es,g as me,k as ss,l as as,av as ts,X as rs,ai as os,R as X,p as xe,aw as pe,ax as A}from"./vendor-icons-teXlZ-kw.js";import{L as ls}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-D6hV6JR3.js";import"./vendor-radix-B_grJx4K.js";async function w(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function ys(){const{mode:I,appMode:p,toggleMode:ue,toggleAppMode:fe,isTogglingMode:$}=de(),u=I==="dark",[H,ge]=t.useState([]),[je,we]=t.useState([]),[m,ye]=t.useState(null),[be,J]=t.useState(!1),[K,q]=t.useState(!1),[Z,G]=t.useState(!1),[ve,R]=t.useState(!1),[y,V]=t.useState(""),[Q,Ne]=t.useState("NSE"),[Y,Se]=t.useState("D"),[x,z]=t.useState(null),b=t.useRef(null),[l,ee]=t.useState(""),[n,se]=t.useState(""),[h,Ce]=t.useState("D"),[L,ae]=t.useState(""),[te,De]=t.useState("NSE"),[re,Ee]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-1),s.toISOString().split("T")[0]}),[oe,ke]=t.useState(()=>new Date().toISOString().split("T")[0]),[U,le]=t.useState([]),[O,Fe]=t.useState({database_size_mb:0,total_records:0,total_symbols:0,watchlist_count:0}),_=t.useRef(null),i=t.useRef(null),P=t.useRef(null),ne=["NSE","BSE","NFO","BFO","MCX","CDS","BCD","NSE_INDEX","BSE_INDEX"],ce=m?[...m.seconds,...m.minutes,...m.hours,...m.days,...m.weeks,...m.months]:["D"];t.useEffect(()=>{M(),B(),Te(),f()},[]),t.useEffect(()=>{if(!_.current)return;i.current&&(i.current.remove(),i.current=null);const s=_.current,a=Ze(s,{width:s.offsetWidth,height:400,layout:{background:{type:Qe.Solid,color:"transparent"},textColor:u?"#a6adbb":"#333"},grid:{vertLines:{color:u?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:u?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},rightPriceScale:{borderColor:u?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)"},timeScale:{borderColor:u?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:!0,secondsVisible:!1},crosshair:{mode:Ge.Normal}}),o=a.addSeries(Ye,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"});i.current=a,P.current=o;const d=()=>{i.current&&s&&i.current.applyOptions({width:s.offsetWidth})};return window.addEventListener("resize",d),()=>{window.removeEventListener("resize",d),i.current&&(i.current.remove(),i.current=null)}},[u]),t.useEffect(()=>{if(P.current&&U.length>0){const s=U.map(a=>({time:a.timestamp,open:a.open,high:a.high,low:a.low,close:a.close}));P.current.setData(s),i.current?.timeScale().fitContent()}},[U]);const M=async()=>{try{const a=await(await fetch("/historify/api/watchlist",{credentials:"include"})).json();a.status==="success"&&ge(a.data||[])}catch(s){console.error("Error loading watchlist:",s)}},B=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&we(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},Te=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&ye(a.data)}catch(s){console.error("Error loading intervals:",s)}},f=async()=>{try{const a=await(await fetch("/historify/api/stats",{credentials:"include"})).json();a.status==="success"&&Fe(a.data)}catch(s){console.error("Error loading stats:",s)}},g=t.useCallback(async()=>{if(!(!l||!n)){J(!0);try{const s=new URLSearchParams({symbol:l,exchange:n,interval:h}),o=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();o.status==="success"?(le(o.data||[]),o.count===0&&r.info("No data available. Download data first.")):r.error(o.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),r.error("Failed to load chart data")}finally{J(!1)}}},[l,n,h]);t.useEffect(()=>{l&&n&&g()},[l,n,h,g]);const ie=async()=>{if(!L.trim()){r.warning("Please enter a symbol");return}try{const s=await w(),o=await(await fetch("/historify/api/watchlist",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s},credentials:"include",body:JSON.stringify({symbol:L.trim().toUpperCase(),exchange:te})})).json();o.status==="success"?(r.success(o.message),ae(""),M(),f()):r.error(o.message||"Failed to add symbol")}catch(s){console.error("Error adding to watchlist:",s),r.error("Failed to add symbol")}},Ie=async(s,a)=>{try{const o=await w(),W=await(await fetch("/historify/api/watchlist",{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRFToken":o},credentials:"include",body:JSON.stringify({symbol:s,exchange:a})})).json();W.status==="success"?(r.success(W.message),M(),f(),l===s&&n===a&&(ee(""),se(""),le([]))):r.error(W.message||"Failed to remove symbol")}catch(o){console.error("Error removing from watchlist:",o),r.error("Failed to remove symbol")}},Re=async()=>{if(!l||!n){r.warning("Please select a symbol first");return}q(!0);try{const s=await w(),o=await(await fetch("/historify/api/download",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s},credentials:"include",body:JSON.stringify({symbol:l,exchange:n,interval:h,start_date:re,end_date:oe})})).json();o.status==="success"?(r.success(`Downloaded ${o.records} records`),B(),f(),g()):r.error(o.message||"Failed to download data")}catch(s){console.error("Error downloading data:",s),r.error("Failed to download data")}finally{q(!1)}},Ve=async()=>{if(!l||!n){r.warning("Please select a symbol first");return}try{const s=await w(),o=await(await fetch("/historify/api/export",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":s},credentials:"include",body:JSON.stringify({symbol:l,exchange:n,interval:h})})).json();o.status==="success"?(window.location.href="/historify/api/export/download",r.success("Export started")):r.error(o.message||"Failed to export data")}catch(s){console.error("Error exporting data:",s),r.error("Failed to export data")}},ze=s=>{const a=s.target.files?.[0];if(a){if(!a.name.toLowerCase().endsWith(".csv")){r.error("Please select a CSV file");return}z(a)}},Le=async()=>{if(!x){r.warning("Please select a CSV file");return}if(!y.trim()){r.warning("Please enter a symbol");return}G(!0);try{const s=await w(),a=new FormData;a.append("file",x),a.append("symbol",y.trim().toUpperCase()),a.append("exchange",Q),a.append("interval",Y);const d=await(await fetch("/historify/api/upload",{method:"POST",headers:{"X-CSRFToken":s},credentials:"include",body:a})).json();d.status==="success"?(r.success(`${d.message}`),R(!1),z(null),V(""),b.current&&(b.current.value=""),B(),f(),d.symbol===l&&d.exchange===n&&d.interval===h&&g()):r.error(d.message||"Failed to upload data")}catch(s){console.error("Error uploading CSV:",s),r.error("Failed to upload CSV")}finally{G(!1)}},Ue=(s,a)=>{ee(s),se(a)},Oe=async()=>{const s=await fe();if(s.success){const a=de.getState().appMode;r.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`)}else r.error(s.message||"Failed to toggle mode")},v=je.find(s=>s.symbol===l&&s.exchange===n&&s.interval===h);return e.jsxs("div",{className:"h-full flex flex-col bg-background text-foreground",children:[e.jsxs("div",{className:"h-12 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify"}),e.jsxs(j,{variant:"outline",className:"text-xs",children:[O.total_records.toLocaleString()," records"]})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:p==="live"?"default":"secondary",className:N("text-xs",p==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),children:p==="live"?"Live":"Analyze"}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Oe,disabled:$,children:$?e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}):p==="live"?e.jsx(es,{className:"h-4 w-4"}):e.jsx(me,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:ue,disabled:p!=="live",children:I==="light"?e.jsx(ss,{className:"h-4 w-4"}):e.jsx(as,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"h-7 text-xs",asChild:!0,children:e.jsx(ls,{to:"/dashboard",children:"Dashboard"})})]})]}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsxs("div",{className:"w-64 border-r border-border bg-card/30 flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-border",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{placeholder:"Symbol",value:L,onChange:s=>ae(s.target.value.toUpperCase()),className:"h-8 text-sm",onKeyDown:s=>s.key==="Enter"&&ie()}),e.jsxs(D,{value:te,onValueChange:De,children:[e.jsx(E,{className:"h-8 w-20 text-xs",children:e.jsx(k,{})}),e.jsx(F,{children:ne.map(s=>e.jsx(T,{value:s,className:"text-xs",children:s},s))})]}),e.jsx(c,{size:"icon",className:"h-8 w-8 shrink-0",onClick:ie,children:e.jsx(ts,{className:"h-4 w-4"})})]})}),e.jsx(qe,{className:"flex-1",children:e.jsx("div",{className:"p-2 space-y-1",children:H.length===0?e.jsxs("div",{className:"text-center text-muted-foreground text-sm py-8",children:[e.jsx(he,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No symbols in watchlist"}),e.jsx("p",{className:"text-xs mt-1",children:"Add symbols to get started"})]}):H.map(s=>e.jsxs("div",{className:N("flex items-center justify-between px-2 py-1.5 rounded cursor-pointer group","hover:bg-accent/50",l===s.symbol&&n===s.exchange&&"bg-accent"),onClick:()=>Ue(s.symbol,s.exchange),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:s.symbol}),e.jsx(j,{variant:"outline",className:"text-[10px] px-1 py-0",children:s.exchange})]}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100",onClick:a=>{a.stopPropagation(),Ie(s.symbol,s.exchange)},children:e.jsx(rs,{className:"h-3 w-3"})})]},`${s.symbol}-${s.exchange}`))})}),e.jsxs("div",{className:"p-3 border-t border-border text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Symbols:"}),e.jsx("span",{children:O.total_symbols})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"DB Size:"}),e.jsxs("span",{children:[O.database_size_mb," MB"]})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"h-12 border-b border-border flex items-center gap-3 px-4 bg-card/30",children:[e.jsxs(D,{value:h,onValueChange:Ce,children:[e.jsx(E,{className:"h-8 w-24",children:e.jsx(k,{placeholder:"Interval"})}),e.jsx(F,{children:ce.map(s=>e.jsx(T,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(S,{type:"date",value:re,onChange:s=>Ee(s.target.value),className:"h-8 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"to"}),e.jsx(S,{type:"date",value:oe,onChange:s=>ke(s.target.value),className:"h-8 w-36"})]}),e.jsx("div",{className:"flex-1"}),e.jsxs(c,{variant:"outline",size:"sm",onClick:Re,disabled:!l||K,children:[K?e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Download"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:Ve,disabled:!l,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Export CSV"]}),e.jsxs(We,{open:ve,onOpenChange:R,children:[e.jsx(Xe,{asChild:!0,children:e.jsxs(c,{variant:"outline",size:"sm",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Upload CSV"]})}),e.jsxs(Ae,{className:"sm:max-w-md",children:[e.jsxs($e,{children:[e.jsxs(He,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-primary"}),"Upload CSV Data"]}),e.jsx(Je,{children:"Import OHLCV data from a CSV file. The file should contain columns for timestamp (or date/time), open, high, low, close, and volume."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"upload-symbol",children:"Symbol"}),e.jsx(S,{id:"upload-symbol",placeholder:"e.g., RELIANCE",value:y,onChange:s=>V(s.target.value.toUpperCase())})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"upload-exchange",children:"Exchange"}),e.jsxs(D,{value:Q,onValueChange:Ne,children:[e.jsx(E,{id:"upload-exchange",children:e.jsx(k,{})}),e.jsx(F,{children:ne.map(s=>e.jsx(T,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"upload-interval",children:"Interval"}),e.jsxs(D,{value:Y,onValueChange:Se,children:[e.jsx(E,{id:"upload-interval",children:e.jsx(k,{})}),e.jsx(F,{children:ce.map(s=>e.jsx(T,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"upload-file",children:"CSV File"}),e.jsxs("div",{className:N("border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors","hover:border-primary/50 hover:bg-accent/50",x?"border-primary bg-primary/5":"border-muted-foreground/25"),onClick:()=>b.current?.click(),children:[e.jsx("input",{ref:b,id:"upload-file",type:"file",accept:".csv",className:"hidden",onChange:ze}),x?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-medium",children:x.name}),e.jsxs(j,{variant:"secondary",className:"text-xs",children:[(x.size/1024).toFixed(1)," KB"]})]}):e.jsxs("div",{className:"text-muted-foreground",children:[e.jsx(A,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"Click to select a CSV file"}),e.jsx("p",{className:"text-xs mt-1",children:"or drag and drop"})]})]})]}),e.jsxs("div",{className:"rounded-lg bg-muted/50 p-3 text-xs text-muted-foreground",children:[e.jsx("p",{className:"font-medium mb-1",children:"Expected CSV format:"}),e.jsx("code",{className:"block",children:"timestamp, open, high, low, close, volume, oi"}),e.jsx("p",{className:"mt-1",children:"or"}),e.jsx("code",{className:"block",children:"date, time, open, high, low, close, volume"})]})]}),e.jsxs(Ke,{children:[e.jsx(c,{variant:"outline",onClick:()=>{R(!1),z(null),V("")},children:"Cancel"}),e.jsx(c,{onClick:Le,disabled:!x||!y||Z,children:Z?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Upload"]})})]})]})]}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:g,children:e.jsx(X,{className:N("h-4 w-4",be&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1 p-4 overflow-hidden",children:l?e.jsxs(_e,{className:"h-full",children:[e.jsx(Pe,{className:"py-3",children:e.jsxs(Me,{className:"text-lg flex items-center gap-3",children:[e.jsxs("span",{children:[l," : ",n]}),e.jsx(j,{variant:"outline",children:h}),v&&e.jsxs("span",{className:"text-sm font-normal text-muted-foreground",children:[v.record_count.toLocaleString()," records ("," ",v.first_date," - ",v.last_date,")"]})]})}),e.jsx(Be,{className:"h-[calc(100%-60px)]",children:e.jsx("div",{ref:_,className:"w-full h-full"})})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(me,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"Select a symbol to view chart"}),e.jsx("p",{className:"text-sm mt-2",children:"Add symbols to your watchlist and download historical data"})]})})})]})]})]})}export{ys as default};
