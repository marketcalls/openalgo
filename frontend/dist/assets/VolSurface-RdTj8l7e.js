import{r as s,j as t}from"./vendor-react-CCyQGCED.js";import{P as X}from"./react-plotly-DV3gd5yC.js";import{w as K,u as $,d as q,s as k,B as G,e as g}from"./index-D9ef9b6u.js";import{o as H}from"./option-chain-cDwCGzRI.js";import{C as J,d as Q}from"./card-9-7YLx-n.js";import{S as D,a as T,b as B,c as _,d as Y}from"./select-DHic2kVJ.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const W={getSurfaceData:async i=>(await K.post("/volsurface/api/surface-data",i)).data},m=[{value:"NIFTY",label:"NIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"BANKNIFTY",label:"BANKNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"SENSEX",label:"SENSEX",exchange:"BFO",brokerExchange:"BSE_INDEX"},{value:"FINNIFTY",label:"FINNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"},{value:"MIDCPNIFTY",label:"MIDCPNIFTY",exchange:"NFO",brokerExchange:"NSE_INDEX"}],Z=[{value:"10",label:"10"},{value:"15",label:"15"},{value:"20",label:"20"},{value:"25",label:"25"},{value:"30",label:"30"},{value:"35",label:"35"},{value:"40",label:"40"}];function ee(i){if(!i)return"";const c=i.split("-");return c.length===3?`${c[0]}${c[1].toUpperCase()}${c[2].slice(-2)}`:i.replace(/-/g,"").toUpperCase()}function ue(){const{mode:i,appMode:c}=$(),u=c==="analyzer",n=i==="dark"||u,{apiKey:h}=q(),[I,A]=s.useState(m[0].value),[b,y]=s.useState([]),[x,f]=s.useState([]),[v,V]=s.useState("40"),[l,N]=s.useState(null),[S,C]=s.useState(!1),p=s.useRef(0),d=m.find(e=>e.value===I)||m[0],a=s.useMemo(()=>({text:n?"#e0e0e0":"#333333",grid:n?u?"rgba(180,160,255,0.15)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",hoverBg:n?u?"#2d2545":"#1e293b":"#ffffff",hoverFont:n?"#e0e0e0":"#333333",hoverBorder:n?u?"#7c3aed":"#475569":"#e2e8f0",colorscale:u?"Plasma":n?"Viridis":"YlOrRd"}),[n,u]);s.useEffect(()=>{if(!h)return;y([]),f([]),N(null);let e=!1;return(async()=>{try{const o=await H.getExpiries(h,d.value,d.exchange,"options");if(e)return;o.status==="success"&&o.data&&o.data.length>0&&(y(o.data),f(o.data.slice(0,4)))}catch{if(e)return;k.error("Failed to fetch expiry dates")}})(),()=>{e=!0}},[h,d.value,d.exchange]);const M=s.useCallback(e=>{f(r=>r.includes(e)?r.filter(o=>o!==e):r.length>=8?r:[...r,e])},[]),R=s.useCallback(async()=>{if(x.length===0)return;const e=++p.current;C(!0);try{const r=await W.getSurfaceData({underlying:d.value,exchange:d.brokerExchange,expiry_dates:x.map(ee),strike_count:parseInt(v)});if(p.current!==e)return;r.status==="success"&&r.data?N(r.data):k.error(r.message||"Failed to load vol surface")}catch{if(p.current!==e)return;k.error("Failed to fetch vol surface data")}finally{p.current===e&&C(!1)}},[x,v,d]),F=s.useMemo(()=>{if(!l)return{data:[],layout:{}};const{strikes:e,expiries:r,surface:o}=l,z=r.map((E,j)=>j),w=r.map(E=>E.date),O=o.map((E,j)=>Array(e.length).fill(w[j])),P=[{type:"surface",x:e,y:z,z:o,customdata:O,colorscale:a.colorscale,hovertemplate:"Strike: %{x}<br>Expiry: %{customdata}<br>IV: %{z:.2f}%<extra></extra>",colorbar:{title:{text:"IV %",font:{color:a.text,size:12}},tickfont:{color:a.text},outlinewidth:0,len:.6},opacity:.95}],U={autosize:!0,paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:a.text,family:"system-ui, sans-serif"},margin:{l:0,r:0,t:0,b:0},scene:{aspectmode:"manual",aspectratio:{x:2,y:1.2,z:.8},domain:{x:[0,1],y:[0,1]},xaxis:{title:{text:"Strike Price",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,backgroundcolor:"rgba(0,0,0,0)"},yaxis:{title:{text:"Expiry",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},tickvals:z,ticktext:w,gridcolor:a.grid,backgroundcolor:"rgba(0,0,0,0)"},zaxis:{title:{text:"Implied Volatility",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,backgroundcolor:"rgba(0,0,0,0)"},camera:{eye:{x:1.6,y:-1.6,z:.7}},bgcolor:"rgba(0,0,0,0)"},hoverlabel:{bgcolor:a.hoverBg,font:{color:a.hoverFont,size:12},bordercolor:a.hoverBorder},showlegend:!1};return{data:P,layout:U}},[l,a,n]),L=s.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return t.jsxs("div",{className:"py-6 space-y-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Vol Surface"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(D,{value:I,onValueChange:e=>{A(e),f([]),y([]),N(null)},children:[t.jsx(T,{className:"w-[140px]",children:t.jsx(B,{placeholder:"Underlying"})}),t.jsx(_,{children:m.map(e=>t.jsx(Y,{value:e.value,children:e.label},e.value))})]}),t.jsxs(D,{value:v,onValueChange:V,children:[t.jsx(T,{className:"w-[100px]",children:t.jsx(B,{placeholder:"Strikes"})}),t.jsx(_,{children:Z.map(e=>t.jsxs(Y,{value:e.value,children:[e.label," Strikes"]},e.value))})]}),t.jsx(G,{variant:"outline",size:"sm",onClick:R,disabled:S||x.length===0,children:S?"Loading...":"Load Surface"})]})]}),b.length>0&&t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx("span",{className:"text-sm text-muted-foreground self-center mr-1",children:"Expiries:"}),b.map(e=>t.jsx("button",{type:"button",onClick:()=>M(e),className:`px-2.5 py-1 rounded-md text-xs border transition-colors ${x.includes(e)?"bg-primary text-primary-foreground border-primary":"bg-muted/50 text-muted-foreground border-border hover:bg-muted"}`,children:e},e))]}),l&&t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsxs(g,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",l.underlying_ltp?.toFixed(2)]}),t.jsxs(g,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",l.atm_strike]}),t.jsxs(g,{variant:"secondary",className:"text-sm px-3 py-1",children:["Expiries: ",l.expiries.length]}),t.jsxs(g,{variant:"secondary",className:"text-sm px-3 py-1",children:["Strikes: ",l.strikes.length]})]}),t.jsx(J,{children:t.jsx(Q,{className:"p-2 sm:p-4",children:S&&!l?t.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Computing volatility surface..."]})}):l?t.jsx(X,{data:F.data,layout:F.layout,config:L,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):t.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:b.length>0?'Select expiries and click "Load Surface" to view the volatility surface':"Select an underlying to begin"})})})]})}export{ue as default};
