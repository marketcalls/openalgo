import{r as n}from"./vendor-react--vsXx8_n.js";import{t as W}from"./trading-BZNjgXR3.js";import{d as j}from"./index-Bg1wiSh7.js";async function K(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function U({symbols:e,mode:w="LTP",enabled:r=!0,autoReconnect:y=!0}){const[S,x]=n.useState(new Map),[s,o]=n.useState(!1),[a,l]=n.useState(!1),[u,k]=n.useState(!1),[R,P]=n.useState(null),M=n.useRef(null),v=n.useRef(null),T=n.useRef(new Set),L=n.useRef([]),E=n.useCallback(async()=>K(),[]),t=n.useCallback(C=>{if(!M.current||M.current.readyState!==WebSocket.OPEN||!a){L.current=C;return}const d=C.filter(f=>{const _=`${f.exchange}:${f.symbol}`;return!T.current.has(_)});d.length!==0&&(M.current.send(JSON.stringify({action:"subscribe",symbols:d,mode:w})),d.forEach(f=>{const _=`${f.exchange}:${f.symbol}`;T.current.add(_),x(h=>{const i=new Map(h);return i.has(_)||i.set(_,{symbol:f.symbol,exchange:f.exchange,data:{}}),i})}))},[a,w]),p=n.useCallback(C=>{try{const d=JSON.parse(C.data);switch(d.type||d.status){case"auth":d.status==="success"?(l(!0),P(null),L.current.length>0&&setTimeout(()=>{t(L.current),L.current=[]},100)):P(`Authentication failed: ${d.message}`);break;case"market_data":{const _=d.symbol.toUpperCase(),h=d.exchange,i=d.data||{},D=`${h}:${_}`;x(m=>{const O=m.get(D);if(!O)return m;const q=new Map(m),b={...O.data};return Object.assign(b,{ltp:i.ltp??b.ltp,open:i.open??b.open,high:i.high??b.high,low:i.low??b.low,close:i.close??b.close,volume:i.volume??b.volume,change:i.change??b.change,change_percent:i.change_percent??b.change_percent,timestamp:i.timestamp??b.timestamp}),q.set(D,{...O,data:b,lastUpdate:Date.now()}),q});break}case"subscribe":break;case"error":P(`WebSocket error: ${d.message}`);break}}catch{}},[t]),c=n.useCallback(async()=>{if(M.current?.readyState!==WebSocket.OPEN){k(!0),P(null);try{const C=await E(),f=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":C},credentials:"include"})).json();if(f.status!=="success")throw new Error("Failed to get WebSocket configuration");const _=f.websocket_url,h=new WebSocket(_);h.onopen=async()=>{o(!0),k(!1);try{const i=await E(),m=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":i},credentials:"include"})).json();m.status==="success"&&m.api_key?h.send(JSON.stringify({action:"authenticate",api_key:m.api_key})):P("No API key found - please generate one at /apikey")}catch(i){P(`Authentication error: ${i}`)}},h.onclose=i=>{o(!1),k(!1),l(!1),T.current.clear(),y&&!i.wasClean&&r&&(v.current=setTimeout(c,3e3))},h.onerror=()=>{P("WebSocket connection error"),k(!1)},h.onmessage=p,M.current=h}catch(C){P(`Connection failed: ${C}`),k(!1)}}},[E,p,y,r]),g=n.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=null),M.current&&(M.current.close(1e3,"User disconnect"),M.current=null),o(!1),l(!1),T.current.clear()},[]);return n.useEffect(()=>(r&&e.length>0&&!s&&!u&&c(),()=>{v.current&&clearTimeout(v.current)}),[r,e.length,s,u,c]),n.useEffect(()=>{a&&e.length>0&&t(e)},[a,e,t]),n.useEffect(()=>()=>{g()},[g]),{data:S,isConnected:s,isAuthenticated:a,isConnecting:u,error:R,connect:c,disconnect:g}}async function H(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function N(){const[e,w]=n.useState({timings:[],holidays:[],isLoading:!0,error:null});n.useEffect(()=>{(async()=>{try{const a={"X-CSRFToken":await H(),"Content-Type":"application/json"},[l,u]=await Promise.all([fetch("/admin/api/timings",{headers:a,credentials:"include"}),fetch("/admin/api/holidays",{headers:a,credentials:"include"})]),k=await l.json(),R=await u.json();w({timings:k.status==="success"?k.market_status||[]:[],holidays:R.status==="success"?R.data||[]:[],isLoading:!1,error:null})}catch(o){w(a=>({...a,isLoading:!1,error:`Failed to fetch market status: ${o}`}))}})()},[]);const r=n.useCallback(s=>{const o=new Date().toISOString().split("T")[0],a=e.holidays.find(l=>l.date===o);if(!a)return!1;if(a.closed_exchanges.includes(s)){const l=a.open_exchanges.find(u=>u.exchange===s);if(l){const u=Date.now();return!(u>=l.start_time&&u<=l.end_time)}return!0}return!1},[e.holidays]),y=n.useCallback(s=>{if(r(s))return!1;const o=e.timings.find(l=>l.exchange===s);if(!o)return!1;const a=Date.now();return a>=o.start_time&&a<=o.end_time},[e.timings,r]),S=n.useCallback(()=>e.timings.some(s=>{const o=Date.now();return o>=s.start_time&&o<=s.end_time&&!r(s.exchange)}),[e.timings,r]),x=n.useCallback(s=>{if(r(s))return"closed";const o=e.timings.find(u=>u.exchange===s);if(!o)return"closed";const a=Date.now(),l=900*1e3;return a<o.start_time-l?"closed":a<o.start_time?"pre-market":a<=o.end_time?"open":"post-market"},[e.timings,r]);return{isMarketOpen:y,isAnyMarketOpen:S,isHolidayForExchange:r,getMarketStatus:x,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function X(e,w={}){const{enabled:r=!0,staleThreshold:y=5e3,useMultiQuotesFallback:S=!0,multiQuotesRefreshInterval:x=3e4}=w,{apiKey:s}=j(),{isMarketOpen:o,isAnyMarketOpen:a}=N(),l=a(),u=typeof window<"u"&&(window.localStorage.getItem("debug_live_price")==="1"||window.localStorage.getItem("debug_live_price")==="true"),[k,R]=n.useState(new Map),P=n.useMemo(()=>e.map(t=>({symbol:t.symbol,exchange:t.exchange})),[e]),{data:M,isConnected:v}=U({symbols:P,mode:"LTP",enabled:r&&e.length>0}),T=v&&l,L=n.useCallback(async()=>{if(!(!s||e.length===0||!S))try{const t=e.map(c=>({symbol:c.symbol,exchange:c.exchange}));u&&console.debug("[useLivePrice] MultiQuotes request",{count:t.length,sample:t.slice(0,5)});const p=await W.getMultiQuotes(s,t);if(u&&console.debug("[useLivePrice] MultiQuotes response",{status:p.status,resultsCount:p.results?.length??0,message:p.message,sampleKeys:p.results?.slice(0,5).map(c=>`${c.exchange}:${c.symbol}`)??[]}),p.status==="success"&&p.results){const c=new Map;p.results.forEach(g=>{const C=`${g.exchange}:${g.symbol}`;g.data&&c.set(C,g.data)}),u&&console.debug("[useLivePrice] MultiQuotes mapped",{mappedCount:c.size}),R(c)}}catch(t){u&&console.debug("[useLivePrice] MultiQuotes fetch failed",t)}},[s,e,S]);return n.useEffect(()=>{if(!r||e.length===0||!S)return;u&&console.debug("[useLivePrice] enabled",{enabled:r,itemsCount:e.length,apiKeyPresent:!!s,useMultiQuotesFallback:S}),L();const t=setInterval(L,x);return()=>clearInterval(t)},[r,e.length,S,L,x]),{data:n.useMemo(()=>(u&&r&&e.length>0&&console.debug("[useLivePrice] enhance items",{itemsCount:e.length,wsConnected:v,marketDataKeysSample:Array.from(M.keys()).slice(0,5),multiQuotesKeysSample:Array.from(k.keys()).slice(0,5)}),e.map(t=>{const p=`${t.exchange}:${t.symbol}`,c=M.get(p),g=k.get(p),C=t.quantity!==void 0&&t.quantity!==null,d=t.quantity||0,f=t.average_price||0,_=o(t.exchange),h=_&&c?.data?.ltp&&c.lastUpdate&&Date.now()-c.lastUpdate<y,i=!h&&g?.ltp;let D,m="rest";const O=c?.lastUpdate?Date.now()-c.lastUpdate:null,q=c?.data?.ltp,b=g?.ltp;if(h&&c?.data?.ltp?(D=c.data.ltp,m="websocket"):i&&g?.ltp?(D=g.ltp,m="multiquotes"):(D=t.ltp,m="rest"),u){const $=e.indexOf(t);$>-1&&$<5&&console.debug("[useLivePrice] decision",{key:p,exchange:t.exchange,exchangeMarketOpen:_,staleThreshold:y,wsConnected:v,wsHasData:!!c,wsLtp:q,wsAgeMs:O,mqHasData:!!g,mqLtp:b,hasWsData:h,hasMqData:i,selectedSource:m,selectedLtp:D})}if(C&&d===0)return{...t,_dataSource:"rest"};let A=t.pnl||0,Q=t.pnlpercent||0;const F=t.today_realized_pnl||0;if(D&&f>0){let $;d>0?$=(D-f)*d:$=(f-D)*Math.abs(d),A=F+$;const I=Math.abs(f*d);Q=I>0?A/I*100:0}return{...t,ltp:D,pnl:A,pnlpercent:Q,_dataSource:m}})),[e,M,k,o,y]),isLive:T,isConnected:v,isAnyMarketOpen:l,multiQuotes:k,refreshMultiQuotes:L}}function V(e,w){if(!w)return null;let r=0,y=0,S=0;e.forEach(s=>{r+=s.pnl||0;const o=s.average_price||0,a=s.quantity||0,l=s.ltp||o;y+=o*a,S+=l*a});const x=y>0?r/y*100:0;return{...w,totalholdingvalue:S,totalinvvalue:y,totalprofitandloss:r,totalpnlpercentage:x}}export{V as c,X as u};
