import{r as e}from"./vendor-react--vsXx8_n.js";function W(){const[n,D]=e.useState(()=>typeof document<"u"?document.visibilityState==="visible":!0),[l,v]=e.useState(!1),[T,L]=e.useState(Date.now()),[O,P]=e.useState(0),[g,k]=e.useState(0),a=e.useRef(n),d=e.useRef(null),C=e.useRef(Date.now()),p=e.useRef(n);e.useEffect(()=>{p.current=n},[n]);const m=e.useCallback(()=>{const i=Date.now();p.current?(P(i-C.current),k(0)):(k(d.current?i-d.current:0),P(0))},[]);return e.useEffect(()=>{if(typeof document>"u")return;const i=()=>{const y=document.visibilityState==="visible",c=Date.now();y&&!a.current?(v(!0),C.current=c,d.current&&k(c-d.current)):y||(d.current=c,v(!1)),a.current=y,D(y),L(c),m()};document.addEventListener("visibilitychange",i);const z=()=>{a.current||i()},o=()=>{a.current&&document.visibilityState==="hidden"&&i()};window.addEventListener("focus",z),window.addEventListener("blur",o);const w=setInterval(m,1e3);return()=>{document.removeEventListener("visibilitychange",i),window.removeEventListener("focus",z),window.removeEventListener("blur",o),clearInterval(w)}},[m]),e.useEffect(()=>{if(l){const i=setTimeout(()=>v(!1),100);return()=>clearTimeout(i)}},[l]),{isVisible:n,wasHidden:l,timeSinceVisible:O,timeSinceHidden:g,lastVisibilityChange:T}}async function J(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function H({symbols:n,mode:D="LTP",enabled:l=!0,autoReconnect:v=!0,pauseWhenHidden:T=!0,pauseDelay:L=5e3}){const[O,P]=e.useState(new Map),[g,k]=e.useState(!1),[a,d]=e.useState(!1),[C,p]=e.useState(!1),[m,i]=e.useState(!1),[z,o]=e.useState(null),{isVisible:w,wasHidden:y}=W(),c=e.useRef(null),_=e.useRef(null),S=e.useRef(null),$=e.useRef(!1),x=e.useRef(new Set),M=e.useRef([]),A=e.useCallback(async()=>J(),[]),E=e.useCallback(b=>{if(!c.current||c.current.readyState!==WebSocket.OPEN||!a){M.current=b;return}const r=b.filter(u=>{const h=`${u.exchange}:${u.symbol}`;return!x.current.has(h)});r.length!==0&&(c.current.send(JSON.stringify({action:"subscribe",symbols:r,mode:D})),r.forEach(u=>{const h=`${u.exchange}:${u.symbol}`;x.current.add(h),P(f=>{const t=new Map(f);return t.has(h)||t.set(h,{symbol:u.symbol,exchange:u.exchange,data:{}}),t})}))},[a,D]),j=e.useCallback(b=>{try{const r=JSON.parse(b.data);switch(r.type||r.status){case"auth":r.status==="success"?(d(!0),o(null),M.current.length>0&&setTimeout(()=>{E(M.current),M.current=[]},100)):o(`Authentication failed: ${r.message}`);break;case"market_data":{const h=r.symbol.toUpperCase(),f=r.exchange,t=r.data||{},N=`${f}:${h}`;P(R=>{const F=R.get(N);if(!F)return R;const U=new Map(R),s={...F.data};return Object.assign(s,{ltp:t.ltp??s.ltp,open:t.open??s.open,high:t.high??s.high,low:t.low??s.low,close:t.close??s.close,volume:t.volume??s.volume,change:t.change??s.change,change_percent:t.change_percent??s.change_percent,timestamp:t.timestamp??s.timestamp,bid_price:t.bid_price??s.bid_price,ask_price:t.ask_price??s.ask_price,bid_size:t.bid_size??s.bid_size,ask_size:t.ask_size??s.ask_size,depth:t.depth??s.depth}),U.set(N,{...F,data:s,lastUpdate:Date.now()}),U});break}case"subscribe":break;case"error":o(`WebSocket error: ${r.message}`);break}}catch{}},[E]),V=e.useCallback(async()=>{if(c.current?.readyState!==WebSocket.OPEN){p(!0),o(null);try{const b=await A(),u=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":b},credentials:"include"})).json();if(u.status!=="success")throw new Error("Failed to get WebSocket configuration");const h=u.websocket_url,f=new WebSocket(h);f.onopen=async()=>{k(!0),p(!1);try{const t=await A(),R=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":t},credentials:"include"})).json();R.status==="success"&&R.api_key?f.send(JSON.stringify({action:"authenticate",api_key:R.api_key})):o("No API key found - please generate one at /apikey")}catch(t){o(`Authentication error: ${t}`)}},f.onclose=t=>{k(!1),p(!1),d(!1),x.current.clear(),v&&!t.wasClean&&l&&(!T||document.visibilityState==="visible")&&(_.current=setTimeout(V,3e3))},f.onerror=()=>{o("WebSocket connection error"),p(!1)},f.onmessage=j,c.current=f}catch(b){o(`Connection failed: ${b}`),p(!1)}}},[A,j,v,l,T]),I=e.useCallback(()=>{_.current&&(clearTimeout(_.current),_.current=null),c.current&&(c.current.close(1e3,"User disconnect"),c.current=null),k(!1),d(!1),x.current.clear()},[]);return e.useEffect(()=>(l&&n.length>0&&!g&&!C&&V(),()=>{_.current&&clearTimeout(_.current)}),[l,n.length,g,C,V]),e.useEffect(()=>{a&&n.length>0&&E(n)},[a,n,E]),e.useEffect(()=>()=>{I()},[I]),e.useEffect(()=>{if(T)return!w&&g?($.current=!0,S.current=setTimeout(()=>{$.current=!1,i(!0),I()},L)):w&&(S.current&&(clearTimeout(S.current),S.current=null,$.current=!1),m&&l&&n.length>0&&($.current=!1,i(!1),V())),()=>{S.current&&(clearTimeout(S.current),S.current=null,$.current=!1)}},[w,g,m,T,L,l,n.length,V,I]),e.useEffect(()=>{y&&w&&a&&n.length>0&&(x.current.clear(),E(n))},[y,w,a,n,E]),{data:O,isConnected:g,isAuthenticated:a,isConnecting:C,isPaused:m,error:z,connect:V,disconnect:I}}export{H as a,W as u};
