import{r,j as e}from"./vendor-react--vsXx8_n.js";import{w as D,B as W,c as M,e as ce,t as k}from"./index-eAJJFbP2.js";import{C as l,a as o,b as m,c as b,d as c}from"./card-aGcF1__k.js";import{T as V,a as O,b as y,c as n,d as z,e as i}from"./table-BGTTavAB.js";import{W as de,q as Z,n as K}from"./lightweight-charts.production-EcMg1Lek.js";import{L as Q,R as oe,ap as me,q as xe,aD as he,bj as ue,D as je,bk as fe,aW as ge,v as ee,w as Ne,a1 as pe,ax as ve}from"./vendor-icons-CZtcNCrV.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CiBIGs7t.js";import"./vendor-radix-DnptSSCf.js";async function be(){return(await D.get("/health/api/current")).data}async function ye(s=24){return(await D.get("/health/api/history",{params:{hours:s}})).data}async function we(s=24){return(await D.get("/health/api/stats",{params:{hours:s}})).data}async function Se(){return(await D.get("/health/api/alerts")).data}async function Ce(s){await D.post(`/health/api/alerts/${s}/acknowledge`)}function ke(s=24){return`/health/export?hours=${s}`}const _e=1e4,Me=24,De=6,G=1200;function _({title:s,icon:u,value:x,subtitle:F,status:a,loading:H}){const w={pass:"text-green-500",warn:"text-yellow-500",fail:"text-red-500",unknown:"text-primary"},B={pass:"text-green-500 opacity-20",warn:"text-yellow-500 opacity-20",fail:"text-red-500 opacity-20",unknown:"text-primary opacity-20"};return e.jsx(l,{children:e.jsx(c,{className:"p-4",children:H?e.jsx("div",{className:"flex items-center justify-center py-6",children:e.jsx(Q,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s}),e.jsx("p",{className:M("text-2xl font-bold",w[a]),children:x}),F&&e.jsx("p",{className:"text-xs text-muted-foreground",children:F})]}),e.jsx(u,{className:M("h-8 w-8",B[a])})]})})})}function J({status:s}){return s==="pass"?e.jsx(Ne,{className:"h-4 w-4 text-green-500"}):s==="warn"?e.jsx(ee,{className:"h-4 w-4 text-yellow-500"}):s==="fail"?e.jsx(pe,{className:"h-4 w-4 text-red-500"}):e.jsx(ve,{className:"h-4 w-4 text-muted-foreground"})}const Fe="Asia/Kolkata";function se(s,u){const x=new Date(s);return Number.isNaN(x.getTime())?"-":new Intl.DateTimeFormat("en-IN",{timeZone:Fe,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0,...u}).format(x)}function Re(s){return se(s,{year:void 0,month:void 0,day:void 0})}function Te(){return document.documentElement.classList.contains("dark")}function Oe(){const[s,u]=r.useState(null),[x,F]=r.useState([]),[a,H]=r.useState(null),[w,B]=r.useState([]),[te,ae]=r.useState(!0),[U,P]=r.useState(!1),[S,re]=r.useState(!0),[q,ne]=r.useState(!0),N=r.useRef(null),p=r.useRef(null),j=r.useRef(null),f=r.useRef(null),L=r.useRef(null),I=r.useRef(null),R=async(t=!1)=>{try{P(!0);const[h,T,A,E]=await Promise.all([be(),ye(De),we(Me),Se()]);u(h),F(T),H(A),B(E),t&&k.success("Metrics refreshed")}catch(h){console.error("Error fetching health metrics:",h),k.error("Failed to fetch health metrics")}finally{ae(!1),P(!1)}};r.useEffect(()=>{R()},[]),r.useEffect(()=>{if(!S||!q)return;const t=setInterval(()=>{R()},_e);return()=>clearInterval(t)},[S,q]),r.useEffect(()=>{const t=()=>{ne(!document.hidden)};return t(),document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[]),r.useEffect(()=>{if(!x.length)return;const t=Te(),h=t?"#9ca3af":"#6b7280",T=t?"#374151":"#e5e7eb",A=t?"#4b5563":"#d1d5db",E={height:300,layout:{background:{type:de.Solid,color:"transparent"},textColor:h},grid:{vertLines:{visible:!1},horzLines:{visible:!1}},timeScale:{borderColor:A,timeVisible:!0},rightPriceScale:{borderColor:A},crosshair:{vertLine:{color:T},horzLine:{color:T}}};if(N.current&&!j.current){const d=Z(N.current,{...E,width:N.current.clientWidth,localization:{priceFormatter:v=>Math.round(v).toString()}}),C=d.addSeries(K,{color:"#3b82f6",lineWidth:2,priceLineVisible:!1,lastValueVisible:!0,priceFormat:{type:"custom",formatter:v=>Math.round(v).toString()}});j.current=d,L.current=C}if(p.current&&!f.current){const d=Z(p.current,{...E,width:p.current.clientWidth}),C=d.addSeries(K,{color:"#10b981",lineWidth:2,priceLineVisible:!1,lastValueVisible:!0});f.current=d,I.current=C}if(L.current&&I.current){const d=x.map(g=>({time:Math.floor(new Date(g.timestamp).getTime()/1e3),fd:g.fd_count,mem:g.memory_rss_mb})),C=d.length>G?Math.ceil(d.length/G):1,v=[],X=[];for(let g=0;g<d.length;g+=C){const $=d[g];v.push({time:$.time,value:$.fd}),X.push({time:$.time,value:$.mem})}L.current.setData(v),I.current.setData(X)}const Y=()=>{j.current&&N.current&&j.current.applyOptions({width:N.current.clientWidth}),f.current&&p.current&&f.current.applyOptions({width:p.current.clientWidth})};return window.addEventListener("resize",Y),()=>window.removeEventListener("resize",Y)},[x]),r.useEffect(()=>()=>{j.current&&(j.current.remove(),j.current=null),f.current&&(f.current.remove(),f.current=null)},[]);const ie=async t=>{try{await Ce(t),k.success("Alert acknowledged"),R()}catch(h){console.error("Error acknowledging alert:",h),k.error("Failed to acknowledge alert")}},le=()=>{window.open(ke(24),"_blank"),k.success("Exporting metrics to CSV")};return te?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(Q,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"System Health Monitor"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Real-time infrastructure monitoring â€¢ Updates every 10 seconds"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(W,{variant:"outline",size:"sm",onClick:()=>R(!0),disabled:U,children:[e.jsx(oe,{className:M("h-4 w-4 mr-2",U&&"animate-spin")}),"Refresh"]}),e.jsxs(W,{variant:S?"default":"outline",size:"sm",onClick:()=>re(!S),children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Auto: ",S?"ON":"OFF"]}),e.jsxs(W,{variant:"outline",size:"sm",onClick:le,children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),s&&e.jsxs("div",{className:M("rounded-lg border p-4 flex items-center gap-4",s.overall_status==="pass"&&"border-green-500/50 bg-green-500/10",s.overall_status==="warn"&&"border-yellow-500/50 bg-yellow-500/10",s.overall_status==="fail"&&"border-red-500/50 bg-red-500/10"),children:[e.jsx(J,{status:s.overall_status}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold",children:["System Status: ",s.overall_status.toUpperCase()]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last updated (IST): ",se(s.timestamp)]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsx(_,{title:"File Descriptors",icon:he,value:s?`${s.fd.count} / ${s.fd.limit}`:"-",subtitle:s?`${s.fd.usage_percent.toFixed(1)}% used`:void 0,status:s?.fd.status||"unknown",loading:!s}),e.jsx(_,{title:"Memory Usage",icon:ue,value:s?`${s.memory.rss_mb.toFixed(1)} MB`:"-",subtitle:s?`${s.memory.percent.toFixed(1)}% of system`:void 0,status:s?.memory.status||"unknown",loading:!s}),e.jsx(_,{title:"Database Connections",icon:je,value:s?.database.total||0,subtitle:"Active connections",status:s?.database.status||"unknown",loading:!s}),e.jsx(_,{title:"WebSocket Connections",icon:fe,value:s?.websocket.total||0,subtitle:s?`${s.websocket.total_symbols} symbols`:void 0,status:s?.websocket.status||"unknown",loading:!s}),e.jsx(_,{title:"Active Threads",icon:ge,value:s?.threads.count||0,subtitle:s&&s.threads.stuck>0?`${s.threads.stuck} stuck`:"None stuck",status:s?.threads.status||"unknown",loading:!s})]}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs(l,{children:[e.jsxs(o,{children:[e.jsx(m,{className:"text-lg",children:"File Descriptors (6h)"}),e.jsx(b,{children:"Historical FD usage over the last 6 hours"})]}),e.jsx(c,{children:e.jsx("div",{ref:N,className:"w-full h-[300px]"})})]}),e.jsxs(l,{children:[e.jsxs(o,{children:[e.jsx(m,{className:"text-lg",children:"Memory Usage (6h)"}),e.jsx(b,{children:"Historical memory consumption in MB over the last 6 hours"})]}),e.jsx(c,{children:e.jsx("div",{ref:p,className:"w-full h-[300px]"})})]})]}),a&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(l,{children:[e.jsx(o,{className:"pb-3",children:e.jsx(m,{className:"text-base",children:"File Descriptor Stats"})}),e.jsx(c,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Current:"}),e.jsx("dd",{className:"font-medium",children:a.fd.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Average:"}),e.jsx("dd",{className:"font-medium",children:a.fd.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Min / Max:"}),e.jsxs("dd",{className:"font-medium",children:[a.fd.min," / ",a.fd.max]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Warnings:"}),e.jsx("dd",{className:"font-medium text-yellow-600 dark:text-yellow-400",children:a.fd.warn_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Failures:"}),e.jsx("dd",{className:"font-medium text-red-600 dark:text-red-400",children:a.fd.fail_count})]})]})})]}),e.jsxs(l,{children:[e.jsx(o,{className:"pb-3",children:e.jsx(m,{className:"text-base",children:"Memory Stats"})}),e.jsx(c,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Current:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.current_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Average:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.avg_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Min / Max:"}),e.jsxs("dd",{className:"font-medium",children:[a.memory.min_mb.toFixed(1)," / ",a.memory.max_mb.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Warnings:"}),e.jsx("dd",{className:"font-medium text-yellow-600 dark:text-yellow-400",children:a.memory.warn_count})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Failures:"}),e.jsx("dd",{className:"font-medium text-red-600 dark:text-red-400",children:a.memory.fail_count})]})]})})]}),e.jsxs(l,{children:[e.jsx(o,{className:"pb-3",children:e.jsx(m,{className:"text-base",children:"Connection Stats"})}),e.jsx(c,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Current:"}),e.jsx("dd",{className:"font-medium",children:a.database.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Average:"}),e.jsx("dd",{className:"font-medium",children:a.database.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Current:"}),e.jsx("dd",{className:"font-medium",children:a.websocket.current})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Average:"}),e.jsx("dd",{className:"font-medium",children:a.websocket.avg.toFixed(1)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Threads:"}),e.jsx("dd",{className:"font-medium",children:a.threads.current})]})]})})]}),e.jsxs(l,{children:[e.jsx(o,{className:"pb-3",children:e.jsx(m,{className:"text-base",children:"Status Summary"})}),e.jsx(c,{children:e.jsxs("dl",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Overall (Pass/Warn/Fail):"}),e.jsx("dd",{className:"font-medium",children:a.status?.overall?`${a.status.overall.pass}/${a.status.overall.warn}/${a.status.overall.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"DB Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.database?`${a.status.database.warn}/${a.status.database.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"WS Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.websocket?`${a.status.websocket.warn}/${a.status.websocket.fail}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Threads Warn/Fail:"}),e.jsx("dd",{className:"font-medium",children:a.status?.threads?`${a.status.threads.warn}/${a.status.threads.fail}`:"-"})]})]})})]})]}),e.jsxs(l,{children:[e.jsxs(o,{children:[e.jsx(m,{className:"text-lg",children:"Top Memory Processes"}),e.jsx(b,{children:"Highest RSS memory usage across the host"})]}),e.jsx(c,{children:s?.processes&&s.processes.length>0?e.jsxs(V,{children:[e.jsx(O,{children:e.jsxs(y,{children:[e.jsx(n,{children:"Process"}),e.jsx(n,{className:"text-right",children:"PID"}),e.jsx(n,{className:"text-right",children:"RSS (MB)"}),e.jsx(n,{className:"text-right",children:"VMS (MB)"}),e.jsx(n,{className:"text-right",children:"Mem %"})]})}),e.jsx(z,{children:s.processes.map(t=>e.jsxs(y,{children:[e.jsx(i,{className:"font-medium",children:t.name}),e.jsx(i,{className:"text-right font-mono text-xs",children:t.pid??"-"}),e.jsx(i,{className:"text-right",children:t.rss_mb.toFixed(1)}),e.jsx(i,{className:"text-right",children:t.vms_mb.toFixed(1)}),e.jsx(i,{className:"text-right",children:t.memory_percent.toFixed(2)})]},`${t.pid}-${t.name}`))})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No process data available."})})]}),e.jsxs(l,{children:[e.jsxs(o,{children:[e.jsx(m,{className:"text-lg",children:"Thread Details"}),e.jsx(b,{children:"Recent thread snapshot from the application"})]}),e.jsx(c,{children:s?.threads.details&&s.threads.details.length>0?e.jsxs(V,{children:[e.jsx(O,{children:e.jsxs(y,{children:[e.jsx(n,{children:"Thread"}),e.jsx(n,{className:"text-right",children:"ID"}),e.jsx(n,{className:"text-right",children:"Daemon"}),e.jsx(n,{className:"text-right",children:"Alive"})]})}),e.jsx(z,{children:s.threads.details.map(t=>e.jsxs(y,{children:[e.jsx(i,{className:"font-medium",children:t.name}),e.jsx(i,{className:"text-right font-mono text-xs",children:t.id??"-"}),e.jsx(i,{className:"text-right",children:t.daemon?"Yes":"No"}),e.jsx(i,{className:"text-right",children:t.alive?"Yes":"No"})]},`${t.id}-${t.name}`))})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"No thread details available."})})]}),w.length>0&&e.jsxs(l,{className:"border-destructive/50",children:[e.jsxs(o,{children:[e.jsxs(m,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(ee,{className:"h-5 w-5"}),"Active Alerts (",w.length,")"]}),e.jsx(b,{children:"System health alerts requiring attention"})]}),e.jsx(c,{children:e.jsx("div",{className:"space-y-3",children:w.map(t=>e.jsxs("div",{className:M("rounded-lg border p-3 flex items-start justify-between gap-4",t.severity==="fail"&&"border-red-500/50 bg-red-500/10",t.severity==="warn"&&"border-yellow-500/50 bg-yellow-500/10"),children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(J,{status:t.severity}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.alert_type.replace(/_/g," ").toUpperCase()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})]})]}),!t.acknowledged&&e.jsx(W,{variant:"outline",size:"sm",onClick:()=>ie(t.id),children:"Acknowledge"})]},t.id))})})]}),e.jsxs(l,{children:[e.jsxs(o,{children:[e.jsx(m,{className:"text-lg",children:"Recent Metrics"}),e.jsx(b,{children:"Last 20 samples from the monitoring system"})]}),e.jsx(c,{children:e.jsxs(V,{children:[e.jsx(O,{children:e.jsxs(y,{children:[e.jsx(n,{children:"Time"}),e.jsx(n,{className:"text-right",children:"FDs"}),e.jsx(n,{className:"text-right",children:"Memory (MB)"}),e.jsx(n,{className:"text-right",children:"DB Conns"}),e.jsx(n,{className:"text-right",children:"WS Conns"}),e.jsx(n,{className:"text-right",children:"Threads"}),e.jsx(n,{children:"Status"})]})}),e.jsx(z,{children:x.slice(-20).reverse().map((t,h)=>e.jsxs(y,{children:[e.jsx(i,{className:"font-mono text-xs",children:Re(t.timestamp)}),e.jsx(i,{className:"text-right",children:t.fd_count}),e.jsx(i,{className:"text-right",children:t.memory_rss_mb.toFixed(1)}),e.jsx(i,{className:"text-right",children:t.db_connections}),e.jsx(i,{className:"text-right",children:t.ws_connections}),e.jsx(i,{className:"text-right",children:t.threads}),e.jsx(i,{children:e.jsx(ce,{variant:t.overall_status==="pass"?"default":t.overall_status==="warn"?"secondary":"destructive",children:t.overall_status})})]},h))})]})})]})]})}export{Oe as default};
