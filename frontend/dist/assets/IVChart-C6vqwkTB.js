import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{K as ce,W as de,q as me,n as ue}from"./lightweight-charts.production-EcMg1Lek.js";import{w as j,u as fe,s as W,B as Q}from"./index-NHrG-O_Z.js";import{C as he,a as pe,b as xe,d as ge}from"./card-Cn20bp_v.js";import{P as be,a as ye,b as ve,C as je,c as Ce,d as Ne,e as Ee,f as we,g as Te}from"./popover-DQlNqO83.js";import{S as k,a as F,b as $,c as D,d as V}from"./select-DcHsBqkV.js";import{T as Se,a as Ie,b as ke}from"./tabs-DnjOpX1p.js";import{aV as Fe,m as $e}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const O={getIVData:async l=>(await j.post("/ivchart/api/iv-data",l)).data,getDefaultSymbols:async l=>(await j.post("/ivchart/api/default-symbols",l)).data,getIntervals:async()=>(await j.get("/ivchart/api/intervals")).data,getUnderlyings:async l=>(await j.get(`/search/api/underlyings?exchange=${l}`)).data,getExpiries:async(l,i)=>(await j.get(`/search/api/expiries?exchange=${l}&underlying=${i}`)).data},De=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],Z={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},C=["iv","delta","theta","vega","gamma"],N={iv:{label:"IV",ceTitle:"CE IV",peTitle:"PE IV",formatter:l=>`${l.toFixed(2)}%`},delta:{label:"Delta",ceTitle:"CE Delta",peTitle:"PE Delta",formatter:l=>l.toFixed(4)},theta:{label:"Theta",ceTitle:"CE Theta",peTitle:"PE Theta",formatter:l=>l.toFixed(4)},vega:{label:"Vega",ceTitle:"CE Vega",peTitle:"PE Vega",formatter:l=>l.toFixed(4)},gamma:{label:"Gamma",ceTitle:"CE Gamma",peTitle:"PE Gamma",formatter:l=>l.toFixed(6)}},A=350;function Ve(l){if(!l)return"";const i=l.split("-");return i.length===3?`${i[0]}${i[1].toUpperCase()}${i[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function ze(){const{mode:l}=fe(),i=l==="dark",[P,M]=n.useState(!1),[R,ee]=n.useState("iv"),[f,te]=n.useState("NFO"),[se,G]=n.useState(Z.NFO),[H,z]=n.useState(!1),[h,U]=n.useState("NIFTY"),[ae,E]=n.useState([]),[w,x]=n.useState(""),[re,B]=n.useState([]),[T,Y]=n.useState("5m"),[g,ne]=n.useState("1"),[m,L]=n.useState(null),p=n.useRef(new Map),u=n.useRef(new Map),b=n.useRef(null),q=n.useMemo(()=>{const t={};for(const a of C)for(const s of["ce","pe"]){const r=`${a}-${s}`;t[r]=o=>{o?p.current.set(r,o):p.current.delete(r)}}return t},[]),K=n.useCallback(t=>({width:t,height:A,layout:{background:{type:de.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0},horzLines:{color:i?"rgba(166,173,187,0.1)":"rgba(0,0,0,0.1)",style:1,visible:!0}},rightPriceScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",scaleMargins:{top:.1,bottom:.1}},timeScale:{borderColor:i?"rgba(166,173,187,0.2)":"rgba(0,0,0,0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:a=>{const s=new Date(a*1e3),r=new Date(s.getTime()+5.5*60*60*1e3),o=r.getUTCHours().toString().padStart(2,"0"),c=r.getUTCMinutes().toString().padStart(2,"0");if(parseInt(g)>1){const y=r.getUTCDate().toString().padStart(2,"0"),d=(r.getUTCMonth()+1).toString().padStart(2,"0");return`${y}/${d} ${o}:${c}`}return`${o}:${c}`}},crosshair:{mode:ce.Normal,vertLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelVisible:!1},horzLine:{width:1,color:i?"rgba(166,173,187,0.5)":"rgba(0,0,0,0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#2563eb"}}}),[i,g]),X=n.useCallback(t=>{const a=document.createElement("div");a.style.cssText=`position:absolute;z-index:2;font-family:Arial,sans-serif;font-size:28px;font-weight:bold;user-select:none;pointer-events:none;color:${i?"rgba(166,173,187,0.12)":"rgba(0,0,0,0.06)"}`,a.textContent="OpenAlgo",t.appendChild(a),setTimeout(()=>{a.style.left=`${t.offsetWidth/2-a.offsetWidth/2}px`,a.style.top=`${t.offsetHeight/2-a.offsetHeight/2}px`},0)},[i]),S=n.useCallback(t=>{for(const a of C)for(const s of["CE","PE"]){const r=`${a}-${s.toLowerCase()}`,o=u.current.get(r);if(!o)continue;const c=t.series.find(d=>d.option_type===s);if(!c)continue;const y=c.iv_data.filter(d=>d[a]!==null).map(d=>({time:d.time,value:d[a]})).sort((d,v)=>d.time-v.time);o.series.setData(y),o.chart.timeScale().fitContent()}},[]);n.useEffect(()=>{for(const[,s]of u.current)s.chart.remove();u.current.clear();for(const[,s]of p.current)s.innerHTML="";const a=p.current.get("iv-ce")?.offsetWidth||500;for(const s of C)for(const r of["ce","pe"]){const o=`${s}-${r}`,c=p.current.get(o);if(!c)continue;const y=c.offsetWidth>0?c.offsetWidth:a,d=r==="ce"?"#22c55e":"#ef4444",v=N[s],ie=r==="ce"?v.ceTitle:v.peTitle,J=me(c,K(y)),oe=J.addSeries(ue,{color:d,lineWidth:2,priceScaleId:"right",title:ie,priceFormat:{type:"custom",formatter:v.formatter}});X(c),u.current.set(o,{chart:J,series:oe})}return b.current&&S(b.current),()=>{for(const[,s]of u.current)s.chart.remove();u.current.clear()}},[K,X,S]),n.useEffect(()=>{const t=()=>{for(const[a,s]of u.current){const r=p.current.get(a);r&&r.offsetWidth>0&&s.chart.applyOptions({width:r.offsetWidth})}};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),n.useEffect(()=>{(async()=>{try{const a=await O.getIntervals();if(a.status==="success"&&a.data){const s=[...a.data.seconds||[],...a.data.minutes||[],...a.data.hours||[]];B(s.length>0?s:["1m","3m","5m","10m","15m","30m","1h"]),s.length>0&&!s.includes(T)&&Y(s.includes("5m")?"5m":s[0])}}catch{B(["1m","3m","5m","10m","15m","30m","1h"])}})()},[]),n.useEffect(()=>{const t=Z[f]||[];G(t),U(t[0]||""),E([]),x(""),L(null),b.current=null;let a=!1;return(async()=>{try{const r=await O.getUnderlyings(f);if(a)return;r.status==="success"&&r.underlyings.length>0&&(G(r.underlyings),r.underlyings.includes(t[0])||U(r.underlyings[0]))}catch{}})(),()=>{a=!0}},[f]),n.useEffect(()=>{if(!h)return;E([]),x(""),L(null),b.current=null;let t=!1;return(async()=>{try{const s=await O.getExpiries(f,h);if(t)return;s.status==="success"&&s.expiries.length>0?(E(s.expiries),x(s.expiries[0])):(E([]),x(""))}catch{if(t)return;W.error("Failed to fetch expiry dates","positions")}})(),()=>{t=!0}},[h]);const _=n.useCallback(async()=>{if(w){M(!0);try{const t=await O.getIVData({underlying:h,exchange:f,expiry_date:Ve(w),interval:T,days:parseInt(g)});t.status==="success"&&t.data?(b.current=t.data,L(t.data),S(t.data)):W.error(t.message||"Failed to load data","positions")}catch{W.error("Failed to fetch data","positions")}finally{M(!1)}}},[w,T,g,h,f,S]);n.useEffect(()=>{_()},[_]);const le=t=>{ee(t),requestAnimationFrame(()=>{for(const a of["ce","pe"]){const s=`${t}-${a}`,r=u.current.get(s),o=p.current.get(s);r&&o&&o.offsetWidth>0&&(r.chart.applyOptions({width:o.offsetWidth}),r.chart.timeScale().fitContent())}})},I=(t,a)=>{if(!m)return"--";const s=m.series.find(c=>c.option_type===t);if(!s)return"--";const r=s.iv_data.filter(c=>c[a]!==null);if(r.length===0)return"--";const o=r[r.length-1][a];return o===null?"--":N[a].formatter(o)};return e.jsx("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:e.jsxs(he,{children:[e.jsx(pe,{className:"pb-4",children:e.jsx(xe,{className:"text-xl font-semibold",children:"Option Greeks"})}),e.jsxs(ge,{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[e.jsxs(k,{value:f,onValueChange:te,children:[e.jsx(F,{className:"w-[100px]",children:e.jsx($,{placeholder:"Exchange"})}),e.jsx(D,{children:De.map(t=>e.jsx(V,{value:t.value,children:t.label},t.value))})]}),e.jsxs(be,{open:H,onOpenChange:z,children:[e.jsx(ye,{asChild:!0,children:e.jsxs(Q,{variant:"outline",role:"combobox","aria-expanded":H,className:"w-[140px] justify-between",children:[h||"Underlying",e.jsx(Fe,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ve,{className:"w-48 p-0",align:"start",children:e.jsxs(je,{children:[e.jsx(Ce,{placeholder:"Search underlying..."}),e.jsxs(Ne,{children:[e.jsx(Ee,{children:"No underlying found"}),e.jsx(we,{children:se.map(t=>e.jsxs(Te,{value:t,onSelect:()=>{U(t),z(!1)},children:[e.jsx($e,{className:`mr-2 h-4 w-4 ${h===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(k,{value:w,onValueChange:x,children:[e.jsx(F,{className:"w-[140px]",children:e.jsx($,{placeholder:"Expiry"})}),e.jsx(D,{children:ae.map(t=>e.jsx(V,{value:t,children:t},t))})]}),e.jsxs(k,{value:T,onValueChange:Y,children:[e.jsx(F,{className:"w-[100px]",children:e.jsx($,{placeholder:"Interval"})}),e.jsx(D,{children:re.map(t=>e.jsx(V,{value:t,children:t},t))})]}),e.jsxs(k,{value:g,onValueChange:ne,children:[e.jsx(F,{className:"w-[100px]",children:e.jsx($,{placeholder:"Days"})}),e.jsx(D,{children:["1","5","10","15"].map(t=>e.jsxs(V,{value:t,children:[t," ",t==="1"?"Day":"Days"]},t))})]}),e.jsx(Q,{variant:"outline",size:"sm",onClick:_,disabled:P,children:P?"Loading...":"Refresh"})]}),m&&e.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-1 mb-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"ATM Strike: "}),e.jsx("span",{className:"font-medium",children:m.atm_strike})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"LTP: "}),e.jsx("span",{className:"font-medium",children:m.underlying_ltp?.toFixed(2)})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-green-500"}),e.jsx("span",{className:"text-muted-foreground",children:"CE: "}),e.jsx("span",{className:"font-medium",children:m.ce_symbol}),e.jsx("span",{className:"text-green-600 dark:text-green-400 font-medium ml-1",children:I("CE","iv")})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-red-500"}),e.jsx("span",{className:"text-muted-foreground",children:"PE: "}),e.jsx("span",{className:"font-medium",children:m.pe_symbol}),e.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium ml-1",children:I("PE","iv")})]})]}),e.jsx(Se,{value:R,onValueChange:le,children:e.jsx(Ie,{className:"grid w-full max-w-md grid-cols-5",children:C.map(t=>e.jsx(ke,{value:t,children:N[t].label},t))})}),e.jsx("div",{className:"mt-4",children:C.map(t=>e.jsx("div",{className:R!==t?"h-0 overflow-hidden pointer-events-none":"",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:[m?.ce_symbol||"CE"," ",N[t].label]}),e.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:I("CE",t)})]}),e.jsx("div",{ref:q[`${t}-ce`],className:"relative w-full rounded-lg border border-border/50",style:{height:A}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-red-600 dark:text-red-400",children:[m?.pe_symbol||"PE"," ",N[t].label]}),e.jsx("span",{className:"text-sm tabular-nums text-muted-foreground",children:I("PE",t)})]}),e.jsx("div",{ref:q[`${t}-pe`],className:"relative w-full rounded-lg border border-border/50",style:{height:A}})]})]})},t))})]})]})})}export{ze as default};
