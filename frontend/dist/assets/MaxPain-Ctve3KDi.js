import{r,j as e}from"./vendor-react-CCyQGCED.js";import{u as J,s as O,B as Q,e as u}from"./index-DtIvpiE8.js";import{o as k}from"./oi-tracker-XVOtPev8.js";import{C as W,d as Z}from"./card-Cjjm5IsA.js";import{S as F,a as C,b as _,c as M,d as E}from"./select-C3YeeD9X.js";import{P as ee}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const te=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],A={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]};function ae(g){if(!g)return"";const f=g.split("-");return f.length===3?`${f[0]}${f[1].toUpperCase()}${f[2].slice(-2)}`:g.replace(/-/g,"").toUpperCase()}function ue(){const{mode:g,appMode:f}=J(),c=f==="analyzer",d=g==="dark"||c,[x,L]=r.useState("NFO"),[R,I]=r.useState(A.NFO),[m,N]=r.useState("NIFTY"),[B,y]=r.useState([]),[p,h]=r.useState(""),[s,S]=r.useState(null),[P,w]=r.useState(!1),b=r.useRef(0);r.useEffect(()=>{const t=A[x]||[];I(t),N(t[0]||""),y([]),h(""),S(null);let n=!1;return(async()=>{try{const l=await k.getUnderlyings(x);if(n)return;l.status==="success"&&l.underlyings.length>0&&(I(l.underlyings),l.underlyings.includes(t[0])||N(l.underlyings[0]))}catch{}})(),()=>{n=!0}},[x]),r.useEffect(()=>{if(!m)return;y([]),h(""),S(null);let t=!1;return(async()=>{try{const i=await k.getExpiries(x,m);if(t)return;i.status==="success"&&i.expiries.length>0?(y(i.expiries),h(i.expiries[0])):(y([]),h(""))}catch{if(t)return;y([]),h("")}})(),()=>{t=!0}},[m]);const z=r.useCallback(async()=>{if(!p)return;const t=++b.current;w(!0);try{const n=ae(p),i=await k.getMaxPain({underlying:m,exchange:x,expiry_date:n});if(b.current!==t)return;i.status==="success"?S(i):O.error(i.message||"Failed to calculate Max Pain")}catch{if(b.current!==t)return;O.error("Failed to calculate Max Pain")}finally{b.current===t&&w(!1)}},[m,p,x]);r.useEffect(()=>{p&&z()},[p]);const a=r.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:d?"#e0e0e0":"#333333",grid:d?c?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",barColor:c?"#8b5cf6":"#7c3aed",maxPainBar:c?"#c084fc":"#a78bfa",markerLine:d?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:d?c?"#2d2545":"#1e293b":"#ffffff",hoverFont:d?"#e0e0e0":"#333333",hoverBorder:d?c?"#7c3aed":"#475569":"#e2e8f0"}),[d,c]),T=r.useMemo(()=>{if(!s?.pain_data)return{data:[],layout:{}};const t=s.max_pain_strike,n=s.pain_data,i=n.map((o,j)=>j),l=n.map(o=>o.strike.toString()),V=n.map(o=>o.total_pain_cr),U=Math.max(1,Math.floor(n.length/15)),Y=i.filter((o,j)=>j%U===0),$=l.filter((o,j)=>j%U===0),X=n.map(o=>o.strike===t?a.maxPainBar:a.barColor),q=[{x:i,y:V,type:"bar",name:"Max Pain",marker:{color:X},hovertemplate:"Strike %{text}<br>MaxPain: %{y:.2f} Crs.<extra></extra>",text:l,textposition:"none"}],v=t?n.findIndex(o=>o.strike===t):-1,G=v>=0?[{x:v,y:1,yref:"paper",text:`Max Pain ${t}`,showarrow:!1,font:{color:a.text,size:12,family:"system-ui, sans-serif"},yanchor:"bottom"}]:[],H=v>=0?[{type:"line",x0:v,x1:v,y0:0,y1:1,yref:"paper",line:{color:a.markerLine,width:1.5,dash:"dash"}}]:[],K={paper_bgcolor:a.paper,plot_bgcolor:a.bg,font:{color:a.text,family:"system-ui, sans-serif"},bargap:.15,hoverlabel:{bgcolor:a.hoverBg,font:{color:a.hoverFont,size:12},bordercolor:a.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:a.text,size:11}},margin:{l:60,r:30,t:30,b:80},xaxis:{tickmode:"array",tickvals:Y,ticktext:$,title:{text:"Strike Price",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,tickangle:-45},yaxis:{title:{text:"Max-Pain (Crs.)",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid},annotations:G,shapes:H};return{data:q,layout:K}},[s,a]),D=r.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Max Pain"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(F,{value:x,onValueChange:L,children:[e.jsx(C,{className:"w-[100px]",children:e.jsx(_,{placeholder:"Exchange"})}),e.jsx(M,{children:te.map(t=>e.jsx(E,{value:t.value,children:t.label},t.value))})]}),e.jsxs(F,{value:m,onValueChange:N,children:[e.jsx(C,{className:"w-[160px]",children:e.jsx(_,{placeholder:"Underlying"})}),e.jsx(M,{children:R.map(t=>e.jsx(E,{value:t,children:t},t))})]}),e.jsxs(F,{value:p,onValueChange:h,disabled:B.length===0,children:[e.jsx(C,{className:"w-[160px]",children:e.jsx(_,{placeholder:"Expiry"})}),e.jsx(M,{children:B.map(t=>e.jsx(E,{value:t,children:t},t))})]}),e.jsx(Q,{variant:"outline",size:"sm",onClick:z,disabled:P,children:P?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (OI): ",s.pcr_oi?.toFixed(2)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (Vol): ",s.pcr_volume?.toFixed(2)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1 font-semibold",children:["Max Pain: ",s.max_pain_strike]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]})]}),e.jsx(W,{children:e.jsx(Z,{className:"p-2 sm:p-4",children:P&&!s?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Calculating Max Pain..."}):s?.pain_data&&s.pain_data.length>0?e.jsx(ee,{data:T.data,layout:T.layout,config:D,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:p?"No data available for Max Pain calculation":"Select an underlying and expiry to view Max Pain"})})})]})}export{ue as default};
