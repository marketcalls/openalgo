import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{u as de,s as $,B as xe,e as v}from"./index-CN7OGpw6.js";import{o as C}from"./oi-profile-R5tLZ-XX.js";import{C as pe,d as he}from"./card-BrDNGO_S.js";import{S as E,a as w,b as O,c as F,d as _}from"./select-B7wjeE11.js";import{P as me}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const ue=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],M={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},fe={"1m":1,"5m":5,"15m":7};function U(m){if(!m)return"";const d=m.split("-");return d.length===3?`${d[0]}${d[1].toUpperCase()}${d[2].slice(-2)}`:m.replace(/-/g,"").toUpperCase()}function ge(m){const d=m.timestamp??m.time;if(!d)return"";if(typeof d=="number"){const i=d>1e12?d:d*1e3,l=new Date(i),b=String(l.getDate()).padStart(2,"0"),S=l.toLocaleString("en",{month:"short"}),f=String(l.getHours()).padStart(2,"0"),p=String(l.getMinutes()).padStart(2,"0");return`${b}-${S} ${f}:${p}`}const u=String(d);try{const i=new Date(u);if(!Number.isNaN(i.getTime())){const l=String(i.getDate()).padStart(2,"0"),b=i.toLocaleString("en",{month:"short"}),S=String(i.getHours()).padStart(2,"0"),f=String(i.getMinutes()).padStart(2,"0");return`${l}-${b} ${S}:${f}`}}catch{}return u}function Oe(){const{mode:m,appMode:d}=de(),u=d==="analyzer",i=m==="dark"||u,[l,b]=n.useState("NFO"),[S,f]=n.useState(M.NFO),[p,k]=n.useState("NIFTY"),[B,I]=n.useState([]),[h,g]=n.useState(""),[R,V]=n.useState(["5m"]),[y,A]=n.useState("5m"),[o,P]=n.useState(null),[z,D]=n.useState(!1),j=n.useRef(0);n.useEffect(()=>{(async()=>{try{const r=await C.getIntervals();r.status==="success"&&r.data?.intervals.length&&(V(r.data.intervals),r.data.intervals.includes(y)||A(r.data.intervals[0]))}catch{}})()},[]),n.useEffect(()=>{const t=M[l]||[];f(t),k(t[0]||""),I([]),g(""),P(null);let r=!1;return(async()=>{try{const x=await C.getUnderlyings(l);if(r)return;x.status==="success"&&x.underlyings.length>0&&(f(x.underlyings),x.underlyings.includes(t[0])||k(x.underlyings[0]))}catch{}})(),()=>{r=!0}},[l]),n.useEffect(()=>{if(!p)return;I([]),g(""),P(null);let t=!1;return(async()=>{try{const c=await C.getExpiries(l,p);if(t)return;c.status==="success"&&c.expiries.length>0?(I(c.expiries),g(c.expiries[0])):(I([]),g(""))}catch{if(t)return;I([]),g("")}})(),()=>{t=!0}},[p]);const L=n.useCallback(async()=>{if(!h)return;const t=++j.current;D(!0);try{const r=U(h),c=fe[y]||5,x=await C.getProfileData({underlying:p,exchange:l,expiry_date:r,interval:y,days:c});if(j.current!==t)return;x.status==="success"?P(x):$.error(x.message||"Failed to fetch OI Profile data")}catch{if(j.current!==t)return;$.error("Failed to fetch OI Profile data")}finally{j.current===t&&D(!1)}},[p,h,l,y]);n.useEffect(()=>{h&&L()},[h,y]);const s=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:i?"#e0e0e0":"#333333",grid:i?u?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceOI:"#22c55e",peOI:"#ef4444",ceChange:"#86efac",peChange:"#fca5a5",atmLine:"#eab308",hoverBg:i?u?"#2d2545":"#1e293b":"#ffffff",hoverFont:i?"#e0e0e0":"#333333",hoverBorder:i?u?"#7c3aed":"#475569":"#e2e8f0",increasing:"#22c55e",decreasing:"#ef4444"}),[i,u]),Y=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),T=n.useMemo(()=>{if(!o?.oi_chain||!o.candles?.length)return{data:[],layout:{}};const t=o.candles,r=o.oi_chain,c=o.atm_strike,x=t.map(ge),H=t.map(a=>a.open),X=t.map(a=>a.high),q=t.map(a=>a.low),G=t.map(a=>a.close),N=r.map(a=>a.strike),K=r.map(a=>a.ce_oi),J=r.map(a=>-a.pe_oi),Q=r.map(a=>a.ce_oi_change),W=r.map(a=>-a.pe_oi_change),Z=r.map(a=>a.pe_oi),ee=r.map(a=>a.pe_oi_change),te=x.length,se=Math.max(1,Math.floor(te/10)),ae=x.filter((a,ce)=>ce%se===0),re=[{x,open:H,high:X,low:q,close:G,type:"candlestick",name:o.futures_symbol||"Futures",xaxis:"x",yaxis:"y",increasing:{line:{color:s.increasing}},decreasing:{line:{color:s.decreasing}},showlegend:!1},{y:N,x:K,type:"bar",orientation:"h",name:"CE OI",marker:{color:s.ceOI},xaxis:"x2",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>OI: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:J,type:"bar",orientation:"h",name:"PE OI",marker:{color:s.peOI},xaxis:"x2",yaxis:"y",customdata:Z,hovertemplate:"<b>%{y} PE</b><br>OI: %{customdata:,.0f}<extra></extra>",showlegend:!1},{y:N,x:Q,type:"bar",orientation:"h",name:"CE Change",marker:{color:s.ceChange},xaxis:"x3",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>Change: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:W,type:"bar",orientation:"h",name:"PE Change",marker:{color:s.peChange},xaxis:"x3",yaxis:"y",customdata:ee,hovertemplate:"<b>%{y} PE</b><br>Change: %{customdata:,.0f}<extra></extra>",showlegend:!1}],ne=U(h),oe=c?[{type:"line",x0:0,x1:1,xref:"paper",y0:c,y1:c,line:{color:s.atmLine,width:2,dash:"dash"}}]:[],ie=c?[{x:0,xref:"paper",y:c,text:`ATM ${c}`,showarrow:!1,font:{color:s.atmLine,size:11},xanchor:"left",yanchor:"bottom"}]:[],le={title:{text:`${p} ${ne} - Futures with OI Profile`,font:{color:s.text,size:14}},paper_bgcolor:s.paper,plot_bgcolor:s.bg,font:{color:s.text,family:"system-ui, sans-serif"},barmode:"overlay",bargap:.1,showlegend:!1,margin:{l:60,r:30,t:50,b:60},hoverlabel:{bgcolor:s.hoverBg,font:{color:s.hoverFont,size:12},bordercolor:s.hoverBorder},xaxis:{domain:[0,.48],type:"category",tickmode:"array",tickvals:ae,tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"Time",font:{color:s.text,size:11}},rangeslider:{visible:!1}},xaxis2:{domain:[.5,.74],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE OI",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},xaxis3:{domain:[.76,1],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE Change (D)",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},yaxis:{title:{text:"Price / Strike",font:{color:s.text,size:11}},tickfont:{color:s.text,size:10},gridcolor:s.grid,showgrid:!0},shapes:oe,annotations:ie};return{data:re,layout:le}},[o,s,h,p]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"OI Profile"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(E,{value:l,onValueChange:b,children:[e.jsx(w,{className:"w-[100px]",children:e.jsx(O,{placeholder:"Exchange"})}),e.jsx(F,{children:ue.map(t=>e.jsx(_,{value:t.value,children:t.label},t.value))})]}),e.jsxs(E,{value:p,onValueChange:k,children:[e.jsx(w,{className:"w-[160px]",children:e.jsx(O,{placeholder:"Underlying"})}),e.jsx(F,{children:S.map(t=>e.jsx(_,{value:t,children:t},t))})]}),e.jsxs(E,{value:h,onValueChange:g,disabled:B.length===0,children:[e.jsx(w,{className:"w-[160px]",children:e.jsx(O,{placeholder:"Expiry"})}),e.jsx(F,{children:B.map(t=>e.jsx(_,{value:t,children:t},t))})]}),e.jsxs(E,{value:y,onValueChange:A,children:[e.jsx(w,{className:"w-[100px]",children:e.jsx(O,{placeholder:"Interval"})}),e.jsx(F,{children:R.map(t=>e.jsx(_,{value:t,children:t},t))})]}),e.jsx(xe,{variant:"outline",size:"sm",onClick:L,disabled:z,children:z?"Loading...":"Refresh"})]})]}),o&&o.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",o.spot_price?.toFixed(1)]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",o.atm_strike]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",o.lot_size]}),o.futures_symbol&&e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",o.futures_symbol]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Interval: ",o.interval]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Candles: ",o.candles?.length||0]})]}),e.jsx(pe,{children:e.jsx(he,{className:"p-2 sm:p-4",children:z&&!o?e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:"Loading OI Profile data..."}):T.data.length>0?e.jsx(me,{data:T.data,layout:T.layout,config:Y,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:h?"No data available":"Select an underlying and expiry to view OI Profile"})})})]})}export{Oe as default};
