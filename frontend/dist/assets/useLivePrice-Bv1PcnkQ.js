import{r as e}from"./vendor-react--vsXx8_n.js";import{t as N}from"./trading-niZE8Jso.js";import{d as U}from"./index-Dv2VjKij.js";function W(){const[t,b]=e.useState(()=>typeof document<"u"?document.visibilityState==="visible":!0),[s,p]=e.useState(!1),[l,v]=e.useState(Date.now()),[r,a]=e.useState(0),[n,c]=e.useState(0),o=e.useRef(t),d=e.useRef(null),D=e.useRef(Date.now()),C=e.useRef(t);e.useEffect(()=>{C.current=t},[t]);const E=e.useCallback(()=>{const g=Date.now();C.current?(a(g-D.current),c(0)):(c(d.current?g-d.current:0),a(0))},[]);return e.useEffect(()=>{if(typeof document>"u")return;const g=()=>{const P=document.visibilityState==="visible",m=Date.now();P&&!o.current?(p(!0),D.current=m,d.current&&c(m-d.current)):P||(d.current=m,p(!1)),o.current=P,b(P),v(m),E()};document.addEventListener("visibilitychange",g);const j=()=>{o.current||g()},k=()=>{o.current&&document.visibilityState==="hidden"&&g()};window.addEventListener("focus",j),window.addEventListener("blur",k);const $=setInterval(E,1e3);return()=>{document.removeEventListener("visibilitychange",g),window.removeEventListener("focus",j),window.removeEventListener("blur",k),clearInterval($)}},[E]),e.useEffect(()=>{if(s){const g=setTimeout(()=>p(!1),100);return()=>clearTimeout(g)}},[s]),{isVisible:t,wasHidden:s,timeSinceVisible:r,timeSinceHidden:n,lastVisibilityChange:l}}async function K(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function z({symbols:t,mode:b="LTP",enabled:s=!0,autoReconnect:p=!0,pauseWhenHidden:l=!0,pauseDelay:v=5e3}){const[r,a]=e.useState(new Map),[n,c]=e.useState(!1),[o,d]=e.useState(!1),[D,C]=e.useState(!1),[E,g]=e.useState(!1),[j,k]=e.useState(null),{isVisible:$,wasHidden:P}=W(),m=e.useRef(null),O=e.useRef(null),I=e.useRef(null),M=e.useRef(!1),q=e.useRef(new Set),i=e.useRef([]),x=e.useCallback(async()=>K(),[]),f=e.useCallback(V=>{if(!m.current||m.current.readyState!==WebSocket.OPEN||!o){i.current=V;return}const y=V.filter(R=>{const h=`${R.exchange}:${R.symbol}`;return!q.current.has(h)});y.length!==0&&(m.current.send(JSON.stringify({action:"subscribe",symbols:y,mode:b})),y.forEach(R=>{const h=`${R.exchange}:${R.symbol}`;q.current.add(h),a(w=>{const u=new Map(w);return u.has(h)||u.set(h,{symbol:R.symbol,exchange:R.exchange,data:{}}),u})}))},[o,b]),T=e.useCallback(V=>{try{const y=JSON.parse(V.data);switch(y.type||y.status){case"auth":y.status==="success"?(d(!0),k(null),i.current.length>0&&setTimeout(()=>{f(i.current),i.current=[]},100)):k(`Authentication failed: ${y.message}`);break;case"market_data":{const h=y.symbol.toUpperCase(),w=y.exchange,u=y.data||{},A=`${w}:${h}`;a(F=>{const H=F.get(A);if(!H)return F;const Q=new Map(F),_={...H.data};return Object.assign(_,{ltp:u.ltp??_.ltp,open:u.open??_.open,high:u.high??_.high,low:u.low??_.low,close:u.close??_.close,volume:u.volume??_.volume,change:u.change??_.change,change_percent:u.change_percent??_.change_percent,timestamp:u.timestamp??_.timestamp}),Q.set(A,{...H,data:_,lastUpdate:Date.now()}),Q});break}case"subscribe":break;case"error":k(`WebSocket error: ${y.message}`);break}}catch{}},[f]),S=e.useCallback(async()=>{if(m.current?.readyState!==WebSocket.OPEN){C(!0),k(null);try{const V=await x(),R=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":V},credentials:"include"})).json();if(R.status!=="success")throw new Error("Failed to get WebSocket configuration");const h=R.websocket_url,w=new WebSocket(h);w.onopen=async()=>{c(!0),C(!1);try{const u=await x(),F=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":u},credentials:"include"})).json();F.status==="success"&&F.api_key?w.send(JSON.stringify({action:"authenticate",api_key:F.api_key})):k("No API key found - please generate one at /apikey")}catch(u){k(`Authentication error: ${u}`)}},w.onclose=u=>{c(!1),C(!1),d(!1),q.current.clear(),p&&!u.wasClean&&s&&(!l||document.visibilityState==="visible")&&(O.current=setTimeout(S,3e3))},w.onerror=()=>{k("WebSocket connection error"),C(!1)},w.onmessage=T,m.current=w}catch(V){k(`Connection failed: ${V}`),C(!1)}}},[x,T,p,s,l]),L=e.useCallback(()=>{O.current&&(clearTimeout(O.current),O.current=null),m.current&&(m.current.close(1e3,"User disconnect"),m.current=null),c(!1),d(!1),q.current.clear()},[]);return e.useEffect(()=>(s&&t.length>0&&!n&&!D&&S(),()=>{O.current&&clearTimeout(O.current)}),[s,t.length,n,D,S]),e.useEffect(()=>{o&&t.length>0&&f(t)},[o,t,f]),e.useEffect(()=>()=>{L()},[L]),e.useEffect(()=>{if(l)return!$&&n?(M.current=!0,I.current=setTimeout(()=>{M.current=!1,g(!0),L()},v)):$&&(I.current&&(clearTimeout(I.current),I.current=null,M.current=!1),E&&s&&t.length>0&&(M.current=!1,g(!1),S())),()=>{I.current&&(clearTimeout(I.current),I.current=null,M.current=!1)}},[$,n,E,l,v,s,t.length,S,L]),e.useEffect(()=>{P&&$&&o&&t.length>0&&(q.current.clear(),f(t))},[P,$,o,t,f]),{data:r,isConnected:n,isAuthenticated:o,isConnecting:D,isPaused:E,error:j,connect:S,disconnect:L}}async function J(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function X(){const[t,b]=e.useState({timings:[],holidays:[],isLoading:!0,error:null});e.useEffect(()=>{(async()=>{try{const n={"X-CSRFToken":await J(),"Content-Type":"application/json"},[c,o]=await Promise.all([fetch("/admin/api/timings",{headers:n,credentials:"include"}),fetch("/admin/api/holidays",{headers:n,credentials:"include"})]),d=await c.json(),D=await o.json();b({timings:d.status==="success"?d.market_status||[]:[],holidays:D.status==="success"?D.data||[]:[],isLoading:!1,error:null})}catch(a){b(n=>({...n,isLoading:!1,error:`Failed to fetch market status: ${a}`}))}})()},[]);const s=e.useCallback(r=>{const a=new Date().toISOString().split("T")[0],n=t.holidays.find(c=>c.date===a);if(!n)return!1;if(n.closed_exchanges.includes(r)){const c=n.open_exchanges.find(o=>o.exchange===r);if(c){const o=Date.now();return!(o>=c.start_time&&o<=c.end_time)}return!0}return!1},[t.holidays]),p=e.useCallback(r=>{if(s(r))return!1;const a=t.timings.find(c=>c.exchange===r);if(!a)return!1;const n=Date.now();return n>=a.start_time&&n<=a.end_time},[t.timings,s]),l=e.useCallback(()=>t.timings.some(r=>{const a=Date.now();return a>=r.start_time&&a<=r.end_time&&!s(r.exchange)}),[t.timings,s]),v=e.useCallback(r=>{if(s(r))return"closed";const a=t.timings.find(o=>o.exchange===r);if(!a)return"closed";const n=Date.now(),c=900*1e3;return n<a.start_time-c?"closed":n<a.start_time?"pre-market":n<=a.end_time?"open":"post-market"},[t.timings,s]);return{isMarketOpen:p,isAnyMarketOpen:l,isHolidayForExchange:s,getMarketStatus:v,timings:t.timings,holidays:t.holidays,isLoading:t.isLoading,error:t.error}}function Z(t,b={}){const{enabled:s=!0,staleThreshold:p=5e3,useMultiQuotesFallback:l=!0,multiQuotesRefreshInterval:v=3e4,pauseWhenHidden:r=!0,pauseDelay:a=5e3}=b,{apiKey:n}=U(),{isMarketOpen:c,isAnyMarketOpen:o}=X(),{isVisible:d,wasHidden:D,timeSinceHidden:C}=W(),E=o(),[g,j]=e.useState(new Map),k=e.useRef(Date.now()),$=e.useMemo(()=>t.map(i=>({symbol:i.symbol,exchange:i.exchange})),[t]),{data:P,isConnected:m,isPaused:O}=z({symbols:$,mode:"LTP",enabled:s&&t.length>0,pauseWhenHidden:r,pauseDelay:a}),I=m&&E&&!O,M=e.useCallback(async()=>{if(!(!n||t.length===0||!l))try{const i=t.map(f=>({symbol:f.symbol,exchange:f.exchange})),x=await N.getMultiQuotes(n,i);if(x.status==="success"&&x.results){const f=new Map;x.results.forEach(T=>{const S=`${T.exchange}:${T.symbol}`;T.data&&f.set(S,T.data)}),j(f)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[n,t,l]);return e.useEffect(()=>{if(!s||t.length===0||!l||r&&!d)return;M(),k.current=Date.now();const i=setInterval(()=>{M(),k.current=Date.now()},v);return()=>clearInterval(i)},[s,t.length,l,M,v,r,d]),e.useEffect(()=>{!D||!d||!l||!s||C>v&&(M(),k.current=Date.now())},[D,d,C,v,l,s,M]),{data:e.useMemo(()=>t.map(i=>{const x=`${i.exchange}:${i.symbol}`,f=P.get(x),T=g.get(x),S=i.quantity||0,L=i.average_price||0,y=c(i.exchange)&&f?.data?.ltp&&f.lastUpdate&&Date.now()-f.lastUpdate<p,R=!y&&T?.ltp;let h,w="rest";if(y&&f?.data?.ltp?(h=f.data.ltp,w="websocket"):R&&T?.ltp?(h=T.ltp,w="multiquotes"):(h=i.ltp,w="rest"),S===0)return{...i,_dataSource:"rest"};let u=i.pnl||0,A=i.pnlpercent||0;const F=i.today_realized_pnl||0;if(h&&L>0){let H;S>0?H=(h-L)*S:H=(L-h)*Math.abs(S),u=F+H;const Q=Math.abs(L*S);A=Q>0?u/Q*100:0}return{...i,ltp:h,pnl:u,pnlpercent:A,_dataSource:w}}),[t,P,g,c,p]),isLive:I,isConnected:m,isPaused:O,isAnyMarketOpen:E,multiQuotes:g,refreshMultiQuotes:M}}function ee(t,b){if(!b)return null;let s=0,p=0,l=0;t.forEach(r=>{s+=r.pnl||0;const a=r.average_price||0,n=r.quantity||0,c=r.ltp||a;p+=a*n,l+=c*n});const v=p>0?s/p*100:0;return{...b,totalholdingvalue:l,totalinvvalue:p,totalprofitandloss:s,totalpnlpercentage:v}}export{Z as a,ee as c,W as u};
