import{r as t}from"./vendor-react--vsXx8_n.js";import{t as A}from"./trading-5htA8SgB.js";import{d as F}from"./index-DJB2TVW5.js";async function I(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function W({symbols:e,mode:y="LTP",enabled:o=!0,autoReconnect:m=!0}){const[w,R]=t.useState(new Map),[a,s]=t.useState(!1),[n,i]=t.useState(!1),[u,D]=t.useState(!1),[$,b]=t.useState(null),S=t.useRef(null),P=t.useRef(null),T=t.useRef(new Set),O=t.useRef([]),r=t.useCallback(async()=>I(),[]),M=t.useCallback(k=>{if(!S.current||S.current.readyState!==WebSocket.OPEN||!n){O.current=k;return}const d=k.filter(p=>{const _=`${p.exchange}:${p.symbol}`;return!T.current.has(_)});d.length!==0&&(S.current.send(JSON.stringify({action:"subscribe",symbols:d,mode:y})),d.forEach(p=>{const _=`${p.exchange}:${p.symbol}`;T.current.add(_),R(l=>{const c=new Map(l);return c.has(_)||c.set(_,{symbol:p.symbol,exchange:p.exchange,data:{}}),c})}))},[n,y]),f=t.useCallback(k=>{try{const d=JSON.parse(k.data);switch(d.type||d.status){case"auth":d.status==="success"?(i(!0),b(null),O.current.length>0&&setTimeout(()=>{M(O.current),O.current=[]},100)):b(`Authentication failed: ${d.message}`);break;case"market_data":{const _=d.symbol.toUpperCase(),l=d.exchange,c=d.data||{},v=`${l}:${_}`;R(x=>{const L=x.get(v);if(!L)return x;const E=new Map(x),h={...L.data};return Object.assign(h,{ltp:c.ltp??h.ltp,open:c.open??h.open,high:c.high??h.high,low:c.low??h.low,close:c.close??h.close,volume:c.volume??h.volume,change:c.change??h.change,change_percent:c.change_percent??h.change_percent,timestamp:c.timestamp??h.timestamp}),E.set(v,{...L,data:h,lastUpdate:Date.now()}),E});break}case"subscribe":break;case"error":b(`WebSocket error: ${d.message}`);break}}catch{}},[M]),g=t.useCallback(async()=>{if(S.current?.readyState!==WebSocket.OPEN){D(!0),b(null);try{const k=await r(),p=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":k},credentials:"include"})).json();if(p.status!=="success")throw new Error("Failed to get WebSocket configuration");const _=p.websocket_url,l=new WebSocket(_);l.onopen=async()=>{s(!0),D(!1);try{const c=await r(),x=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":c},credentials:"include"})).json();x.status==="success"&&x.api_key?l.send(JSON.stringify({action:"authenticate",api_key:x.api_key})):b("No API key found - please generate one at /apikey")}catch(c){b(`Authentication error: ${c}`)}},l.onclose=c=>{s(!1),D(!1),i(!1),T.current.clear(),m&&!c.wasClean&&o&&(P.current=setTimeout(g,3e3))},l.onerror=()=>{b("WebSocket connection error"),D(!1)},l.onmessage=f,S.current=l}catch(k){b(`Connection failed: ${k}`),D(!1)}}},[r,f,m,o]),C=t.useCallback(()=>{P.current&&(clearTimeout(P.current),P.current=null),S.current&&(S.current.close(1e3,"User disconnect"),S.current=null),s(!1),i(!1),T.current.clear()},[]);return t.useEffect(()=>(o&&e.length>0&&!a&&!u&&g(),()=>{P.current&&clearTimeout(P.current)}),[o,e.length,a,u,g]),t.useEffect(()=>{n&&e.length>0&&M(e)},[n,e,M]),t.useEffect(()=>()=>{C()},[C]),{data:w,isConnected:a,isAuthenticated:n,isConnecting:u,error:$,connect:g,disconnect:C}}async function j(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function q(){const[e,y]=t.useState({timings:[],holidays:[],isLoading:!0,error:null});t.useEffect(()=>{(async()=>{try{const n={"X-CSRFToken":await j(),"Content-Type":"application/json"},[i,u]=await Promise.all([fetch("/admin/api/timings",{headers:n,credentials:"include"}),fetch("/admin/api/holidays",{headers:n,credentials:"include"})]),D=await i.json(),$=await u.json();y({timings:D.status==="success"?D.market_status||[]:[],holidays:$.status==="success"?$.data||[]:[],isLoading:!1,error:null})}catch(s){y(n=>({...n,isLoading:!1,error:`Failed to fetch market status: ${s}`}))}})()},[]);const o=t.useCallback(a=>{const s=new Date().toISOString().split("T")[0],n=e.holidays.find(i=>i.date===s);if(!n)return!1;if(n.closed_exchanges.includes(a)){const i=n.open_exchanges.find(u=>u.exchange===a);if(i){const u=Date.now();return!(u>=i.start_time&&u<=i.end_time)}return!0}return!1},[e.holidays]),m=t.useCallback(a=>{if(o(a))return!1;const s=e.timings.find(i=>i.exchange===a);if(!s)return!1;const n=Date.now();return n>=s.start_time&&n<=s.end_time},[e.timings,o]),w=t.useCallback(()=>e.timings.some(a=>{const s=Date.now();return s>=a.start_time&&s<=a.end_time&&!o(a.exchange)}),[e.timings,o]),R=t.useCallback(a=>{if(o(a))return"closed";const s=e.timings.find(u=>u.exchange===a);if(!s)return"closed";const n=Date.now(),i=900*1e3;return n<s.start_time-i?"closed":n<s.start_time?"pre-market":n<=s.end_time?"open":"post-market"},[e.timings,o]);return{isMarketOpen:m,isAnyMarketOpen:w,isHolidayForExchange:o,getMarketStatus:R,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function H(e,y={}){const{enabled:o=!0,staleThreshold:m=5e3,useMultiQuotesFallback:w=!0,multiQuotesRefreshInterval:R=3e4}=y,{apiKey:a}=F(),{isMarketOpen:s,isAnyMarketOpen:n}=q(),i=n(),[u,D]=t.useState(new Map),$=t.useMemo(()=>e.map(r=>({symbol:r.symbol,exchange:r.exchange})),[e]),{data:b,isConnected:S}=W({symbols:$,mode:"LTP",enabled:o&&e.length>0}),P=S&&i,T=t.useCallback(async()=>{if(!(!a||e.length===0||!w))try{const r=e.map(f=>({symbol:f.symbol,exchange:f.exchange})),M=await A.getMultiQuotes(a,r);if(M.status==="success"&&M.results){const f=new Map;M.results.forEach(g=>{const C=`${g.exchange}:${g.symbol}`;g.data&&f.set(C,g.data)}),D(f)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[a,e,w]);return t.useEffect(()=>{if(!o||e.length===0||!w)return;T();const r=setInterval(T,R);return()=>clearInterval(r)},[o,e.length,w,T,R]),{data:t.useMemo(()=>e.map(r=>{const M=`${r.exchange}:${r.symbol}`,f=b.get(M),g=u.get(M),C=r.quantity||0,k=r.average_price||0,p=s(r.exchange)&&f?.data?.ltp&&f.lastUpdate&&Date.now()-f.lastUpdate<m,_=!p&&g?.ltp;let l,c="rest";if(p&&f?.data?.ltp?(l=f.data.ltp,c="websocket"):_&&g?.ltp?(l=g.ltp,c="multiquotes"):(l=r.ltp,c="rest"),C===0)return{...r,_dataSource:"rest"};let v=r.pnl||0,x=r.pnlpercent||0;const L=r.today_realized_pnl||0;if(l&&k>0){let E;C>0?E=(l-k)*C:E=(k-l)*Math.abs(C),v=L+E;const h=Math.abs(k*C);x=h>0?v/h*100:0}return{...r,ltp:l,pnl:v,pnlpercent:x,_dataSource:c}}),[e,b,u,s,m]),isLive:P,isConnected:S,isAnyMarketOpen:i,multiQuotes:u,refreshMultiQuotes:T}}function K(e,y){if(!y)return null;let o=0,m=0,w=0;e.forEach(a=>{o+=a.pnl||0;const s=a.average_price||0,n=a.quantity||0,i=a.ltp||s;m+=s*n,w+=i*n});const R=m>0?o/m*100:0;return{...y,totalholdingvalue:w,totalinvvalue:m,totalprofitandloss:o,totalpnlpercentage:R}}export{K as c,H as u};
