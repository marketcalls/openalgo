import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{w as C,u as pe,s as M,B as xe,e as v}from"./index-BdWlx98l.js";import{C as he,d as ue}from"./card-BtyxT_5a.js";import{S as w,a as E,b as O,c as F,d as P}from"./select-CHGfSVeS.js";import{P as ge}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const _={getProfileData:async l=>(await C.post("/oiprofile/api/profile-data",l)).data,getIntervals:async()=>(await C.get("/oiprofile/api/intervals")).data,getUnderlyings:async l=>(await C.get(`/search/api/underlyings?exchange=${l}`)).data,getExpiries:async(l,o)=>(await C.get(`/search/api/expiries?exchange=${l}&underlying=${o}`)).data},fe=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],U={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},me={"1m":1,"5m":5,"15m":7};function R(l){if(!l)return"";const o=l.split("-");return o.length===3?`${o[0]}${o[1].toUpperCase()}${o[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function ye(l){const o=l.timestamp??l.time;if(!o)return"";if(typeof o=="number"){const c=o>1e12?o:o*1e3,d=new Date(c),b=String(d.getDate()).padStart(2,"0"),S=d.toLocaleString("en",{month:"short"}),f=String(d.getHours()).padStart(2,"0"),h=String(d.getMinutes()).padStart(2,"0");return`${b}-${S} ${f}:${h}`}const u=String(o);try{const c=new Date(u);if(!Number.isNaN(c.getTime())){const d=String(c.getDate()).padStart(2,"0"),b=c.toLocaleString("en",{month:"short"}),S=String(c.getHours()).padStart(2,"0"),f=String(c.getMinutes()).padStart(2,"0");return`${d}-${b} ${S}:${f}`}}catch{}return u}function Oe(){const{mode:l,appMode:o}=pe(),u=o==="analyzer",c=l==="dark"||u,[d,b]=n.useState("NFO"),[S,f]=n.useState(U.NFO),[h,k]=n.useState("NIFTY"),[B,I]=n.useState([]),[g,m]=n.useState(""),[V,Y]=n.useState(["5m"]),[y,D]=n.useState("5m"),[i,z]=n.useState(null),[T,A]=n.useState(!1),j=n.useRef(0);n.useEffect(()=>{(async()=>{try{const r=await _.getIntervals();r.status==="success"&&r.data?.intervals.length&&(Y(r.data.intervals),r.data.intervals.includes(y)||D(r.data.intervals[0]))}catch{}})()},[]),n.useEffect(()=>{const t=U[d]||[];f(t),k(t[0]||""),I([]),m(""),z(null);let r=!1;return(async()=>{try{const x=await _.getUnderlyings(d);if(r)return;x.status==="success"&&x.underlyings.length>0&&(f(x.underlyings),x.underlyings.includes(t[0])||k(x.underlyings[0]))}catch{}})(),()=>{r=!0}},[d]),n.useEffect(()=>{if(!h)return;I([]),m(""),z(null);let t=!1;return(async()=>{try{const p=await _.getExpiries(d,h);if(t)return;p.status==="success"&&p.expiries.length>0?(I(p.expiries),m(p.expiries[0])):(I([]),m(""))}catch{if(t)return;I([]),m("")}})(),()=>{t=!0}},[h]);const L=n.useCallback(async()=>{if(!g)return;const t=++j.current;A(!0);try{const r=R(g),p=me[y]||5,x=await _.getProfileData({underlying:h,exchange:d,expiry_date:r,interval:y,days:p});if(j.current!==t)return;x.status==="success"?z(x):M.error(x.message||"Failed to fetch OI Profile data")}catch{if(j.current!==t)return;M.error("Failed to fetch OI Profile data")}finally{j.current===t&&A(!1)}},[h,g,d,y]);n.useEffect(()=>{g&&L()},[g,y]);const s=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:c?"#e0e0e0":"#333333",grid:c?u?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceOI:"#22c55e",peOI:"#ef4444",ceChange:"#86efac",peChange:"#fca5a5",atmLine:"#eab308",hoverBg:c?u?"#2d2545":"#1e293b":"#ffffff",hoverFont:c?"#e0e0e0":"#333333",hoverBorder:c?u?"#7c3aed":"#475569":"#e2e8f0",increasing:"#22c55e",decreasing:"#ef4444"}),[c,u]),H=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),$=n.useMemo(()=>{if(!i?.oi_chain||!i.candles?.length)return{data:[],layout:{}};const t=i.candles,r=i.oi_chain,p=i.atm_strike,x=t.map(ye),X=t.map(a=>a.open),q=t.map(a=>a.high),G=t.map(a=>a.low),K=t.map(a=>a.close),N=r.map(a=>a.strike),J=r.map(a=>a.ce_oi),Q=r.map(a=>-a.pe_oi),W=r.map(a=>a.ce_oi_change),Z=r.map(a=>-a.pe_oi_change),ee=r.map(a=>a.pe_oi),te=r.map(a=>a.pe_oi_change),se=x.length,ae=Math.max(1,Math.floor(se/10)),re=x.filter((a,de)=>de%ae===0),ne=[{x,open:X,high:q,low:G,close:K,type:"candlestick",name:i.futures_symbol||"Futures",xaxis:"x",yaxis:"y",increasing:{line:{color:s.increasing}},decreasing:{line:{color:s.decreasing}},showlegend:!1},{y:N,x:J,type:"bar",orientation:"h",name:"CE OI",marker:{color:s.ceOI},xaxis:"x2",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>OI: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:Q,type:"bar",orientation:"h",name:"PE OI",marker:{color:s.peOI},xaxis:"x2",yaxis:"y",customdata:ee,hovertemplate:"<b>%{y} PE</b><br>OI: %{customdata:,.0f}<extra></extra>",showlegend:!1},{y:N,x:W,type:"bar",orientation:"h",name:"CE Change",marker:{color:s.ceChange},xaxis:"x3",yaxis:"y",hovertemplate:"<b>%{y} CE</b><br>Change: %{x:,.0f}<extra></extra>",showlegend:!1},{y:N,x:Z,type:"bar",orientation:"h",name:"PE Change",marker:{color:s.peChange},xaxis:"x3",yaxis:"y",customdata:te,hovertemplate:"<b>%{y} PE</b><br>Change: %{customdata:,.0f}<extra></extra>",showlegend:!1}],oe=R(g),ie=p?[{type:"line",x0:0,x1:1,xref:"paper",y0:p,y1:p,line:{color:s.atmLine,width:2,dash:"dash"}}]:[],le=p?[{x:0,xref:"paper",y:p,text:`ATM ${p}`,showarrow:!1,font:{color:s.atmLine,size:11},xanchor:"left",yanchor:"bottom"}]:[],ce={title:{text:`${h} ${oe} - Futures with OI Profile`,font:{color:s.text,size:14}},paper_bgcolor:s.paper,plot_bgcolor:s.bg,font:{color:s.text,family:"system-ui, sans-serif"},barmode:"overlay",bargap:.1,showlegend:!1,margin:{l:60,r:30,t:50,b:60},hoverlabel:{bgcolor:s.hoverBg,font:{color:s.hoverFont,size:12},bordercolor:s.hoverBorder},xaxis:{domain:[0,.48],type:"category",tickmode:"array",tickvals:re,tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"Time",font:{color:s.text,size:11}},rangeslider:{visible:!1}},xaxis2:{domain:[.5,.74],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE OI",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},xaxis3:{domain:[.76,1],anchor:"y",tickfont:{color:s.text,size:9},gridcolor:s.grid,title:{text:"CE <-> PE Change (D)",font:{color:s.text,size:11}},zeroline:!0,zerolinecolor:s.grid},yaxis:{title:{text:"Price / Strike",font:{color:s.text,size:11}},tickfont:{color:s.text,size:10},gridcolor:s.grid,showgrid:!0},shapes:ie,annotations:le};return{data:ne,layout:ce}},[i,s,g,h]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"OI Profile"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(w,{value:d,onValueChange:b,children:[e.jsx(E,{className:"w-[100px]",children:e.jsx(O,{placeholder:"Exchange"})}),e.jsx(F,{children:fe.map(t=>e.jsx(P,{value:t.value,children:t.label},t.value))})]}),e.jsxs(w,{value:h,onValueChange:k,children:[e.jsx(E,{className:"w-[160px]",children:e.jsx(O,{placeholder:"Underlying"})}),e.jsx(F,{children:S.map(t=>e.jsx(P,{value:t,children:t},t))})]}),e.jsxs(w,{value:g,onValueChange:m,disabled:B.length===0,children:[e.jsx(E,{className:"w-[160px]",children:e.jsx(O,{placeholder:"Expiry"})}),e.jsx(F,{children:B.map(t=>e.jsx(P,{value:t,children:t},t))})]}),e.jsxs(w,{value:y,onValueChange:D,children:[e.jsx(E,{className:"w-[100px]",children:e.jsx(O,{placeholder:"Interval"})}),e.jsx(F,{children:V.map(t=>e.jsx(P,{value:t,children:t},t))})]}),e.jsx(xe,{variant:"outline",size:"sm",onClick:L,disabled:T,children:T?"Loading...":"Refresh"})]})]}),i&&i.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",i.spot_price?.toFixed(1)]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",i.atm_strike]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",i.lot_size]}),i.futures_symbol&&e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",i.futures_symbol]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Interval: ",i.interval]}),e.jsxs(v,{variant:"secondary",className:"text-sm px-3 py-1",children:["Candles: ",i.candles?.length||0]})]}),e.jsx(he,{children:e.jsx(ue,{className:"p-2 sm:p-4",children:T&&!i?e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:"Loading OI Profile data..."}):$.data.length>0?e.jsx(ge,{data:$.data,layout:$.layout,config:H,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:g?"No data available":"Select an underlying and expiry to view OI Profile"})})})]})}export{Oe as default};
