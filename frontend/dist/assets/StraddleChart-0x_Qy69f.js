import{r as s,j as t}from"./vendor-react-CCyQGCED.js";import{q as Te,K as De,W as Me,n as te}from"./lightweight-charts.production-EcMg1Lek.js";import{w as he,u as Ie,s as se,B as xe}from"./index-NHrG-O_Z.js";import{o as ge}from"./oi-profile-DciLACbk.js";import{C as Re,a as Le,b as Ue,d as He}from"./card-Cn20bp_v.js";import{P as Oe,a as Ve,b as Be,C as Pe,c as We,d as _e,e as Ae,f as ze,g as Ye}from"./popover-DQlNqO83.js";import{S as O,a as V,b as B,c as P,d as W}from"./select-DcHsBqkV.js";import{aV as Ge,m as Je}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const ye={getStraddleData:async u=>(await he.post("/straddle/api/straddle-data",u)).data,getIntervals:async()=>(await he.get("/straddle/api/intervals")).data},Ke=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],be={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},Se=500;function Xe(u){if(!u)return"";const f=u.split("-");return f.length===3?`${f[0]}${f[1].toUpperCase()}${f[2].slice(-2)}`:u.replace(/-/g,"").toUpperCase()}function qe(u){const f=new Date(u*1e3),h=new Date(f.getTime()+5.5*60*60*1e3),E=h.getUTCDate().toString().padStart(2,"0"),D=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][h.getUTCMonth()],m=h.getUTCHours().toString().padStart(2,"0"),_=h.getUTCMinutes().toString().padStart(2,"0"),A=h.getUTCHours()>=12?"PM":"AM";return{date:`${E} ${D}`,time:`${m}:${_} ${A}`}}function ct(){const{mode:u,appMode:f}=Ie(),h=u==="dark",E=f==="analyzer",[T,D]=s.useState(!1),[m,_]=s.useState("NFO"),[A,re]=s.useState(be.NFO),[ne,ae]=s.useState(!1),[g,z]=s.useState("NIFTY"),[ve,M]=s.useState([]),[I,S]=s.useState(""),[je,ie]=s.useState([]),[R,oe]=s.useState("1m"),[v,Ce]=s.useState("3"),[j,Y]=s.useState(null),[C,we]=s.useState(!0),[w,Ne]=s.useState(!1),[N,$e]=s.useState(!1),G=s.useRef(null),d=s.useRef(null),L=s.useRef(null),U=s.useRef(null),H=s.useRef(null),$=s.useRef(null),b=s.useRef(null),F=s.useRef(null),le=s.useRef(new Map),a=s.useMemo(()=>E?{text:"#d4bfff",grid:"rgba(139, 92, 246, 0.1)",border:"rgba(139, 92, 246, 0.2)",crosshair:"rgba(139, 92, 246, 0.5)",crosshairLabel:"#4c1d95",spot:"#e2e8f0",straddle:"#a78bfa",synthetic:"#60a5fa",watermark:"rgba(139, 92, 246, 0.12)",tooltipBg:"rgba(30, 15, 60, 0.92)",tooltipBorder:"rgba(139, 92, 246, 0.3)",tooltipText:"#d4bfff",tooltipMuted:"#a78bfa"}:h?{text:"#a6adbb",grid:"rgba(166, 173, 187, 0.1)",border:"rgba(166, 173, 187, 0.2)",crosshair:"rgba(166, 173, 187, 0.5)",crosshairLabel:"#1f2937",spot:"#e2e8f0",straddle:"#4ade80",synthetic:"#60a5fa",watermark:"rgba(166, 173, 187, 0.12)",tooltipBg:"rgba(17, 24, 39, 0.92)",tooltipBorder:"rgba(166, 173, 187, 0.2)",tooltipText:"#e2e8f0",tooltipMuted:"#9ca3af"}:{text:"#333",grid:"rgba(0, 0, 0, 0.1)",border:"rgba(0, 0, 0, 0.2)",crosshair:"rgba(0, 0, 0, 0.3)",crosshairLabel:"#2563eb",spot:"#1e293b",straddle:"#16a34a",synthetic:"#2563eb",watermark:"rgba(0, 0, 0, 0.06)",tooltipBg:"rgba(255, 255, 255, 0.95)",tooltipBorder:"rgba(0, 0, 0, 0.15)",tooltipText:"#1e293b",tooltipMuted:"#6b7280"},[h,E]),ce=s.useRef(a);ce.current=a;const de=s.useCallback(()=>{if(!G.current)return;d.current&&(d.current.remove(),d.current=null);const e=G.current,i=$.current;e.innerHTML="",i&&e.appendChild(i);const n=Te(e,{width:e.offsetWidth,height:Se,layout:{background:{type:Me.Solid,color:"transparent"},textColor:a.text},grid:{vertLines:{color:a.grid,style:1,visible:!0},horzLines:{color:a.grid,style:1,visible:!0}},leftPriceScale:{visible:!0,borderColor:a.border,scaleMargins:{top:.05,bottom:.05}},rightPriceScale:{visible:!0,borderColor:a.border,scaleMargins:{top:.05,bottom:.05}},timeScale:{borderColor:a.border,timeVisible:!0,secondsVisible:!1,tickMarkFormatter:l=>{const c=new Date(l*1e3),y=new Date(c.getTime()+5.5*60*60*1e3),p=y.getUTCHours().toString().padStart(2,"0"),o=y.getUTCMinutes().toString().padStart(2,"0");if(parseInt(v)>1){const q=y.getUTCDate().toString().padStart(2,"0"),Q=(y.getUTCMonth()+1).toString().padStart(2,"0");return`${q}/${Q} ${p}:${o}`}return`${p}:${o}`}},crosshair:{mode:De.Normal,vertLine:{width:1,color:a.crosshair,style:2,labelVisible:!1},horzLine:{width:1,color:a.crosshair,style:2,labelBackgroundColor:a.crosshairLabel}}}),r=document.createElement("div");if(r.style.cssText=`position:absolute;z-index:2;font-family:Arial,sans-serif;font-size:48px;font-weight:bold;user-select:none;pointer-events:none;color:${a.watermark}`,r.textContent="OpenAlgo",e.appendChild(r),b.current=r,setTimeout(()=>{r.style.left=`${e.offsetWidth/2-r.offsetWidth/2}px`,r.style.top=`${e.offsetHeight/2-r.offsetHeight/2}px`},0),$.current)e.appendChild($.current);else{const l=document.createElement("div");l.style.cssText="position:absolute;z-index:10;pointer-events:none;display:none;border-radius:6px;padding:8px 12px;font-family:ui-monospace,SFMono-Regular,monospace;font-size:12px;line-height:1.6;white-space:nowrap;",e.appendChild(l),$.current=l}const X=n.addSeries(te,{color:a.spot,lineWidth:2,priceScaleId:"left",title:"Spot",lastValueVisible:!0,priceLineVisible:!0,visible:w}),Fe=n.addSeries(te,{color:a.straddle,lineWidth:2,priceScaleId:"right",title:"Straddle",lastValueVisible:!0,priceLineVisible:!0,visible:C}),ke=n.addSeries(te,{color:a.synthetic,lineWidth:1,lineStyle:2,priceScaleId:"left",title:"Synthetic Fut",lastValueVisible:!0,priceLineVisible:!1,visible:N});d.current=n,L.current=X,U.current=Fe,H.current=ke,n.subscribeCrosshairMove(l=>{const c=$.current;if(!c||!e)return;if(!l.time||!l.point||l.point.x<0||l.point.y<0||l.point.x>e.offsetWidth||l.point.y>e.offsetHeight){c.style.display="none";return}const y=l.time,p=le.current.get(y);if(!p){c.style.display="none";return}const o=ce.current,{date:q,time:Q}=qe(y);c.style.display="block",c.style.background=o.tooltipBg,c.style.border=`1px solid ${o.tooltipBorder}`,c.style.color=o.tooltipText,c.innerHTML=`
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.straddle};font-weight:600">Straddle Price</span>
          <span style="color:${o.straddle};font-weight:600">${p.straddle.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">&bull; ${p.atm_strike} Call:</span>
          <span>${p.ce_price.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">&bull; ${p.atm_strike} Put:</span>
          <span>${p.pe_price.toFixed(2)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.synthetic}">Synthetic Fut</span>
          <span style="color:${o.synthetic}">${p.synthetic_future.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px">
          <span style="color:${o.tooltipMuted}">Spot Price</span>
          <span>${p.spot.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:16px;margin-top:4px;border-top:1px solid ${o.tooltipBorder};padding-top:4px">
          <span style="color:${o.tooltipMuted}">${q}</span>
          <span style="color:${o.tooltipMuted}">${Q}</span>
        </div>
      `;const ue=c.offsetWidth,Z=c.offsetHeight,fe=l.point.x,Ee=l.point.y,me=16;let ee=fe+me;ee+ue>e.offsetWidth&&(ee=fe-ue-me);let k=Ee-Z/2;k<0&&(k=0),k+Z>e.offsetHeight&&(k=e.offsetHeight-Z),c.style.left=`${ee}px`,c.style.top=`${k}px`}),F.current&&J(F.current);const pe=()=>{d.current&&e&&(d.current.applyOptions({width:e.offsetWidth}),b.current&&(b.current.style.left=`${e.offsetWidth/2-b.current.offsetWidth/2}px`,b.current.style.top=`${e.offsetHeight/2-b.current.offsetHeight/2}px`))};return window.addEventListener("resize",pe),()=>{window.removeEventListener("resize",pe)}},[a,v,C,w,N]),J=s.useCallback(e=>{if(!e.series||e.series.length===0)return;const i=[...e.series].sort((r,X)=>r.time-X.time),n=new Map;for(const r of i)n.set(r.time,r);le.current=n,L.current&&L.current.setData(i.map(r=>({time:r.time,value:r.spot}))),U.current&&U.current.setData(i.map(r=>({time:r.time,value:r.straddle}))),H.current&&H.current.setData(i.map(r=>({time:r.time,value:r.synthetic_future}))),d.current&&d.current.timeScale().fitContent()},[]);s.useEffect(()=>{const e=de();return()=>{e?.(),d.current&&(d.current.remove(),d.current=null)}},[de]),s.useEffect(()=>{L.current?.applyOptions({visible:w})},[w]),s.useEffect(()=>{U.current?.applyOptions({visible:C})},[C]),s.useEffect(()=>{H.current?.applyOptions({visible:N})},[N]),s.useEffect(()=>{(async()=>{try{const i=await ye.getIntervals();if(i.status==="success"&&i.data){const n=[...i.data.seconds||[],...i.data.minutes||[],...i.data.hours||[]];ie(n.length>0?n:["1m","3m","5m","10m","15m","30m","1h"]),n.length>0&&!n.includes(R)&&oe(n.includes("1m")?"1m":n[0])}}catch{ie(["1m","3m","5m","10m","15m","30m","1h"])}})()},[]),s.useEffect(()=>{const e=be[m]||[];re(e),z(e[0]||""),M([]),S(""),Y(null),F.current=null;let i=!1;return(async()=>{try{const r=await ge.getUnderlyings(m);if(i)return;r.status==="success"&&r.underlyings.length>0&&(re(r.underlyings),r.underlyings.includes(e[0])||z(r.underlyings[0]))}catch{}})(),()=>{i=!0}},[m]),s.useEffect(()=>{if(!g)return;M([]),S(""),Y(null),F.current=null;let e=!1;return(async()=>{try{const n=await ge.getExpiries(m,g);if(e)return;n.status==="success"&&n.expiries.length>0?(M(n.expiries),S(n.expiries[0])):(M([]),S(""))}catch{if(e)return;se.error("Failed to fetch expiry dates","positions")}})(),()=>{e=!0}},[g]);const K=s.useCallback(async()=>{if(I){D(!0);try{const e=await ye.getStraddleData({underlying:g,exchange:m,expiry_date:Xe(I),interval:R,days:parseInt(v)});e.status==="success"&&e.data?(F.current=e.data,Y(e.data),J(e.data)):se.error(e.message||"Failed to load straddle data","positions")}catch{se.error("Failed to fetch straddle data","positions")}finally{D(!1)}}},[I,R,v,g,m,J]);s.useEffect(()=>{K()},[K]);const x=s.useMemo(()=>j?.series?.length?j.series[j.series.length-1]:null,[j]);return t.jsx("div",{className:"container mx-auto px-4 py-6 max-w-7xl",children:t.jsxs(Re,{children:[t.jsx(Le,{className:"pb-4",children:t.jsx(Ue,{className:"text-xl font-semibold",children:"Straddle Chart"})}),t.jsxs(He,{children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-4",children:[t.jsxs(O,{value:m,onValueChange:_,children:[t.jsx(V,{className:"w-[100px]",children:t.jsx(B,{placeholder:"Exchange"})}),t.jsx(P,{children:Ke.map(e=>t.jsx(W,{value:e.value,children:e.label},e.value))})]}),t.jsxs(Oe,{open:ne,onOpenChange:ae,children:[t.jsx(Ve,{asChild:!0,children:t.jsxs(xe,{variant:"outline",role:"combobox","aria-expanded":ne,className:"w-[140px] justify-between",children:[g||"Underlying",t.jsx(Ge,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),t.jsx(Be,{className:"w-48 p-0",align:"start",children:t.jsxs(Pe,{children:[t.jsx(We,{placeholder:"Search underlying..."}),t.jsxs(_e,{children:[t.jsx(Ae,{children:"No underlying found"}),t.jsx(ze,{children:A.map(e=>t.jsxs(Ye,{value:e,onSelect:()=>{z(e),ae(!1)},children:[t.jsx(Je,{className:`mr-2 h-4 w-4 ${g===e?"opacity-100":"opacity-0"}`}),e]},e))})]})]})})]}),t.jsxs(O,{value:I,onValueChange:S,children:[t.jsx(V,{className:"w-[140px]",children:t.jsx(B,{placeholder:"Expiry"})}),t.jsx(P,{children:ve.map(e=>t.jsx(W,{value:e,children:e},e))})]}),t.jsxs(O,{value:R,onValueChange:oe,children:[t.jsx(V,{className:"w-[100px]",children:t.jsx(B,{placeholder:"Interval"})}),t.jsx(P,{children:je.map(e=>t.jsx(W,{value:e,children:e},e))})]}),t.jsxs(O,{value:v,onValueChange:Ce,children:[t.jsx(V,{className:"w-[100px]",children:t.jsx(B,{placeholder:"Days"})}),t.jsx(P,{children:["1","3","5"].map(e=>t.jsxs(W,{value:e,children:[e," ",e==="1"?"Day":"Days"]},e))})]}),t.jsx(xe,{variant:"outline",size:"sm",onClick:K,disabled:T,children:T?"Loading...":"Refresh"})]}),x&&j&&t.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-1 mb-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Straddle Price "}),t.jsx("span",{className:"font-semibold",style:{color:a.straddle},children:x.straddle.toFixed(2)})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Spot "}),t.jsx("span",{className:"font-medium",children:x.spot.toFixed(2)})]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-muted-foreground",children:"Straddle Strike "}),t.jsx("span",{className:"font-medium",children:x.atm_strike})]}),t.jsxs("div",{children:[t.jsxs("span",{className:"text-muted-foreground",children:[x.atm_strike," CE"," "]}),t.jsx("span",{className:"font-medium",children:x.ce_price.toFixed(2)})]}),t.jsxs("div",{children:[t.jsxs("span",{className:"text-muted-foreground",children:[x.atm_strike," PE"," "]}),t.jsx("span",{className:"font-medium",children:x.pe_price.toFixed(2)})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx("div",{ref:G,className:"relative w-full rounded-lg border border-border/50",style:{height:Se}}),T&&t.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-background/60 rounded-lg",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Loading straddle data..."]})})]}),t.jsxs("div",{className:"flex items-center justify-center gap-4 mt-3",children:[t.jsxs("button",{type:"button",onClick:()=>we(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${C?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded",style:{backgroundColor:a.straddle}}),"Straddle"]}),t.jsxs("button",{type:"button",onClick:()=>Ne(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${w?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded",style:{backgroundColor:a.spot}}),"Spot"]}),t.jsxs("button",{type:"button",onClick:()=>$e(e=>!e),className:`flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs transition-colors ${N?"bg-muted font-medium":"opacity-50 hover:opacity-75"}`,children:[t.jsx("span",{className:"inline-block h-0.5 w-5 rounded border-dashed border-t-2",style:{borderColor:a.synthetic,backgroundColor:"transparent"}}),"Synthetic Fut"]})]})]})]})})}export{ct as default};
