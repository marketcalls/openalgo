import{r as t}from"./vendor-react--vsXx8_n.js";import{t as A}from"./trading-Ba3GIukr.js";import{d as F}from"./index-Df-MP2DF.js";async function I(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function W({symbols:e,mode:g="LTP",enabled:r=!0,autoReconnect:k=!0}){const[y,D]=t.useState(new Map),[a,s]=t.useState(!1),[n,o]=t.useState(!1),[u,C]=t.useState(!1),[E,m]=t.useState(null),w=t.useRef(null),R=t.useRef(null),x=t.useRef(new Set),O=t.useRef([]),i=t.useCallback(async()=>I(),[]),b=t.useCallback(_=>{if(!w.current||w.current.readyState!==WebSocket.OPEN||!n){O.current=_;return}const d=_.filter(h=>{const S=`${h.exchange}:${h.symbol}`;return!x.current.has(S)});d.length!==0&&(w.current.send(JSON.stringify({action:"subscribe",symbols:d,mode:g})),d.forEach(h=>{const S=`${h.exchange}:${h.symbol}`;x.current.add(S),D(l=>{const c=new Map(l);return c.has(S)||c.set(S,{symbol:h.symbol,exchange:h.exchange,data:{}}),c})}))},[n,g]),f=t.useCallback(_=>{try{const d=JSON.parse(_.data);switch(d.type||d.status){case"auth":d.status==="success"?(o(!0),m(null),O.current.length>0&&setTimeout(()=>{b(O.current),O.current=[]},100)):m(`Authentication failed: ${d.message}`);break;case"market_data":{const S=d.symbol.toUpperCase(),l=d.exchange,c=d.data||{},v=`${l}:${S}`;D($=>{const P=$.get(v);if(!P)return $;const L=new Map($),M={...P.data};return Object.assign(M,{ltp:c.ltp??M.ltp,open:c.open??M.open,high:c.high??M.high,low:c.low??M.low,close:c.close??M.close,volume:c.volume??M.volume,change:c.change??M.change,change_percent:c.change_percent??M.change_percent,timestamp:c.timestamp??M.timestamp}),L.set(v,{...P,data:M,lastUpdate:Date.now()}),L});break}case"subscribe":break;case"error":m(`WebSocket error: ${d.message}`);break}}catch{}},[b]),p=t.useCallback(async()=>{if(w.current?.readyState!==WebSocket.OPEN){C(!0),m(null);try{const _=await i(),h=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":_},credentials:"include"})).json();if(h.status!=="success")throw new Error("Failed to get WebSocket configuration");const S=h.websocket_url,l=new WebSocket(S);l.onopen=async()=>{s(!0),C(!1);try{const c=await i(),$=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":c},credentials:"include"})).json();$.status==="success"&&$.api_key?l.send(JSON.stringify({action:"authenticate",api_key:$.api_key})):m("No API key found - please generate one at /apikey")}catch(c){m(`Authentication error: ${c}`)}},l.onclose=c=>{s(!1),C(!1),o(!1),x.current.clear(),k&&!c.wasClean&&r&&(R.current=setTimeout(p,3e3))},l.onerror=()=>{m("WebSocket connection error"),C(!1)},l.onmessage=f,w.current=l}catch(_){m(`Connection failed: ${_}`),C(!1)}}},[i,f,k,r]),T=t.useCallback(()=>{R.current&&(clearTimeout(R.current),R.current=null),w.current&&(w.current.close(1e3,"User disconnect"),w.current=null),s(!1),o(!1),x.current.clear()},[]);return t.useEffect(()=>(r&&e.length>0&&!a&&!u&&p(),()=>{R.current&&clearTimeout(R.current)}),[r,e.length,a,u,p]),t.useEffect(()=>{n&&e.length>0&&b(e)},[n,e,b]),t.useEffect(()=>()=>{T()},[T]),{data:y,isConnected:a,isAuthenticated:n,isConnecting:u,error:E,connect:p,disconnect:T}}async function j(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function q(){const[e,g]=t.useState({timings:[],holidays:[],isLoading:!0,error:null});t.useEffect(()=>{(async()=>{try{const n={"X-CSRFToken":await j(),"Content-Type":"application/json"},[o,u]=await Promise.all([fetch("/api/market-timings",{headers:n,credentials:"include"}),fetch("/api/holidays",{headers:n,credentials:"include"})]),C=await o.json(),E=await u.json();g({timings:C.status==="success"?C.data||[]:[],holidays:E.status==="success"?E.data||[]:[],isLoading:!1,error:null})}catch(s){g(n=>({...n,isLoading:!1,error:`Failed to fetch market status: ${s}`}))}})()},[]);const r=t.useCallback(a=>{const s=new Date().toISOString().split("T")[0],n=e.holidays.find(o=>o.date===s);if(!n)return!1;if(n.closed_exchanges.includes(a)){const o=n.open_exchanges.find(u=>u.exchange===a);if(o){const u=Date.now();return!(u>=o.start_time&&u<=o.end_time)}return!0}return!1},[e.holidays]),k=t.useCallback(a=>{if(r(a))return!1;const s=e.timings.find(o=>o.exchange===a);if(!s)return!1;const n=Date.now();return n>=s.start_time&&n<=s.end_time},[e.timings,r]),y=t.useCallback(()=>e.timings.some(a=>{const s=Date.now();return s>=a.start_time&&s<=a.end_time&&!r(a.exchange)}),[e.timings,r]),D=t.useCallback(a=>{if(r(a))return"closed";const s=e.timings.find(u=>u.exchange===a);if(!s)return"closed";const n=Date.now(),o=900*1e3;return n<s.start_time-o?"closed":n<s.start_time?"pre-market":n<=s.end_time?"open":"post-market"},[e.timings,r]);return{isMarketOpen:k,isAnyMarketOpen:y,isHolidayForExchange:r,getMarketStatus:D,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function H(e,g={}){const{enabled:r=!0,staleThreshold:k=5e3,useMultiQuotesFallback:y=!0,multiQuotesRefreshInterval:D=3e4}=g,{apiKey:a}=F(),{isMarketOpen:s,isAnyMarketOpen:n}=q(),o=n(),[u,C]=t.useState(new Map),E=t.useMemo(()=>e.map(i=>({symbol:i.symbol,exchange:i.exchange})),[e]),{data:m,isConnected:w}=W({symbols:E,mode:"LTP",enabled:r&&e.length>0}),R=w&&o,x=t.useCallback(async()=>{if(!(!a||e.length===0||!y))try{const i=e.map(f=>({symbol:f.symbol,exchange:f.exchange})),b=await A.getMultiQuotes(a,i);if(b.status==="success"&&b.results){const f=new Map;b.results.forEach(p=>{const T=`${p.exchange}:${p.symbol}`;p.data&&f.set(T,p.data)}),C(f)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[a,e,y]);return t.useEffect(()=>{if(!r||e.length===0||!y)return;x();const i=setInterval(x,D);return()=>clearInterval(i)},[r,e.length,y,x,D]),{data:t.useMemo(()=>e.map(i=>{const b=`${i.exchange}:${i.symbol}`,f=m.get(b),p=u.get(b),T=i.quantity||0,_=i.pnl||0,h=s(i.exchange)&&f?.data?.ltp&&f.lastUpdate&&Date.now()-f.lastUpdate<k,S=!h&&p?.ltp;let l,c="rest";if(h&&f?.data?.ltp?(l=f.data.ltp,c="websocket"):S&&p?.ltp?(l=p.ltp,c="multiquotes"):(l=i.ltp,c="rest"),T===0)return{...i,ltp:l,_dataSource:c};let v=i.average_price;return!v&&l&&T!==0&&(v=l-_/T),{...i,ltp:l,average_price:v,_dataSource:c}}),[e,m,u,s,k]),isLive:R,isConnected:w,isAnyMarketOpen:o,multiQuotes:u,refreshMultiQuotes:x}}function K(e,g){if(!g)return null;let r=0,k=0,y=0;e.forEach(a=>{r+=a.pnl||0;const s=a.average_price||0,n=a.quantity||0,o=a.ltp||s;k+=s*n,y+=o*n});const D=k>0?r/k*100:0;return{...g,totalholdingvalue:y,totalinvvalue:k,totalprofitandloss:r,totalpnlpercentage:D}}export{K as c,H as u};
