import{r,j as e}from"./vendor-react-CCyQGCED.js";import{u as Z,s as T,B as z,e as u}from"./index-NHrG-O_Z.js";import{o as P}from"./oi-tracker-Dud8WQlI.js";import{C as ee,d as te}from"./card-Cn20bp_v.js";import{P as ae,a as se,b as re,C as ne,c as ie,d as oe,e as le,f as ce,g as de}from"./popover-DQlNqO83.js";import{S as O,a as U,b as L,c as A,d as D}from"./select-DcHsBqkV.js";import{P as xe}from"./react-plotly-DV3gd5yC.js";import{aV as pe,m as me}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const ue=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],R={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]};function fe(g){if(!g)return"";const f=g.split("-");return f.length===3?`${f[0]}${f[1].toUpperCase()}${f[2].slice(-2)}`:g.replace(/-/g,"").toUpperCase()}function Fe(){const{mode:g,appMode:f}=Z(),c=f==="analyzer",d=g==="dark"||c,[x,V]=r.useState("NFO"),[Y,k]=r.useState(R.NFO),[F,_]=r.useState(!1),[p,N]=r.useState("NIFTY"),[E,y]=r.useState([]),[m,h]=r.useState(""),[s,C]=r.useState(null),[S,M]=r.useState(!1),b=r.useRef(0);r.useEffect(()=>{const t=R[x]||[];k(t),N(t[0]||""),y([]),h(""),C(null);let n=!1;return(async()=>{try{const l=await P.getUnderlyings(x);if(n)return;l.status==="success"&&l.underlyings.length>0&&(k(l.underlyings),l.underlyings.includes(t[0])||N(l.underlyings[0]))}catch{}})(),()=>{n=!0}},[x]),r.useEffect(()=>{if(!p)return;y([]),h(""),C(null);let t=!1;return(async()=>{try{const i=await P.getExpiries(x,p);if(t)return;i.status==="success"&&i.expiries.length>0?(y(i.expiries),h(i.expiries[0])):(y([]),h(""))}catch{if(t)return;y([]),h("")}})(),()=>{t=!0}},[p]);const w=r.useCallback(async()=>{if(!m)return;const t=++b.current;M(!0);try{const n=fe(m),i=await P.getMaxPain({underlying:p,exchange:x,expiry_date:n});if(b.current!==t)return;i.status==="success"?C(i):T.error(i.message||"Failed to calculate Max Pain")}catch{if(b.current!==t)return;T.error("Failed to calculate Max Pain")}finally{b.current===t&&M(!1)}},[p,m,x]);r.useEffect(()=>{m&&w()},[m]);const a=r.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:d?"#e0e0e0":"#333333",grid:d?c?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",barColor:c?"#8b5cf6":"#7c3aed",maxPainBar:c?"#c084fc":"#a78bfa",markerLine:d?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:d?c?"#2d2545":"#1e293b":"#ffffff",hoverFont:d?"#e0e0e0":"#333333",hoverBorder:d?c?"#7c3aed":"#475569":"#e2e8f0"}),[d,c]),I=r.useMemo(()=>{if(!s?.pain_data)return{data:[],layout:{}};const t=s.max_pain_strike,n=s.pain_data,i=n.map((o,v)=>v),l=n.map(o=>o.strike.toString()),G=n.map(o=>o.total_pain_cr),B=Math.max(1,Math.floor(n.length/15)),X=i.filter((o,v)=>v%B===0),q=l.filter((o,v)=>v%B===0),H=n.map(o=>o.strike===t?a.maxPainBar:a.barColor),K=[{x:i,y:G,type:"bar",name:"Max Pain",marker:{color:H},hovertemplate:"Strike %{text}<br>MaxPain: %{y:.2f} Crs.<extra></extra>",text:l,textposition:"none"}],j=t?n.findIndex(o=>o.strike===t):-1,J=j>=0?[{x:j,y:1,yref:"paper",text:`Max Pain ${t}`,showarrow:!1,font:{color:a.text,size:12,family:"system-ui, sans-serif"},yanchor:"bottom"}]:[],Q=j>=0?[{type:"line",x0:j,x1:j,y0:0,y1:1,yref:"paper",line:{color:a.markerLine,width:1.5,dash:"dash"}}]:[],W={paper_bgcolor:a.paper,plot_bgcolor:a.bg,font:{color:a.text,family:"system-ui, sans-serif"},bargap:.15,hoverlabel:{bgcolor:a.hoverBg,font:{color:a.hoverFont,size:12},bordercolor:a.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:a.text,size:11}},margin:{l:60,r:30,t:30,b:80},xaxis:{tickmode:"array",tickvals:X,ticktext:q,title:{text:"Strike Price",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,tickangle:-45},yaxis:{title:{text:"Max-Pain (Crs.)",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid},annotations:J,shapes:Q};return{data:K,layout:W}},[s,a]),$=r.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Max Pain"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(O,{value:x,onValueChange:V,children:[e.jsx(U,{className:"w-[100px]",children:e.jsx(L,{placeholder:"Exchange"})}),e.jsx(A,{children:ue.map(t=>e.jsx(D,{value:t.value,children:t.label},t.value))})]}),e.jsxs(ae,{open:F,onOpenChange:_,children:[e.jsx(se,{asChild:!0,children:e.jsxs(z,{variant:"outline",role:"combobox","aria-expanded":F,className:"w-[160px] justify-between",children:[p||"Underlying",e.jsx(pe,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(re,{className:"w-48 p-0",align:"start",children:e.jsxs(ne,{children:[e.jsx(ie,{placeholder:"Search underlying..."}),e.jsxs(oe,{children:[e.jsx(le,{children:"No underlying found"}),e.jsx(ce,{children:Y.map(t=>e.jsxs(de,{value:t,onSelect:()=>{N(t),_(!1)},children:[e.jsx(me,{className:`mr-2 h-4 w-4 ${p===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(O,{value:m,onValueChange:h,disabled:E.length===0,children:[e.jsx(U,{className:"w-[160px]",children:e.jsx(L,{placeholder:"Expiry"})}),e.jsx(A,{children:E.map(t=>e.jsx(D,{value:t,children:t},t))})]}),e.jsx(z,{variant:"outline",size:"sm",onClick:w,disabled:S,children:S?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (OI): ",s.pcr_oi?.toFixed(2)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (Vol): ",s.pcr_volume?.toFixed(2)]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1 font-semibold",children:["Max Pain: ",s.max_pain_strike]}),e.jsxs(u,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]})]}),e.jsx(ee,{children:e.jsx(te,{className:"p-2 sm:p-4",children:S&&!s?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Calculating Max Pain..."}):s?.pain_data&&s.pain_data.length>0?e.jsx(xe,{data:I.data,layout:I.layout,config:$,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:m?"No data available for Max Pain calculation":"Select an underlying and expiry to view Max Pain"})})})]})}export{Fe as default};
