import{r as c}from"./vendor-react--vsXx8_n.js";import{t as $}from"./trading-CrdHgkpV.js";import{u as j,a as W}from"./useMarketData-LIMTcZ3_.js";import{d as z}from"./index-Cn9SqEr-.js";async function V(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function U(){const[t,f]=c.useState({timings:[],holidays:[],isLoading:!0,error:null});c.useEffect(()=>{(async()=>{try{const e={"X-CSRFToken":await V(),"Content-Type":"application/json"},[r,u]=await Promise.all([fetch("/admin/api/timings",{headers:e,credentials:"include"}),fetch("/admin/api/holidays",{headers:e,credentials:"include"})]),g=await r.json(),M=await u.json();f({timings:g.status==="success"?g.market_status||[]:[],holidays:M.status==="success"?M.data||[]:[],isLoading:!1,error:null})}catch(n){f(e=>({...e,isLoading:!1,error:`Failed to fetch market status: ${n}`}))}})()},[]);const o=c.useCallback(a=>{const n=new Date().toISOString().split("T")[0],e=t.holidays.find(r=>r.date===n);if(!e)return!1;if(e.closed_exchanges.includes(a)){const r=e.open_exchanges.find(u=>u.exchange===a);if(r){const u=Date.now();return!(u>=r.start_time&&u<=r.end_time)}return!0}return!1},[t.holidays]),d=c.useCallback(a=>{if(o(a))return!1;const n=t.timings.find(r=>r.exchange===a);if(!n)return!1;const e=Date.now();return e>=n.start_time&&e<=n.end_time},[t.timings,o]),i=c.useCallback(()=>t.timings.some(a=>{const n=Date.now();return n>=a.start_time&&n<=a.end_time&&!o(a.exchange)}),[t.timings,o]),p=c.useCallback(a=>{if(o(a))return"closed";const n=t.timings.find(u=>u.exchange===a);if(!n)return"closed";const e=Date.now(),r=900*1e3;return e<n.start_time-r?"closed":e<n.start_time?"pre-market":e<=n.end_time?"open":"post-market"},[t.timings,o]);return{isMarketOpen:d,isAnyMarketOpen:i,isHolidayForExchange:o,getMarketStatus:p,timings:t.timings,holidays:t.holidays,isLoading:t.isLoading,error:t.error}}function Y(t,f={}){const{enabled:o=!0,staleThreshold:d=5e3,useMultiQuotesFallback:i=!0,multiQuotesRefreshInterval:p=3e4,pauseWhenHidden:a=!0,pauseDelay:n=5e3}=f,{apiKey:e}=z(),{isMarketOpen:r,isAnyMarketOpen:u}=U(),{isVisible:g,wasHidden:M,timeSinceHidden:x}=j(),C=u(),[_,H]=c.useState(new Map),P=c.useRef(Date.now()),Q=c.useMemo(()=>t.map(s=>({symbol:s.symbol,exchange:s.exchange})),[t]),{data:L,isConnected:O,isPaused:R}=W({symbols:Q,mode:"LTP",enabled:o&&t.length>0,pauseWhenHidden:a,pauseDelay:n}),F=O&&C&&!R,k=c.useCallback(async()=>{if(!(!e||t.length===0||!i))try{const s=t.map(l=>({symbol:l.symbol,exchange:l.exchange})),w=await $.getMultiQuotes(e,s);if(w.status==="success"&&w.results){const l=new Map;w.results.forEach(h=>{const y=`${h.exchange}:${h.symbol}`;h.data&&l.set(y,h.data)}),H(l)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[e,t,i]);return c.useEffect(()=>{if(!o||t.length===0||!i||a&&!g)return;k(),P.current=Date.now();const s=setInterval(()=>{k(),P.current=Date.now()},p);return()=>clearInterval(s)},[o,t.length,i,k,p,a,g]),c.useEffect(()=>{!M||!g||!i||!o||x>p&&(k(),P.current=Date.now())},[M,g,x,p,i,o,k]),{data:c.useMemo(()=>t.map(s=>{const w=`${s.exchange}:${s.symbol}`,l=L.get(w),h=_.get(w),y=s.quantity||0,D=s.average_price||0,T=r(s.exchange)&&l?.data?.ltp&&l.lastUpdate&&Date.now()-l.lastUpdate<d,A=!T&&h?.ltp;let m,b="rest";if(T&&l?.data?.ltp?(m=l.data.ltp,b="websocket"):A&&h?.ltp?(m=h.ltp,b="multiquotes"):(m=s.ltp,b="rest"),y===0)return{...s,_dataSource:"rest"};let v=s.pnl||0,q=s.pnlpercent||0;const I=s.today_realized_pnl||0;if(m&&D>0){let S;y>0?S=(m-D)*y:S=(D-m)*Math.abs(y),v=I+S;const E=Math.abs(D*y);q=E>0?v/E*100:0}return{...s,ltp:m,pnl:v,pnlpercent:q,_dataSource:b}}),[t,L,_,r,d]),isLive:F,isConnected:O,isPaused:R,isAnyMarketOpen:C,multiQuotes:_,refreshMultiQuotes:k}}function Z(t,f){if(!f)return null;let o=0,d=0,i=0;t.forEach(a=>{o+=a.pnl||0;const n=a.average_price||0,e=a.quantity||0,r=a.ltp||n;d+=n*e,i+=r*e});const p=d>0?o/d*100:0;return{...f,totalholdingvalue:i,totalinvvalue:d,totalprofitandloss:o,totalpnlpercentage:p}}export{Z as c,Y as u};
