import{r as a,j as e}from"./vendor-react-CCyQGCED.js";import{P as J}from"./react-plotly-DV3gd5yC.js";import{w as Q,u as W,s as E,B as T,e as h}from"./index-NHrG-O_Z.js";import{o as U}from"./oi-profile-DciLACbk.js";import{C as Z,d as ee}from"./card-Cn20bp_v.js";import{P as te,a as se,b as re,C as ae,c as le,d as oe,e as ne,f as ie,g as ce}from"./popover-DQlNqO83.js";import{S as D,a as P,b as _,c as A,d as V}from"./select-DcHsBqkV.js";import{aV as de,m as ue}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const xe={getSurfaceData:async c=>(await Q.post("/volsurface/api/surface-data",c)).data},pe=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],L={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},me=[{value:"10",label:"10"},{value:"15",label:"15"},{value:"20",label:"20"},{value:"25",label:"25"},{value:"30",label:"30"},{value:"35",label:"35"},{value:"40",label:"40"}];function fe(c){if(!c)return"";const d=c.split("-");return d.length===3?`${d[0]}${d[1].toUpperCase()}${d[2].slice(-2)}`:c.replace(/-/g,"").toUpperCase()}function we(){const{mode:c,appMode:d}=W(),p=d==="analyzer",n=c==="dark"||p,[u,R]=a.useState("NFO"),[M,w]=a.useState(L.NFO),[F,I]=a.useState(!1),[x,y]=a.useState("NIFTY"),[b,v]=a.useState([]),[m,f]=a.useState([]),[j,Y]=a.useState("40"),[l,S]=a.useState(null),[N,z]=a.useState(!1),g=a.useRef(0),s=a.useMemo(()=>({text:n?"#e0e0e0":"#333333",grid:n?p?"rgba(180,160,255,0.15)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",hoverBg:n?p?"#2d2545":"#1e293b":"#ffffff",hoverFont:n?"#e0e0e0":"#333333",hoverBorder:n?p?"#7c3aed":"#475569":"#e2e8f0",colorscale:p?"Plasma":n?"Viridis":"YlOrRd"}),[n,p]);a.useEffect(()=>{const t=L[u]||[];w(t),y(t[0]||""),v([]),f([]),S(null);let r=!1;return(async()=>{try{const i=await U.getUnderlyings(u);if(r)return;i.status==="success"&&i.underlyings.length>0&&(w(i.underlyings),i.underlyings.includes(t[0])||y(i.underlyings[0]))}catch{}})(),()=>{r=!0}},[u]),a.useEffect(()=>{if(!x)return;v([]),f([]),S(null);let t=!1;return(async()=>{try{const o=await U.getExpiries(u,x);if(t)return;o.status==="success"&&o.expiries.length>0&&(v(o.expiries),f(o.expiries.slice(0,4)))}catch{if(t)return;E.error("Failed to fetch expiry dates")}})(),()=>{t=!0}},[x]);const $=a.useCallback(t=>{f(r=>r.includes(t)?r.filter(o=>o!==t):r.length>=8?r:[...r,t])},[]),G=a.useCallback(async()=>{if(m.length===0)return;const t=++g.current;z(!0);try{const r=await xe.getSurfaceData({underlying:x,exchange:u,expiry_dates:m.map(fe),strike_count:parseInt(j)});if(g.current!==t)return;r.status==="success"&&r.data?S(r.data):E.error(r.message||"Failed to load vol surface")}catch{if(g.current!==t)return;E.error("Failed to fetch vol surface data")}finally{g.current===t&&z(!1)}},[m,j,x,u]),B=a.useMemo(()=>{if(!l)return{data:[],layout:{}};const{strikes:t,expiries:r,surface:o}=l,i=r.map((C,k)=>k),O=r.map(C=>C.date),X=o.map((C,k)=>Array(t.length).fill(O[k])),q=[{type:"surface",x:t,y:i,z:o,customdata:X,colorscale:s.colorscale,hovertemplate:"Strike: %{x}<br>Expiry: %{customdata}<br>IV: %{z:.2f}%<extra></extra>",colorbar:{title:{text:"IV %",font:{color:s.text,size:12}},tickfont:{color:s.text},outlinewidth:0,len:.6},opacity:.95}],H={autosize:!0,paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:s.text,family:"system-ui, sans-serif"},margin:{l:0,r:0,t:0,b:0},scene:{aspectmode:"manual",aspectratio:{x:2,y:1.2,z:.8},domain:{x:[0,1],y:[0,1]},xaxis:{title:{text:"Strike Price",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},yaxis:{title:{text:"Expiry",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},tickvals:i,ticktext:O,gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},zaxis:{title:{text:"Implied Volatility",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},camera:{eye:{x:1.6,y:-1.6,z:.7}},bgcolor:"rgba(0,0,0,0)"},hoverlabel:{bgcolor:s.hoverBg,font:{color:s.hoverFont,size:12},bordercolor:s.hoverBorder},showlegend:!1};return{data:q,layout:H}},[l,s,n]),K=a.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Vol Surface"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(D,{value:u,onValueChange:R,children:[e.jsx(P,{className:"w-[100px]",children:e.jsx(_,{placeholder:"Exchange"})}),e.jsx(A,{children:pe.map(t=>e.jsx(V,{value:t.value,children:t.label},t.value))})]}),e.jsxs(te,{open:F,onOpenChange:I,children:[e.jsx(se,{asChild:!0,children:e.jsxs(T,{variant:"outline",role:"combobox","aria-expanded":F,className:"w-[140px] justify-between",children:[x||"Underlying",e.jsx(de,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(re,{className:"w-48 p-0",align:"start",children:e.jsxs(ae,{children:[e.jsx(le,{placeholder:"Search underlying..."}),e.jsxs(oe,{children:[e.jsx(ne,{children:"No underlying found"}),e.jsx(ie,{children:M.map(t=>e.jsxs(ce,{value:t,onSelect:()=>{y(t),I(!1)},children:[e.jsx(ue,{className:`mr-2 h-4 w-4 ${x===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(D,{value:j,onValueChange:Y,children:[e.jsx(P,{className:"w-[100px]",children:e.jsx(_,{placeholder:"Strikes"})}),e.jsx(A,{children:me.map(t=>e.jsxs(V,{value:t.value,children:[t.label," Strikes"]},t.value))})]}),e.jsx(T,{variant:"outline",size:"sm",onClick:G,disabled:N||m.length===0,children:N?"Loading...":"Load Surface"})]})]}),b.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground self-center mr-1",children:"Expiries:"}),b.map(t=>e.jsx("button",{type:"button",onClick:()=>$(t),className:`px-2.5 py-1 rounded-md text-xs border transition-colors ${m.includes(t)?"bg-primary text-primary-foreground border-primary":"bg-muted/50 text-muted-foreground border-border hover:bg-muted"}`,children:t},t))]}),l&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",l.underlying_ltp?.toFixed(2)]}),e.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",l.atm_strike]}),e.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Expiries: ",l.expiries.length]}),e.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Strikes: ",l.strikes.length]})]}),e.jsx(Z,{children:e.jsx(ee,{className:"p-2 sm:p-4",children:N&&!l?e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Computing volatility surface..."]})}):l?e.jsx(J,{data:B.data,layout:B.layout,config:K,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):e.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:b.length>0?'Select expiries and click "Load Surface" to view the volatility surface':"Select an underlying to begin"})})})]})}export{we as default};
