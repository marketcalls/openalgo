import{r as m,j as e}from"./vendor-react-CCyQGCED.js";import{d as W,g as O,B as q,c as i,s as Y}from"./index-DLrRZEmO.js";import{t as K}from"./trading-DCRr6etS.js";import{C as g,d as v,a as b,c as L,b as z}from"./card-BHRAREBW.js";import{S}from"./skeleton-CI0sJPt5.js";import{u as G}from"./useLivePrice-BswvQCRj.js";import{Y as J,u as X,n as Z,a2 as ee,c as te,a3 as se}from"./vendor-icons-Ys8lBJ3m.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";import"./useMarketStatus-BxIKad63.js";function E(x){const p=Math.abs(x),P=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(p);return x<0?`-${P}`:P}function o(x){return x>0?`+${E(x)}`:E(x)}function ue(){const{apiKey:x}=W(),[p,P]=m.useState([]),[_,R]=m.useState(!0),[B,C]=m.useState(!1),[Q,w]=m.useState(null),[A,I]=m.useState(new Set),{wasHidden:U,timeSinceHidden:T}=O(),f=m.useCallback(async(a=!1)=>{if(x){a?C(!0):R(!0);try{const s=await K.getTrades(x);s.status==="success"&&s.data?(P(s.data),w(null)):w(s.message||"Failed to fetch trades")}catch(s){w("Failed to fetch tradebook"),console.error("Tradebook fetch error:",s)}finally{R(!1),C(!1)}}},[x]);m.useEffect(()=>{f()},[f]),m.useEffect(()=>{U&&T>3e4&&f(!0)},[U,T,f]);const F=m.useMemo(()=>{const a=new Map;return p.forEach(s=>{const d=`${s.strategy||"Untagged"}:${s.symbol}:${s.exchange}`,l=a.get(d);if(l){if(s.action==="BUY"){const r=l.avgBuyPrice*l.buyQty+s.average_price*s.quantity;l.buyQty+=s.quantity,l.avgBuyPrice=l.buyQty>0?r/l.buyQty:0}else{const r=l.avgSellPrice*l.sellQty+s.average_price*s.quantity;l.sellQty+=s.quantity,l.avgSellPrice=l.sellQty>0?r/l.sellQty:0}l.netQty=l.buyQty-l.sellQty,l.quantity=Math.abs(l.netQty),l.average_price=l.netQty>0?l.avgBuyPrice:l.avgSellPrice}else{const r=s.action==="BUY";a.set(d,{symbol:s.symbol,exchange:s.exchange,buyQty:r?s.quantity:0,sellQty:r?0:s.quantity,netQty:r?s.quantity:-s.quantity,avgBuyPrice:r?s.average_price:0,avgSellPrice:r?0:s.average_price,ltp:0,realizedPnl:0,unrealizedPnl:0,product:s.product,quantity:s.quantity,average_price:s.average_price})}}),Array.from(a.values())},[p]),{data:k,isLive:D}=G(F,{enabled:F.length>0,useMultiQuotesFallback:!0,pauseWhenHidden:!0}),u=m.useMemo(()=>{const a=new Map,s=new Map;return p.forEach(t=>{const d=t.strategy||"Untagged",l=`${t.symbol}:${t.exchange}`;s.set(l,d)}),k.forEach(t=>{const d=`${t.symbol}:${t.exchange}`,l=s.get(d)||"Untagged",r=Math.min(t.buyQty,t.sellQty),h=t.netQty,n=t.ltp||0;let N=0;r>0&&t.avgBuyPrice>0&&t.avgSellPrice>0&&(N=(t.avgSellPrice-t.avgBuyPrice)*r);let j=0;if(h!==0&&n>0){const $=h>0?t.avgBuyPrice:t.avgSellPrice;h>0?j=(n-$)*h:j=($-n)*Math.abs(h)}const M={...t,ltp:n,realizedPnl:N,unrealizedPnl:j},y=a.get(l);y?(y.legs.push(M),y.totalRealizedPnl+=N,y.totalUnrealizedPnl+=j,y.totalPnl=y.totalRealizedPnl+y.totalUnrealizedPnl):a.set(l,{name:l,legs:[M],totalRealizedPnl:N,totalUnrealizedPnl:j,totalPnl:N+j})}),Array.from(a.values()).sort((t,d)=>t.name.localeCompare(d.name))},[k,p]),c=m.useMemo(()=>u.reduce((a,s)=>({realizedPnl:a.realizedPnl+s.totalRealizedPnl,unrealizedPnl:a.unrealizedPnl+s.totalUnrealizedPnl,totalPnl:a.totalPnl+s.totalPnl}),{realizedPnl:0,unrealizedPnl:0,totalPnl:0}),[u]),V=a=>{I(s=>{const t=new Set(s);return t.has(a)?t.delete(a):t.add(a),t})},H=()=>{const a=["Strategy","Symbol","Exchange","Buy Qty","Sell Qty","Net Qty","Avg Buy Price","Avg Sell Price","LTP","Realized P&L","Unrealized P&L","Total P&L"],s=u.flatMap(h=>h.legs.map(n=>[h.name,n.symbol,n.exchange,n.buyQty,n.sellQty,n.netQty,n.avgBuyPrice.toFixed(2),n.avgSellPrice.toFixed(2),n.ltp.toFixed(2),n.realizedPnl.toFixed(2),n.unrealizedPnl.toFixed(2),(n.realizedPnl+n.unrealizedPnl).toFixed(2)])),t=[a.join(","),...s.map(h=>h.join(","))].join(`
`),d=new Blob([t],{type:"text/csv"}),l=URL.createObjectURL(d),r=document.createElement("a");r.href=l,r.download=`intraday_pnl_${new Date().toISOString().split("T")[0]}.csv`,r.click(),URL.revokeObjectURL(l),Y.success("CSV exported successfully","system")};return _?e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(S,{className:"h-8 w-48"}),e.jsx(S,{className:"h-10 w-32"})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:[1,2,3].map(a=>e.jsx(S,{className:"h-24"},a))}),e.jsx(S,{className:"h-64"})]}):e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Intraday P&L"}),e.jsxs("p",{className:"text-muted-foreground",children:["Today's strategy-wise P&L from tradebook",D&&e.jsxs("span",{className:"ml-2 inline-flex items-center gap-1 text-green-600",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),"Live"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>f(!0),disabled:B,children:[e.jsx(J,{className:i("h-4 w-4 mr-2",B&&"animate-spin")}),"Refresh"]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:H,disabled:u.length===0,children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),Q&&e.jsx(g,{className:"border-destructive",children:e.jsx(v,{className:"pt-6",children:e.jsx("p",{className:"text-destructive",children:Q})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx(g,{children:e.jsxs(b,{className:"pb-2",children:[e.jsx(L,{children:"Realized P&L"}),e.jsx(z,{className:i("text-2xl",c.realizedPnl>=0?"text-green-600":"text-red-600"),children:o(c.realizedPnl)})]})}),e.jsx(g,{children:e.jsxs(b,{className:"pb-2",children:[e.jsx(L,{children:"Unrealized P&L"}),e.jsx(z,{className:i("text-2xl",c.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:o(c.unrealizedPnl)})]})}),e.jsx(g,{children:e.jsxs(b,{className:"pb-2",children:[e.jsx(L,{children:"Total P&L"}),e.jsx(z,{className:i("text-2xl",c.totalPnl>=0?"text-green-600":"text-red-600"),children:o(c.totalPnl)})]})})]}),u.length===0&&!Q&&e.jsx(g,{children:e.jsx(v,{className:"py-12 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No trades found for today"})})}),e.jsx("div",{className:"space-y-4",children:u.map(a=>{const s=A.has(a.name);return e.jsxs(g,{children:[e.jsxs(b,{className:"cursor-pointer flex flex-row items-center justify-between py-4",onClick:()=>V(a.name),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s?e.jsx(Z,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(ee,{className:"h-5 w-5 text-muted-foreground"}),e.jsx(z,{className:"text-lg",children:a.name}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",a.legs.length," legs)"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Realized"}),e.jsx("div",{className:i("font-medium",a.totalRealizedPnl>=0?"text-green-600":"text-red-600"),children:o(a.totalRealizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Unrealized"}),e.jsx("div",{className:i("font-medium",a.totalUnrealizedPnl>=0?"text-green-600":"text-red-600"),children:o(a.totalUnrealizedPnl)})]}),e.jsxs("div",{className:"text-right min-w-[100px]",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsxs("div",{className:"flex items-center gap-1",children:[a.totalPnl>=0?e.jsx(te,{className:"h-4 w-4 text-green-600"}):e.jsx(se,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:i("font-bold",a.totalPnl>=0?"text-green-600":"text-red-600"),children:o(a.totalPnl)})]})]})]})]}),!s&&e.jsx(v,{className:"pt-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-2 font-medium",children:"Symbol"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Buy Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Sell Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Net Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Avg Buy"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Avg Sell"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"LTP"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Realized"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Unrealized"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"P&L"})]})}),e.jsx("tbody",{children:a.legs.map((t,d)=>{const l=t.realizedPnl+t.unrealizedPnl;return e.jsxs("tr",{className:"border-b last:border-0 hover:bg-muted/50",children:[e.jsxs("td",{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:t.symbol}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.exchange})]}),e.jsx("td",{className:"text-right py-2 text-green-600",children:t.buyQty||"-"}),e.jsx("td",{className:"text-right py-2 text-red-600",children:t.sellQty||"-"}),e.jsxs("td",{className:i("text-right py-2 font-medium",t.netQty>0?"text-green-600":t.netQty<0?"text-red-600":""),children:[t.netQty>0?"+":"",t.netQty]}),e.jsx("td",{className:"text-right py-2",children:t.avgBuyPrice>0?`₹${t.avgBuyPrice.toFixed(2)}`:"-"}),e.jsx("td",{className:"text-right py-2",children:t.avgSellPrice>0?`₹${t.avgSellPrice.toFixed(2)}`:"-"}),e.jsx("td",{className:"text-right py-2 font-medium",children:t.ltp>0?`₹${t.ltp.toFixed(2)}`:"-"}),e.jsx("td",{className:i("text-right py-2",t.realizedPnl>=0?"text-green-600":"text-red-600"),children:o(t.realizedPnl)}),e.jsx("td",{className:i("text-right py-2",t.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:o(t.unrealizedPnl)}),e.jsx("td",{className:i("text-right py-2 font-bold",l>=0?"text-green-600":"text-red-600"),children:o(l)})]},d)})})]})})})]},a.name)})}),u.length>0&&e.jsx(g,{className:"bg-muted/50",children:e.jsx(v,{className:"py-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium",children:["Grand Total (",u.length," strategies, ",u.reduce((a,s)=>a+s.legs.length,0)," ","legs)"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Realized:"}),e.jsx("span",{className:i("font-medium",c.realizedPnl>=0?"text-green-600":"text-red-600"),children:o(c.realizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Unrealized:"}),e.jsx("span",{className:i("font-medium",c.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:o(c.unrealizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Total:"}),e.jsx("span",{className:i("font-bold text-lg",c.totalPnl>=0?"text-green-600":"text-red-600"),children:o(c.totalPnl)})]})]})]})})})]})}export{ue as default};
