import{r as e}from"./vendor-react--vsXx8_n.js";function H(){const[c,D]=e.useState(()=>typeof document<"u"?document.visibilityState==="visible":!0),[h,v]=e.useState(!1),[E,L]=e.useState(Date.now()),[z,C]=e.useState(0),[g,m]=e.useState(0),o=e.useRef(c),p=e.useRef(null),T=e.useRef(Date.now()),b=e.useRef(c);e.useEffect(()=>{b.current=c},[c]);const k=e.useCallback(()=>{const u=Date.now();b.current?(C(u-T.current),m(0)):(m(p.current?u-p.current:0),C(0))},[]);return e.useEffect(()=>{if(typeof document>"u")return;const u=()=>{const y=document.visibilityState==="visible",r=Date.now();y&&!o.current?(v(!0),T.current=r,p.current&&m(r-p.current)):y||(p.current=r,v(!1)),o.current=y,D(y),L(r),k()};document.addEventListener("visibilitychange",u);const N=()=>{o.current||u()},d=()=>{o.current&&document.visibilityState==="hidden"&&u()};window.addEventListener("focus",N),window.addEventListener("blur",d);const w=setInterval(k,1e3);return()=>{document.removeEventListener("visibilitychange",u),window.removeEventListener("focus",N),window.removeEventListener("blur",d),clearInterval(w)}},[k]),e.useEffect(()=>{if(h){const u=setTimeout(()=>v(!1),100);return()=>clearTimeout(u)}},[h]),{isVisible:c,wasHidden:h,timeSinceVisible:z,timeSinceHidden:g,lastVisibilityChange:E}}async function U(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function B({symbols:c,mode:D="LTP",enabled:h=!0,autoReconnect:v=!0,pauseWhenHidden:E=!0,pauseDelay:L=5e3}){const[z,C]=e.useState(new Map),[g,m]=e.useState(!1),[o,p]=e.useState(!1),[T,b]=e.useState(!1),[k,u]=e.useState(!1),[N,d]=e.useState(null),{isVisible:w,wasHidden:y}=H(),r=e.useRef(null),_=e.useRef(null),S=e.useRef(null),P=e.useRef(!1),$=e.useRef(new Set),O=e.useRef([]),F=e.useCallback(async()=>U(),[]),x=e.useCallback(i=>{if(!r.current||r.current.readyState!==WebSocket.OPEN||!o){O.current=i;return}const s=i.filter(n=>{const l=`${n.exchange}:${n.symbol}`;return!$.current.has(l)});s.length!==0&&(r.current.send(JSON.stringify({action:"subscribe",symbols:s,mode:D})),s.forEach(n=>{const l=`${n.exchange}:${n.symbol}`;$.current.add(l),C(f=>{const t=new Map(f);return t.has(l)||t.set(l,{symbol:n.symbol,exchange:n.exchange,data:{}}),t})}))},[o,D]),W=e.useCallback(i=>{!r.current||r.current.readyState!==WebSocket.OPEN||i.length===0||(r.current.send(JSON.stringify({action:"unsubscribe",symbols:i})),i.forEach(s=>{const n=`${s.exchange}:${s.symbol}`;$.current.delete(n)}),C(s=>{const n=new Map(s);return i.forEach(l=>{const f=`${l.exchange}:${l.symbol}`;n.delete(f)}),n}))},[]),j=e.useCallback(i=>{try{const s=JSON.parse(i.data);switch(s.type||s.status){case"auth":s.status==="success"?(p(!0),d(null),O.current.length>0&&setTimeout(()=>{x(O.current),O.current=[]},100)):d(`Authentication failed: ${s.message}`);break;case"market_data":{const l=s.symbol.toUpperCase(),f=s.exchange,t=s.data||{},M=`${f}:${l}`;C(R=>{const A=R.get(M);if(!A)return R;const K=new Map(R),a={...A.data};return Object.assign(a,{ltp:t.ltp??a.ltp,open:t.open??a.open,high:t.high??a.high,low:t.low??a.low,close:t.close??a.close,volume:t.volume??a.volume,change:t.change??a.change,change_percent:t.change_percent??a.change_percent,timestamp:t.timestamp??a.timestamp,bid_price:t.bid_price??a.bid_price,ask_price:t.ask_price??a.ask_price,bid_size:t.bid_size??a.bid_size,ask_size:t.ask_size??a.ask_size,depth:t.depth??a.depth}),K.set(M,{...A,data:a,lastUpdate:Date.now()}),K});break}case"subscribe":break;case"error":d(`WebSocket error: ${s.message}`);break}}catch{}},[x]),V=e.useCallback(async()=>{if(r.current?.readyState!==WebSocket.OPEN){b(!0),d(null);try{const i=await F(),n=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":i},credentials:"include"})).json();if(n.status!=="success")throw new Error("Failed to get WebSocket configuration");const l=n.websocket_url,f=new WebSocket(l);f.onopen=async()=>{m(!0),b(!1);try{const t=await F(),R=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":t},credentials:"include"})).json();R.status==="success"&&R.api_key?f.send(JSON.stringify({action:"authenticate",api_key:R.api_key})):d("No API key found - please generate one at /apikey")}catch(t){d(`Authentication error: ${t}`)}},f.onclose=t=>{m(!1),b(!1),p(!1),$.current.clear(),v&&!t.wasClean&&h&&(!E||document.visibilityState==="visible")&&(_.current=setTimeout(V,3e3))},f.onerror=()=>{d("WebSocket connection error"),b(!1)},f.onmessage=j,r.current=f}catch(i){d(`Connection failed: ${i}`),b(!1)}}},[F,j,v,h,E]),I=e.useCallback(()=>{_.current&&(clearTimeout(_.current),_.current=null),r.current&&(r.current.close(1e3,"User disconnect"),r.current=null),m(!1),p(!1),$.current.clear()},[]);e.useEffect(()=>(h&&c.length>0&&!g&&!T&&V(),()=>{_.current&&clearTimeout(_.current)}),[h,c.length,g,T,V]);const J=e.useRef([]);return e.useEffect(()=>{if(!o)return;const i=new Set(c.map(n=>`${n.exchange}:${n.symbol}`)),s=J.current.filter(n=>!i.has(`${n.exchange}:${n.symbol}`));s.length>0&&W(s),c.length>0&&x(c),J.current=[...c]},[o,c,x,W]),e.useEffect(()=>()=>{I()},[I]),e.useEffect(()=>{if(E)return!w&&g?(P.current=!0,S.current=setTimeout(()=>{P.current=!1,u(!0),I()},L)):w&&(S.current&&(clearTimeout(S.current),S.current=null,P.current=!1),k&&h&&c.length>0&&(P.current=!1,u(!1),V())),()=>{S.current&&(clearTimeout(S.current),S.current=null,P.current=!1)}},[w,g,k,E,L,h,c.length,V,I]),e.useEffect(()=>{y&&w&&o&&c.length>0&&($.current.clear(),x(c))},[y,w,o,c,x]),{data:z,isConnected:g,isAuthenticated:o,isConnecting:T,isPaused:k,error:N,connect:V,disconnect:I}}export{B as a,H as u};
