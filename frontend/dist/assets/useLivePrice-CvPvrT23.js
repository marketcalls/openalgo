import{r as t}from"./vendor-react--vsXx8_n.js";import{t as A}from"./trading-YqFbNuOJ.js";import{d as F}from"./index-CldAMq0C.js";async function I(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function W({symbols:e,mode:k="LTP",enabled:o=!0,autoReconnect:y=!0}){const[m,T]=t.useState(new Map),[a,s]=t.useState(!1),[n,i]=t.useState(!1),[u,D]=t.useState(!1),[$,w]=t.useState(null),b=t.useRef(null),v=t.useRef(null),R=t.useRef(new Set),E=t.useRef([]),r=t.useCallback(async()=>I(),[]),S=t.useCallback(f=>{if(!b.current||b.current.readyState!==WebSocket.OPEN||!n){E.current=f;return}const p=f.filter(h=>{const M=`${h.exchange}:${h.symbol}`;return!R.current.has(M)});p.length!==0&&(b.current.send(JSON.stringify({action:"subscribe",symbols:p,mode:k})),p.forEach(h=>{const M=`${h.exchange}:${h.symbol}`;R.current.add(M),T(l=>{const c=new Map(l);return c.has(M)||c.set(M,{symbol:h.symbol,exchange:h.exchange,data:{}}),c})}))},[n,k]),d=t.useCallback(f=>{try{const p=JSON.parse(f.data);switch(p.type||p.status){case"auth":p.status==="success"?(i(!0),w(null),E.current.length>0&&setTimeout(()=>{S(E.current),E.current=[]},100)):w(`Authentication failed: ${p.message}`);break;case"market_data":{const M=p.symbol.toUpperCase(),l=p.exchange,c=p.data||{},P=`${l}:${M}`;T(C=>{const O=C.get(P);if(!O)return C;const L=new Map(C),_={...O.data};return Object.assign(_,{ltp:c.ltp??_.ltp,open:c.open??_.open,high:c.high??_.high,low:c.low??_.low,close:c.close??_.close,volume:c.volume??_.volume,change:c.change??_.change,change_percent:c.change_percent??_.change_percent,timestamp:c.timestamp??_.timestamp}),L.set(P,{...O,data:_,lastUpdate:Date.now()}),L});break}case"subscribe":break;case"error":w(`WebSocket error: ${p.message}`);break}}catch{}},[S]),g=t.useCallback(async()=>{if(b.current?.readyState!==WebSocket.OPEN){D(!0),w(null);try{const f=await r(),h=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":f},credentials:"include"})).json();if(h.status!=="success")throw new Error("Failed to get WebSocket configuration");const M=h.websocket_url,l=new WebSocket(M);l.onopen=async()=>{s(!0),D(!1);try{const c=await r(),C=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":c},credentials:"include"})).json();C.status==="success"&&C.api_key?l.send(JSON.stringify({action:"authenticate",api_key:C.api_key})):w("No API key found - please generate one at /apikey")}catch(c){w(`Authentication error: ${c}`)}},l.onclose=c=>{s(!1),D(!1),i(!1),R.current.clear(),y&&!c.wasClean&&o&&(v.current=setTimeout(g,3e3))},l.onerror=()=>{w("WebSocket connection error"),D(!1)},l.onmessage=d,b.current=l}catch(f){w(`Connection failed: ${f}`),D(!1)}}},[r,d,y,o]),x=t.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=null),b.current&&(b.current.close(1e3,"User disconnect"),b.current=null),s(!1),i(!1),R.current.clear()},[]);return t.useEffect(()=>(o&&e.length>0&&!a&&!u&&g(),()=>{v.current&&clearTimeout(v.current)}),[o,e.length,a,u,g]),t.useEffect(()=>{n&&e.length>0&&S(e)},[n,e,S]),t.useEffect(()=>()=>{x()},[x]),{data:m,isConnected:a,isAuthenticated:n,isConnecting:u,error:$,connect:g,disconnect:x}}async function j(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function q(){const[e,k]=t.useState({timings:[],holidays:[],isLoading:!0,error:null});t.useEffect(()=>{(async()=>{try{const n={"X-CSRFToken":await j(),"Content-Type":"application/json"},[i,u]=await Promise.all([fetch("/admin/api/timings",{headers:n,credentials:"include"}),fetch("/admin/api/holidays",{headers:n,credentials:"include"})]),D=await i.json(),$=await u.json();k({timings:D.status==="success"?D.market_status||[]:[],holidays:$.status==="success"?$.data||[]:[],isLoading:!1,error:null})}catch(s){k(n=>({...n,isLoading:!1,error:`Failed to fetch market status: ${s}`}))}})()},[]);const o=t.useCallback(a=>{const s=new Date().toISOString().split("T")[0],n=e.holidays.find(i=>i.date===s);if(!n)return!1;if(n.closed_exchanges.includes(a)){const i=n.open_exchanges.find(u=>u.exchange===a);if(i){const u=Date.now();return!(u>=i.start_time&&u<=i.end_time)}return!0}return!1},[e.holidays]),y=t.useCallback(a=>{if(o(a))return!1;const s=e.timings.find(i=>i.exchange===a);if(!s)return!1;const n=Date.now();return n>=s.start_time&&n<=s.end_time},[e.timings,o]),m=t.useCallback(()=>e.timings.some(a=>{const s=Date.now();return s>=a.start_time&&s<=a.end_time&&!o(a.exchange)}),[e.timings,o]),T=t.useCallback(a=>{if(o(a))return"closed";const s=e.timings.find(u=>u.exchange===a);if(!s)return"closed";const n=Date.now(),i=900*1e3;return n<s.start_time-i?"closed":n<s.start_time?"pre-market":n<=s.end_time?"open":"post-market"},[e.timings,o]);return{isMarketOpen:y,isAnyMarketOpen:m,isHolidayForExchange:o,getMarketStatus:T,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function H(e,k={}){const{enabled:o=!0,staleThreshold:y=5e3,useMultiQuotesFallback:m=!0,multiQuotesRefreshInterval:T=3e4}=k,{apiKey:a}=F(),{isMarketOpen:s,isAnyMarketOpen:n}=q(),i=n(),[u,D]=t.useState(new Map),$=t.useMemo(()=>e.map(r=>({symbol:r.symbol,exchange:r.exchange})),[e]),{data:w,isConnected:b}=W({symbols:$,mode:"LTP",enabled:o&&e.length>0}),v=b&&i,R=t.useCallback(async()=>{if(!(!a||e.length===0||!m))try{const r=e.map(d=>({symbol:d.symbol,exchange:d.exchange})),S=await A.getMultiQuotes(a,r);if(S.status==="success"&&S.results){const d=new Map;S.results.forEach(g=>{const x=`${g.exchange}:${g.symbol}`;g.data&&d.set(x,g.data)}),D(d)}}catch{console.debug("MultiQuotes fetch failed, using cached/REST data")}},[a,e,m]);return t.useEffect(()=>{if(!o||e.length===0||!m)return;R();const r=setInterval(R,T);return()=>clearInterval(r)},[o,e.length,m,R,T]),{data:t.useMemo(()=>e.map(r=>{const S=`${r.exchange}:${r.symbol}`,d=w.get(S),g=u.get(S),x=r.quantity||0,f=r.average_price||0,h=s(r.exchange)&&d?.data?.ltp&&d.lastUpdate&&Date.now()-d.lastUpdate<y,M=!h&&g?.ltp;let l,c="rest";if(h&&d?.data?.ltp?(l=d.data.ltp,c="websocket"):M&&g?.ltp?(l=g.ltp,c="multiquotes"):(l=r.ltp,c="rest"),x===0)return{...r,_dataSource:"rest"};let P=r.pnl||0,C=r.pnlpercent||0;return l&&f>0&&(x>0?(P=(l-f)*x,C=(l-f)/f*100):(P=(f-l)*Math.abs(x),C=(f-l)/f*100)),{...r,ltp:l,pnl:P,pnlpercent:C,_dataSource:c}}),[e,w,u,s,y]),isLive:v,isConnected:b,isAnyMarketOpen:i,multiQuotes:u,refreshMultiQuotes:R}}function K(e,k){if(!k)return null;let o=0,y=0,m=0;e.forEach(a=>{o+=a.pnl||0;const s=a.average_price||0,n=a.quantity||0,i=a.ltp||s;y+=s*n,m+=i*n});const T=y>0?o/y*100:0;return{...k,totalholdingvalue:m,totalinvvalue:y,totalprofitandloss:o,totalpnlpercentage:T}}export{K as c,H as u};
