import{r as f,j as e,a as O}from"./vendor-react--vsXx8_n.js";import{w as L,B as k,t as _,e as b}from"./index-DxRmsqKr.js";import{A as z,b as Y,c as M,d as W,e as q,f as Q,g as V,h as J}from"./alert-dialog-C-D2Gwk4.js";import{C as H,a as X,b as Z,c as K}from"./card-BgNp8iPB.js";import{C as ee,b as se,a as te}from"./collapsible-oki6G1qf.js";import{T as R,a as P,b as T,c as a,d as A,e as i}from"./table-B3ZVgrEX.js";import{I as re}from"./input-DQmf3E-J.js";import{R as G,$ as ne,k as ae,ah as ie,c as le,a0 as oe,aX as U}from"./vendor-icons-CeggrRkS.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CclZ5Z6W.js";import"./vendor-radix-DIebA-qg.js";async function ce(){const s=await L.get("/api/strategy-state");if(s.data.status==="error")throw new Error(s.data.message||"Failed to fetch strategy states");return s.data.data}async function de(s){console.log("[STRATPOS_DEBUG] Deleting strategy:",s);const r=await L.delete(`/api/strategy-state/${encodeURIComponent(s)}`);if(console.log("[STRATPOS_DEBUG] Delete response:",r.data),r.data.status==="error")throw new Error(r.data.message||"Failed to delete strategy state")}async function xe(s,r,u,o){const x=await L.post(`/api/strategy-state/${encodeURIComponent(s)}/override`,{leg_key:r,override_type:u,new_value:o});if(x.data.status==="error")throw new Error(x.data.message||"Failed to create strategy override");return{message:x.data.message||"Override created successfully"}}const me={RUNNING:"bg-green-500",PAUSED:"bg-yellow-500",COMPLETED:"bg-gray-400",ERROR:"bg-red-500"},B={IDLE:"bg-gray-400",PENDING_ENTRY:"bg-blue-400",IN_POSITION:"bg-green-500",PENDING_EXIT:"bg-orange-400",EXITED_WAITING_REENTRY:"bg-yellow-500",EXITED_WAITING_REEXECUTE:"bg-purple-500",DONE:"bg-gray-500"},he={SL_HIT:"bg-red-500",TARGET_HIT:"bg-green-500",HEDGE_SL_EXIT:"bg-red-400",HEDGE_TARGET_EXIT:"bg-green-400",STRATEGY_DONE:"bg-gray-500"};function ue(s){if(s==null)return"â€”";const r=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(Math.abs(s));return s<0?`-${r}`:r}function E(s){return s==null?"â€”":s.toFixed(2)}function fe(s){return s?new Date(s).toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}):"â€”"}function F(s){return s?new Date(s).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}):"â€”"}function S({value:s,showIcon:r=!0}){if(s==null)return e.jsx("span",{className:"text-muted-foreground",children:"â€”"});const u=s>=0,o=u?"text-green-600":"text-red-600";return e.jsxs("span",{className:`font-medium ${o} flex items-center gap-1`,children:[r&&(u?e.jsx(le,{className:"h-3 w-3"}):e.jsx(oe,{className:"h-3 w-3"})),ue(s)]})}function $({value:s,instanceId:r,legKey:u,overrideType:o,leg:x,onSuccess:m}){const[l,t]=f.useState(!1),[j,v]=f.useState(""),[D,y]=f.useState(!1),p=O.useRef(null),N=x.status==="IN_POSITION",I=()=>{N&&(v(s?.toString()??""),t(!0))};O.useEffect(()=>{l&&p.current&&(p.current.focus(),p.current.select())},[l]);const w=n=>{if(Number.isNaN(n)||n<0)return"Value must be a non-negative number";const h=x.entry_price;if(!h)return null;const g=x.side;if(o==="sl_price"){if(g==="SELL"&&n<=h)return`SL for SELL must be above entry price (${h.toFixed(2)})`;if(g==="BUY"&&n>=h)return`SL for BUY must be below entry price (${h.toFixed(2)})`}if(o==="target_price"){if(g==="SELL"&&n>=h)return`Target for SELL must be below entry price (${h.toFixed(2)})`;if(g==="BUY"&&n<=h)return`Target for BUY must be above entry price (${h.toFixed(2)})`}return null},C=async()=>{const n=Number.parseFloat(j),h=w(n);if(h){_.error(h);return}if(s!=null&&Math.abs(n-s)<.01){t(!1);return}y(!0);try{const g=await xe(r,u,o,n);_.success(g.message),t(!1),m()}catch(g){_.error(g instanceof Error?g.message:"Failed to update")}finally{y(!1)}},c=n=>{n.key==="Enter"?(n.preventDefault(),C()):n.key==="Escape"&&t(!1)},d=()=>{t(!1)};return l?e.jsx(re,{ref:p,type:"number",step:"0.05",value:j,onChange:n=>v(n.target.value),onKeyDown:c,onBlur:d,disabled:D,className:"h-7 w-20 text-right text-sm px-1"}):e.jsx("span",{onClick:I,onKeyDown:n=>n.key==="Enter"&&I(),tabIndex:N?0:void 0,role:N?"button":void 0,className:N?"cursor-pointer hover:bg-muted px-1 py-0.5 rounded transition-colors":"",title:N?"Click to edit":void 0,children:E(s)})}function ge({legs:s,instanceId:r,onRefresh:u}){if(console.log("[STRATPOS_DEBUG] CurrentPositionsTable legs:",{legs:s,type:typeof s,is_null:s===null,is_undefined:s===void 0}),!s)return console.log("[STRATPOS_DEBUG] CurrentPositionsTable: legs is null/undefined, returning early"),e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"});const o=Object.entries(s);console.log("[STRATPOS_DEBUG] CurrentPositionsTable legEntries:",o);const x=o.filter(([l,t])=>["IN_POSITION","PENDING_ENTRY","PENDING_EXIT"].includes(t.status)),m=o.filter(([l,t])=>["DONE","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE","IDLE"].includes(t.status));return o.length===0?e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"}):e.jsxs("div",{className:"space-y-4",children:[x.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4 text-green-500"}),"Open Positions (",x.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(R,{children:[e.jsx(P,{children:e.jsxs(T,{children:[e.jsx(a,{children:"Leg"}),e.jsx(a,{children:"Symbol"}),e.jsx(a,{children:"Side"}),e.jsx(a,{className:"text-right",children:"Qty"}),e.jsx(a,{className:"text-right",children:"Entry"}),e.jsx(a,{className:"text-right",children:"LTP"}),e.jsx(a,{className:"text-right",children:"SL"}),e.jsx(a,{className:"text-right",children:"Target"}),e.jsx(a,{children:"Status"}),e.jsx(a,{className:"text-right",children:"Unreal P&L"}),e.jsx(a,{className:"text-right",children:"Reentry"})]})}),e.jsx(A,{children:x.map(([l,t])=>e.jsxs(T,{children:[e.jsx(i,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.leg_pair_name||l}),t.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(i,{className:"font-mono text-xs",children:t.symbol}),e.jsx(i,{children:t.side?e.jsx(b,{variant:t.side==="SELL"?"destructive":"default",children:t.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(i,{className:"text-right",children:t.quantity}),e.jsx(i,{className:"text-right",children:E(t.entry_price)}),e.jsx(i,{className:"text-right",children:E(t.current_ltp??t.entry_price)}),e.jsx(i,{className:"text-right",children:e.jsx($,{value:t.sl_price,instanceId:r,legKey:l,overrideType:"sl_price",leg:t,onSuccess:u})}),e.jsx(i,{className:"text-right",children:e.jsx($,{value:t.target_price,instanceId:r,legKey:l,overrideType:"target_price",leg:t,onSuccess:u})}),e.jsx(i,{children:e.jsx(b,{className:B[t.status],variant:"secondary",children:t.status.replace(/_/g," ")})}),e.jsx(i,{className:"text-right",children:e.jsx(S,{value:t.unrealized_pnl})}),e.jsxs(i,{className:"text-right",children:[t.reentry_count??0,"/",t.reentry_limit??"âˆž"]})]},l))})]})})]}),m.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4 text-gray-400"}),"Exited/Waiting Positions (",m.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(R,{children:[e.jsx(P,{children:e.jsxs(T,{children:[e.jsx(a,{children:"Leg"}),e.jsx(a,{children:"Symbol"}),e.jsx(a,{children:"Side"}),e.jsx(a,{className:"text-right",children:"Qty"}),e.jsx(a,{className:"text-right",children:"Entry"}),e.jsx(a,{children:"Status"}),e.jsx(a,{className:"text-right",children:"Realized P&L"}),e.jsx(a,{className:"text-right",children:"Reentry"}),e.jsx(a,{className:"text-right",children:"Reexec"})]})}),e.jsx(A,{children:m.map(([l,t])=>e.jsxs(T,{children:[e.jsx(i,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.leg_pair_name||l}),t.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(i,{className:"font-mono text-xs",children:t.symbol}),e.jsx(i,{children:t.side?e.jsx(b,{variant:t.side==="SELL"?"destructive":"default",children:t.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(i,{className:"text-right",children:t.quantity}),e.jsx(i,{className:"text-right",children:E(t.entry_price)}),e.jsx(i,{children:e.jsx(b,{className:B[t.status],variant:"secondary",children:t.status.replace(/_/g," ")})}),e.jsx(i,{className:"text-right",children:e.jsx(S,{value:t.realized_pnl})}),e.jsxs(i,{className:"text-right",children:[t.reentry_count??0,"/",t.reentry_limit??"âˆž"]}),e.jsxs(i,{className:"text-right",children:[t.reexecute_count??0,"/",t.reexecute_limit??"âˆž"]})]},l))})]})})]})]})}function je({trades:s}){return console.log("[STRATPOS_DEBUG] TradeHistoryTable trades:",{trades:s,type:typeof s,is_null:s===null,is_undefined:s===void 0,is_array:Array.isArray(s),length:Array.isArray(s)?s.length:"N/A"}),!s||s.length===0?(console.log("[STRATPOS_DEBUG] TradeHistoryTable: trades is empty/null, returning early"),e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No trade history"})):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(R,{children:[e.jsx(P,{children:e.jsxs(T,{children:[e.jsx(a,{children:"#"}),e.jsx(a,{children:"Leg"}),e.jsx(a,{children:"Symbol"}),e.jsx(a,{children:"Side"}),e.jsx(a,{className:"text-right",children:"Qty"}),e.jsx(a,{className:"text-right",children:"Entry"}),e.jsx(a,{className:"text-right",children:"Exit"}),e.jsx(a,{children:"Exit Type"}),e.jsx(a,{className:"text-right",children:"P&L"})]})}),e.jsx(A,{children:s.map(r=>e.jsxs(T,{children:[e.jsx(i,{children:r.trade_id}),e.jsx(i,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:r.leg_pair_name||r.leg_key}),r.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(i,{className:"font-mono text-xs",children:r.symbol}),e.jsx(i,{children:e.jsx(b,{variant:r.side==="SELL"?"destructive":"default",children:r.side})}),e.jsx(i,{className:"text-right",children:r.quantity}),e.jsx(i,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:E(r.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:F(r.entry_time)})]})}),e.jsx(i,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:E(r.exit_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:F(r.exit_time)})]})}),e.jsx(i,{children:r.exit_type&&e.jsx(b,{className:he[r.exit_type],variant:"secondary",children:r.exit_type.replace(/_/g," ")})}),e.jsx(i,{className:"text-right",children:e.jsx(S,{value:r.pnl})})]},r.trade_id))})]})})}function pe({strategy:s,onDelete:r,onRefresh:u}){const[o,x]=f.useState(!0),m=s.config;console.log("[STRATPOS_DEBUG] Rendering StrategyAccordionItem:",{strategy_name:s?.strategy_name,legs:s?.legs,trade_history:s?.trade_history,summary:s?.summary});const l=t=>{t.stopPropagation(),r(s.instance_id,s.strategy_name)};return e.jsx(ee,{open:o,onOpenChange:x,children:e.jsxs(H,{className:"mb-4",children:[e.jsx(se,{asChild:!0,children:e.jsx(Z,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[o?e.jsx(ne,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(ae,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(K,{className:"text-lg",children:s.strategy_name}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[m&&e.jsxs(e.Fragment,{children:[m.underlying," | Expiry: ",m.expiry_date," | Lots: ",m.lots," Ã— ",m.lot_size]}),!m&&`Instance: ${s.instance_id}`]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total P&L"}),e.jsx(S,{value:s.summary?.total_pnl})]}),e.jsx(b,{className:me[s.status]||"bg-gray-400",children:s.status}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:l,title:"Delete strategy state",children:e.jsx(ie,{className:"h-4 w-4"})})]})]})})}),e.jsx(te,{children:e.jsxs(X,{className:"pt-0 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Open Positions"}),e.jsx("p",{className:"text-lg font-semibold",children:s.summary?.open_positions_count??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Trades"}),e.jsx("p",{className:"text-lg font-semibold",children:s.summary?.total_trades??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Realized P&L"}),e.jsx(S,{value:s.summary?.total_realized_pnl,showIcon:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Unrealized P&L"}),e.jsx(S,{value:s.summary?.total_unrealized_pnl,showIcon:!1})]})]}),s.last_updated&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last updated: ",fe(s.last_updated),s.orchestrator&&` | Cycles: ${s.orchestrator.cycle_count}`]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“Š Current Positions"}),e.jsx(ge,{legs:s.legs,instanceId:s.instance_id,onRefresh:u})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“œ Trade History"}),e.jsx(je,{trades:s.trade_history})]})]})})]})})}function Ce(){const[s,r]=f.useState([]),[u,o]=f.useState(!0),[x,m]=f.useState(!1),[l,t]=f.useState({open:!1,instanceId:"",strategyName:""}),[j,v]=f.useState(!1),[D,y]=f.useState(""),p=async(c=!1)=>{try{console.log("[STRATPOS_DEBUG] Fetching strategy states...");const d=await ce();console.log("[STRATPOS_DEBUG] Raw API response:",JSON.stringify(d,null,2)),console.log("[STRATPOS_DEBUG] Data type:",typeof d),console.log("[STRATPOS_DEBUG] Is array:",Array.isArray(d)),d&&Array.isArray(d)&&d.forEach((n,h)=>{console.log(`[STRATPOS_DEBUG] Strategy ${h}:`,{strategy_name:n?.strategy_name,status:n?.status,legs_type:typeof n?.legs,legs_is_null:n?.legs===null,legs_is_undefined:n?.legs===void 0,legs:n?.legs,trade_history_type:typeof n?.trade_history,trade_history_is_null:n?.trade_history===null,trade_history_is_undefined:n?.trade_history===void 0,trade_history_is_array:Array.isArray(n?.trade_history),trade_history:n?.trade_history,summary:n?.summary,config:n?.config})}),r(d),c&&_.success("Data refreshed")}catch(d){console.error("[STRATPOS_DEBUG] Error fetching strategy states:",d),_.error("Failed to fetch strategy positions")}finally{o(!1),m(!1)}},N=(c,d)=>{y(""),t({open:!0,instanceId:c,strategyName:d})},I=async()=>{if(l.instanceId){v(!0);try{await de(l.instanceId),_.success(`Strategy "${l.strategyName}" deleted successfully`),r(c=>c.filter(d=>d.instance_id!==l.instanceId))}catch(c){console.error("[STRATPOS_DEBUG] Error deleting strategy:",c),_.error("Failed to delete strategy")}finally{v(!1),t({open:!1,instanceId:"",strategyName:""}),y("")}}},w=D===l.strategyName;f.useEffect(()=>{p()},[]);const C=()=>{m(!0),p(!0)};return e.jsxs("div",{className:"container mx-auto py-6 px-4 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Strategy Positions"}),e.jsx("p",{className:"text-muted-foreground",children:"View positions and trade history for Python strategies"})]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:C,disabled:x,children:[e.jsx(G,{className:`h-4 w-4 mr-2 ${x?"animate-spin":""}`}),"Refresh"]})]}),u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(G,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):s.length===0?e.jsx(H,{children:e.jsxs(X,{className:"py-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"No strategy states found"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Strategy positions will appear here when you run Python strategies with state persistence."})]})}):e.jsx("div",{children:s.map(c=>e.jsx(pe,{strategy:c,onDelete:N,onRefresh:()=>p(!1)},c.instance_id))}),e.jsx(z,{open:l.open,onOpenChange:c=>{j||(t(d=>({...d,open:c})),c||y(""))},children:e.jsxs(Y,{children:[e.jsxs(M,{children:[e.jsx(W,{children:"Delete Strategy State?"}),e.jsx(q,{asChild:!0,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["Are you sure you want to delete the strategy state for"," ",e.jsx("strong",{children:l.strategyName}),"? This action cannot be undone and will remove all position data and trade history for this strategy."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm",children:["To confirm, type ",e.jsx("strong",{className:"text-foreground",children:l.strategyName})," below:"]}),e.jsx("input",{type:"text",value:D,onChange:c=>y(c.target.value),placeholder:"Type strategy name to confirm",className:"w-full px-3 py-2 text-sm border rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring",disabled:j,autoComplete:"off"})]})]})})]}),e.jsxs(Q,{children:[e.jsx(V,{disabled:j,children:"Cancel"}),e.jsx(J,{onClick:I,disabled:j||!w,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50",children:j?"Deleting...":"Delete"})]})]})})]})}export{Ce as default};
