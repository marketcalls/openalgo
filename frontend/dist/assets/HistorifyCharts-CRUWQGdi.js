import{r as a,j as e}from"./vendor-react-RhKMXzW9.js";import{u as se,d as Ie,t as j,c as A,B as f,e as k,D as Fe,h as Re,i as $e,p as Oe,j as H,k as Ue,m as Pe}from"./index-C8LlWM1c.js";import{C as N,a as w}from"./card-Bhbdd39G.js";import{P as Ve,a as Ae,b as He,C as Be,c as _e,d as We,e as qe,f as Ge,g as Ze}from"./popover-D46Mgnar.js";import{I as te}from"./input-Dw94pmqa.js";import{S as Ke,a as Ye,b as Je,c as Qe,d as Xe}from"./select-jk74NOid.js";import{q as es,K as ss,W as ts,R as as,V as rs}from"./lightweight-charts.production-BQUuleWj.js";import{A as ns,D as ae,S as os,ai as ls,R as cs,Z as re,g as ne,L as is,k as ds,l as ms,aF as hs,aG as us,N as xs,m as gs,n as fs}from"./vendor-icons-Ca5eNZvr.js";import{a as ps,c as js,d as vs,L as B}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-CXZqcLdW.js";import"./vendor-radix-gKv__6YA.js";function Es(){const z=ps(),{mode:E,toggleMode:oe,appMode:h,toggleAppMode:le,isTogglingMode:_}=se(),{user:T,logout:W}=Ie(),d=E==="dark"||h==="analyzer",{symbol:ce}=js(),[q,G]=vs(),ie=async()=>{try{await Pe.logout(),W(),z("/login"),j.success("Logged out successfully")}catch{W(),z("/login")}},Z=async()=>{const s=await le();if(s.success){const t=se.getState().appMode;j.success(`Switched to ${t==="live"?"Live":"Analyze"} mode`)}else j.error(s.message||"Failed to toggle mode")},[v,de]=a.useState([]),[u,me]=a.useState(null),[K,Y]=a.useState(!1),[I,F]=a.useState(!1),[o,he]=a.useState(ce||""),[l,ue]=a.useState(q.get("exchange")||"NSE"),[c,xe]=a.useState(q.get("interval")||"D"),[ge,J]=a.useState(!1),[y,Q]=a.useState(""),[R,fe]=a.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[$,pe]=a.useState(()=>new Date().toISOString().split("T")[0]),[r,je]=a.useState([]),[C,ve]=a.useState(null),x=a.useRef(null),m=a.useRef(null),be=a.useRef(null),Se=a.useRef(null),Ne=a.useMemo(()=>u?[...u.seconds,...u.minutes,...u.hours,...u.days,...u.weeks,...u.months]:["D"],[u]),O=a.useMemo(()=>{const s=new Map;return v.forEach(t=>{const i=`${t.symbol}:${t.exchange}`;s.has(i)?s.get(i).intervals.push(t.interval):s.set(i,{symbol:t.symbol,exchange:t.exchange,intervals:[t.interval]})}),Array.from(s.values())},[v]),we=a.useMemo(()=>{if(!y)return O;const s=y.toLowerCase();return O.filter(t=>t.symbol.toLowerCase().includes(s)||t.exchange.toLowerCase().includes(s))},[O,y]);a.useEffect(()=>{ye(),Ce()},[]),a.useEffect(()=>{o&&l&&c&&G({exchange:l,interval:c})},[o,l,c,G]),a.useEffect(()=>{o&&l&&c&&(X(),De())},[o,l,c]),a.useEffect(()=>{if(!x.current)return;const s=setTimeout(()=>{if(!x.current)return;m.current&&(m.current.remove(),m.current=null);const p=x.current,D=p.offsetWidth||800,L=p.offsetHeight||600,ke=b=>{const S=new Date(b*1e3),n=5.5*60*60*1e3,g=new Date(S.getTime()+n),P=g.getUTCDate().toString().padStart(2,"0"),V=(g.getUTCMonth()+1).toString().padStart(2,"0"),ze=g.getUTCFullYear().toString().slice(-2),Ee=g.getUTCHours().toString().padStart(2,"0"),Te=g.getUTCMinutes().toString().padStart(2,"0");return`${P}/${V}/${ze} ${Ee}:${Te}`},M=es(p,{width:D,height:Math.max(L,500),layout:{background:{type:ts.Solid,color:"transparent"},textColor:d?"#a6adbb":"#333"},grid:{vertLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:ke},rightPriceScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:!0,secondsVisible:!1,tickMarkFormatter:b=>{const S=new Date(b*1e3),n=5.5*60*60*1e3,g=new Date(S.getTime()+n),P=g.getUTCHours().toString().padStart(2,"0"),V=g.getUTCMinutes().toString().padStart(2,"0");return`${P}:${V}`}},crosshair:{mode:ss.Normal,vertLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:d?"#1f2937":"#374151"},horzLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:d?"#1f2937":"#374151"}}}),ee=M.addSeries(as,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),U=M.addSeries(rs,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(U.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),m.current=M,be.current=ee,Se.current=U,r.length>0){const b=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));ee.setData(b);const S=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));U.setData(S),M.timeScale().fitContent()}},100),t=()=>{if(m.current&&x.current){const p=x.current,D=p.offsetWidth,L=p.offsetHeight;D>0&&L>0&&m.current.applyOptions({width:D,height:L})}},i=new ResizeObserver(t);return x.current&&i.observe(x.current),window.addEventListener("resize",t),()=>{clearTimeout(s),i.disconnect(),window.removeEventListener("resize",t),m.current&&(m.current.remove(),m.current=null)}},[d,r,I]);const ye=async()=>{try{const t=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();t.status==="success"&&de(t.data||[])}catch(s){console.error("Error loading catalog:",s)}},Ce=async()=>{try{const t=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();t.status==="success"&&me(t.data)}catch(s){console.error("Error loading intervals:",s)}},X=a.useCallback(async()=>{if(!(!o||!l)){Y(!0);try{const s=new URLSearchParams({symbol:o,exchange:l,interval:c,start_date:R,end_date:$}),i=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();i.status==="success"?(je(i.data||[]),i.count===0&&j.info("No data available for this range")):j.error(i.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),j.error("Failed to load chart data")}finally{Y(!1)}}},[o,l,c,R,$]),De=a.useCallback(()=>{const s=v.find(t=>t.symbol===o&&t.exchange===l&&t.interval===c);ve(s||null)},[v,o,l,c]),Le=(s,t)=>{he(s),ue(t),J(!1),Q("")},Me=()=>{document.fullscreenElement?(document.exitFullscreen(),F(!1)):(document.documentElement.requestFullscreen(),F(!0))};return a.useEffect(()=>{const s=()=>{F(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:A("h-full flex flex-col bg-background text-foreground",I&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(B,{to:"/historify",children:e.jsx(ns,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(Ve,{open:ge,onOpenChange:J,children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[o?e.jsxs("span",{children:[o,":",l]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(os,{className:"h-4 w-4 ml-2"})]})}),e.jsx(He,{className:"w-64 p-0",align:"start",children:e.jsxs(Be,{children:[e.jsx(_e,{placeholder:"Search symbols...",value:y,onValueChange:Q}),e.jsxs(We,{children:[e.jsx(qe,{children:"No symbols found"}),e.jsx(Ge,{children:we.slice(0,20).map(s=>e.jsxs(Ze,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>Le(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(k,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(Ke,{value:c,onValueChange:xe,children:[e.jsx(Ye,{className:"w-24",children:e.jsx(Je,{})}),e.jsx(Qe,{children:Ne.map(s=>e.jsx(Xe,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(te,{type:"date",value:R,onChange:s=>fe(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(te,{type:"date",value:$,onChange:s=>pe(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:X,disabled:K,children:e.jsx(cs,{className:A("h-4 w-4",K&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[T?.broker&&e.jsx(k,{variant:"outline",className:"text-xs",children:T.broker.toUpperCase()}),e.jsxs(k,{variant:h==="live"?"default":"secondary",className:A("text-xs cursor-pointer",h==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:Z,children:[h==="live"?e.jsx(re,{className:"h-3 w-3 mr-1"}):e.jsx(ne,{className:"h-3 w-3 mr-1"}),h==="live"?"Live":"Analyze"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Z,disabled:_,title:`Switch to ${h==="live"?"Analyze":"Live"} mode`,children:_?e.jsx(is,{className:"h-4 w-4 animate-spin"}):h==="live"?e.jsx(re,{className:"h-4 w-4"}):e.jsx(ne,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:oe,disabled:h!=="live",title:E==="light"?"Switch to dark mode":"Switch to light mode",children:E==="light"?e.jsx(ds,{className:"h-4 w-4"}):e.jsx(ms,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:Me,children:I?e.jsx(hs,{className:"h-4 w-4"}):e.jsx(us,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(B,{to:"/dashboard",children:[e.jsx(xs,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Fe,{children:[e.jsx(Re,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:T?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs($e,{align:"end",className:"w-56",children:[Oe.map(s=>e.jsxs(H,{onSelect:()=>z(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(H,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(gs,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Ue,{}),e.jsxs(H,{onClick:ie,className:"text-destructive focus:text-destructive",children:[e.jsx(fs,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:o?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[o,":",l]}),e.jsx(k,{variant:"outline",children:c}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),C&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",C.first_date," - ",C.last_date]}),e.jsxs("span",{children:[C.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:x,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(N,{children:e.jsxs(w,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(N,{children:e.jsxs(w,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(N,{children:e.jsxs(w,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(N,{children:e.jsxs(w,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(N,{children:e.jsxs(w,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(ae,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),v.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(B,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Es as default};
