import{r as a}from"./vendor-react--vsXx8_n.js";import{y as E,M as F}from"./index-JRPYi7nR.js";function $({symbols:n,mode:d="LTP",enabled:c=!0,autoReconnect:m=!0,pauseWhenHidden:g=!0,pauseDelay:h=5e3}){const t=E(),e=a.useRef(t?.manager??F.getInstance()),[s,o]=a.useState(new Map),[i,k]=a.useState({isConnected:t?.isConnected??!1,isAuthenticated:t?.isAuthenticated??!1,isPaused:t?.isPaused??!1,isFallbackMode:t?.isFallbackMode??!1,error:t?.error??null}),[p,S]=a.useState(!1),D=a.useMemo(()=>n.map(u=>`${u.exchange}:${u.symbol}`).sort().join(","),[n]);a.useEffect(()=>{e.current.setAutoReconnect(m)},[m]),a.useEffect(()=>e.current.addStateListener(r=>{k({isConnected:r.isConnected,isAuthenticated:r.isAuthenticated,isPaused:r.isPaused,isFallbackMode:r.isFallbackMode,error:r.error}),S(r.connectionState==="connecting"||r.connectionState==="authenticating")}),[]),a.useEffect(()=>{if(!g||!c)return;const u=e.current;let l=null;const r=()=>{document.hidden?l=setTimeout(()=>{u.pauseConnection()},h):(l&&(clearTimeout(l),l=null),u.resumeConnection())};return document.addEventListener("visibilitychange",r),()=>{document.removeEventListener("visibilitychange",r),l&&clearTimeout(l)}},[g,h,c]),a.useEffect(()=>{if(!c||n.length===0){o(new Map);return}const u=e.current;!i.isConnected&&!i.isPaused&&u.connect();const l=[];for(const{symbol:r,exchange:C}of n){const T=u.subscribe(r,C,d,f=>{o(M=>{const y=`${f.exchange}:${f.symbol}`,w=new Map(M);return w.set(y,f),w})});l.push(T);const b=u.getCachedData(r,C);if(b){const f=`${C}:${r}`;o(M=>{const y=new Map(M);return y.set(f,b),y})}}return()=>{l.forEach(r=>r())}},[c,D,d]);const _=a.useCallback(async()=>{await e.current.connect()},[]),x=a.useCallback(()=>{e.current.disconnect()},[]);return{data:s,isConnected:i.isConnected,isAuthenticated:i.isAuthenticated,isConnecting:p,isPaused:i.isPaused,isFallbackMode:i.isFallbackMode,error:i.error,connect:_,disconnect:x}}async function L(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function R(){const[n,d]=a.useState({timings:[],holidays:[],isLoading:!0,error:null});a.useEffect(()=>{(async()=>{try{const s={"X-CSRFToken":await L(),"Content-Type":"application/json"},[o,i]=await Promise.all([fetch("/admin/api/timings",{headers:s,credentials:"include"}),fetch("/admin/api/holidays",{headers:s,credentials:"include"})]),k=await o.json(),p=await i.json();d({timings:k.status==="success"?k.market_status||[]:[],holidays:p.status==="success"?p.data||[]:[],isLoading:!1,error:null})}catch(e){d(s=>({...s,isLoading:!1,error:`Failed to fetch market status: ${e}`}))}})()},[]);const c=a.useCallback(t=>{const e=new Date().toISOString().split("T")[0],s=n.holidays.find(o=>o.date===e);if(!s)return!1;if(s.closed_exchanges.includes(t)){const o=s.open_exchanges.find(i=>i.exchange===t);if(o){const i=Date.now();return!(i>=o.start_time&&i<=o.end_time)}return!0}return!1},[n.holidays]),m=a.useCallback(t=>{if(c(t))return!1;const e=n.timings.find(o=>o.exchange===t);if(!e)return!1;const s=Date.now();return s>=e.start_time&&s<=e.end_time},[n.timings,c]),g=a.useCallback(()=>n.timings.some(t=>{const e=Date.now();return e>=t.start_time&&e<=t.end_time&&!c(t.exchange)}),[n.timings,c]),h=a.useCallback(t=>{if(c(t))return"closed";const e=n.timings.find(i=>i.exchange===t);if(!e)return"closed";const s=Date.now(),o=900*1e3;return s<e.start_time-o?"closed":s<e.start_time?"pre-market":s<=e.end_time?"open":"post-market"},[n.timings,c]);return{isMarketOpen:m,isAnyMarketOpen:g,isHolidayForExchange:c,getMarketStatus:h,timings:n.timings,holidays:n.holidays,isLoading:n.isLoading,error:n.error}}export{$ as a,R as u};
