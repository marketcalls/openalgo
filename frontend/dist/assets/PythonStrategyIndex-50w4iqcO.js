import{j as e,r as d}from"./vendor-react-CCyQGCED.js";import{c as J,B as n,e as F,D as K,j as W,k as Z,m as E,n as X,s as a}from"./index-a7rEZX68.js";import{p as h}from"./python-strategy-DzR1-i0p.js";import{A as ee,a as se}from"./alert-1_Gdt_L2.js";import{C as u,d as m,a as te,b as ae,c as re}from"./card-uB3o9XXI.js";import{D as ne,b as le,c as ie,d as oe,e as ce,f as de}from"./dialog-Btr2P_61.js";import{S as v}from"./skeleton-3VUudCB4.js";import{ad as he,ae as xe,af as ue,ag as me,ah as ge,ai as pe}from"./vendor-radix-CYVJEJRR.js";import{S as L,a as A,b as je}from"./python-strategy-CJF1bPLS.js";import{t as fe,Y as ye,aI as z,a_ as C,aQ as P,as as $,V as Ne,a$ as Se,u as ve,an as be,T as we,aP as Ce,a6 as ke,F as De}from"./vendor-icons-CCn_k3dF.js";import{a as _e,L as k}from"./vendor-router-Dzc1xxhr.js";import"./vendor-charts-l0_txfiz.js";function Te({delayDuration:l=0,...i}){return e.jsx(pe,{"data-slot":"tooltip-provider",delayDuration:l,...i})}function g({...l}){return e.jsx(Te,{children:e.jsx(he,{"data-slot":"tooltip",...l})})}function p({...l}){return e.jsx(xe,{"data-slot":"tooltip-trigger",...l})}function j({className:l,sideOffset:i=0,children:N,...f}){return e.jsx(ue,{children:e.jsxs(me,{"data-slot":"tooltip-content",sideOffset:i,className:J("bg-foreground text-background animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",l),...f,children:[N,e.jsx(ge,{className:"bg-foreground fill-foreground z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}function Be(){const l=_e(),[i,N]=d.useState([]),[f,R]=d.useState(null),[M,D]=d.useState(!0),[b,o]=d.useState(null),[I,S]=d.useState(!1),[y,_]=d.useState(null),[O,U]=d.useState(new Date),x=async(s=!1)=>{try{s||D(!0);const[t,c]=await Promise.all([h.getStrategies(),h.getMasterContractStatus()]);N(t),R(c)}catch(t){console.error("Failed to fetch data:",t),s||a.error("Failed to load strategies","pythonStrategy")}finally{s||D(!1)}};d.useEffect(()=>{x();const s=setInterval(()=>U(new Date),1e3),t=new EventSource("/python/api/events");return t.onmessage=c=>{try{const r=JSON.parse(c.data);if(r.type==="connected"){console.log("SSE connected for strategy status updates");return}r.strategy_id&&r.status&&(console.log(`Strategy ${r.strategy_id} status: ${r.status}`),x(!0))}catch{}},t.onerror=()=>{console.log("SSE connection error, will auto-reconnect")},()=>{clearInterval(s),t.close()}},[]);const B=async s=>{try{o(s.id);const t=await h.startStrategy(s.id);t.status==="success"?(a.success(t.message||`Strategy ${s.name} started`,"pythonStrategy"),x()):a.error(t.message||"Failed to start strategy","pythonStrategy")}catch(t){console.error("Failed to start strategy:",t);const r=t.response?.data?.message||"Failed to start strategy";a.error(r,"pythonStrategy")}finally{o(null)}},H=async s=>{try{o(s.id);const t=await h.stopStrategy(s.id);t.status==="success"?(a.success(t.message||`Strategy ${s.name} stopped`,"pythonStrategy"),x()):a.error(t.message||"Failed to stop strategy","pythonStrategy")}catch(t){console.error("Failed to stop strategy:",t),a.error("Failed to stop strategy","pythonStrategy")}finally{o(null)}},V=async s=>{try{o(s.id);const t=await h.clearError(s.id);t.status==="success"?(a.success("Error cleared","pythonStrategy"),x()):a.error(t.message||"Failed to clear error","pythonStrategy")}catch(t){console.error("Failed to clear error:",t),a.error("Failed to clear error","pythonStrategy")}finally{o(null)}},Q=async()=>{if(y)try{o(y.id);const s=await h.deleteStrategy(y.id);s.status==="success"?(a.success("Strategy deleted","pythonStrategy"),N(i.filter(t=>t.id!==y.id))):a.error(s.message||"Failed to delete strategy","pythonStrategy")}catch(s){console.error("Failed to delete strategy:",s),a.error("Failed to delete strategy","pythonStrategy")}finally{o(null),S(!1),_(null)}},Y=async s=>{try{const t=await h.exportStrategy(s.id),c=URL.createObjectURL(t),r=document.createElement("a");r.href=c,r.download=s.file_name,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c),a.success("Strategy exported","pythonStrategy")}catch(t){console.error("Failed to export strategy:",t),a.error("Failed to export strategy","pythonStrategy")}},q=async()=>{try{o("master");const s=await h.checkAndStartPending();if(s.status==="success"){const t=s.data?.started||0;a.success(`Started ${t} pending strategies`,"pythonStrategy"),x()}else a.error(s.message||"Failed to check contracts","pythonStrategy")}catch(s){console.error("Failed to check contracts:",s),a.error("Failed to check contracts","pythonStrategy")}finally{o(null)}},G=s=>!s||s.length===0?"":s.length===7?"Every day":s.length===5&&!s.includes("sat")&&!s.includes("sun")?"Weekdays":s.map(t=>je.find(c=>c.value===t)?.label.slice(0,3)||t).join(", "),T=s=>s?new Date(s).toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}):"-",w={total:i.length,running:i.filter(s=>s.status==="running").length,scheduled:i.filter(s=>s.is_scheduled).length};return M?e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(v,{className:"h-8 w-48"}),e.jsx(v,{className:"h-10 w-32"})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-4",children:[1,2,3,4].map(s=>e.jsx(v,{className:"h-24"},s))}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[1,2,3].map(s=>e.jsx(v,{className:"h-64"},s))})]}):e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Python Strategies"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and run your Python trading scripts"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>l("/python/guide"),children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Guide"]}),e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>x(),children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(n,{onClick:()=>l("/python/new"),children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Add Strategy"]})]})]}),e.jsxs("div",{className:"grid gap-4 grid-cols-2 md:grid-cols-4",children:[e.jsx(u,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:w.total})]}),e.jsx(C,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(u,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Running"}),e.jsx("p",{className:"text-2xl font-bold text-green-500",children:w.running})]}),e.jsx(P,{className:"h-8 w-8 text-green-500"})]})})}),e.jsx(u,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Scheduled"}),e.jsx("p",{className:"text-2xl font-bold text-blue-500",children:w.scheduled})]}),e.jsx($,{className:"h-8 w-8 text-blue-500"})]})})}),e.jsx(u,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Master Contract"}),e.jsx(F,{variant:f?.ready?"default":"secondary",children:f?.ready?"Ready":"Not Ready"})]}),!f?.ready&&e.jsx(n,{size:"sm",variant:"outline",onClick:q,disabled:b==="master",children:"Check"})]})})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ne,{className:"h-4 w-4"}),"Current IST: ",O.toLocaleString("en-IN",{timeZone:"Asia/Kolkata"})]}),i.length===0?e.jsx(u,{className:"py-12",children:e.jsxs(m,{className:"flex flex-col items-center justify-center text-center",children:[e.jsx(C,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Python Strategies"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Upload your first Python trading script to get started."}),e.jsxs(n,{onClick:()=>l("/python/new"),children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Add Strategy"]})]})}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3 items-start",children:i.map(s=>e.jsxs(u,{className:"relative overflow-hidden flex flex-col",children:[e.jsx("div",{className:`absolute top-0 left-0 right-0 h-1 ${L[s.status]}`}),e.jsx(te,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ae,{className:"text-lg",children:s.name}),e.jsx(re,{className:"font-mono text-xs",children:s.file_name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{children:[e.jsx(p,{children:e.jsx(F,{variant:s.status==="running"?"default":"secondary",className:L[s.status]||"",children:A[s.status]||s.status})}),e.jsx(j,{children:s.status_message||A[s.status]})]}),e.jsxs(K,{children:[e.jsx(W,{asChild:!0,children:e.jsx(n,{variant:"ghost",size:"icon",children:e.jsx(Se,{className:"h-4 w-4"})})}),e.jsxs(Z,{align:"end",children:[e.jsxs(E,{onClick:()=>Y(s),children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Export"]}),e.jsx(X,{}),e.jsxs(E,{className:"text-red-500",disabled:s.status==="running",onClick:()=>{_(s),S(!0)},children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]})]})}),e.jsxs(m,{className:"space-y-4 flex-1 flex flex-col",children:[e.jsxs("div",{className:"text-sm p-2 rounded min-h-[52px] bg-blue-500/10 border border-blue-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-4 w-4 text-blue-500"}),e.jsxs("span",{children:[s.schedule_start_time||"09:00"," - ",s.schedule_stop_time||"16:00"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:G(s.schedule_days?.length?s.schedule_days:["mon","tue","wed","thu","fri"])})]}),s.status==="error"&&s.error_message&&e.jsxs(ee,{variant:"destructive",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsxs(se,{className:"text-xs",children:[s.error_message,e.jsx(n,{variant:"link",size:"sm",className:"p-0 h-auto ml-2",onClick:()=>V(s),children:"Clear"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs text-muted-foreground mt-auto",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block",children:"Last Started"}),e.jsx("span",{children:T(s.last_started)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block",children:"Last Stopped"}),e.jsx("span",{children:T(s.last_stopped)})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2 mt-auto",children:[s.status==="running"||s.status==="scheduled"?e.jsxs(g,{children:[e.jsx(p,{asChild:!0,children:e.jsxs(n,{variant:s.status==="running"?"destructive":"outline",size:"sm",className:`flex-1 ${s.status==="scheduled"?"border-orange-500 text-orange-600 hover:bg-orange-50 dark:text-orange-400 dark:hover:bg-orange-950":""}`,onClick:()=>H(s),disabled:b===s.id,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),s.status==="running"?"Stop":"Cancel"]})}),e.jsx(j,{children:s.status==="running"?"Stop running strategy":"Cancel scheduled auto-start"})]}):e.jsxs(g,{children:[e.jsx(p,{asChild:!0,children:e.jsxs(n,{variant:"default",size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>B(s),disabled:b===s.id,children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Start"]})}),e.jsx(j,{children:"Start strategy"})]}),e.jsxs(g,{children:[e.jsx(p,{asChild:!0,children:e.jsx(n,{variant:"outline",size:"sm",className:"border-blue-500 text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-950",asChild:!0,disabled:s.status==="running",children:e.jsxs(k,{to:`/python/${s.id}/schedule`,children:[e.jsx(ke,{className:"h-4 w-4 mr-1"}),e.jsx("span",{className:"text-xs",children:"Schedule"})]})})}),e.jsx(j,{children:s.schedule_start_time&&s.schedule_stop_time?`${s.schedule_start_time} - ${s.schedule_stop_time}`:"Edit schedule"})]}),e.jsxs(g,{children:[e.jsx(p,{asChild:!0,children:e.jsx(n,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(k,{to:`/python/${s.id}/logs`,children:e.jsx(De,{className:"h-4 w-4"})})})}),e.jsx(j,{children:"View logs"})]}),e.jsxs(g,{children:[e.jsx(p,{asChild:!0,children:e.jsx(n,{variant:"outline",size:"sm",asChild:!0,children:e.jsx(k,{to:`/python/${s.id}/edit`,children:e.jsx(C,{className:"h-4 w-4"})})})}),e.jsx(j,{children:"Edit code"})]})]})]})]},s.id))}),e.jsx(ne,{open:I,onOpenChange:S,children:e.jsxs(le,{children:[e.jsxs(ie,{children:[e.jsx(oe,{children:"Delete Strategy"}),e.jsxs(ce,{children:['Are you sure you want to delete "',y?.name,'"? This will remove the strategy file and all associated logs.']})]}),e.jsxs(de,{children:[e.jsx(n,{variant:"outline",onClick:()=>S(!1),children:"Cancel"}),e.jsx(n,{variant:"destructive",onClick:Q,children:"Delete Strategy"})]})]})})]})}export{Be as default};
