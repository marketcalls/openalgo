import{r as i,j as e}from"./vendor-react-RhKMXzW9.js";import{d as Z,o as ee,l as te,e as $,B as F,c as f,s as u}from"./index-BOwMk2sa.js";import{t as se}from"./trading-BE6bqkUK.js";import{C as w,b as k,d as C,c as L,a as ae}from"./card-Dqjwrop5.js";import{T as ne,a as re,b as M,c as h,d as le,e as d,f as ce}from"./table-CtewT87E.js";import{u as oe,a as ie}from"./useMarketStatus-B27EKIuh.js";import{Q as de,R as xe,D as me,c as V,Y as B,L as pe}from"./vendor-icons-Chlwwn8V.js";import"./vendor-syntax-D6hV6JR3.js";import"./vendor-router-DdyOoyPF.js";import"./vendor-radix-B_grJx4K.js";function g(m){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(m)}function R(m){return`${m>=0?"+":""}${m.toFixed(2)}%`}function Pe(){const{apiKey:m}=Z(),[j,z]=i.useState([]),[N,Q]=i.useState(null),[W,E]=i.useState(!0),[I,H]=i.useState(!1),[_,S]=i.useState(null),{isMarketOpen:P,isAnyMarketOpen:K}=oe(),O=K(),Y=i.useMemo(()=>j.map(t=>({symbol:t.symbol,exchange:t.exchange})),[j]),{data:T,isConnected:G}=ie({symbols:Y,mode:"LTP",enabled:j.length>0&&O}),D=G&&O,y=i.useMemo(()=>j.map(t=>{const a=`${t.exchange}:${t.symbol}`,c=T.get(a),l=t.quantity||0,v=t.pnl||0,n=P(t.exchange)&&c?.data?.ltp&&c.lastUpdate&&Date.now()-c.lastUpdate<5e3;let r=t.average_price;if(!r&&t.ltp&&l!==0&&(r=t.ltp-v/l),n&&c?.data?.ltp&&l!==0){const b=c.data.ltp;if(!r&&t.ltp&&(r=t.ltp-v/l),r){const U=(b-r)*l,q=Math.abs(r*l),X=q>0?U/q*100:0;return{...t,ltp:b,average_price:r,pnl:U,pnlpercent:X}}}return{...t,average_price:r}}),[j,T,P]),s=i.useMemo(()=>{if(!N||!y.some(o=>{const n=`${o.exchange}:${o.symbol}`,r=T.get(n);return P(o.exchange)&&r?.data?.ltp&&r.lastUpdate&&Date.now()-r.lastUpdate<5e3}))return N;let a=0,c=0,l=0;y.forEach(o=>{a+=o.pnl||0;const n=o.average_price||0,r=o.quantity||0,b=o.ltp||n;c+=n*r,l+=b*r});const v=c>0?a/c*100:0;return{...N,totalholdingvalue:l,totalinvvalue:c,totalprofitandloss:a,totalpnlpercentage:v}},[N,y,T,P]),x=i.useCallback(async(t=!1)=>{if(!m){E(!1);return}t&&H(!0);try{const a=await se.getHoldings(m);a.status==="success"&&a.data?(z(a.data.holdings||[]),Q(a.data.statistics),S(null)):S(a.message||"Failed to fetch holdings")}catch{S("Failed to fetch holdings")}finally{E(!1),H(!1)}},[m]);i.useEffect(()=>{x();const a=setInterval(()=>x(),D?3e4:1e4);return()=>clearInterval(a)},[x,D]),i.useEffect(()=>{const t=ee(()=>{x()});return()=>t()},[x]);const A=i.useRef(null);i.useEffect(()=>{const t=window.location.protocol,a=window.location.hostname,c=window.location.port;A.current=te(`${t}//${a}:${c}`,{transports:["websocket","polling"]});const l=A.current;return l.on("order_event",()=>{setTimeout(()=>x(),500)}),l.on("analyzer_update",()=>{setTimeout(()=>x(),500)}),()=>{l.disconnect()}},[x]);const J=()=>{const t=["Symbol","Exchange","Quantity","Avg Price","LTP","Product","P&L","P&L %"],a=y.map(n=>[u(n.symbol),u(n.exchange),u(n.quantity),u(n.average_price),u(n.ltp),u(n.product),u(n.pnl),u(n.pnlpercent)]),c=[t,...a].map(n=>n.join(",")).join(`
`),l=new Blob([c],{type:"text/csv"}),v=URL.createObjectURL(l),o=document.createElement("a");o.href=v,o.download=`holdings_${new Date().toISOString().split("T")[0]}.csv`,o.click()},p=t=>t>=0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Investor Summary"}),D&&e.jsxs($,{variant:"outline",className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/30 gap-1",children:[e.jsx(de,{className:"h-3 w-3 animate-pulse"}),"Live"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"View your holdings portfolio"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>x(!0),disabled:I,children:[e.jsx(xe,{className:f("h-4 w-4 mr-2",I&&"animate-spin")}),"Refresh"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:J,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Export"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(w,{children:e.jsxs(k,{className:"pb-2",children:[e.jsx(C,{children:"Total Holding Value"}),e.jsx(L,{className:"text-2xl text-primary",children:s?g(s.totalholdingvalue):"---"})]})}),e.jsx(w,{children:e.jsxs(k,{className:"pb-2",children:[e.jsx(C,{children:"Total Investment Value"}),e.jsx(L,{className:"text-2xl",children:s?g(s.totalinvvalue):"---"})]})}),e.jsx(w,{children:e.jsxs(k,{className:"pb-2",children:[e.jsx(C,{children:"Total Profit and Loss"}),e.jsx(L,{className:f("text-2xl",s&&p(s.totalprofitandloss)?"text-green-600":"text-red-600"),children:s?e.jsxs("div",{className:"flex items-center gap-1",children:[p(s.totalprofitandloss)?e.jsx(V,{className:"h-5 w-5"}):e.jsx(B,{className:"h-5 w-5"}),g(s.totalprofitandloss)]}):"---"})]})}),e.jsx(w,{children:e.jsxs(k,{className:"pb-2",children:[e.jsx(C,{children:"Total PnL Percentage"}),e.jsx(L,{className:f("text-2xl",s&&p(s.totalpnlpercentage)?"text-green-600":"text-red-600"),children:s?R(s.totalpnlpercentage):"---"})]})})]}),e.jsx(w,{children:e.jsx(ae,{className:"p-0",children:W?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(pe,{className:"h-8 w-8 animate-spin"})}):_?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:_}):j.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No holdings found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ne,{children:[e.jsx(re,{children:e.jsxs(M,{children:[e.jsx(h,{children:"Trading Symbol"}),e.jsx(h,{children:"Exchange"}),e.jsx(h,{className:"text-right",children:"Quantity"}),e.jsx(h,{className:"text-right",children:"Avg Price"}),e.jsx(h,{className:"text-right",children:"LTP"}),e.jsx(h,{children:"Product"}),e.jsx(h,{className:"text-right",children:"Profit and Loss"}),e.jsx(h,{className:"text-right",children:"PnL %"})]})}),e.jsx(le,{children:y.map((t,a)=>e.jsxs(M,{children:[e.jsx(d,{className:"font-medium",children:t.symbol}),e.jsx(d,{children:e.jsx($,{variant:"outline",children:t.exchange})}),e.jsx(d,{className:"text-right font-mono",children:t.quantity}),e.jsx(d,{className:"text-right font-mono",children:t.average_price!==void 0?g(t.average_price):"-"}),e.jsx(d,{className:"text-right font-mono",children:t.ltp!==void 0?g(t.ltp):"-"}),e.jsx(d,{children:e.jsx($,{variant:"secondary",children:t.product})}),e.jsx(d,{className:f("text-right font-medium",p(t.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[p(t.pnl)?e.jsx(V,{className:"h-4 w-4"}):e.jsx(B,{className:"h-4 w-4"}),g(t.pnl)]})}),e.jsx(d,{className:f("text-right",p(t.pnlpercent)?"text-green-600":"text-red-600"),children:R(t.pnlpercent)})]},`${t.symbol}-${t.exchange}-${a}`))}),e.jsx(ce,{children:e.jsxs(M,{className:"bg-muted/50",children:[e.jsx(d,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsx(d,{className:f("text-right font-bold",s&&p(s.totalprofitandloss)?"text-green-600":"text-red-600"),children:s?`${s.totalprofitandloss>=0?"+":""}${g(s.totalprofitandloss)}`:"-"}),e.jsx(d,{className:f("text-right font-bold",s&&p(s.totalpnlpercentage)?"text-green-600":"text-red-600"),children:s?R(s.totalpnlpercentage):"-"})]})})]})})})})]})}export{Pe as default};
