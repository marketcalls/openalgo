import{r as u,j as e,a as J}from"./vendor-react--vsXx8_n.js";import{w as W,B as k,t as O,e as S}from"./index-nOKaJn6t.js";import{A as me,b as ue,c as fe,d as je,e as Ne,f as ge,g as pe,h as _e}from"./alert-dialog-CHXNdZeC.js";import{C as ie,d as le,a as ye,b as Ee}from"./card-CDH-YEP5.js";import{C as Z,b as K,a as ee}from"./collapsible-BFPZ0scE.js";import{T as G,a as U,b as w,c as n,d as X,e as a}from"./table-C7iOB9S9.js";import{u as be}from"./useLivePrice-Cj2h7yj5.js";import{I as ce}from"./input-C0Lqepf2.js";import{L as se}from"./label-sO8c898q.js";import{S as Ie}from"./switch-CGoMIk_P.js";import{R as te,$ as re,k as ne,ah as ve,c as Te,a0 as Se,aX as z}from"./vendor-icons-BBm8NOs4.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CiBIGs7t.js";import"./vendor-radix-DnptSSCf.js";import"./trading-BY87V3rv.js";async function we(){const s=await W.get("/api/strategy-state");if(s.data.status==="error")throw new Error(s.data.message||"Failed to fetch strategy states");return s.data.data}async function De(s){const r=await W.delete(`/api/strategy-state/${encodeURIComponent(s)}`);if(r.data.status==="error")throw new Error(r.data.message||"Failed to delete strategy state")}async function Pe(s,r,d,o){const h=await W.post(`/api/strategy-state/${encodeURIComponent(s)}/override`,{leg_key:r,override_type:d,new_value:o});if(h.data.status==="error")throw new Error(h.data.message||"Failed to create strategy override");return{message:h.data.message||"Override created successfully"}}const Ce={RUNNING:"bg-green-500",PAUSED:"bg-yellow-500",COMPLETED:"bg-gray-400",ERROR:"bg-red-500"},Y={IDLE:"bg-gray-400",PENDING_ENTRY:"bg-blue-400",IN_POSITION:"bg-green-500",PENDING_EXIT:"bg-orange-400",EXITED_WAITING_REENTRY:"bg-yellow-500",EXITED_WAITING_REEXECUTE:"bg-purple-500",DONE:"bg-gray-500"},Le={SL_HIT:"bg-red-500",TARGET_HIT:"bg-green-500",HEDGE_SL_EXIT:"bg-red-400",HEDGE_TARGET_EXIT:"bg-green-400",STRATEGY_DONE:"bg-gray-500"};function Re(s){if(s==null)return"â€”";const r=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(Math.abs(s));return s<0?`-${r}`:r}function y(s){return s==null?"â€”":s.toFixed(2)}function Oe(s){if(s.wait_trigger_price)return s.wait_trigger_price;const r=s.wait_baseline_price,d=s.wait_trade_percent;return r==null||d==null||!s.side?null:s.side==="BUY"?r*(1+d):s.side==="SELL"?r*(1-d):null}function Ae(s){return s?new Date(s).toLocaleString("en-IN",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}):"â€”"}function H(s){return s?new Date(s).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"}):"â€”"}function D({value:s,showIcon:r=!0}){if(s==null)return e.jsx("span",{className:"text-muted-foreground",children:"-"});const d=s>=0,o=d?"text-green-600":"text-red-600";return e.jsxs("span",{className:`font-medium ${o} flex items-center gap-1`,children:[r&&(d?e.jsx(Te,{className:"h-3 w-3"}):e.jsx(Se,{className:"h-3 w-3"})),Re(s)]})}function $(s,r){const d=s.entry_price,o=s.quantity,h=s.side;return r==null||d==null||o===null||o===void 0||!h?null:h==="BUY"?(r-d)*o:h==="SELL"?(d-r)*o:null}function Fe(s){return!s||s.length===0?0:s.reduce((r,d)=>r+(d.pnl||0),0)}function ae({value:s,instanceId:r,legKey:d,overrideType:o,leg:h,onSuccess:E}){const[N,g]=u.useState(!1),[l,t]=u.useState(""),[b,L]=u.useState(!1),_=J.useRef(null),j=h.status==="IN_POSITION",f=()=>{j&&(t(s?.toString()??""),g(!0))};J.useEffect(()=>{N&&_.current&&(_.current.focus(),_.current.select())},[N]);const m=x=>{if(Number.isNaN(x)||x<0)return"Value must be a non-negative number";const p=h.entry_price;if(!p)return null;const v=h.side;if(o==="sl_price"){if(v==="SELL"&&x<=p)return`SL for SELL must be above entry price (${p.toFixed(2)})`;if(v==="BUY"&&x>=p)return`SL for BUY must be below entry price (${p.toFixed(2)})`}if(o==="target_price"){if(v==="SELL"&&x>=p)return`Target for SELL must be below entry price (${p.toFixed(2)})`;if(v==="BUY"&&x<=p)return`Target for BUY must be above entry price (${p.toFixed(2)})`}return null},I=async()=>{const x=Number.parseFloat(l),p=m(x);if(p){O.error(p);return}if(s!=null&&Math.abs(x-s)<.01){g(!1);return}L(!0);try{const v=await Pe(r,d,o,x);O.success(v.message),g(!1),E()}catch(v){O.error(v instanceof Error?v.message:"Failed to update")}finally{L(!1)}},P=x=>{x.key==="Enter"?(x.preventDefault(),I()):x.key==="Escape"&&g(!1)},R=()=>{g(!1)};return N?e.jsx(ce,{ref:_,type:"number",step:"0.05",value:l,onChange:x=>t(x.target.value),onKeyDown:P,onBlur:R,disabled:b,className:"h-7 w-20 text-right text-sm px-1"}):e.jsx("span",{onClick:f,onKeyDown:x=>x.key==="Enter"&&f(),tabIndex:j?0:void 0,role:j?"button":void 0,className:j?"cursor-pointer hover:bg-muted px-1 py-0.5 rounded transition-colors":"",title:j?"Click to edit":void 0,children:y(s)})}function Ge({legs:s,instanceId:r,onRefresh:d,liveLtpByLegKey:o}){if(!s)return e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"});const h=Object.entries(s),E=h.filter(([l,t])=>["IN_POSITION","PENDING_EXIT"].includes(t.status)),N=h.filter(([l,t])=>["IDLE","PENDING_ENTRY","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(t.status)),g=h.filter(([l,t])=>t.status==="DONE");return h.length===0?e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No positions found"}):e.jsxs("div",{className:"space-y-4",children:[E.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-green-500"}),"Open Positions (",E.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs(w,{children:[e.jsx(n,{children:"Leg"}),e.jsx(n,{children:"Symbol"}),e.jsx(n,{children:"Side"}),e.jsx(n,{className:"text-right",children:"Qty"}),e.jsx(n,{className:"text-right",children:"Entry"}),e.jsx(n,{className:"text-right",children:"LTP"}),e.jsx(n,{className:"text-right",children:"SL"}),e.jsx(n,{className:"text-right",children:"Target"}),e.jsx(n,{children:"Status"}),e.jsx(n,{className:"text-right",children:"Unreal P&L"}),e.jsx(n,{className:"text-right",children:"Reentry"})]})}),e.jsx(X,{children:E.map(([l,t])=>e.jsxs(w,{children:[e.jsx(a,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.leg_pair_name||l}),t.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(a,{className:"font-mono text-xs",children:t.symbol}),e.jsx(a,{children:t.side?e.jsx(S,{variant:t.side==="SELL"?"destructive":"default",children:t.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(a,{className:"text-right",children:t.quantity}),e.jsx(a,{className:"text-right",children:y(t.entry_price)}),e.jsx(a,{className:"text-right",children:o?.[l]===null||o?.[l]===void 0?"-":y(o?.[l])}),e.jsx(a,{className:"text-right",children:e.jsx(ae,{value:t.sl_price,instanceId:r,legKey:l,overrideType:"sl_price",leg:t,onSuccess:d})}),e.jsx(a,{className:"text-right",children:e.jsx(ae,{value:t.target_price,instanceId:r,legKey:l,overrideType:"target_price",leg:t,onSuccess:d})}),e.jsx(a,{children:e.jsx(S,{className:Y[t.status],variant:"secondary",children:t.status.replace(/_/g," ")})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:$(t,o?.[l])})}),e.jsxs(a,{className:"text-right",children:[t.reentry_count??0,"/",t.reentry_limit??"âˆž"]})]},l))})]})})]}),N.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-yellow-500"}),"Pending / Planned Trades (",N.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs(w,{children:[e.jsx(n,{children:"Leg"}),e.jsx(n,{children:"Symbol"}),e.jsx(n,{children:"Side"}),e.jsx(n,{className:"text-right",children:"Qty"}),e.jsx(n,{className:"text-right",children:"LTP"}),e.jsx(n,{className:"text-right",children:"Planned Entry"}),e.jsx(n,{className:"text-right",children:"Planned SL"}),e.jsx(n,{className:"text-right",children:"Planned Target"}),e.jsx(n,{children:"Status"}),e.jsx(n,{className:"text-right",children:"Reentry"}),e.jsx(n,{className:"text-right",children:"Reexec"})]})}),e.jsx(X,{children:N.map(([l,t])=>e.jsxs(w,{children:[e.jsx(a,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.leg_pair_name||l}),t.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(a,{className:"font-mono text-xs",children:t.symbol}),e.jsx(a,{children:t.side?e.jsx(S,{variant:t.side==="SELL"?"destructive":"default",children:t.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(a,{className:"text-right",children:t.quantity}),e.jsx(a,{className:"text-right",children:o?.[l]===null||o?.[l]===void 0?"-":y(o?.[l])}),e.jsx(a,{className:"text-right",children:y(Oe(t))}),e.jsx(a,{className:"text-right",children:y(t.sl_price)}),e.jsx(a,{className:"text-right",children:y(t.target_price)}),e.jsx(a,{children:e.jsx(S,{className:Y[t.status]||"bg-gray-400",variant:"secondary",children:t.status.replace(/_/g," ")})}),e.jsxs(a,{className:"text-right",children:[t.reentry_count??0,"/",t.reentry_limit??"âˆž"]}),e.jsxs(a,{className:"text-right",children:[t.reexecute_count??0,"/",t.reexecute_limit??"âˆž"]})]},l))})]})})]}),g.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold mb-2 flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-gray-500"}),"Done Legs (",g.length,")"]}),e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs(w,{children:[e.jsx(n,{children:"Leg"}),e.jsx(n,{children:"Symbol"}),e.jsx(n,{children:"Side"}),e.jsx(n,{className:"text-right",children:"Qty"}),e.jsx(n,{className:"text-right",children:"Entry"}),e.jsx(n,{className:"text-right",children:"Realized P&L"}),e.jsx(n,{className:"text-right",children:"Total P&L"}),e.jsx(n,{children:"Status"})]})}),e.jsx(X,{children:g.map(([l,t])=>e.jsxs(w,{children:[e.jsx(a,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.leg_pair_name||l}),t.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(a,{className:"font-mono text-xs",children:t.symbol}),e.jsx(a,{children:t.side?e.jsx(S,{variant:t.side==="SELL"?"destructive":"default",children:t.side}):e.jsx("span",{className:"text-muted-foreground",children:"â€”"})}),e.jsx(a,{className:"text-right",children:t.quantity}),e.jsx(a,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:y(t.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:H(t.entry_time)})]})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:t.realized_pnl})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:t.total_pnl??t.realized_pnl})}),e.jsx(a,{children:e.jsx(S,{className:Y[t.status]||"bg-gray-400",variant:"secondary",children:t.status.replace(/_/g," ")})})]},l))})]})})]})]})}function Ue({trades:s}){return!s||s.length===0?e.jsx("p",{className:"text-muted-foreground text-sm py-4",children:"No trade history"}):e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsx("div",{className:"max-h-[50vh] overflow-y-auto",children:e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs(w,{children:[e.jsx(n,{children:"#"}),e.jsx(n,{children:"Leg"}),e.jsx(n,{children:"Symbol"}),e.jsx(n,{children:"Side"}),e.jsx(n,{className:"text-right",children:"Qty"}),e.jsx(n,{className:"text-right",children:"Entry"}),e.jsx(n,{className:"text-right",children:"Exit"}),e.jsx(n,{className:"text-right",children:"SL"}),e.jsx(n,{className:"text-right",children:"Target"}),e.jsx(n,{children:"Exit Type"}),e.jsx(n,{className:"text-right",children:"P&L"})]})}),e.jsx(X,{children:s.map(r=>e.jsxs(w,{children:[e.jsx(a,{children:r.trade_id}),e.jsx(a,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:r.leg_pair_name||r.leg_key}),r.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(a,{className:"font-mono text-xs",children:r.symbol}),e.jsx(a,{children:e.jsx(S,{variant:r.side==="SELL"?"destructive":"default",children:r.side})}),e.jsx(a,{className:"text-right",children:r.quantity}),e.jsx(a,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:y(r.entry_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:H(r.entry_time)})]})}),e.jsx(a,{className:"text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:y(r.exit_price)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:H(r.exit_time)})]})}),e.jsx(a,{className:"text-right",children:y(r.sl_price)}),e.jsx(a,{className:"text-right",children:y(r.target_price)}),e.jsx(a,{children:r.exit_type&&e.jsx(S,{className:Le[r.exit_type],variant:"secondary",children:r.exit_type.replace(/_/g," ")})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:r.pnl})})]},r.trade_id))})]})})})}function Xe({strategy:s,onDelete:r,onRefresh:d,liveLtpByLegKey:o}){const[h,E]=u.useState(!0),[N,g]=u.useState(!1),l=s.config,t=f=>{f.stopPropagation(),r(s.instance_id,s.strategy_name)},b=s.legs||{},L=u.useMemo(()=>Fe(s.trade_history),[s.trade_history]),_=u.useMemo(()=>{let f=0;for(const[m,I]of Object.entries(b)){if(!["IN_POSITION","PENDING_EXIT"].includes(I.status))continue;const P=$(I,o?.[m]);P!==null&&(f+=P)}return f},[b,o]),j=L+_;return e.jsx(Z,{open:h,onOpenChange:E,children:e.jsxs(ie,{className:"mb-4",children:[e.jsx(K,{asChild:!0,children:e.jsx(ye,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[h?e.jsx(re,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(ne,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(Ee,{className:"text-lg",children:s.strategy_name}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[l&&e.jsxs(e.Fragment,{children:[l.underlying," | Expiry: ",l.expiry_date," | Lots: ",l.lots," Ã— ",l.lot_size]}),!l&&`Instance: ${s.instance_id}`]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total P&L"}),e.jsx(D,{value:j})]}),e.jsx(S,{className:Ce[s.status]||"bg-gray-400",children:s.status}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:t,title:"Delete strategy state",children:e.jsx(ve,{className:"h-4 w-4"})})]})]})})}),e.jsx(ee,{children:e.jsxs(le,{className:"pt-0 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 p-4 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Open Positions"}),e.jsx("p",{className:"text-lg font-semibold",children:Object.values(s.legs||{}).filter(f=>["IN_POSITION","PENDING_EXIT"].includes(f.status)).length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pending / Planned"}),e.jsx("p",{className:"text-lg font-semibold",children:Object.values(s.legs||{}).filter(f=>["IDLE","PENDING_ENTRY","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(f.status)).length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Trades"}),e.jsx("p",{className:"text-lg font-semibold",children:s.trade_history?.length??0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Realized P&L"}),e.jsx(D,{value:L,showIcon:!1})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Unrealized P&L"}),e.jsx(D,{value:_,showIcon:!1})]})]}),e.jsxs(Z,{open:N,onOpenChange:g,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-md font-semibold",children:"Leg P&L"}),e.jsx(K,{asChild:!0,children:e.jsxs(k,{variant:"ghost",size:"sm",className:"h-8 px-2",children:[N?e.jsx(re,{className:"h-4 w-4 mr-2"}):e.jsx(ne,{className:"h-4 w-4 mr-2"}),N?"Hide":"Show"]})})]}),e.jsx(ee,{children:e.jsx("div",{className:"rounded-md border overflow-x-auto mt-2",children:e.jsxs(G,{children:[e.jsx(U,{children:e.jsxs(w,{children:[e.jsx(n,{children:"Leg"}),e.jsx(n,{children:"Symbol"}),e.jsx(n,{children:"Status"}),e.jsx(n,{className:"text-right",children:"Realized P&L"}),e.jsx(n,{className:"text-right",children:"Unrealized P&L"}),e.jsx(n,{className:"text-right",children:"Total P&L"})]})}),e.jsx(X,{children:Object.entries(b).map(([f,m])=>{const I=["IN_POSITION","PENDING_EXIT"].includes(m.status)?$(m,o?.[f]):0,P=m.realized_pnl??0,R=(m.total_pnl??null)!==null&&m.total_pnl!==void 0?m.total_pnl:I===null?null:P+I;return e.jsxs(w,{children:[e.jsx(a,{className:"font-medium",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:m.leg_pair_name||f}),m.is_main_leg&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Main"})]})}),e.jsx(a,{className:"font-mono text-xs",children:m.symbol}),e.jsx(a,{children:e.jsx(S,{className:Y[m.status]||"bg-gray-400",variant:"secondary",children:m.status.replace(/_/g," ")})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:m.realized_pnl,showIcon:!1})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:I,showIcon:!1})}),e.jsx(a,{className:"text-right",children:e.jsx(D,{value:R,showIcon:!1})})]},f)})})]})})})]}),s.last_updated&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last updated: ",Ae(s.last_updated),s.orchestrator&&` | Cycles: ${s.orchestrator.cycle_count}`]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“Š Current Positions"}),e.jsx(Ge,{legs:s.legs,instanceId:s.instance_id,onRefresh:d,liveLtpByLegKey:o})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-md font-semibold mb-3",children:"ðŸ“œ Trade History"}),e.jsx(Ue,{trades:s.trade_history})]})]})})]})})}function ss(){const[s,r]=u.useState([]),[d,o]=u.useState(!0),[h,E]=u.useState(!1),N="strategy_positions_auto_refresh_enabled",g="strategy_positions_auto_refresh_seconds",[l,t]=u.useState(!0),[b,L]=u.useState(10),_=u.useRef(!1),[j,f]=u.useState({open:!1,instanceId:"",strategyName:""}),[m,I]=u.useState(!1),[P,R]=u.useState(""),x=async(i=!1)=>{try{const c=await we();r(c),i&&O.success("Data refreshed")}catch(c){console.error("Error fetching strategy states:",c),O.error("Failed to fetch strategy positions")}finally{o(!1),E(!1),_.current=!1}},p=(i,c)=>{R(""),f({open:!0,instanceId:i,strategyName:c})},v=async()=>{if(j.instanceId){I(!0);try{await De(j.instanceId),O.success(`Strategy "${j.strategyName}" deleted successfully`),r(i=>i.filter(c=>c.instance_id!==j.instanceId))}catch(i){console.error("Error deleting strategy:",i),O.error("Failed to delete strategy")}finally{I(!1),f({open:!1,instanceId:"",strategyName:""}),R("")}}},oe=P===j.strategyName;u.useEffect(()=>{try{const i=window.localStorage.getItem(N);i!==null&&t(i==="1"||i==="true");const c=window.localStorage.getItem(g);if(c){const T=Number.parseInt(c,10);if(!Number.isNaN(T)){const A=Math.min(300,Math.max(5,T));L(A)}}}catch(i){console.error("Error loading strategy positions auto-refresh preferences:",i)}x()},[]),u.useEffect(()=>{try{window.localStorage.setItem(N,l?"1":"0"),window.localStorage.setItem(g,String(b))}catch(i){console.error("Error saving strategy positions auto-refresh preferences:",i)}},[l,b]),u.useEffect(()=>{if(!l)return;const i=Math.min(300,Math.max(5,b)),c=window.setInterval(()=>{_.current||(_.current=!0,E(!0),x(!1))},i*1e3);return()=>window.clearInterval(c)},[l,b]);const B=u.useMemo(()=>{const i=[];for(const c of s){const T=c.config?.exchange||"NFO",A=c.legs||{};for(const[F,C]of Object.entries(A)){if(!["IN_POSITION","PENDING_EXIT","PENDING_ENTRY","IDLE","EXITED_WAITING_REENTRY","EXITED_WAITING_REEXECUTE"].includes(C.status))continue;const M=(C.symbol||"").trim();if(M)if(M.includes(":")){const[he,V]=M.split(":",2);if(!V)continue;i.push({instanceId:c.instance_id,legKey:F,symbol:V,exchange:he||T,ltp:C.current_ltp??C.entry_price})}else i.push({instanceId:c.instance_id,legKey:F,symbol:M,exchange:T,ltp:C.current_ltp??C.entry_price})}}return i},[s]),{data:q}=be(B,{enabled:B.length>0,useMultiQuotesFallback:!0}),de=u.useMemo(()=>{const i={};for(const c of q)i[c.instanceId]||(i[c.instanceId]={}),i[c.instanceId][c.legKey]=c.ltp;return i},[q]),xe=()=>{_.current=!0,E(!0),x(!0)},Q=u.useMemo(()=>[...s].sort((i,c)=>{const T=(i.strategy_name||"").toLocaleLowerCase(),A=(c.strategy_name||"").toLocaleLowerCase();if(T<A)return-1;if(T>A)return 1;const F=i.created_at?new Date(i.created_at).getTime():Number.POSITIVE_INFINITY,C=c.created_at?new Date(c.created_at).getTime():Number.POSITIVE_INFINITY;return F!==C?F-C:(i.instance_id||"").localeCompare(c.instance_id||"")}),[s]);return e.jsxs("div",{className:"container mx-auto py-6 px-4 max-w-7xl",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Strategy Positions"}),e.jsx("p",{className:"text-muted-foreground",children:"View positions and trade history for Python strategies"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"text-xs text-muted-foreground",children:"Auto refresh"}),e.jsx(Ie,{checked:l,onCheckedChange:t})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"text-xs text-muted-foreground",children:"Every (s)"}),e.jsx(ce,{type:"number",min:5,max:300,step:1,value:b,onChange:i=>{const c=Number.parseInt(i.target.value,10);if(Number.isNaN(c))return;const T=Math.min(300,Math.max(5,c));L(T)},className:"h-8 w-20",disabled:!l})]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:xe,disabled:h,children:[e.jsx(te,{className:`h-4 w-4 mr-2 ${h?"animate-spin":""}`}),"Refresh"]})]}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Range: 5â€“300 seconds (saved locally)"})]})]}),d?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(te,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):Q.length===0?e.jsx(ie,{children:e.jsxs(le,{className:"py-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:"No strategy states found"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Strategy positions will appear here when you run Python strategies with state persistence."})]})}):e.jsx("div",{children:Q.map(i=>e.jsx(Xe,{strategy:i,onDelete:p,onRefresh:()=>x(!1),liveLtpByLegKey:de[i.instance_id]||{}},i.instance_id))}),e.jsx(me,{open:j.open,onOpenChange:i=>{m||(f(c=>({...c,open:i})),i||R(""))},children:e.jsxs(ue,{children:[e.jsxs(fe,{children:[e.jsx(je,{children:"Delete Strategy State?"}),e.jsx(Ne,{asChild:!0,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["Are you sure you want to delete the strategy state for"," ",e.jsx("strong",{children:j.strategyName}),"? This action cannot be undone and will remove all position data and trade history for this strategy."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-sm",children:["To confirm, type ",e.jsx("strong",{className:"text-foreground",children:j.strategyName})," below:"]}),e.jsx("input",{type:"text",value:P,onChange:i=>R(i.target.value),placeholder:"Type strategy name to confirm",className:"w-full px-3 py-2 text-sm border rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring",disabled:m,autoComplete:"off"})]})]})})]}),e.jsxs(ge,{children:[e.jsx(pe,{disabled:m,children:"Cancel"}),e.jsx(_e,{onClick:v,disabled:m||!oe,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90 disabled:opacity-50",children:m?"Deleting...":"Delete"})]})]})})]})}export{ss as default};
