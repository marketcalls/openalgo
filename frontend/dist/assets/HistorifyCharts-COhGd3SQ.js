import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as xe,d as Qe,t as D,c as G,B as j,e as R,D as Je,h as Ge,i as Ze,p as Ke,j as Z,k as Xe,m as es}from"./index-ZY85b03f.js";import{C as L,a as k}from"./card-BQNy6Ea-.js";import{P as ss,a as ts,b as as,C as rs,c as ns,d as ls,e as os,f as cs,g as is}from"./popover-Dzlh4Xqv.js";import{I as K}from"./input-BCdTfGK-.js";import{S as ge,a as fe,b as pe,c as je,d as v}from"./select-BwHMAecc.js";import{q as ds,K as ms,W as us,R as hs,V as xs}from"./lightweight-charts.production-BQUuleWj.js";import{A as gs,D as ve,S as fs,ai as ps,R as js,Z as Se,g as be,L as vs,k as Ss,l as bs,aF as Ns,aG as ws,N as ys,m as Cs,n as Ds}from"./vendor-icons-Ca5eNZvr.js";import{a as Ms,c as Is,d as Ls,L as X}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-DzupMptF.js";import"./vendor-radix-gKv__6YA.js";function Ps(){const U=Ms(),{mode:V,toggleMode:Ne,appMode:h,toggleAppMode:we,isTogglingMode:ee}=xe(),{user:A,logout:se}=Qe(),i=V==="dark"||h==="analyzer",{symbol:ye}=Is(),[te,ae]=Ls(),Ce=async()=>{try{await es.logout(),se(),U("/login"),D.success("Logged out successfully")}catch{se(),U("/login")}},re=async()=>{const s=await we();if(s.success){const a=xe.getState().appMode;D.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`)}else D.error(s.message||"Failed to toggle mode")},[M,De]=t.useState([]),[x,Me]=t.useState(null),[ne,le]=t.useState(!1),[P,H]=t.useState(!1),[l,Ie]=t.useState(ye||""),[o,Le]=t.useState(te.get("exchange")||"NSE"),[m,ke]=t.useState(te.get("interval")||"D"),[Te,oe]=t.useState(!1),[T,ce]=t.useState(""),[g,ie]=t.useState(!1),[z,ze]=t.useState("25"),[d,Ee]=t.useState("m"),[W,$e]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[B,Fe]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,Oe]=t.useState([]),[E,Re]=t.useState(null),f=t.useRef(null),u=t.useRef(null),Ue=t.useRef(null),Ve=t.useRef(null),Ae=t.useMemo(()=>x?[...x.seconds,...x.minutes,...x.hours,...x.days,...x.weeks,...x.months]:["D"],[x]),b=t.useMemo(()=>{if(g){if(["W","MO","Q","Y"].includes(d)){const s=parseInt(z)||1;return s===1?d:`${s}${d}`}return`${z}${d}`}return m},[g,z,d,m]),de=t.useMemo(()=>!!(["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(b)||g&&["m","h"].includes(d)),[b,g,d]),Y=t.useMemo(()=>{const s=new Map;return M.forEach(a=>{const c=`${a.symbol}:${a.exchange}`;s.has(c)?s.get(c).intervals.push(a.interval):s.set(c,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[M]),Pe=t.useMemo(()=>{if(!T)return Y;const s=T.toLowerCase();return Y.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[Y,T]);t.useEffect(()=>{He(),We()},[]),t.useEffect(()=>{l&&o&&m&&ae({exchange:o,interval:m})},[l,o,m,ae]),t.useEffect(()=>{l&&o&&b&&(me(),Be())},[l,o,b]),t.useEffect(()=>{if(!f.current)return;const s=setTimeout(()=>{if(!f.current)return;u.current&&(u.current.remove(),u.current=null);const N=f.current,$=N.offsetWidth||800,F=N.offsetHeight||600,_=de,ue=g&&["W","MO","Q","Y"].includes(d),qe=I=>{const w=new Date(I*1e3),n=ue?0:5.5*60*60*1e3,S=new Date(w.getTime()+n),p=S.getUTCDate().toString().padStart(2,"0"),y=(S.getUTCMonth()+1).toString().padStart(2,"0"),C=S.getUTCFullYear().toString().slice(-2),Q=S.getUTCHours().toString().padStart(2,"0"),J=S.getUTCMinutes().toString().padStart(2,"0");return _?`${p}/${y}/${C} ${Q}:${J}`:`${p}/${y}/${C}`},O=ds(N,{width:$,height:Math.max(F,500),layout:{background:{type:us.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:qe},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:_,secondsVisible:!1,tickMarkFormatter:(I,w)=>{const n=new Date(I*1e3),S=ue?0:5.5*60*60*1e3,p=new Date(n.getTime()+S);if(_){const y=p.getUTCHours().toString().padStart(2,"0"),C=p.getUTCMinutes().toString().padStart(2,"0");return`${y}:${C}`}else{const y=p.getUTCDate(),C=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Q=p.getUTCMonth(),J=p.getUTCFullYear();return w===0?J.toString():w===1?C[Q]:y.toString()}}},crosshair:{mode:ms.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),he=O.addSeries(hs,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),q=O.addSeries(xs,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(q.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),u.current=O,Ue.current=he,Ve.current=q,r.length>0){const I=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));he.setData(I);const w=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));q.setData(w),O.timeScale().fitContent()}},100),a=()=>{if(u.current&&f.current){const N=f.current,$=N.offsetWidth,F=N.offsetHeight;$>0&&F>0&&u.current.applyOptions({width:$,height:F})}},c=new ResizeObserver(a);return f.current&&c.observe(f.current),window.addEventListener("resize",a),()=>{clearTimeout(s),c.disconnect(),window.removeEventListener("resize",a),u.current&&(u.current.remove(),u.current=null)}},[i,r,P,de,g,d]);const He=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&De(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},We=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&Me(a.data)}catch(s){console.error("Error loading intervals:",s)}},me=t.useCallback(async()=>{if(!(!l||!o)){le(!0);try{const s=new URLSearchParams({symbol:l,exchange:o,interval:b,start_date:W,end_date:B}),c=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();c.status==="success"?(Oe(c.data||[]),c.count===0&&D.info("No data available for this range. Make sure 1m data is downloaded for custom intervals.")):D.error(c.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),D.error("Failed to load chart data")}finally{le(!1)}}},[l,o,b,W,B]),Be=t.useCallback(()=>{const s=M.find(a=>a.symbol===l&&a.exchange===o&&a.interval===m);Re(s||null)},[M,l,o,m]),Ye=(s,a)=>{Ie(s),Le(a),oe(!1),ce("")},_e=()=>{document.fullscreenElement?(document.exitFullscreen(),H(!1)):(document.documentElement.requestFullscreen(),H(!0))};return t.useEffect(()=>{const s=()=>{H(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:G("h-full flex flex-col bg-background text-foreground",P&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(j,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(X,{to:"/historify",children:e.jsx(gs,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(ss,{open:Te,onOpenChange:oe,children:[e.jsx(ts,{asChild:!0,children:e.jsxs(j,{variant:"outline",className:"w-64 justify-between",children:[l?e.jsxs("span",{children:[l,":",o]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(fs,{className:"h-4 w-4 ml-2"})]})}),e.jsx(as,{className:"w-64 p-0",align:"start",children:e.jsxs(rs,{children:[e.jsx(ns,{placeholder:"Search symbols...",value:T,onValueChange:ce}),e.jsxs(ls,{children:[e.jsx(os,{children:"No symbols found"}),e.jsx(cs,{children:Pe.slice(0,20).map(s=>e.jsxs(is,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>Ye(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(R,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(ge,{value:g?"custom":m,onValueChange:s=>{s==="custom"?ie(!0):(ie(!1),ke(s))},children:[e.jsx(fe,{className:"w-24",children:e.jsx(pe,{})}),e.jsxs(je,{children:[Ae.map(s=>e.jsx(v,{value:s,children:s},s)),e.jsx(v,{value:"custom",children:"Custom"})]})]}),g&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(K,{type:"number",min:"1",max:"999",value:z,onChange:s=>ze(s.target.value),className:"h-9 w-14 text-center",placeholder:"1"}),e.jsxs(ge,{value:d,onValueChange:s=>Ee(s),children:[e.jsx(fe,{className:"w-20 h-9",children:e.jsx(pe,{})}),e.jsxs(je,{children:[e.jsx(v,{value:"m",children:"min"}),e.jsx(v,{value:"h",children:"hr"}),e.jsx(v,{value:"W",children:"Week"}),e.jsx(v,{value:"MO",children:"Month"}),e.jsx(v,{value:"Q",children:"Qtr"}),e.jsx(v,{value:"Y",children:"Year"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(K,{type:"date",value:W,onChange:s=>$e(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(K,{type:"date",value:B,onChange:s=>Fe(s.target.value),className:"h-9 w-36"})]}),e.jsx(j,{variant:"outline",size:"icon",onClick:me,disabled:ne,children:e.jsx(js,{className:G("h-4 w-4",ne&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[A?.broker&&e.jsx(R,{variant:"outline",className:"text-xs",children:A.broker.toUpperCase()}),e.jsxs(R,{variant:h==="live"?"default":"secondary",className:G("text-xs cursor-pointer",h==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:re,children:[h==="live"?e.jsx(Se,{className:"h-3 w-3 mr-1"}):e.jsx(be,{className:"h-3 w-3 mr-1"}),h==="live"?"Live":"Analyze"]}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:re,disabled:ee,title:`Switch to ${h==="live"?"Analyze":"Live"} mode`,children:ee?e.jsx(vs,{className:"h-4 w-4 animate-spin"}):h==="live"?e.jsx(Se,{className:"h-4 w-4"}):e.jsx(be,{className:"h-4 w-4"})}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Ne,disabled:h!=="live",title:V==="light"?"Switch to dark mode":"Switch to light mode",children:V==="light"?e.jsx(Ss,{className:"h-4 w-4"}):e.jsx(bs,{className:"h-4 w-4"})}),e.jsx(j,{variant:"ghost",size:"icon",onClick:_e,children:P?e.jsx(Ns,{className:"h-4 w-4"}):e.jsx(ws,{className:"h-4 w-4"})}),e.jsx(j,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(X,{to:"/dashboard",children:[e.jsx(ys,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Je,{children:[e.jsx(Ge,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:A?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Ze,{align:"end",className:"w-56",children:[Ke.map(s=>e.jsxs(Z,{onSelect:()=>U(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(Z,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Xe,{}),e.jsxs(Z,{onClick:Ce,className:"text-destructive focus:text-destructive",children:[e.jsx(Ds,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:l?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[l,":",o]}),e.jsx(R,{variant:"outline",children:m}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),E&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",E.first_date," - ",E.last_date]}),e.jsxs("span",{children:[E.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:f,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(ve,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),M.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(X,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Ps as default};
