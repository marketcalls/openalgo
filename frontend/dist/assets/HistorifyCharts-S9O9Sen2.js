import{r as a,j as e}from"./vendor-react-RhKMXzW9.js";import{u as ne,d as Fe,t as N,c as W,B as f,e as E,D as $e,h as Oe,i as Re,p as Ue,j as q,k as Ae,m as Pe}from"./index-Dozf8b_9.js";import{C,a as D}from"./card-BO8Izvrs.js";import{P as Ve,a as He,b as Be,C as _e,c as We,d as qe,e as Je,f as Ge,g as Ye}from"./popover-Ca-nFEmL.js";import{I as oe}from"./input-CRqgr8Cf.js";import{S as Ze,a as Ke,b as Qe,c as Xe,d as es}from"./select-BUkWQb4M.js";import{q as ss,K as ts,W as as,R as rs,V as ns}from"./lightweight-charts.production-BQUuleWj.js";import{A as os,D as le,S as ls,ai as cs,R as is,Z as ce,g as ie,L as ds,k as ms,l as hs,aF as us,aG as xs,N as gs,m as fs,n as ps}from"./vendor-icons-Ca5eNZvr.js";import{a as js,c as vs,d as bs,L as J}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-DzupMptF.js";import"./vendor-radix-gKv__6YA.js";function Es(){const I=js(),{mode:F,toggleMode:de,appMode:h,toggleAppMode:me,isTogglingMode:G}=ne(),{user:$,logout:Y}=Fe(),d=F==="dark"||h==="analyzer",{symbol:he}=vs(),[Z,K]=bs(),ue=async()=>{try{await Pe.logout(),Y(),I("/login"),N.success("Logged out successfully")}catch{Y(),I("/login")}},Q=async()=>{const s=await me();if(s.success){const t=ne.getState().appMode;N.success(`Switched to ${t==="live"?"Live":"Analyze"} mode`)}else N.error(s.message||"Failed to toggle mode")},[w,xe]=a.useState([]),[u,ge]=a.useState(null),[X,ee]=a.useState(!1),[O,R]=a.useState(!1),[o,fe]=a.useState(he||""),[l,pe]=a.useState(Z.get("exchange")||"NSE"),[c,je]=a.useState(Z.get("interval")||"D"),[ve,se]=a.useState(!1),[M,te]=a.useState(""),[U,be]=a.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[A,Se]=a.useState(()=>new Date().toISOString().split("T")[0]),[r,Ne]=a.useState([]),[L,we]=a.useState(null),x=a.useRef(null),m=a.useRef(null),ye=a.useRef(null),Ce=a.useRef(null),De=a.useMemo(()=>u?[...u.seconds,...u.minutes,...u.hours,...u.days,...u.weeks,...u.months]:["D"],[u]),P=a.useMemo(()=>{const s=new Map;return w.forEach(t=>{const i=`${t.symbol}:${t.exchange}`;s.has(i)?s.get(i).intervals.push(t.interval):s.set(i,{symbol:t.symbol,exchange:t.exchange,intervals:[t.interval]})}),Array.from(s.values())},[w]),Me=a.useMemo(()=>{if(!M)return P;const s=M.toLowerCase();return P.filter(t=>t.symbol.toLowerCase().includes(s)||t.exchange.toLowerCase().includes(s))},[P,M]);a.useEffect(()=>{Le(),ke()},[]),a.useEffect(()=>{o&&l&&c&&K({exchange:l,interval:c})},[o,l,c,K]),a.useEffect(()=>{o&&l&&c&&(ae(),Te())},[o,l,c]),a.useEffect(()=>{if(!x.current)return;const s=setTimeout(()=>{if(!x.current)return;m.current&&(m.current.remove(),m.current=null);const j=x.current,k=j.offsetWidth||800,T=j.offsetHeight||600,V=["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(c),Ie=y=>{const v=new Date(y*1e3),n=5.5*60*60*1e3,p=new Date(v.getTime()+n),g=p.getUTCDate().toString().padStart(2,"0"),b=(p.getUTCMonth()+1).toString().padStart(2,"0"),S=p.getUTCFullYear().toString().slice(-2),B=p.getUTCHours().toString().padStart(2,"0"),_=p.getUTCMinutes().toString().padStart(2,"0");return V?`${g}/${b}/${S} ${B}:${_}`:`${g}/${b}/${S}`},z=ss(j,{width:k,height:Math.max(T,500),layout:{background:{type:as.Solid,color:"transparent"},textColor:d?"#a6adbb":"#333"},grid:{vertLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:Ie},rightPriceScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:V,secondsVisible:!1,tickMarkFormatter:(y,v)=>{const n=new Date(y*1e3),p=5.5*60*60*1e3,g=new Date(n.getTime()+p);if(V){const b=g.getUTCHours().toString().padStart(2,"0"),S=g.getUTCMinutes().toString().padStart(2,"0");return`${b}:${S}`}else{const b=g.getUTCDate(),S=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B=g.getUTCMonth(),_=g.getUTCFullYear();return v===0?_.toString():v===1?S[B]:b.toString()}}},crosshair:{mode:ts.Normal,vertLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:d?"#1f2937":"#374151"},horzLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:d?"#1f2937":"#374151"}}}),re=z.addSeries(rs,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),H=z.addSeries(ns,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(H.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),m.current=z,ye.current=re,Ce.current=H,r.length>0){const y=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));re.setData(y);const v=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));H.setData(v),z.timeScale().fitContent()}},100),t=()=>{if(m.current&&x.current){const j=x.current,k=j.offsetWidth,T=j.offsetHeight;k>0&&T>0&&m.current.applyOptions({width:k,height:T})}},i=new ResizeObserver(t);return x.current&&i.observe(x.current),window.addEventListener("resize",t),()=>{clearTimeout(s),i.disconnect(),window.removeEventListener("resize",t),m.current&&(m.current.remove(),m.current=null)}},[d,r,O]);const Le=async()=>{try{const t=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();t.status==="success"&&xe(t.data||[])}catch(s){console.error("Error loading catalog:",s)}},ke=async()=>{try{const t=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();t.status==="success"&&ge(t.data)}catch(s){console.error("Error loading intervals:",s)}},ae=a.useCallback(async()=>{if(!(!o||!l)){ee(!0);try{const s=new URLSearchParams({symbol:o,exchange:l,interval:c,start_date:U,end_date:A}),i=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();i.status==="success"?(Ne(i.data||[]),i.count===0&&N.info("No data available for this range")):N.error(i.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),N.error("Failed to load chart data")}finally{ee(!1)}}},[o,l,c,U,A]),Te=a.useCallback(()=>{const s=w.find(t=>t.symbol===o&&t.exchange===l&&t.interval===c);we(s||null)},[w,o,l,c]),ze=(s,t)=>{fe(s),pe(t),se(!1),te("")},Ee=()=>{document.fullscreenElement?(document.exitFullscreen(),R(!1)):(document.documentElement.requestFullscreen(),R(!0))};return a.useEffect(()=>{const s=()=>{R(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:W("h-full flex flex-col bg-background text-foreground",O&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(J,{to:"/historify",children:e.jsx(os,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(le,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(Ve,{open:ve,onOpenChange:se,children:[e.jsx(He,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[o?e.jsxs("span",{children:[o,":",l]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(ls,{className:"h-4 w-4 ml-2"})]})}),e.jsx(Be,{className:"w-64 p-0",align:"start",children:e.jsxs(_e,{children:[e.jsx(We,{placeholder:"Search symbols...",value:M,onValueChange:te}),e.jsxs(qe,{children:[e.jsx(Je,{children:"No symbols found"}),e.jsx(Ge,{children:Me.slice(0,20).map(s=>e.jsxs(Ye,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>ze(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(E,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(Ze,{value:c,onValueChange:je,children:[e.jsx(Ke,{className:"w-24",children:e.jsx(Qe,{})}),e.jsx(Xe,{children:De.map(s=>e.jsx(es,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(oe,{type:"date",value:U,onChange:s=>be(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(oe,{type:"date",value:A,onChange:s=>Se(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:ae,disabled:X,children:e.jsx(is,{className:W("h-4 w-4",X&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[$?.broker&&e.jsx(E,{variant:"outline",className:"text-xs",children:$.broker.toUpperCase()}),e.jsxs(E,{variant:h==="live"?"default":"secondary",className:W("text-xs cursor-pointer",h==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:Q,children:[h==="live"?e.jsx(ce,{className:"h-3 w-3 mr-1"}):e.jsx(ie,{className:"h-3 w-3 mr-1"}),h==="live"?"Live":"Analyze"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Q,disabled:G,title:`Switch to ${h==="live"?"Analyze":"Live"} mode`,children:G?e.jsx(ds,{className:"h-4 w-4 animate-spin"}):h==="live"?e.jsx(ce,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:de,disabled:h!=="live",title:F==="light"?"Switch to dark mode":"Switch to light mode",children:F==="light"?e.jsx(ms,{className:"h-4 w-4"}):e.jsx(hs,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:Ee,children:O?e.jsx(us,{className:"h-4 w-4"}):e.jsx(xs,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(J,{to:"/dashboard",children:[e.jsx(gs,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs($e,{children:[e.jsx(Oe,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:$?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Re,{align:"end",className:"w-56",children:[Ue.map(s=>e.jsxs(q,{onSelect:()=>I(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(q,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(fs,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Ae,{}),e.jsxs(q,{onClick:ue,className:"text-destructive focus:text-destructive",children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:o?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[o,":",l]}),e.jsx(E,{variant:"outline",children:c}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),L&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",L.first_date," - ",L.last_date]}),e.jsxs("span",{children:[L.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:x,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(C,{children:e.jsxs(D,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(C,{children:e.jsxs(D,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(C,{children:e.jsxs(D,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(C,{children:e.jsxs(D,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(C,{children:e.jsxs(D,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(le,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),w.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(J,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Es as default};
