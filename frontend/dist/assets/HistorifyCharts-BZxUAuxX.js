import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{u as he,d as qe,t as D,c as G,B as p,e as R,D as Je,h as Qe,i as Ge,p as Ze,j as Z,k as Ke,m as Xe}from"./index-CEGKWS9L.js";import{C as L,a as k}from"./card-502qoWym.js";import{P as es,a as ss,b as ts,C as as,c as rs,d as ns,e as ls,f as os,g as cs}from"./popover-CcnrTjEV.js";import{I as K}from"./input-B5fqcv1o.js";import{S as xe,a as ge,b as fe,c as pe,d as j}from"./select-DoyBwxKn.js";import{q as is,K as ds,W as ms,R as us,V as hs}from"./lightweight-charts.production-BQUuleWj.js";import{A as xs,D as je,S as gs,ai as fs,R as ps,Z as ve,g as Se,L as js,k as vs,l as Ss,aF as bs,aG as Ns,N as ws,m as ys,n as Cs}from"./vendor-icons-Ca5eNZvr.js";import{a as Ds,c as Ms,d as Is,L as X}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-DzupMptF.js";import"./vendor-radix-gKv__6YA.js";function Ps(){const U=Ds(),{mode:V,toggleMode:be,appMode:u,toggleAppMode:Ne,isTogglingMode:ee}=he(),{user:P,logout:se}=qe(),i=V==="dark"||u==="analyzer",{symbol:we}=Ms(),[te,ae]=Is(),ye=async()=>{try{await Xe.logout(),se(),U("/login"),D.success("Logged out successfully")}catch{se(),U("/login")}},re=async()=>{const s=await Ne();if(s.success){const a=he.getState().appMode;D.success(`Switched to ${a==="live"?"Live":"Analyze"} mode`)}else D.error(s.message||"Failed to toggle mode")},[M,Ce]=t.useState([]),[h,De]=t.useState(null),[ne,le]=t.useState(!1),[A,H]=t.useState(!1),[l,Me]=t.useState(we||""),[o,Ie]=t.useState(te.get("exchange")||"NSE"),[d,Le]=t.useState(te.get("interval")||"D"),[ke,oe]=t.useState(!1),[T,ce]=t.useState(""),[S,ie]=t.useState(!1),[z,Te]=t.useState("25"),[x,ze]=t.useState("m"),[W,Ee]=t.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[B,$e]=t.useState(()=>new Date().toISOString().split("T")[0]),[r,Fe]=t.useState([]),[E,Oe]=t.useState(null),g=t.useRef(null),m=t.useRef(null),Re=t.useRef(null),Ue=t.useRef(null),Ve=t.useMemo(()=>h?[...h.seconds,...h.minutes,...h.hours,...h.days,...h.weeks,...h.months]:["D"],[h]),b=t.useMemo(()=>{if(S){if(["W","MO","Q","Y"].includes(x)){const s=parseInt(z)||1;return s===1?x:`${s}${x}`}return`${z}${x}`}return d},[S,z,x,d]),de=t.useMemo(()=>!!(["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(b)||S&&["m","h"].includes(x)),[b,S,x]),_=t.useMemo(()=>{const s=new Map;return M.forEach(a=>{const c=`${a.symbol}:${a.exchange}`;s.has(c)?s.get(c).intervals.push(a.interval):s.set(c,{symbol:a.symbol,exchange:a.exchange,intervals:[a.interval]})}),Array.from(s.values())},[M]),Pe=t.useMemo(()=>{if(!T)return _;const s=T.toLowerCase();return _.filter(a=>a.symbol.toLowerCase().includes(s)||a.exchange.toLowerCase().includes(s))},[_,T]);t.useEffect(()=>{Ae(),He()},[]),t.useEffect(()=>{l&&o&&d&&ae({exchange:o,interval:d})},[l,o,d,ae]),t.useEffect(()=>{l&&o&&b&&(me(),We())},[l,o,b]),t.useEffect(()=>{if(!g.current)return;const s=setTimeout(()=>{if(!g.current)return;m.current&&(m.current.remove(),m.current=null);const N=g.current,$=N.offsetWidth||800,F=N.offsetHeight||600,Y=de,Ye=I=>{const w=new Date(I*1e3),n=5.5*60*60*1e3,v=new Date(w.getTime()+n),f=v.getUTCDate().toString().padStart(2,"0"),y=(v.getUTCMonth()+1).toString().padStart(2,"0"),C=v.getUTCFullYear().toString().slice(-2),J=v.getUTCHours().toString().padStart(2,"0"),Q=v.getUTCMinutes().toString().padStart(2,"0");return Y?`${f}/${y}/${C} ${J}:${Q}`:`${f}/${y}/${C}`},O=is(N,{width:$,height:Math.max(F,500),layout:{background:{type:ms.Solid,color:"transparent"},textColor:i?"#a6adbb":"#333"},grid:{vertLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:i?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:Ye},rightPriceScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:i?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:Y,secondsVisible:!1,tickMarkFormatter:(I,w)=>{const n=new Date(I*1e3),v=5.5*60*60*1e3,f=new Date(n.getTime()+v);if(Y){const y=f.getUTCHours().toString().padStart(2,"0"),C=f.getUTCMinutes().toString().padStart(2,"0");return`${y}:${C}`}else{const y=f.getUTCDate(),C=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],J=f.getUTCMonth(),Q=f.getUTCFullYear();return w===0?Q.toString():w===1?C[J]:y.toString()}}},crosshair:{mode:ds.Normal,vertLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:i?"#1f2937":"#374151"},horzLine:{width:1,color:i?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:i?"#1f2937":"#374151"}}}),ue=O.addSeries(us,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),q=O.addSeries(hs,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(q.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),m.current=O,Re.current=ue,Ue.current=q,r.length>0){const I=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));ue.setData(I);const w=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));q.setData(w),O.timeScale().fitContent()}},100),a=()=>{if(m.current&&g.current){const N=g.current,$=N.offsetWidth,F=N.offsetHeight;$>0&&F>0&&m.current.applyOptions({width:$,height:F})}},c=new ResizeObserver(a);return g.current&&c.observe(g.current),window.addEventListener("resize",a),()=>{clearTimeout(s),c.disconnect(),window.removeEventListener("resize",a),m.current&&(m.current.remove(),m.current=null)}},[i,r,A,de]);const Ae=async()=>{try{const a=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();a.status==="success"&&Ce(a.data||[])}catch(s){console.error("Error loading catalog:",s)}},He=async()=>{try{const a=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();a.status==="success"&&De(a.data)}catch(s){console.error("Error loading intervals:",s)}},me=t.useCallback(async()=>{if(!(!l||!o)){le(!0);try{const s=new URLSearchParams({symbol:l,exchange:o,interval:b,start_date:W,end_date:B}),c=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();c.status==="success"?(Fe(c.data||[]),c.count===0&&D.info("No data available for this range. Make sure 1m data is downloaded for custom intervals.")):D.error(c.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),D.error("Failed to load chart data")}finally{le(!1)}}},[l,o,b,W,B]),We=t.useCallback(()=>{const s=M.find(a=>a.symbol===l&&a.exchange===o&&a.interval===d);Oe(s||null)},[M,l,o,d]),Be=(s,a)=>{Me(s),Ie(a),oe(!1),ce("")},_e=()=>{document.fullscreenElement?(document.exitFullscreen(),H(!1)):(document.documentElement.requestFullscreen(),H(!0))};return t.useEffect(()=>{const s=()=>{H(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:G("h-full flex flex-col bg-background text-foreground",A&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(p,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(X,{to:"/historify",children:e.jsx(xs,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(es,{open:ke,onOpenChange:oe,children:[e.jsx(ss,{asChild:!0,children:e.jsxs(p,{variant:"outline",className:"w-64 justify-between",children:[l?e.jsxs("span",{children:[l,":",o]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(gs,{className:"h-4 w-4 ml-2"})]})}),e.jsx(ts,{className:"w-64 p-0",align:"start",children:e.jsxs(as,{children:[e.jsx(rs,{placeholder:"Search symbols...",value:T,onValueChange:ce}),e.jsxs(ns,{children:[e.jsx(ls,{children:"No symbols found"}),e.jsx(os,{children:Pe.slice(0,20).map(s=>e.jsxs(cs,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>Be(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(R,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(xe,{value:S?"custom":d,onValueChange:s=>{s==="custom"?ie(!0):(ie(!1),Le(s))},children:[e.jsx(ge,{className:"w-24",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[Ve.map(s=>e.jsx(j,{value:s,children:s},s)),e.jsx(j,{value:"custom",children:"Custom"})]})]}),S&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(K,{type:"number",min:"1",max:"999",value:z,onChange:s=>Te(s.target.value),className:"h-9 w-14 text-center",placeholder:"1"}),e.jsxs(xe,{value:x,onValueChange:s=>ze(s),children:[e.jsx(ge,{className:"w-20 h-9",children:e.jsx(fe,{})}),e.jsxs(pe,{children:[e.jsx(j,{value:"m",children:"min"}),e.jsx(j,{value:"h",children:"hr"}),e.jsx(j,{value:"W",children:"Week"}),e.jsx(j,{value:"MO",children:"Month"}),e.jsx(j,{value:"Q",children:"Qtr"}),e.jsx(j,{value:"Y",children:"Year"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(K,{type:"date",value:W,onChange:s=>Ee(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(K,{type:"date",value:B,onChange:s=>$e(s.target.value),className:"h-9 w-36"})]}),e.jsx(p,{variant:"outline",size:"icon",onClick:me,disabled:ne,children:e.jsx(ps,{className:G("h-4 w-4",ne&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[P?.broker&&e.jsx(R,{variant:"outline",className:"text-xs",children:P.broker.toUpperCase()}),e.jsxs(R,{variant:u==="live"?"default":"secondary",className:G("text-xs cursor-pointer",u==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:re,children:[u==="live"?e.jsx(ve,{className:"h-3 w-3 mr-1"}):e.jsx(Se,{className:"h-3 w-3 mr-1"}),u==="live"?"Live":"Analyze"]}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:re,disabled:ee,title:`Switch to ${u==="live"?"Analyze":"Live"} mode`,children:ee?e.jsx(js,{className:"h-4 w-4 animate-spin"}):u==="live"?e.jsx(ve,{className:"h-4 w-4"}):e.jsx(Se,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:be,disabled:u!=="live",title:V==="light"?"Switch to dark mode":"Switch to light mode",children:V==="light"?e.jsx(vs,{className:"h-4 w-4"}):e.jsx(Ss,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:_e,children:A?e.jsx(bs,{className:"h-4 w-4"}):e.jsx(Ns,{className:"h-4 w-4"})}),e.jsx(p,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(X,{to:"/dashboard",children:[e.jsx(ws,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Je,{children:[e.jsx(Qe,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:P?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Ge,{align:"end",className:"w-56",children:[Ze.map(s=>e.jsxs(Z,{onSelect:()=>U(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(Z,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(ys,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Ke,{}),e.jsxs(Z,{onClick:ye,className:"text-destructive focus:text-destructive",children:[e.jsx(Cs,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:l?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[l,":",o]}),e.jsx(R,{variant:"outline",children:d}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),E&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",E.first_date," - ",E.last_date]}),e.jsxs("span",{children:[E.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:g,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(L,{children:e.jsxs(k,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(je,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),M.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(X,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Ps as default};
