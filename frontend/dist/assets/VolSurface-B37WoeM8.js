import{r as a,j as t}from"./vendor-react-CCyQGCED.js";import{P as q}from"./react-plotly-DV3gd5yC.js";import{w as G,u as H,s as C,B as J,e as h}from"./index-DLrRZEmO.js";import{o as A}from"./oi-profile-CkxblXa3.js";import{C as Q,d as W}from"./card-BHRAREBW.js";import{S as F,a as I,b as w,c as z,d as B}from"./select-CSWw-9Vv.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const Z={getSurfaceData:async c=>(await G.post("/volsurface/api/surface-data",c)).data},ee=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],D={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},te=[{value:"10",label:"10"},{value:"15",label:"15"},{value:"20",label:"20"},{value:"25",label:"25"},{value:"30",label:"30"},{value:"35",label:"35"},{value:"40",label:"40"}];function se(c){if(!c)return"";const d=c.split("-");return d.length===3?`${d[0]}${d[1].toUpperCase()}${d[2].slice(-2)}`:c.replace(/-/g,"").toUpperCase()}function fe(){const{mode:c,appMode:d}=H(),x=d==="analyzer",n=c==="dark"||x,[u,V]=a.useState("NFO"),[L,T]=a.useState(D.NFO),[f,y]=a.useState("NIFTY"),[b,v]=a.useState([]),[p,m]=a.useState([]),[S,R]=a.useState("40"),[l,j]=a.useState(null),[N,U]=a.useState(!1),g=a.useRef(0),s=a.useMemo(()=>({text:n?"#e0e0e0":"#333333",grid:n?x?"rgba(180,160,255,0.15)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",hoverBg:n?x?"#2d2545":"#1e293b":"#ffffff",hoverFont:n?"#e0e0e0":"#333333",hoverBorder:n?x?"#7c3aed":"#475569":"#e2e8f0",colorscale:x?"Plasma":n?"Viridis":"YlOrRd"}),[n,x]);a.useEffect(()=>{const e=D[u]||[];T(e),y(e[0]||""),v([]),m([]),j(null);let r=!1;return(async()=>{try{const i=await A.getUnderlyings(u);if(r)return;i.status==="success"&&i.underlyings.length>0&&(T(i.underlyings),i.underlyings.includes(e[0])||y(i.underlyings[0]))}catch{}})(),()=>{r=!0}},[u]),a.useEffect(()=>{if(!f)return;v([]),m([]),j(null);let e=!1;return(async()=>{try{const o=await A.getExpiries(u,f);if(e)return;o.status==="success"&&o.expiries.length>0&&(v(o.expiries),m(o.expiries.slice(0,4)))}catch{if(e)return;C.error("Failed to fetch expiry dates")}})(),()=>{e=!0}},[f]);const M=a.useCallback(e=>{m(r=>r.includes(e)?r.filter(o=>o!==e):r.length>=8?r:[...r,e])},[]),P=a.useCallback(async()=>{if(p.length===0)return;const e=++g.current;U(!0);try{const r=await Z.getSurfaceData({underlying:f,exchange:u,expiry_dates:p.map(se),strike_count:parseInt(S)});if(g.current!==e)return;r.status==="success"&&r.data?j(r.data):C.error(r.message||"Failed to load vol surface")}catch{if(g.current!==e)return;C.error("Failed to fetch vol surface data")}finally{g.current===e&&U(!1)}},[p,S,f,u]),O=a.useMemo(()=>{if(!l)return{data:[],layout:{}};const{strikes:e,expiries:r,surface:o}=l,i=r.map((k,E)=>E),_=r.map(k=>k.date),$=o.map((k,E)=>Array(e.length).fill(_[E])),K=[{type:"surface",x:e,y:i,z:o,customdata:$,colorscale:s.colorscale,hovertemplate:"Strike: %{x}<br>Expiry: %{customdata}<br>IV: %{z:.2f}%<extra></extra>",colorbar:{title:{text:"IV %",font:{color:s.text,size:12}},tickfont:{color:s.text},outlinewidth:0,len:.6},opacity:.95}],X={autosize:!0,paper_bgcolor:"rgba(0,0,0,0)",plot_bgcolor:"rgba(0,0,0,0)",font:{color:s.text,family:"system-ui, sans-serif"},margin:{l:0,r:0,t:0,b:0},scene:{aspectmode:"manual",aspectratio:{x:2,y:1.2,z:.8},domain:{x:[0,1],y:[0,1]},xaxis:{title:{text:"Strike Price",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},yaxis:{title:{text:"Expiry",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},tickvals:i,ticktext:_,gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},zaxis:{title:{text:"Implied Volatility",font:{color:s.text,size:12}},tickfont:{color:s.text,size:10},gridcolor:s.grid,backgroundcolor:"rgba(0,0,0,0)"},camera:{eye:{x:1.6,y:-1.6,z:.7}},bgcolor:"rgba(0,0,0,0)"},hoverlabel:{bgcolor:s.hoverBg,font:{color:s.hoverFont,size:12},bordercolor:s.hoverBorder},showlegend:!1};return{data:K,layout:X}},[l,s,n]),Y=a.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return t.jsxs("div",{className:"py-6 space-y-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Vol Surface"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs(F,{value:u,onValueChange:V,children:[t.jsx(I,{className:"w-[100px]",children:t.jsx(w,{placeholder:"Exchange"})}),t.jsx(z,{children:ee.map(e=>t.jsx(B,{value:e.value,children:e.label},e.value))})]}),t.jsxs(F,{value:f,onValueChange:y,children:[t.jsx(I,{className:"w-[140px]",children:t.jsx(w,{placeholder:"Underlying"})}),t.jsx(z,{children:L.map(e=>t.jsx(B,{value:e,children:e},e))})]}),t.jsxs(F,{value:S,onValueChange:R,children:[t.jsx(I,{className:"w-[100px]",children:t.jsx(w,{placeholder:"Strikes"})}),t.jsx(z,{children:te.map(e=>t.jsxs(B,{value:e.value,children:[e.label," Strikes"]},e.value))})]}),t.jsx(J,{variant:"outline",size:"sm",onClick:P,disabled:N||p.length===0,children:N?"Loading...":"Load Surface"})]})]}),b.length>0&&t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx("span",{className:"text-sm text-muted-foreground self-center mr-1",children:"Expiries:"}),b.map(e=>t.jsx("button",{type:"button",onClick:()=>M(e),className:`px-2.5 py-1 rounded-md text-xs border transition-colors ${p.includes(e)?"bg-primary text-primary-foreground border-primary":"bg-muted/50 text-muted-foreground border-border hover:bg-muted"}`,children:e},e))]}),l&&t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",l.underlying_ltp?.toFixed(2)]}),t.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",l.atm_strike]}),t.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Expiries: ",l.expiries.length]}),t.jsxs(h,{variant:"secondary",className:"text-sm px-3 py-1",children:["Strikes: ",l.strikes.length]})]}),t.jsx(Q,{children:t.jsx(W,{className:"p-2 sm:p-4",children:N&&!l?t.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Computing volatility surface..."]})}):l?t.jsx(q,{data:O.data,layout:O.layout,config:Y,useResizeHandler:!0,style:{width:"100%",height:"700px"}}):t.jsx("div",{className:"flex items-center justify-center h-[700px] text-muted-foreground",children:b.length>0?'Select expiries and click "Load Surface" to view the volatility surface':"Select an underlying to begin"})})})]})}export{fe as default};
