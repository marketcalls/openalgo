import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{u as re,s as L,B as P,e as p}from"./index-NHrG-O_Z.js";import{o as C}from"./oi-tracker-Dud8WQlI.js";import{C as ae,d as ne}from"./card-Cn20bp_v.js";import{P as oe,a as ie,b as le,C as ce,c as de,d as xe,e as pe,f as ue,g as me}from"./popover-DQlNqO83.js";import{S as U,a as M,b as $,c as A,d as D}from"./select-DcHsBqkV.js";import{P as he}from"./react-plotly-DV3gd5yC.js";import{aV as fe,m as ge}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const ye=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],R={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]};function V(o){if(!o)return"";const h=o.split("-");return h.length===3?`${h[0]}${h[1].toUpperCase()}${h[2].slice(-2)}`:o.replace(/-/g,"").toUpperCase()}function Y(o){return o>=1e7?`${(o/1e7).toFixed(1)}Cr`:o>=1e5?`${(o/1e5).toFixed(1)}L`:o>=1e3?`${(o/1e3).toFixed(1)}K`:o.toString()}function _e(){const{mode:o,appMode:h}=re(),g=h==="analyzer",u=o==="dark"||g,[m,G]=n.useState("NFO"),[K,k]=n.useState(R.NFO),[F,E]=n.useState(!1),[i,b]=n.useState("NIFTY"),[_,y]=n.useState([]),[c,f]=n.useState(""),[s,I]=n.useState(null),[S,w]=n.useState(!1),N=n.useRef(0);n.useEffect(()=>{const t=R[m]||[];k(t),b(t[0]||""),y([]),f(""),I(null);let d=!1;return(async()=>{try{const x=await C.getUnderlyings(m);if(d)return;x.status==="success"&&x.underlyings.length>0&&(k(x.underlyings),x.underlyings.includes(t[0])||b(x.underlyings[0]))}catch{}})(),()=>{d=!0}},[m]),n.useEffect(()=>{if(!i)return;y([]),f(""),I(null);let t=!1;return(async()=>{try{const a=await C.getExpiries(m,i);if(t)return;a.status==="success"&&a.expiries.length>0?(y(a.expiries),f(a.expiries[0])):(y([]),f(""))}catch{if(t)return;y([]),f("")}})(),()=>{t=!0}},[i]);const B=n.useCallback(async()=>{if(!c)return;const t=++N.current;w(!0);try{const d=V(c),a=await C.getOIData({underlying:i,exchange:m,expiry_date:d});if(N.current!==t)return;a.status==="success"?I(a):L.error(a.message||"Failed to fetch OI data")}catch{if(N.current!==t)return;L.error("Failed to fetch OI data")}finally{N.current===t&&w(!1)}},[i,c,m]);n.useEffect(()=>{c&&B()},[c]);const r=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:u?"#e0e0e0":"#333333",grid:u?g?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceBar:"#ef4444",peBar:"#22c55e",atmLine:u?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:u?g?"#2d2545":"#1e293b":"#ffffff",hoverFont:u?"#e0e0e0":"#333333",hoverBorder:u?g?"#7c3aed":"#475569":"#e2e8f0"}),[u,g]),T=n.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.lot_size||1,d=s.atm_strike,a=s.chain,x=a.map((l,v)=>v),O=a.map(l=>l.strike.toString()),q=a.map(l=>Math.round(l.ce_oi/t)),H=a.map(l=>Math.round(l.pe_oi/t)),z=Math.max(1,Math.floor(a.length/15)),J=x.filter((l,v)=>v%z===0),Q=O.filter((l,v)=>v%z===0),W=[{x,y:q,type:"bar",name:"Call Options OI (lots)",marker:{color:r.ceBar},hovertemplate:"Strike %{text}<br>CE OI: %{y:,}<extra></extra>",text:O,textposition:"none"},{x,y:H,type:"bar",name:"Put Options OI (lots)",marker:{color:r.peBar},hovertemplate:"Strike %{text}<br>PE OI: %{y:,}<extra></extra>",text:O,textposition:"none"}],Z=V(c),j=d?a.findIndex(l=>l.strike===d):-1,ee=j>=0?[{x:j,y:1,yref:"paper",text:`${i} ATM Strike ${d}`,showarrow:!1,font:{color:r.text,size:12},yanchor:"bottom"}]:[],te=j>=0?[{type:"line",x0:j,x1:j,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}}]:[],se={title:{text:`${i} ${Z} - current`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},barmode:"group",bargap:.15,hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:r.text,size:11}},margin:{l:70,r:30,t:50,b:80},xaxis:{tickmode:"array",tickvals:J,ticktext:Q,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Open Interest",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:ee,shapes:te};return{data:W,layout:se}},[s,r,c,i]),X=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"OI Tracker"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(U,{value:m,onValueChange:G,children:[e.jsx(M,{className:"w-[100px]",children:e.jsx($,{placeholder:"Exchange"})}),e.jsx(A,{children:ye.map(t=>e.jsx(D,{value:t.value,children:t.label},t.value))})]}),e.jsxs(oe,{open:F,onOpenChange:E,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(P,{variant:"outline",role:"combobox","aria-expanded":F,className:"w-[160px] justify-between",children:[i||"Underlying",e.jsx(fe,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(le,{className:"w-48 p-0",align:"start",children:e.jsxs(ce,{children:[e.jsx(de,{placeholder:"Search underlying..."}),e.jsxs(xe,{children:[e.jsx(pe,{children:"No underlying found"}),e.jsx(ue,{children:K.map(t=>e.jsxs(me,{value:t,onSelect:()=>{b(t),E(!1)},children:[e.jsx(ge,{className:`mr-2 h-4 w-4 ${i===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(U,{value:c,onValueChange:f,disabled:_.length===0,children:[e.jsx(M,{className:"w-[160px]",children:e.jsx($,{placeholder:"Expiry"})}),e.jsx(A,{children:_.map(t=>e.jsx(D,{value:t,children:t},t))})]}),e.jsx(P,{variant:"outline",size:"sm",onClick:B,disabled:S,children:S?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (OI): ",s.pcr_oi?.toFixed(2)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR (Vol): ",s.pcr_volume?.toFixed(2)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Total CE OI: ",Y(s.total_ce_oi||0)]}),e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-1",children:["Total PE OI: ",Y(s.total_pe_oi||0)]})]}),e.jsx(ae,{children:e.jsx(ne,{className:"p-2 sm:p-4",children:S&&!s?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Loading OI data..."}):s?.chain&&s.chain.length>0?e.jsx(he,{data:T.data,layout:T.layout,config:X,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:c?"No OI data available":"Select an underlying and expiry to view OI data"})})})]})}export{_e as default};
