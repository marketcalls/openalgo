import{r as o,j as e}from"./vendor-react-RhKMXzW9.js";import{d as K,o as Y,l as G,e as $,B as q,c as f,s as u}from"./index-CAFQPGlC.js";import{t as J}from"./trading-D_IhWH4J.js";import{C as b,b as T,d as C,c as L,a as X}from"./card-t6_eU0S_.js";import{T as Z,a as ee,b as k,c as h,d as te,e as i,f as se}from"./table-Dy5LZUMX.js";import{u as ae}from"./useMarketData-CaDaQee9.js";import{Q as ne,R as re,D as le,c as A,Y as F,L as ce}from"./vendor-icons-Chlwwn8V.js";import"./vendor-syntax-D6hV6JR3.js";import"./vendor-router-DdyOoyPF.js";import"./vendor-radix-B_grJx4K.js";function j(m){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(m)}function R(m){return`${m>=0?"+":""}${m.toFixed(2)}%`}function ge(){const{apiKey:m}=K(),[g,V]=o.useState([]),[N,B]=o.useState(null),[z,E]=o.useState(!0),[I,H]=o.useState(!1),[_,S]=o.useState(null),Q=o.useMemo(()=>g.map(t=>({symbol:t.symbol,exchange:t.exchange})),[g]),{data:w,isConnected:D}=ae({symbols:Q,mode:"LTP",enabled:g.length>0}),y=o.useMemo(()=>g.map(t=>{const n=`${t.exchange}:${t.symbol}`,l=w.get(n),r=t.quantity||0,v=t.pnl||0,c=l?.data?.ltp&&l.lastUpdate&&Date.now()-l.lastUpdate<5e3;let s=t.average_price;if(!s&&t.ltp&&r!==0&&(s=t.ltp-v/r),c&&l?.data?.ltp&&r!==0){const x=l.data.ltp;if(!s&&t.ltp&&(s=t.ltp-v/r),s){const P=(x-s)*r,U=Math.abs(s*r),O=U>0?P/U*100:0;return{...t,ltp:x,average_price:s,pnl:P,pnlpercent:O}}}return{...t,average_price:s}}),[g,w]),a=o.useMemo(()=>{if(!N||!y.some(c=>{const s=`${c.exchange}:${c.symbol}`,x=w.get(s);return x?.data?.ltp&&x.lastUpdate&&Date.now()-x.lastUpdate<5e3}))return N;let n=0,l=0,r=0;y.forEach(c=>{n+=c.pnl||0;const s=c.average_price||0,x=c.quantity||0,P=c.ltp||s;l+=s*x,r+=P*x});const v=l>0?n/l*100:0;return{...N,totalholdingvalue:r,totalinvvalue:l,totalprofitandloss:n,totalpnlpercentage:v}},[N,y,w]),d=o.useCallback(async(t=!1)=>{if(!m){E(!1);return}t&&H(!0);try{const n=await J.getHoldings(m);n.status==="success"&&n.data?(V(n.data.holdings||[]),B(n.data.statistics),S(null)):S(n.message||"Failed to fetch holdings")}catch{S("Failed to fetch holdings")}finally{E(!1),H(!1)}},[m]);o.useEffect(()=>{d();const n=setInterval(()=>d(),D?3e4:1e4);return()=>clearInterval(n)},[d,D]),o.useEffect(()=>{const t=Y(()=>{d()});return()=>t()},[d]);const M=o.useRef(null);o.useEffect(()=>{const t=window.location.protocol,n=window.location.hostname,l=window.location.port;M.current=G(`${t}//${n}:${l}`,{transports:["websocket","polling"]});const r=M.current;return r.on("order_event",()=>{setTimeout(()=>d(),500)}),r.on("analyzer_update",()=>{setTimeout(()=>d(),500)}),()=>{r.disconnect()}},[d]);const W=()=>{const t=["Symbol","Exchange","Quantity","Avg Price","LTP","Product","P&L","P&L %"],n=y.map(s=>[u(s.symbol),u(s.exchange),u(s.quantity),u(s.average_price),u(s.ltp),u(s.product),u(s.pnl),u(s.pnlpercent)]),l=[t,...n].map(s=>s.join(",")).join(`
`),r=new Blob([l],{type:"text/csv"}),v=URL.createObjectURL(r),c=document.createElement("a");c.href=v,c.download=`holdings_${new Date().toISOString().split("T")[0]}.csv`,c.click()},p=t=>t>=0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Investor Summary"}),D&&e.jsxs($,{variant:"outline",className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/30 gap-1",children:[e.jsx(ne,{className:"h-3 w-3 animate-pulse"}),"Live"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"View your holdings portfolio"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>d(!0),disabled:I,children:[e.jsx(re,{className:f("h-4 w-4 mr-2",I&&"animate-spin")}),"Refresh"]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:W,children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Export"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(b,{children:e.jsxs(T,{className:"pb-2",children:[e.jsx(C,{children:"Total Holding Value"}),e.jsx(L,{className:"text-2xl text-primary",children:a?j(a.totalholdingvalue):"---"})]})}),e.jsx(b,{children:e.jsxs(T,{className:"pb-2",children:[e.jsx(C,{children:"Total Investment Value"}),e.jsx(L,{className:"text-2xl",children:a?j(a.totalinvvalue):"---"})]})}),e.jsx(b,{children:e.jsxs(T,{className:"pb-2",children:[e.jsx(C,{children:"Total Profit and Loss"}),e.jsx(L,{className:f("text-2xl",a&&p(a.totalprofitandloss)?"text-green-600":"text-red-600"),children:a?e.jsxs("div",{className:"flex items-center gap-1",children:[p(a.totalprofitandloss)?e.jsx(A,{className:"h-5 w-5"}):e.jsx(F,{className:"h-5 w-5"}),j(a.totalprofitandloss)]}):"---"})]})}),e.jsx(b,{children:e.jsxs(T,{className:"pb-2",children:[e.jsx(C,{children:"Total PnL Percentage"}),e.jsx(L,{className:f("text-2xl",a&&p(a.totalpnlpercentage)?"text-green-600":"text-red-600"),children:a?R(a.totalpnlpercentage):"---"})]})})]}),e.jsx(b,{children:e.jsx(X,{className:"p-0",children:z?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ce,{className:"h-8 w-8 animate-spin"})}):_?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:_}):g.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No holdings found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(k,{children:[e.jsx(h,{children:"Trading Symbol"}),e.jsx(h,{children:"Exchange"}),e.jsx(h,{className:"text-right",children:"Quantity"}),e.jsx(h,{className:"text-right",children:"Avg Price"}),e.jsx(h,{className:"text-right",children:"LTP"}),e.jsx(h,{children:"Product"}),e.jsx(h,{className:"text-right",children:"Profit and Loss"}),e.jsx(h,{className:"text-right",children:"PnL %"})]})}),e.jsx(te,{children:y.map((t,n)=>e.jsxs(k,{children:[e.jsx(i,{className:"font-medium",children:t.symbol}),e.jsx(i,{children:e.jsx($,{variant:"outline",children:t.exchange})}),e.jsx(i,{className:"text-right font-mono",children:t.quantity}),e.jsx(i,{className:"text-right font-mono",children:t.average_price!==void 0?j(t.average_price):"-"}),e.jsx(i,{className:"text-right font-mono",children:t.ltp!==void 0?j(t.ltp):"-"}),e.jsx(i,{children:e.jsx($,{variant:"secondary",children:t.product})}),e.jsx(i,{className:f("text-right font-medium",p(t.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[p(t.pnl)?e.jsx(A,{className:"h-4 w-4"}):e.jsx(F,{className:"h-4 w-4"}),j(t.pnl)]})}),e.jsx(i,{className:f("text-right",p(t.pnlpercent)?"text-green-600":"text-red-600"),children:R(t.pnlpercent)})]},`${t.symbol}-${t.exchange}-${n}`))}),e.jsx(se,{children:e.jsxs(k,{className:"bg-muted/50",children:[e.jsx(i,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsx(i,{className:f("text-right font-bold",a&&p(a.totalprofitandloss)?"text-green-600":"text-red-600"),children:a?`${a.totalprofitandloss>=0?"+":""}${j(a.totalprofitandloss)}`:"-"}),e.jsx(i,{className:f("text-right font-bold",a&&p(a.totalpnlpercentage)?"text-green-600":"text-red-600"),children:a?R(a.totalpnlpercentage):"-"})]})})]})})})})]})}export{ge as default};
