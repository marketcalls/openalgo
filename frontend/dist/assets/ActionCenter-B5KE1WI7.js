import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{w as f,s as r,l as te,i as ae,B as p,e as d}from"./index-NHrG-O_Z.js";import{A as re,b as ne,a as le}from"./alert-BoGaKMRC.js";import{A as ie,b as ce,c as de,d as oe,e as xe,f as he,g as me,h as pe}from"./alert-dialog-DP5Vbj8e.js";import{C as u,d as g,a as ue,b as ge,c as je}from"./card-Cn20bp_v.js";import{C as fe,a as Ne}from"./collapsible-DcfHjv7p.js";import{T as ve,a as ye,b as y,c as o,d as we,e as c}from"./table-Crau903Y.js";import{T as be,a as Ae,b as w}from"./tabs-DnjOpX1p.js";import{I as Ce,N as _e,aj as Se,Y as b,m as M,k as Te,ak as De,al as Oe,am as Re,a2 as ke,X as Fe,an as $e}from"./vendor-icons-CCn_k3dF.js";import{L as S}from"./vendor-router-Dzc1xxhr.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-radix-CYVJEJRR.js";function Ve(){const[A,z]=n.useState([]),[l,H]=n.useState({total_pending:0,total_approved:0,total_rejected:0,total_buy_orders:0,total_sell_orders:0}),[U,Y]=n.useState(!0),[T,D]=n.useState(!1),[m,q]=n.useState("pending"),[O,K]=n.useState(new Set),[C,_]=n.useState(null),[R,k]=n.useState(!1),[F,$]=n.useState(null),[B,E]=n.useState(null),[I,P]=n.useState(!1),L=n.useRef(null),N=n.useRef(null),i=n.useCallback(async()=>{try{const s=m==="all"?"":m,t=await f.get(`/action-center/api/data${s?`?status=${s}`:""}`);t.data.status==="success"&&(z(Array.isArray(t.data.data.orders)?t.data.data.orders:[]),H(t.data.data.statistics||{total_pending:0,total_approved:0,total_rejected:0,total_buy_orders:0,total_sell_orders:0}))}catch{r.error("Failed to load action center data","actionCenter")}finally{Y(!1),D(!1)}},[m]);n.useEffect(()=>{if(i(),m==="pending"){const s=setInterval(i,3e4);return()=>clearInterval(s)}},[i,m]),n.useEffect(()=>{N.current=new Audio("/sounds/alert.mp3"),N.current.preload="auto";const s=window.location.protocol,t=window.location.hostname,a=window.location.port;L.current=te(`${s}//${t}:${a}`,{transports:["polling"],upgrade:!1});const h=L.current;return h.on("pending_order_created",x=>{const{shouldShowToast:j,shouldPlaySound:v}=ae.getState();v()&&j("actionCenter")&&N.current&&N.current.play().catch(()=>{}),r.warning(`New Order Queued: ${x.message}`,"actionCenter",{duration:5e3}),i()}),h.on("pending_order_updated",()=>{i()}),()=>{h.disconnect()}},[i]);const V=async()=>{D(!0),await i(),r.success("Data refreshed","actionCenter")},J=async s=>{$(s);try{const t=await f.post(`/action-center/approve/${s}`,{});t.data.status==="success"?(r.success(t.data.message||"Order approved and executed","actionCenter"),i()):t.data.status==="warning"?(r.warning(t.data.message,"actionCenter"),i()):r.error(t.data.message||"Failed to approve order","actionCenter")}catch(t){const a=t;r.error(a.response?.data?.message||"Failed to approve order","actionCenter")}finally{$(null)}},Q=async s=>{E(s);try{const t=await f.post(`/action-center/reject/${s}`,{reason:"Rejected by user"});t.data.status==="success"?(r.success("Order rejected","actionCenter"),i()):r.error(t.data.message||"Failed to reject order","actionCenter")}catch(t){const a=t;r.error(a.response?.data?.message||"Failed to reject order","actionCenter")}finally{E(null)}},W=async()=>{if(C){k(!0);try{const s=await f.delete(`/action-center/delete/${C.id}`);s.data.status==="success"?(r.success("Order deleted","actionCenter"),_(null),i()):r.error(s.data.message||"Failed to delete order","actionCenter")}catch(s){const t=s;r.error(t.response?.data?.message||"Failed to delete order","actionCenter")}finally{k(!1)}}},X=async()=>{P(!0);try{const s=await f.post("/action-center/approve-all",{});s.data.status==="success"?(r.success(s.data.message||"All orders approved","actionCenter"),i()):s.data.status==="warning"?(r.warning(s.data.message,"actionCenter"),i()):r.error(s.data.message||"Failed to approve all orders","actionCenter")}catch(s){const t=s;r.error(t.response?.data?.message||"Failed to approve all orders","actionCenter")}finally{P(!1)}},G=s=>{K(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})},Z=s=>{switch(s){case"NSE":return"default";case"NFO":return"secondary";default:return"outline"}},ee=s=>{switch(s){case"MARKET":return"default";case"LIMIT":return"secondary";case"SL":case"SL-M":return"destructive";default:return"outline"}},se=s=>{if(!s)return"";try{const t=new Date(s.replace(" IST","")),h=new Date().getTime()-t.getTime(),x=Math.floor(h/6e4);if(x<1)return"Just now";if(x===1)return"1 minute ago";if(x<60)return`${x} minutes ago`;const j=Math.floor(x/60);if(j===1)return"1 hour ago";if(j<24)return`${j} hours ago`;const v=Math.floor(j/24);return v===1?"Yesterday":`${v} days ago`}catch{return""}};return U?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs(re,{children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsx(ne,{children:"OpenAlgo Action Center"}),e.jsx(le,{children:"Centralized hub for managing semi-automated trading orders. When Semi-Auto mode is enabled in API Key settings, all incoming orders are queued here for manual approval before broker execution."})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(S,{to:"/dashboard",className:"text-muted-foreground hover:text-foreground",children:e.jsx(_e,{className:"h-4 w-4"})}),e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Se,{className:"h-6 w-6"}),"Action Center"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"Review and manage pending orders"})]}),e.jsxs("div",{className:"flex gap-2",children:[m==="pending"&&l.total_pending>0&&e.jsxs(p,{variant:"default",className:"bg-green-500 hover:bg-green-600",onClick:X,disabled:I,children:[I?e.jsx(b,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(M,{className:"h-4 w-4 mr-2"}),"Approve All (",l.total_pending,")"]}),e.jsxs(p,{variant:"outline",onClick:V,disabled:T,children:[e.jsx(b,{className:`h-4 w-4 mr-2 ${T?"animate-spin":""}`}),"Refresh"]}),e.jsx(S,{to:"/apikey",children:e.jsxs(p,{variant:"outline",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),"Toggle Order Mode"]})})]})]}),e.jsx(be,{value:m,onValueChange:s=>q(s),children:e.jsxs(Ae,{children:[e.jsxs(w,{value:"pending",className:"relative",children:["Pending",l.total_pending>0&&e.jsx(d,{variant:"destructive",className:"ml-2 animate-pulse",children:l.total_pending})]}),e.jsxs(w,{value:"approved",children:["Approved",l.total_approved>0&&e.jsx(d,{variant:"secondary",className:"ml-2 bg-green-500",children:l.total_approved})]}),e.jsxs(w,{value:"rejected",children:["Rejected",l.total_rejected>0&&e.jsx(d,{variant:"destructive",className:"ml-2",children:l.total_rejected})]}),e.jsx(w,{value:"all",children:"All Orders"})]})}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-5 gap-4",children:[e.jsx(u,{children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-yellow-500",children:l.total_pending}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pending Approval"})]})}),e.jsx(u,{children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-500",children:l.total_buy_orders}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Buy Orders"})]})}),e.jsx(u,{children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-red-500",children:l.total_sell_orders}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Sell Orders"})]})}),e.jsx(u,{children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-500",children:l.total_approved}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Approved"})]})}),e.jsx(u,{children:e.jsxs(g,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-red-500",children:l.total_rejected}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rejected"})]})})]}),e.jsxs(u,{children:[e.jsxs(ue,{children:[e.jsx(ge,{children:"Orders"}),e.jsxs(je,{children:[A.length," orders"]})]}),e.jsx(g,{children:e.jsx("div",{className:"border rounded-md",children:e.jsxs(ve,{children:[e.jsx(ye,{children:e.jsxs(y,{children:[e.jsx(o,{children:"Strategy"}),e.jsx(o,{children:"Symbol"}),e.jsx(o,{children:"Exchange"}),e.jsx(o,{children:"Action"}),e.jsx(o,{className:"text-right",children:"Quantity"}),e.jsx(o,{className:"text-right",children:"Price"}),e.jsx(o,{children:"Order Type"}),e.jsx(o,{children:"Product"}),e.jsx(o,{children:"Created"}),e.jsx(o,{children:"Actions"})]})}),e.jsx(we,{children:A.length===0?e.jsx(y,{children:e.jsx(c,{colSpan:10,className:"text-center text-muted-foreground py-8",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{children:"No orders found"}),e.jsxs("p",{className:"text-sm",children:["Enable Semi-Auto mode in"," ",e.jsx(S,{to:"/apikey",className:"text-primary hover:underline",children:"API Key settings"})," ","to queue orders here"]})]})})}):A.map(s=>e.jsxs(e.Fragment,{children:[e.jsxs(y,{children:[e.jsxs(c,{children:[e.jsx(d,{variant:"outline",children:s.strategy}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s.api_type})]}),e.jsx(c,{className:"font-medium",children:s.symbol}),e.jsx(c,{children:e.jsx(d,{variant:Z(s.exchange),children:s.exchange})}),e.jsx(c,{children:e.jsxs(d,{className:`gap-1 ${s.action==="BUY"?"bg-green-500 hover:bg-green-600":"bg-red-500 hover:bg-red-600"}`,children:[s.action==="BUY"?e.jsx(De,{className:"h-3 w-3"}):e.jsx(Oe,{className:"h-3 w-3"}),s.action]})}),e.jsx(c,{className:"text-right font-mono",children:s.quantity}),e.jsx(c,{className:"text-right font-mono",children:s.price||0}),e.jsx(c,{children:e.jsx(d,{variant:ee(s.price_type),children:s.price_type})}),e.jsx(c,{children:e.jsx(d,{variant:"secondary",children:s.product_type})}),e.jsxs(c,{children:[e.jsx("div",{className:"text-sm font-mono",children:s.created_at_ist}),e.jsx("div",{className:"text-xs text-muted-foreground",children:se(s.created_at_ist)})]}),e.jsx(c,{children:e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[e.jsx(p,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>G(s.id),children:O.has(s.id)?e.jsx(Re,{className:"h-4 w-4"}):e.jsx(ke,{className:"h-4 w-4"})}),s.status==="pending"?e.jsxs(e.Fragment,{children:[e.jsx(p,{size:"sm",className:"bg-green-500 hover:bg-green-600 h-8",onClick:()=>J(s.id),disabled:F===s.id,children:F===s.id?e.jsx(b,{className:"h-4 w-4 animate-spin"}):e.jsx(M,{className:"h-4 w-4"})}),e.jsx(p,{size:"sm",variant:"destructive",className:"h-8",onClick:()=>Q(s.id),disabled:B===s.id,children:B===s.id?e.jsx(b,{className:"h-4 w-4 animate-spin"}):e.jsx(Fe,{className:"h-4 w-4"})})]}):e.jsx(p,{size:"sm",variant:"ghost",className:"h-8 text-destructive hover:text-destructive",onClick:()=>_(s),children:e.jsx($e,{className:"h-4 w-4"})})]})})]},s.id),O.has(s.id)&&e.jsx(y,{children:e.jsx(c,{colSpan:10,className:"bg-muted/50 p-4",children:e.jsx(fe,{open:!0,children:e.jsx(Ne,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold",children:"Order Details"}),s.api_type==="basketorder"&&s.raw_order_data.orders?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Basket Order with"," ",Array.isArray(s.raw_order_data.orders)?s.raw_order_data.orders.length:0," ","orders"]}),Array.isArray(s.raw_order_data.orders)&&s.raw_order_data.orders.map((t,a)=>e.jsx(u,{children:e.jsxs(g,{className:"p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(d,{variant:"outline",children:["Order ",a+1]}),e.jsx("span",{className:"font-medium",children:String(t.symbol||"")}),e.jsx(d,{className:t.action==="BUY"?"bg-green-500":"bg-red-500",children:String(t.action||"")})]}),e.jsx("div",{className:"grid grid-cols-4 gap-2 text-sm",children:Object.entries(t).map(([h,x])=>e.jsxs("div",{children:[e.jsxs("span",{className:"text-muted-foreground",children:[h,":"]})," ",e.jsx("span",{className:"font-medium",children:String(x)})]},h))})]})},a))]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:Object.entries(s.raw_order_data).map(([t,a])=>e.jsxs("div",{className:"bg-background rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground uppercase",children:t}),e.jsx("p",{className:"font-medium break-all",children:typeof a=="object"?JSON.stringify(a,null,2):String(a)})]},t))})]})})})})})]}))})]})})})]}),e.jsx(ie,{open:!!C,onOpenChange:()=>_(null),children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(oe,{children:"Delete Order?"}),e.jsx(xe,{children:"Are you sure you want to delete this order? This action cannot be undone."})]}),e.jsxs(he,{children:[e.jsx(me,{children:"Cancel"}),e.jsx(pe,{onClick:W,disabled:R,children:R?"Deleting...":"Delete"})]})]})})]})}export{Ve as default};
