import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{w as V,u as ae,s as O,B as E,e as b}from"./index-NHrG-O_Z.js";import{C as U,d as R}from"./card-Cn20bp_v.js";import{P as ne,a as ie,b as le,C as oe,c as ce,d as de,e as ue,f as pe,g as xe}from"./popover-DQlNqO83.js";import{S as L,a as D,b as Y,c as G,d as H}from"./select-DcHsBqkV.js";import{P as me}from"./react-plotly-DV3gd5yC.js";import{aV as fe,m as he}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const F={getIVSmileData:async l=>(await V.post("/ivsmile/api/iv-smile-data",l)).data,getUnderlyings:async l=>(await V.get(`/search/api/underlyings?exchange=${l}`)).data,getExpiries:async(l,c)=>(await V.get(`/search/api/expiries?exchange=${l}&underlying=${c}`)).data},ge=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],X={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},ye=3e4;function q(l){if(!l)return"";const c=l.split("-");return c.length===3?`${c[0]}${c[1].toUpperCase()}${c[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function Ee(){const{mode:l,appMode:c}=ae(),f=c==="analyzer",x=l==="dark"||f,[m,K]=n.useState("NFO"),[J,w]=n.useState(X.NFO),[T,A]=n.useState(!1),[u,S]=n.useState("NIFTY"),[P,g]=n.useState([]),[o,h]=n.useState(""),[r,I]=n.useState(null),[k,$]=n.useState(!1),[y,Q]=n.useState(!1),v=n.useRef(0),j=n.useRef(null);n.useEffect(()=>{const t=X[m]||[];w(t),S(t[0]||""),g([]),h(""),I(null);let s=!1;return(async()=>{try{const d=await F.getUnderlyings(m);if(s)return;d.status==="success"&&d.underlyings.length>0&&(w(d.underlyings),d.underlyings.includes(t[0])||S(d.underlyings[0]))}catch{}})(),()=>{s=!0}},[m]),n.useEffect(()=>{if(!u)return;g([]),h(""),I(null);let t=!1;return(async()=>{try{const i=await F.getExpiries(m,u);if(t)return;i.status==="success"&&i.expiries.length>0?(g(i.expiries),h(i.expiries[0])):(g([]),h(""))}catch{if(t)return;g([]),h("")}})(),()=>{t=!0}},[u]);const N=n.useCallback(async()=>{if(!o)return;const t=++v.current;$(!0);try{const s=q(o),i=await F.getIVSmileData({underlying:u,exchange:m,expiry_date:s});if(v.current!==t)return;i.status==="success"?I(i):O.error(i.message||"Failed to fetch IV Smile data")}catch{if(v.current!==t)return;O.error("Failed to fetch IV Smile data")}finally{v.current===t&&$(!1)}},[u,o,m]);n.useEffect(()=>{o&&N()},[o]),n.useEffect(()=>(y&&o&&(j.current=setInterval(N,ye)),()=>{j.current&&(clearInterval(j.current),j.current=null)}),[y,N,o]);const a=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:x?"#e0e0e0":"#333333",grid:x?f?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",callIV:"#3b82f6",putIV:"#ef4444",spotLine:x?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:x?f?"#2d2545":"#1e293b":"#ffffff",hoverFont:x?"#e0e0e0":"#333333",hoverBorder:x?f?"#7c3aed":"#475569":"#e2e8f0"}),[x,f]),W=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),C=n.useMemo(()=>{if(!r?.chain)return{data:[],layout:{}};const t=r.chain,s=r.spot_price,i=r.atm_strike,d=t.filter(p=>p.ce_iv!==null||p.pe_iv!==null);if(d.length===0)return{data:[],layout:{}};const B=d.map(p=>p.strike),Z=d.map(p=>p.ce_iv),ee=d.map(p=>p.pe_iv),te=[{x:B,y:Z,type:"scatter",mode:"lines+markers",name:"Call IV",line:{color:a.callIV,width:2.5},marker:{size:4,color:a.callIV},hovertemplate:"Strike: %{x}<br>Call IV: %{y:.2f}%<extra></extra>",connectgaps:!0},{x:B,y:ee,type:"scatter",mode:"lines+markers",name:"Put IV",line:{color:a.putIV,width:2.5},marker:{size:4,color:a.putIV},hovertemplate:"Strike: %{x}<br>Put IV: %{y:.2f}%<extra></extra>",connectgaps:!0}],_=[],M=[];s&&(_.push({type:"line",x0:s,x1:s,y0:0,y1:1,yref:"paper",line:{color:a.spotLine,width:1.5,dash:"dash"}}),M.push({x:s,y:1,yref:"paper",text:`Spot ${s?.toFixed(1)}`,showarrow:!1,font:{color:a.text,size:11},yanchor:"bottom"})),i&&i!==s&&_.push({type:"line",x0:i,x1:i,y0:0,y1:1,yref:"paper",line:{color:a.spotLine,width:1,dash:"dot"}});const se=q(o),re={title:{text:`${u} ${se} - IV Smile`,font:{color:a.text,size:14}},paper_bgcolor:a.paper,plot_bgcolor:a.bg,font:{color:a.text,family:"system-ui, sans-serif"},hovermode:"x unified",hoverlabel:{bgcolor:a.hoverBg,font:{color:a.hoverFont,size:12},bordercolor:a.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.15,font:{color:a.text,size:11}},margin:{l:60,r:30,t:50,b:80},xaxis:{title:{text:"Strike Price",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,tickangle:-45},yaxis:{title:{text:"Implied Volatility (%)",font:{color:a.text,size:12}},tickfont:{color:a.text,size:10},gridcolor:a.grid,ticksuffix:"%"},annotations:M,shapes:_};return{data:te,layout:re}},[r,a,o,u]),z=n.useMemo(()=>{if(!r?.chain||!r.atm_strike)return[];const t=r.atm_strike;return r.chain.filter(s=>Math.abs(s.strike-t)/t<=.05&&(s.ce_iv!==null||s.pe_iv!==null)).map(s=>({strike:s.strike,ce_iv:s.ce_iv,pe_iv:s.pe_iv,diff:s.ce_iv!==null&&s.pe_iv!==null?s.pe_iv-s.ce_iv:null,isATM:s.strike===t}))},[r]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"IV Smile"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(L,{value:m,onValueChange:K,children:[e.jsx(D,{className:"w-[100px]",children:e.jsx(Y,{placeholder:"Exchange"})}),e.jsx(G,{children:ge.map(t=>e.jsx(H,{value:t.value,children:t.label},t.value))})]}),e.jsxs(ne,{open:T,onOpenChange:A,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(E,{variant:"outline",role:"combobox","aria-expanded":T,className:"w-[160px] justify-between",children:[u||"Underlying",e.jsx(fe,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(le,{className:"w-48 p-0",align:"start",children:e.jsxs(oe,{children:[e.jsx(ce,{placeholder:"Search underlying..."}),e.jsxs(de,{children:[e.jsx(ue,{children:"No underlying found"}),e.jsx(pe,{children:J.map(t=>e.jsxs(xe,{value:t,onSelect:()=>{S(t),A(!1)},children:[e.jsx(he,{className:`mr-2 h-4 w-4 ${u===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(L,{value:o,onValueChange:h,disabled:P.length===0,children:[e.jsx(D,{className:"w-[160px]",children:e.jsx(Y,{placeholder:"Expiry"})}),e.jsx(G,{children:P.map(t=>e.jsx(H,{value:t,children:t},t))})]}),e.jsx(E,{variant:y?"default":"outline",size:"sm",onClick:()=>Q(!y),children:y?"Auto: ON":"Auto: OFF"}),e.jsx(E,{variant:"outline",size:"sm",onClick:N,disabled:k,children:k?"Loading...":"Refresh"})]})]}),r&&r.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",r.spot_price?.toFixed(1)]}),e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",r.atm_strike]}),r.atm_iv!==null&&r.atm_iv!==void 0&&e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM IV: ",r.atm_iv,"%"]}),r.skew!==null&&r.skew!==void 0&&e.jsxs(b,{variant:"secondary",className:"text-sm px-3 py-1",children:["Skew (25d): ",r.skew>0?"+":"",r.skew,"%"]})]}),e.jsx(U,{children:e.jsx(R,{className:"p-2 sm:p-4",children:k&&!r?e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:"Loading IV Smile data..."}):C.data.length>0?e.jsx(me,{data:C.data,layout:C.layout,config:W,useResizeHandler:!0,style:{width:"100%",height:"500px"}}):e.jsx("div",{className:"flex items-center justify-center h-[500px] text-muted-foreground",children:o?"No IV data available":"Select an underlying and expiry to view IV Smile"})})}),z.length>0&&e.jsx(U,{children:e.jsxs(R,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"IV Near ATM"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 px-3 font-medium text-muted-foreground",children:"Strike"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-blue-500",children:"Call IV"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-red-500",children:"Put IV"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Diff (PE-CE)"})]})}),e.jsx("tbody",{children:z.map(t=>e.jsxs("tr",{className:`border-b border-border/50 last:border-0 ${t.isATM?"bg-muted/50 font-medium":""}`,children:[e.jsxs("td",{className:"py-2 px-3",children:[t.strike,t.isATM&&e.jsx("span",{className:"ml-1 text-xs text-muted-foreground",children:"(ATM)"})]}),e.jsx("td",{className:"text-right py-2 px-3 text-blue-500",children:t.ce_iv!==null?`${t.ce_iv}%`:"-"}),e.jsx("td",{className:"text-right py-2 px-3 text-red-500",children:t.pe_iv!==null?`${t.pe_iv}%`:"-"}),e.jsx("td",{className:`text-right py-2 px-3 ${t.diff!==null&&t.diff>0?"text-red-500":t.diff!==null&&t.diff<0?"text-blue-500":"text-muted-foreground"}`,children:t.diff!==null?`${t.diff>0?"+":""}${t.diff.toFixed(2)}%`:"-"})]},t.strike))})]})})]})})]})}export{Ee as default};
