import{r as s}from"./vendor-react--vsXx8_n.js";import{t as I}from"./trading-BY87V3rv.js";import{d as F}from"./index-nOKaJn6t.js";async function W(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function j({symbols:e,mode:S="LTP",enabled:r=!0,autoReconnect:k=!0}){const[M,P]=s.useState(new Map),[n,c]=s.useState(!1),[a,l]=s.useState(!1),[u,m]=s.useState(!1),[T,x]=s.useState(null),C=s.useRef(null),v=s.useRef(null),R=s.useRef(new Set),L=s.useRef([]),O=s.useCallback(async()=>W(),[]),t=s.useCallback(_=>{if(!C.current||C.current.readyState!==WebSocket.OPEN||!a){L.current=_;return}const f=_.filter(d=>{const D=`${d.exchange}:${d.symbol}`;return!R.current.has(D)});f.length!==0&&(C.current.send(JSON.stringify({action:"subscribe",symbols:f,mode:S})),f.forEach(d=>{const D=`${d.exchange}:${d.symbol}`;R.current.add(D),P(h=>{const i=new Map(h);return i.has(D)||i.set(D,{symbol:d.symbol,exchange:d.exchange,data:{}}),i})}))},[a,S]),p=s.useCallback(_=>{try{const f=JSON.parse(_.data);switch(f.type||f.status){case"auth":f.status==="success"?(l(!0),x(null),L.current.length>0&&setTimeout(()=>{t(L.current),L.current=[]},100)):x(`Authentication failed: ${f.message}`);break;case"market_data":{const D=f.symbol.toUpperCase(),h=f.exchange,i=f.data||{},y=`${h}:${D}`;P(w=>{const $=w.get(y);if(!$)return w;const E=new Map(w),b={...$.data};return Object.assign(b,{ltp:i.ltp??b.ltp,open:i.open??b.open,high:i.high??b.high,low:i.low??b.low,close:i.close??b.close,volume:i.volume??b.volume,change:i.change??b.change,change_percent:i.change_percent??b.change_percent,timestamp:i.timestamp??b.timestamp}),E.set(y,{...$,data:b,lastUpdate:Date.now()}),E});break}case"subscribe":break;case"error":x(`WebSocket error: ${f.message}`);break}}catch{}},[t]),o=s.useCallback(async()=>{if(C.current?.readyState!==WebSocket.OPEN){m(!0),x(null);try{const _=await O(),d=await(await fetch("/api/websocket/config",{headers:{"X-CSRFToken":_},credentials:"include"})).json();if(d.status!=="success")throw new Error("Failed to get WebSocket configuration");const D=d.websocket_url,h=new WebSocket(D);h.onopen=async()=>{c(!0),m(!1);try{const i=await O(),w=await(await fetch("/api/websocket/apikey",{headers:{"X-CSRFToken":i},credentials:"include"})).json();w.status==="success"&&w.api_key?h.send(JSON.stringify({action:"authenticate",api_key:w.api_key})):x("No API key found - please generate one at /apikey")}catch(i){x(`Authentication error: ${i}`)}},h.onclose=i=>{c(!1),m(!1),l(!1),R.current.clear(),k&&!i.wasClean&&r&&(v.current=setTimeout(o,3e3))},h.onerror=()=>{x("WebSocket connection error"),m(!1)},h.onmessage=p,C.current=h}catch(_){x(`Connection failed: ${_}`),m(!1)}}},[O,p,k,r]),g=s.useCallback(()=>{v.current&&(clearTimeout(v.current),v.current=null),C.current&&(C.current.close(1e3,"User disconnect"),C.current=null),c(!1),l(!1),R.current.clear()},[]);return s.useEffect(()=>(r&&e.length>0&&!n&&!u&&o(),()=>{v.current&&clearTimeout(v.current)}),[r,e.length,n,u,o]),s.useEffect(()=>{a&&e.length>0&&t(e)},[a,e,t]),s.useEffect(()=>()=>{g()},[g]),{data:M,isConnected:n,isAuthenticated:a,isConnecting:u,error:T,connect:o,disconnect:g}}async function K(){return(await(await fetch("/auth/csrf-token",{credentials:"include"})).json()).csrf_token}function U(){const[e,S]=s.useState({timings:[],holidays:[],isLoading:!0,error:null});s.useEffect(()=>{(async()=>{try{const a={"X-CSRFToken":await K(),"Content-Type":"application/json"},[l,u]=await Promise.all([fetch("/admin/api/timings",{headers:a,credentials:"include"}),fetch("/admin/api/holidays",{headers:a,credentials:"include"})]),m=await l.json(),T=await u.json();S({timings:m.status==="success"?m.market_status||[]:[],holidays:T.status==="success"?T.data||[]:[],isLoading:!1,error:null})}catch(c){S(a=>({...a,isLoading:!1,error:`Failed to fetch market status: ${c}`}))}})()},[]);const r=s.useCallback(n=>{const c=new Date().toISOString().split("T")[0],a=e.holidays.find(l=>l.date===c);if(!a)return!1;if(a.closed_exchanges.includes(n)){const l=a.open_exchanges.find(u=>u.exchange===n);if(l){const u=Date.now();return!(u>=l.start_time&&u<=l.end_time)}return!0}return!1},[e.holidays]),k=s.useCallback(n=>{if(r(n))return!1;const c=e.timings.find(l=>l.exchange===n);if(!c)return!1;const a=Date.now();return a>=c.start_time&&a<=c.end_time},[e.timings,r]),M=s.useCallback(()=>e.timings.some(n=>{const c=Date.now();return c>=n.start_time&&c<=n.end_time&&!r(n.exchange)}),[e.timings,r]),P=s.useCallback(n=>{if(r(n))return"closed";const c=e.timings.find(u=>u.exchange===n);if(!c)return"closed";const a=Date.now(),l=900*1e3;return a<c.start_time-l?"closed":a<c.start_time?"pre-market":a<=c.end_time?"open":"post-market"},[e.timings,r]);return{isMarketOpen:k,isAnyMarketOpen:M,isHolidayForExchange:r,getMarketStatus:P,timings:e.timings,holidays:e.holidays,isLoading:e.isLoading,error:e.error}}function J(e,S={}){const{enabled:r=!0,staleThreshold:k=5e3,useMultiQuotesFallback:M=!0,multiQuotesRefreshInterval:P=3e4}=S,{apiKey:n}=F(),{isMarketOpen:c,isAnyMarketOpen:a}=U(),l=a(),u=typeof window<"u"&&(window.localStorage.getItem("debug_live_price")==="1"||window.localStorage.getItem("debug_live_price")==="true"),[m,T]=s.useState(new Map),x=s.useMemo(()=>e.map(t=>({symbol:t.symbol,exchange:t.exchange})),[e]),{data:C,isConnected:v}=j({symbols:x,mode:"LTP",enabled:r&&e.length>0}),R=v&&l,L=s.useCallback(async()=>{if(!(!n||e.length===0||!M))try{const t=e.map(o=>({symbol:o.symbol,exchange:o.exchange}));u&&console.debug("[useLivePrice] MultiQuotes request",{count:t.length,sample:t.slice(0,5)});const p=await I.getMultiQuotes(n,t);if(u&&console.debug("[useLivePrice] MultiQuotes response",{status:p.status,resultsCount:p.results?.length??0,message:p.message,sampleKeys:p.results?.slice(0,5).map(o=>`${o.exchange}:${o.symbol}`)??[]}),p.status==="success"&&p.results){const o=new Map;p.results.forEach(g=>{const _=`${g.exchange}:${g.symbol}`;g.data&&o.set(_,g.data)}),u&&console.debug("[useLivePrice] MultiQuotes mapped",{mappedCount:o.size}),T(o)}}catch(t){u&&console.debug("[useLivePrice] MultiQuotes fetch failed",t)}},[n,e,M]);return s.useEffect(()=>{if(!r||e.length===0||!M)return;u&&console.debug("[useLivePrice] enabled",{enabled:r,itemsCount:e.length,apiKeyPresent:!!n,useMultiQuotesFallback:M}),L();const t=setInterval(L,P);return()=>clearInterval(t)},[r,e.length,M,L,P]),{data:s.useMemo(()=>(u&&r&&e.length>0&&console.debug("[useLivePrice] enhance items",{itemsCount:e.length,wsConnected:v,marketDataKeysSample:Array.from(C.keys()).slice(0,5),multiQuotesKeysSample:Array.from(m.keys()).slice(0,5)}),e.map(t=>{const p=`${t.exchange}:${t.symbol}`,o=C.get(p),g=m.get(p),_=t.quantity!==void 0&&t.quantity!==null,f=t.quantity||0,d=t.average_price||0,D=c(t.exchange),h=D&&o?.data?.ltp&&o.lastUpdate&&Date.now()-o.lastUpdate<k,i=!h&&g?.ltp;let y,w="rest";const $=o?.lastUpdate?Date.now()-o.lastUpdate:null,E=o?.data?.ltp,b=g?.ltp;if(h&&o?.data?.ltp?(y=o.data.ltp,w="websocket"):i&&g?.ltp?(y=g.ltp,w="multiquotes"):(y=t.ltp,w="rest"),u){const Q=e.indexOf(t);Q>-1&&Q<5&&console.debug("[useLivePrice] decision",{key:p,exchange:t.exchange,exchangeMarketOpen:D,staleThreshold:k,wsConnected:v,wsHasData:!!o,wsLtp:E,wsAgeMs:$,mqHasData:!!g,mqLtp:b,hasWsData:h,hasMqData:i,selectedSource:w,selectedLtp:y})}if(_&&f===0)return{...t,_dataSource:"rest"};let q=t.pnl||0,A=t.pnlpercent||0;return y&&d>0&&(f>0?(q=(y-d)*f,A=(y-d)/d*100):(q=(d-y)*Math.abs(f),A=(d-y)/d*100)),{...t,ltp:y,pnl:q,pnlpercent:A,_dataSource:w}})),[e,C,m,c,k]),isLive:R,isConnected:v,isAnyMarketOpen:l,multiQuotes:m,refreshMultiQuotes:L}}function X(e,S){if(!S)return null;let r=0,k=0,M=0;e.forEach(n=>{r+=n.pnl||0;const c=n.average_price||0,a=n.quantity||0,l=n.ltp||c;k+=c*a,M+=l*a});const P=k>0?r/k*100:0;return{...S,totalholdingvalue:M,totalinvvalue:k,totalprofitandloss:r,totalpnlpercentage:P}}export{X as c,J as u};
