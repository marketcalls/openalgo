import{r as a,j as e}from"./vendor-react-RhKMXzW9.js";import{u as ae,d as $e,t as S,c as H,B as f,e as z,D as Fe,h as Re,i as Oe,p as Ue,j as B,k as Pe,m as Ve}from"./index-VXMZv-HQ.js";import{C as y,a as C}from"./card-BBNb6tnJ.js";import{P as Ae,a as He,b as Be,C as _e,c as We,d as qe,e as Ge,f as Ze,g as Ke}from"./popover-IhJKGTp_.js";import{I as re}from"./input-CbrDfPZA.js";import{S as Ye,a as Je,b as Qe,c as Xe,d as es}from"./select-sZOKs1_E.js";import{q as ss,K as ts,W as as,R as rs,V as ns}from"./lightweight-charts.production-BQUuleWj.js";import{A as os,D as ne,S as ls,ai as cs,R as is,Z as oe,g as le,L as ds,k as ms,l as hs,aF as us,aG as xs,N as gs,m as fs,n as ps}from"./vendor-icons-Ca5eNZvr.js";import{a as js,c as vs,d as Ss,L as _}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-DzupMptF.js";import"./vendor-radix-gKv__6YA.js";function Es(){const E=js(),{mode:I,toggleMode:ce,appMode:u,toggleAppMode:ie,isTogglingMode:W}=ae(),{user:$,logout:q}=$e(),d=I==="dark"||u==="analyzer",{symbol:de}=vs(),[G,Z]=Ss(),me=async()=>{try{await Ve.logout(),q(),E("/login"),S.success("Logged out successfully")}catch{q(),E("/login")}},K=async()=>{const s=await ie();if(s.success){const t=ae.getState().appMode;S.success(`Switched to ${t==="live"?"Live":"Analyze"} mode`)}else S.error(s.message||"Failed to toggle mode")},[b,he]=a.useState([]),[x,ue]=a.useState(null),[Y,J]=a.useState(!1),[F,R]=a.useState(!1),[o,xe]=a.useState(de||""),[l,ge]=a.useState(G.get("exchange")||"NSE"),[c,fe]=a.useState(G.get("interval")||"D"),[pe,Q]=a.useState(!1),[D,X]=a.useState(""),[O,je]=a.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-6),s.toISOString().split("T")[0]}),[U,ve]=a.useState(()=>new Date().toISOString().split("T")[0]),[r,Se]=a.useState([]),[M,be]=a.useState(null),g=a.useRef(null),h=a.useRef(null),Ne=a.useRef(null),we=a.useRef(null),ye=a.useMemo(()=>x?[...x.seconds,...x.minutes,...x.hours,...x.days,...x.weeks,...x.months]:["D"],[x]),P=a.useMemo(()=>{const s=new Map;return b.forEach(t=>{const i=`${t.symbol}:${t.exchange}`;s.has(i)?s.get(i).intervals.push(t.interval):s.set(i,{symbol:t.symbol,exchange:t.exchange,intervals:[t.interval]})}),Array.from(s.values())},[b]),Ce=a.useMemo(()=>{if(!D)return P;const s=D.toLowerCase();return P.filter(t=>t.symbol.toLowerCase().includes(s)||t.exchange.toLowerCase().includes(s))},[P,D]);a.useEffect(()=>{De(),Me()},[]),a.useEffect(()=>{o&&l&&c&&Z({exchange:l,interval:c})},[o,l,c,Z]),a.useEffect(()=>{o&&l&&c&&(ee(),Le())},[o,l,c]),a.useEffect(()=>{if(!g.current)return;const s=setTimeout(()=>{if(!g.current)return;h.current&&(h.current.remove(),h.current=null);const p=g.current,L=p.offsetWidth||800,k=p.offsetHeight||600,V=["1s","5s","10s","15s","30s","1m","2m","3m","5m","10m","15m","30m","1h","2h","4h"].includes(c),ze=N=>{const w=new Date(N*1e3),n=5.5*60*60*1e3,m=new Date(w.getTime()+n),j=m.getUTCDate().toString().padStart(2,"0"),v=(m.getUTCMonth()+1).toString().padStart(2,"0"),te=m.getUTCFullYear().toString().slice(-2),Ee=m.getUTCHours().toString().padStart(2,"0"),Ie=m.getUTCMinutes().toString().padStart(2,"0");return V?`${j}/${v}/${te} ${Ee}:${Ie}`:`${j}/${v}/${te}`},T=ss(p,{width:L,height:Math.max(k,500),layout:{background:{type:as.Solid,color:"transparent"},textColor:d?"#a6adbb":"#333"},grid:{vertLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"},horzLines:{color:d?"rgba(166, 173, 187, 0.1)":"rgba(0, 0, 0, 0.1)"}},localization:{timeFormatter:ze},rightPriceScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",scaleMargins:{top:.1,bottom:.25}},timeScale:{borderColor:d?"rgba(166, 173, 187, 0.2)":"rgba(0, 0, 0, 0.2)",timeVisible:V,secondsVisible:!1,tickMarkFormatter:N=>{const w=new Date(N*1e3),n=5.5*60*60*1e3,m=new Date(w.getTime()+n);if(V){const j=m.getUTCHours().toString().padStart(2,"0"),v=m.getUTCMinutes().toString().padStart(2,"0");return`${j}:${v}`}else{const j=m.getUTCDate().toString().padStart(2,"0"),v=(m.getUTCMonth()+1).toString().padStart(2,"0");return`${j}/${v}`}}},crosshair:{mode:ts.Normal,vertLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelVisible:!0,labelBackgroundColor:d?"#1f2937":"#374151"},horzLine:{width:1,color:d?"rgba(166, 173, 187, 0.5)":"rgba(0, 0, 0, 0.3)",style:2,labelBackgroundColor:d?"#1f2937":"#374151"}}}),se=T.addSeries(rs,{upColor:"#22c55e",downColor:"#ef4444",borderVisible:!1,wickUpColor:"#22c55e",wickDownColor:"#ef4444"}),A=T.addSeries(ns,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:""});if(A.priceScale().applyOptions({scaleMargins:{top:.8,bottom:0}}),h.current=T,Ne.current=se,we.current=A,r.length>0){const N=r.map(n=>({time:n.timestamp,open:n.open,high:n.high,low:n.low,close:n.close}));se.setData(N);const w=r.map(n=>({time:n.timestamp,value:n.volume,color:n.close>=n.open?"rgba(34, 197, 94, 0.5)":"rgba(239, 68, 68, 0.5)"}));A.setData(w),T.timeScale().fitContent()}},100),t=()=>{if(h.current&&g.current){const p=g.current,L=p.offsetWidth,k=p.offsetHeight;L>0&&k>0&&h.current.applyOptions({width:L,height:k})}},i=new ResizeObserver(t);return g.current&&i.observe(g.current),window.addEventListener("resize",t),()=>{clearTimeout(s),i.disconnect(),window.removeEventListener("resize",t),h.current&&(h.current.remove(),h.current=null)}},[d,r,F]);const De=async()=>{try{const t=await(await fetch("/historify/api/catalog",{credentials:"include"})).json();t.status==="success"&&he(t.data||[])}catch(s){console.error("Error loading catalog:",s)}},Me=async()=>{try{const t=await(await fetch("/historify/api/intervals",{credentials:"include"})).json();t.status==="success"&&ue(t.data)}catch(s){console.error("Error loading intervals:",s)}},ee=a.useCallback(async()=>{if(!(!o||!l)){J(!0);try{const s=new URLSearchParams({symbol:o,exchange:l,interval:c,start_date:O,end_date:U}),i=await(await fetch(`/historify/api/data?${s}`,{credentials:"include"})).json();i.status==="success"?(Se(i.data||[]),i.count===0&&S.info("No data available for this range")):S.error(i.message||"Failed to load chart data")}catch(s){console.error("Error loading chart data:",s),S.error("Failed to load chart data")}finally{J(!1)}}},[o,l,c,O,U]),Le=a.useCallback(()=>{const s=b.find(t=>t.symbol===o&&t.exchange===l&&t.interval===c);be(s||null)},[b,o,l,c]),ke=(s,t)=>{xe(s),ge(t),Q(!1),X("")},Te=()=>{document.fullscreenElement?(document.exitFullscreen(),R(!1)):(document.documentElement.requestFullscreen(),R(!0))};return a.useEffect(()=>{const s=()=>{R(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",s),()=>document.removeEventListener("fullscreenchange",s)},[]),e.jsxs("div",{className:H("h-full flex flex-col bg-background text-foreground",F&&"fixed inset-0 z-50"),children:[e.jsxs("div",{className:"h-14 border-b border-border flex items-center px-4 bg-card/50",children:[e.jsx(f,{variant:"ghost",size:"icon",className:"mr-2",asChild:!0,children:e.jsx(_,{to:"/historify",children:e.jsx(os,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Historify Charts"})]}),e.jsxs("div",{className:"flex items-center gap-3 ml-6",children:[e.jsxs(Ae,{open:pe,onOpenChange:Q,children:[e.jsx(He,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-64 justify-between",children:[o?e.jsxs("span",{children:[o,":",l]}):e.jsx("span",{className:"text-muted-foreground",children:"Select symbol..."}),e.jsx(ls,{className:"h-4 w-4 ml-2"})]})}),e.jsx(Be,{className:"w-64 p-0",align:"start",children:e.jsxs(_e,{children:[e.jsx(We,{placeholder:"Search symbols...",value:D,onValueChange:X}),e.jsxs(qe,{children:[e.jsx(Ge,{children:"No symbols found"}),e.jsx(Ze,{children:Ce.slice(0,20).map(s=>e.jsxs(Ke,{value:`${s.symbol}:${s.exchange}`,onSelect:()=>ke(s.symbol,s.exchange),children:[e.jsx("span",{className:"font-medium",children:s.symbol}),e.jsx(z,{variant:"outline",className:"ml-2 text-[10px]",children:s.exchange}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-auto",children:[s.intervals.length," intervals"]})]},`${s.symbol}:${s.exchange}`))})]})]})})]}),e.jsxs(Ye,{value:c,onValueChange:fe,children:[e.jsx(Je,{className:"w-24",children:e.jsx(Qe,{})}),e.jsx(Xe,{children:ye.map(s=>e.jsx(es,{value:s,children:s},s))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(re,{type:"date",value:O,onChange:s=>je(s.target.value),className:"h-9 w-36"}),e.jsx("span",{className:"text-muted-foreground",children:"-"}),e.jsx(re,{type:"date",value:U,onChange:s=>ve(s.target.value),className:"h-9 w-36"})]}),e.jsx(f,{variant:"outline",size:"icon",onClick:ee,disabled:Y,children:e.jsx(is,{className:H("h-4 w-4",Y&&"animate-spin")})})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"flex items-center gap-2",children:[$?.broker&&e.jsx(z,{variant:"outline",className:"text-xs",children:$.broker.toUpperCase()}),e.jsxs(z,{variant:u==="live"?"default":"secondary",className:H("text-xs cursor-pointer",u==="analyzer"&&"bg-purple-500 hover:bg-purple-600 text-white"),onClick:K,children:[u==="live"?e.jsx(oe,{className:"h-3 w-3 mr-1"}):e.jsx(le,{className:"h-3 w-3 mr-1"}),u==="live"?"Live":"Analyze"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:K,disabled:W,title:`Switch to ${u==="live"?"Analyze":"Live"} mode`,children:W?e.jsx(ds,{className:"h-4 w-4 animate-spin"}):u==="live"?e.jsx(oe,{className:"h-4 w-4"}):e.jsx(le,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:ce,disabled:u!=="live",title:I==="light"?"Switch to dark mode":"Switch to light mode",children:I==="light"?e.jsx(ms,{className:"h-4 w-4"}):e.jsx(hs,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"icon",onClick:Te,children:F?e.jsx(us,{className:"h-4 w-4"}):e.jsx(xs,{className:"h-4 w-4"})}),e.jsx(f,{variant:"ghost",size:"sm",className:"h-8 text-xs",asChild:!0,children:e.jsxs(_,{to:"/dashboard",children:[e.jsx(gs,{className:"h-4 w-4 mr-1.5"}),"Dashboard"]})}),e.jsxs(Fe,{children:[e.jsx(Re,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8 rounded-full bg-primary text-primary-foreground",children:e.jsx("span",{className:"text-sm font-medium",children:$?.username?.[0]?.toUpperCase()||"O"})})}),e.jsxs(Oe,{align:"end",className:"w-56",children:[Ue.map(s=>e.jsxs(B,{onSelect:()=>E(s.href),className:"cursor-pointer",children:[e.jsx(s.icon,{className:"h-4 w-4 mr-2"}),s.label]},s.href)),e.jsx(B,{asChild:!0,children:e.jsxs("a",{href:"https://docs.openalgo.in",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2",children:[e.jsx(fs,{className:"h-4 w-4"}),"Docs"]})}),e.jsx(Pe,{}),e.jsxs(B,{onClick:me,className:"text-destructive focus:text-destructive",children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Logout"]})]})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden p-4",children:o?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold",children:[o,":",l]}),e.jsx(z,{variant:"outline",children:c}),r.length>0&&e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.length.toLocaleString()," candles"]})]}),M&&e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Data: ",M.first_date," - ",M.last_date]}),e.jsxs("span",{children:[M.record_count.toLocaleString()," records stored"]})]})]}),e.jsx("div",{className:"flex-1 min-h-0 border rounded-lg bg-card overflow-hidden relative",children:e.jsx("div",{ref:g,className:"absolute inset-0"})}),r.length>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-5 gap-4",children:[e.jsx(y,{children:e.jsxs(C,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Open"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.open?.toFixed(2)})]})}),e.jsx(y,{children:e.jsxs(C,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"High"}),e.jsx("div",{className:"text-lg font-medium text-green-600",children:r[r.length-1]?.high?.toFixed(2)})]})}),e.jsx(y,{children:e.jsxs(C,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Low"}),e.jsx("div",{className:"text-lg font-medium text-red-600",children:r[r.length-1]?.low?.toFixed(2)})]})}),e.jsx(y,{children:e.jsxs(C,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Close"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.close?.toFixed(2)})]})}),e.jsx(y,{children:e.jsxs(C,{className:"p-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Volume"}),e.jsx("div",{className:"text-lg font-medium",children:r[r.length-1]?.volume?.toLocaleString()})]})})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(ne,{className:"h-16 w-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-xl font-medium",children:"Select a Symbol"}),e.jsx("p",{className:"text-sm mt-2",children:"Choose a symbol from your data catalog to view its chart"}),b.length===0&&e.jsxs("p",{className:"text-sm mt-4",children:["No data in catalog."," ",e.jsx(_,{to:"/historify",className:"text-primary underline",children:"Download data first"})]})]})})})]})}export{Es as default};
