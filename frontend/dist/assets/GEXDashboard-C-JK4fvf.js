import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{w as U,u as de,s as re,B as ae,e as k}from"./index-Bat6d_-L.js";import{C as _,d as E}from"./card-CIKcPOuA.js";import{S as D,a as V,b as Y,c as H,d as W}from"./select-ptGUKsSf.js";import{P as oe}from"./react-plotly-DV3gd5yC.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-icons-Ys8lBJ3m.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const K={getGEXData:async l=>(await U.post("/gex/api/gex-data",l)).data,getUnderlyings:async l=>(await U.get(`/search/api/underlyings?exchange=${l}`)).data,getExpiries:async(l,h)=>(await U.get(`/search/api/expiries?exchange=${l}&underlying=${h}`)).data},xe=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],ne={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},pe=3e4;function q(l){if(!l)return"";const h=l.split("-");return h.length===3?`${h[0]}${h[1].toUpperCase()}${h[2].slice(-2)}`:l.replace(/-/g,"").toUpperCase()}function X(l){return l>=1e7?`${(l/1e7).toFixed(1)}Cr`:l>=1e5?`${(l/1e5).toFixed(1)}L`:l>=1e3?`${(l/1e3).toFixed(1)}K`:l.toFixed(0)}function ve(){const{mode:l,appMode:h}=de(),j=h==="analyzer",g=l==="dark"||j,[y,le]=n.useState("NFO"),[ie,J]=n.useState(ne.NFO),[u,M]=n.useState("NIFTY"),[Q,S]=n.useState([]),[d,v]=n.useState(""),[s,B]=n.useState(null),[w,Z]=n.useState(!1),[I,ce]=n.useState(!1),G=n.useRef(0),O=n.useRef(null);n.useEffect(()=>{const t=ne[y]||[];J(t),M(t[0]||""),S([]),v(""),B(null);let a=!1;return(async()=>{try{const x=await K.getUnderlyings(y);if(a)return;x.status==="success"&&x.underlyings.length>0&&(J(x.underlyings),x.underlyings.includes(t[0])||M(x.underlyings[0]))}catch{}})(),()=>{a=!0}},[y]),n.useEffect(()=>{if(!u)return;S([]),v(""),B(null);let t=!1;return(async()=>{try{const o=await K.getExpiries(y,u);if(t)return;o.status==="success"&&o.expiries.length>0?(S(o.expiries),v(o.expiries[0])):(S([]),v(""))}catch{if(t)return;S([]),v("")}})(),()=>{t=!0}},[u]);const z=n.useCallback(async()=>{if(!d)return;const t=++G.current;Z(!0);try{const a=q(d),o=await K.getGEXData({underlying:u,exchange:y,expiry_date:a});if(G.current!==t)return;o.status==="success"?B(o):re.error(o.message||"Failed to fetch GEX data")}catch{if(G.current!==t)return;re.error("Failed to fetch GEX data")}finally{G.current===t&&Z(!1)}},[u,d,y]);n.useEffect(()=>{d&&z()},[d]),n.useEffect(()=>(I&&d&&(O.current=setInterval(z,pe)),()=>{O.current&&(clearInterval(O.current),O.current=null)}),[I,z,d]);const r=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:g?"#e0e0e0":"#333333",grid:g?j?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceBar:"#ef4444",peBar:"#22c55e",positiveGex:"#3b82f6",negativeGex:"#f97316",atmLine:g?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:g?j?"#2d2545":"#1e293b":"#ffffff",hoverFont:g?"#e0e0e0":"#333333",hoverBorder:g?j?"#7c3aed":"#475569":"#e2e8f0"}),[g,j]),ee=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),te=n.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.lot_size||1,a=s.atm_strike,o=s.chain,x=o.map((c,F)=>F),f=o.map(c=>c.strike.toString()),i=o.map(c=>Math.round(c.ce_oi/t)),m=o.map(c=>Math.round(c.pe_oi/t)),C=Math.max(1,Math.floor(o.length/15)),$=x.filter((c,F)=>F%C===0),A=f.filter((c,F)=>F%C===0),b=[{x,y:i,type:"bar",name:"Call OI (lots)",marker:{color:r.ceBar},hovertemplate:"Strike %{text}<br>CE OI: %{y:,}<extra></extra>",text:f,textposition:"none"},{x,y:m,type:"bar",name:"Put OI (lots)",marker:{color:r.peBar},hovertemplate:"Strike %{text}<br>PE OI: %{y:,}<extra></extra>",text:f,textposition:"none"}],N=a?o.findIndex(c=>c.strike===a):-1,T=N>=0?[{x:N,y:1,yref:"paper",text:`ATM ${a}`,showarrow:!1,font:{color:r.text,size:11},yanchor:"bottom"}]:[],P=N>=0?[{type:"line",x0:N,x1:N,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}}]:[],R=q(d),p={title:{text:`${u} ${R} - OI Walls`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},barmode:"group",bargap:.15,hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.18,font:{color:r.text,size:11}},margin:{l:60,r:20,t:50,b:80},xaxis:{tickmode:"array",tickvals:$,ticktext:A,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Open Interest (lots)",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:T,shapes:P};return{data:b,layout:p}},[s,r,d,u]),se=n.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.atm_strike,a=s.chain,o=a.map((p,c)=>c),x=a.map(p=>p.strike.toString()),f=a.map(p=>p.net_gex),i=f.map(p=>p>=0?r.positiveGex:r.negativeGex),m=Math.max(1,Math.floor(a.length/15)),C=o.filter((p,c)=>c%m===0),$=x.filter((p,c)=>c%m===0),A=[{x:o,y:f,type:"bar",name:"Net GEX",marker:{color:i},hovertemplate:"Strike %{text}<br>Net GEX: %{y:,.2f}<extra></extra>",text:x,textposition:"none",showlegend:!1}],b=t?a.findIndex(p=>p.strike===t):-1,N=b>=0?[{x:b,y:1,yref:"paper",text:`ATM ${t}`,showarrow:!1,font:{color:r.text,size:11},yanchor:"bottom"}]:[],T=[{type:"line",x0:0,x1:1,xref:"paper",y0:0,y1:0,line:{color:r.grid,width:1}}];b>=0&&T.push({type:"line",x0:b,x1:b,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}});const P=q(d),R={title:{text:`${u} ${P} - Net GEX Walls`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!1,margin:{l:60,r:20,t:50,b:80},xaxis:{tickmode:"array",tickvals:C,ticktext:$,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Net GEX (gamma x OI x lot)",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:N,shapes:T};return{data:A,layout:R}},[s,r,d,u]),L=n.useMemo(()=>{if(!s?.chain)return{topCallOI:[],topPutOI:[],topNetGex:[]};const t=[...s.chain],a=s.lot_size||1,o=[...t].sort((i,m)=>m.ce_oi-i.ce_oi).slice(0,5).map(i=>({strike:i.strike,value:Math.round(i.ce_oi/a)})),x=[...t].sort((i,m)=>m.pe_oi-i.pe_oi).slice(0,5).map(i=>({strike:i.strike,value:Math.round(i.pe_oi/a)})),f=[...t].sort((i,m)=>Math.abs(m.net_gex)-Math.abs(i.net_gex)).slice(0,5).map(i=>({strike:i.strike,value:i.net_gex}));return{topCallOI:o,topPutOI:x,topNetGex:f}},[s]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"GEX Dashboard"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(D,{value:y,onValueChange:le,children:[e.jsx(V,{className:"w-[100px]",children:e.jsx(Y,{placeholder:"Exchange"})}),e.jsx(H,{children:xe.map(t=>e.jsx(W,{value:t.value,children:t.label},t.value))})]}),e.jsxs(D,{value:u,onValueChange:M,children:[e.jsx(V,{className:"w-[160px]",children:e.jsx(Y,{placeholder:"Underlying"})}),e.jsx(H,{children:ie.map(t=>e.jsx(W,{value:t,children:t},t))})]}),e.jsxs(D,{value:d,onValueChange:v,disabled:Q.length===0,children:[e.jsx(V,{className:"w-[160px]",children:e.jsx(Y,{placeholder:"Expiry"})}),e.jsx(H,{children:Q.map(t=>e.jsx(W,{value:t,children:t},t))})]}),e.jsx(ae,{variant:I?"default":"outline",size:"sm",onClick:()=>ce(!I),children:I?"Auto: ON":"Auto: OFF"}),e.jsx(ae,{variant:"outline",size:"sm",onClick:z,disabled:w,children:w?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR: ",s.pcr_oi?.toFixed(2)]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Net GEX: ",X(s.total_net_gex||0)]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(_,{children:e.jsx(E,{className:"p-2 sm:p-4",children:w&&!s?e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:"Loading GEX data..."}):s?.chain&&s.chain.length>0?e.jsx(oe,{data:te.data,layout:te.layout,config:ee,useResizeHandler:!0,style:{width:"100%",height:"450px"}}):e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:d?"No OI data available":"Select an underlying and expiry to view OI Walls"})})}),e.jsx(_,{children:e.jsx(E,{className:"p-2 sm:p-4",children:w&&!s?e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:"Loading GEX data..."}):s?.chain&&s.chain.length>0?e.jsx(oe,{data:se.data,layout:se.layout,config:ee,useResizeHandler:!0,style:{width:"100%",height:"450px"}}):e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:d?"No GEX data available":"Select an underlying and expiry to view Net GEX"})})})]}),s?.chain&&s.chain.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Call OI (Resistance)"}),e.jsx("div",{className:"space-y-1",children:L.topCallOI.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsx("span",{className:"font-medium text-red-500",children:X(t.value)})]},t.strike))})]})}),e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Put OI (Support)"}),e.jsx("div",{className:"space-y-1",children:L.topPutOI.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsx("span",{className:"font-medium text-green-500",children:X(t.value)})]},t.strike))})]})}),e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Net GEX Strikes"}),e.jsx("div",{className:"space-y-1",children:L.topNetGex.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsxs("span",{className:`font-medium ${t.value>=0?"text-blue-500":"text-orange-500"}`,children:[t.value>=0?"+":"",X(t.value)]})]},t.strike))})]})})]}),s?.chain&&s.chain.length>0&&e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"GEX Table"}),e.jsx("div",{className:"overflow-x-auto max-h-[500px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-background z-10",children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 px-3 font-medium text-muted-foreground",children:"Strike"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Call GEX"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Put GEX"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Net GEX"})]})}),e.jsx("tbody",{children:s.chain.map(t=>{const a=t.strike===s.atm_strike;return e.jsxs("tr",{className:`border-b border-border/30 ${a?"bg-yellow-500/10 font-semibold":"hover:bg-muted/50"}`,children:[e.jsxs("td",{className:"py-1.5 px-3",children:[t.strike,a&&e.jsx("span",{className:"ml-2 text-xs text-yellow-500",children:"ATM"})]}),e.jsx("td",{className:"py-1.5 px-3 text-right text-red-500",children:t.ce_gex.toFixed(2)}),e.jsx("td",{className:"py-1.5 px-3 text-right text-green-500",children:t.pe_gex.toFixed(2)}),e.jsxs("td",{className:`py-1.5 px-3 text-right font-medium ${t.net_gex>=0?"text-blue-500":"text-orange-500"}`,children:[t.net_gex>=0?"+":"",t.net_gex.toFixed(2)]})]},t.strike)})}),e.jsx("tfoot",{className:"sticky bottom-0 bg-background border-t-2 border-border",children:e.jsxs("tr",{className:"font-semibold",children:[e.jsx("td",{className:"py-2 px-3",children:"Total"}),e.jsx("td",{className:"py-2 px-3 text-right text-red-500",children:(s.total_ce_gex||0).toFixed(2)}),e.jsx("td",{className:"py-2 px-3 text-right text-green-500",children:(s.total_pe_gex||0).toFixed(2)}),e.jsxs("td",{className:`py-2 px-3 text-right ${(s.total_net_gex||0)>=0?"text-blue-500":"text-orange-500"}`,children:[(s.total_net_gex||0)>=0?"+":"",(s.total_net_gex||0).toFixed(2)]})]})})]})})]})})]})}export{ve as default};
