import{r as o,j as e}from"./vendor-react-RhKMXzW9.js";import{d as re,o as le,l as ce,e as R,B as z,c as y,s as g}from"./index-DIYLftG1.js";import{t as W}from"./trading-Dvt4-4yh.js";import{C as T,b as C,d as L,c as S,a as oe}from"./card-QZ1-djoA.js";import{T as ie,a as de,b as E,c as j,d as xe,e as x,f as me}from"./table-CK4hMSU8.js";import{u as pe,a as ue}from"./useMarketStatus-B27EKIuh.js";import{V as he,R as fe,p as ge,c as K,_ as G,L as je}from"./vendor-icons-Ca5eNZvr.js";import"./vendor-router-DdyOoyPF.js";import"./vendor-radix-gKv__6YA.js";function v(i){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2}).format(i)}function I(i){return`${i>=0?"+":""}${i.toFixed(2)}%`}function Ce(){const{apiKey:i}=re(),[N,J]=o.useState([]),[b,X]=o.useState(null),[Y,_]=o.useState(!0),[H,O]=o.useState(!1),[Q,$]=o.useState(null),[q,Z]=o.useState(new Map),{isMarketOpen:k,isAnyMarketOpen:ee}=pe(),A=ee(),te=o.useMemo(()=>N.map(t=>({symbol:t.symbol,exchange:t.exchange})),[N]),{data:M,isConnected:se}=ue({symbols:te,mode:"LTP",enabled:N.length>0&&A}),D=se&&A,w=o.useMemo(()=>N.map(t=>{const a=`${t.exchange}:${t.symbol}`,n=M.get(a),r=t.quantity||0,d=t.pnl||0,l=k(t.exchange)&&n?.data?.ltp&&n.lastUpdate&&Date.now()-n.lastUpdate<5e3,p=q.get(a),P=!l&&p?.ltp;let u;l&&n?.data?.ltp?u=n.data.ltp:P?u=p.ltp:u=t.ltp;let h=t.average_price;if(!h&&u&&r!==0&&(h=u-d/r),(l||P)&&u&&r!==0&&(!h&&t.ltp&&(h=t.ltp-d/r),h)){const F=(u-h)*r,B=Math.abs(h*r),ne=B>0?F/B*100:0;return{...t,ltp:u,average_price:h,pnl:F,pnlpercent:ne}}return{...t,ltp:u,average_price:h}}),[N,M,k,q]),s=o.useMemo(()=>{if(!b||!w.some(c=>{const l=`${c.exchange}:${c.symbol}`,p=M.get(l);return k(c.exchange)&&p?.data?.ltp&&p.lastUpdate&&Date.now()-p.lastUpdate<5e3}))return b;let a=0,n=0,r=0;w.forEach(c=>{a+=c.pnl||0;const l=c.average_price||0,p=c.quantity||0,P=c.ltp||l;n+=l*p,r+=P*p});const d=n>0?a/n*100:0;return{...b,totalholdingvalue:r,totalinvvalue:n,totalprofitandloss:a,totalpnlpercentage:d}},[b,w,M,k]),U=o.useCallback(async t=>{if(!(!i||t.length===0))try{const a=t.map(r=>({symbol:r.symbol,exchange:r.exchange})),n=await W.getMultiQuotes(i,a);if(n.status==="success"&&n.results){const r=new Map;n.results.forEach(d=>{const c=`${d.exchange}:${d.symbol}`;d.data&&r.set(c,d.data)}),Z(r)}}catch{}},[i]),m=o.useCallback(async(t=!1)=>{if(!i){_(!1);return}t&&O(!0);try{const a=await W.getHoldings(i);if(a.status==="success"&&a.data){const n=a.data.holdings||[];J(n),X(a.data.statistics),$(null),n.length>0&&U(n)}else $(a.message||"Failed to fetch holdings")}catch{$("Failed to fetch holdings")}finally{_(!1),O(!1)}},[i,U]);o.useEffect(()=>{m();const a=setInterval(()=>m(),D?3e4:1e4);return()=>clearInterval(a)},[m,D]),o.useEffect(()=>{const t=le(()=>{m()});return()=>t()},[m]);const V=o.useRef(null);o.useEffect(()=>{const t=window.location.protocol,a=window.location.hostname,n=window.location.port;V.current=ce(`${t}//${a}:${n}`,{transports:["websocket","polling"]});const r=V.current;return r.on("order_event",()=>{setTimeout(()=>m(),500)}),r.on("analyzer_update",()=>{setTimeout(()=>m(),500)}),()=>{r.disconnect()}},[m]);const ae=()=>{const t=["Symbol","Exchange","Quantity","Avg Price","LTP","Product","P&L","P&L %"],a=w.map(l=>[g(l.symbol),g(l.exchange),g(l.quantity),g(l.average_price),g(l.ltp),g(l.product),g(l.pnl),g(l.pnlpercent)]),n=[t,...a].map(l=>l.join(",")).join(`
`),r=new Blob([n],{type:"text/csv"}),d=URL.createObjectURL(r),c=document.createElement("a");c.href=d,c.download=`holdings_${new Date().toISOString().split("T")[0]}.csv`,c.click()},f=t=>t>=0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Investor Summary"}),D&&e.jsxs(R,{variant:"outline",className:"bg-emerald-500/10 text-emerald-600 border-emerald-500/30 gap-1",children:[e.jsx(he,{className:"h-3 w-3 animate-pulse"}),"Live"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"View your holdings portfolio"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(z,{variant:"outline",size:"sm",onClick:()=>m(!0),disabled:H,children:[e.jsx(fe,{className:y("h-4 w-4 mr-2",H&&"animate-spin")}),"Refresh"]}),e.jsxs(z,{variant:"outline",size:"sm",onClick:ae,children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Export"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(T,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(L,{children:"Total Holding Value"}),e.jsx(S,{className:"text-2xl text-primary",children:s?v(s.totalholdingvalue):"---"})]})}),e.jsx(T,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(L,{children:"Total Investment Value"}),e.jsx(S,{className:"text-2xl",children:s?v(s.totalinvvalue):"---"})]})}),e.jsx(T,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(L,{children:"Total Profit and Loss"}),e.jsx(S,{className:y("text-2xl",s&&f(s.totalprofitandloss)?"text-green-600":"text-red-600"),children:s?e.jsxs("div",{className:"flex items-center gap-1",children:[f(s.totalprofitandloss)?e.jsx(K,{className:"h-5 w-5"}):e.jsx(G,{className:"h-5 w-5"}),v(s.totalprofitandloss)]}):"---"})]})}),e.jsx(T,{children:e.jsxs(C,{className:"pb-2",children:[e.jsx(L,{children:"Total PnL Percentage"}),e.jsx(S,{className:y("text-2xl",s&&f(s.totalpnlpercentage)?"text-green-600":"text-red-600"),children:s?I(s.totalpnlpercentage):"---"})]})})]}),e.jsx(T,{children:e.jsx(oe,{className:"p-0",children:Y?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(je,{className:"h-8 w-8 animate-spin"})}):Q?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:Q}):N.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No holdings found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ie,{children:[e.jsx(de,{children:e.jsxs(E,{children:[e.jsx(j,{children:"Trading Symbol"}),e.jsx(j,{children:"Exchange"}),e.jsx(j,{className:"text-right",children:"Quantity"}),e.jsx(j,{className:"text-right",children:"Avg Price"}),e.jsx(j,{className:"text-right",children:"LTP"}),e.jsx(j,{children:"Product"}),e.jsx(j,{className:"text-right",children:"Profit and Loss"}),e.jsx(j,{className:"text-right",children:"PnL %"})]})}),e.jsx(xe,{children:w.map((t,a)=>e.jsxs(E,{children:[e.jsx(x,{className:"font-medium",children:t.symbol}),e.jsx(x,{children:e.jsx(R,{variant:"outline",children:t.exchange})}),e.jsx(x,{className:"text-right font-mono",children:t.quantity}),e.jsx(x,{className:"text-right font-mono",children:t.average_price!==void 0?v(t.average_price):"-"}),e.jsx(x,{className:"text-right font-mono",children:t.ltp!==void 0?v(t.ltp):"-"}),e.jsx(x,{children:e.jsx(R,{variant:"secondary",children:t.product})}),e.jsx(x,{className:y("text-right font-medium",f(t.pnl)?"text-green-600":"text-red-600"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[f(t.pnl)?e.jsx(K,{className:"h-4 w-4"}):e.jsx(G,{className:"h-4 w-4"}),v(t.pnl)]})}),e.jsx(x,{className:y("text-right",f(t.pnlpercent)?"text-green-600":"text-red-600"),children:I(t.pnlpercent)})]},`${t.symbol}-${t.exchange}-${a}`))}),e.jsx(me,{children:e.jsxs(E,{className:"bg-muted/50",children:[e.jsx(x,{colSpan:6,className:"text-right text-muted-foreground",children:"Total P&L:"}),e.jsx(x,{className:y("text-right font-bold",s&&f(s.totalprofitandloss)?"text-green-600":"text-red-600"),children:s?`${s.totalprofitandloss>=0?"+":""}${v(s.totalprofitandloss)}`:"-"}),e.jsx(x,{className:y("text-right font-bold",s&&f(s.totalpnlpercentage)?"text-green-600":"text-red-600"),children:s?I(s.totalpnlpercentage):"-"})]})})]})})})})]})}export{Ce as default};
