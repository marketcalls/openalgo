import{r as n,j as e}from"./vendor-react-CCyQGCED.js";import{w as U,u as pe,s as te,B as D,e as k}from"./index-D0023jFM.js";import{C as _,d as E}from"./card-CDguRyHx.js";import{P as he,a as me,b as ue,C as fe,c as ge,d as ye,e as be,f as je,g as Ne}from"./popover-BKWWulwW.js";import{S as se,a as re,b as ae,c as oe,d as ne}from"./select-DXT-lI-N.js";import{P as ie}from"./react-plotly-DV3gd5yC.js";import{aV as ve,m as ke}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";const V={getGEXData:async i=>(await U.post("/gex/api/gex-data",i)).data,getUnderlyings:async i=>(await U.get(`/search/api/underlyings?exchange=${i}`)).data,getExpiries:async(i,m)=>(await U.get(`/search/api/expiries?exchange=${i}&underlying=${m}`)).data},_e=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],le={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},Ee=3e4;function Y(i){if(!i)return"";const m=i.split("-");return m.length===3?`${m[0]}${m[1].toUpperCase()}${m[2].slice(-2)}`:i.replace(/-/g,"").toUpperCase()}function X(i){return i>=1e7?`${(i/1e7).toFixed(1)}Cr`:i>=1e5?`${(i/1e5).toFixed(1)}L`:i>=1e3?`${(i/1e3).toFixed(1)}K`:i.toFixed(0)}function Me(){const{mode:i,appMode:m}=pe(),N=m==="analyzer",g=i==="dark"||N,[y,ce]=n.useState("NFO"),[de,H]=n.useState(le.NFO),[W,K]=n.useState(!1),[h,M]=n.useState("NIFTY"),[q,S]=n.useState([]),[d,v]=n.useState(""),[s,B]=n.useState(null),[F,J]=n.useState(!1),[I,xe]=n.useState(!1),C=n.useRef(0),G=n.useRef(null);n.useEffect(()=>{const t=le[y]||[];H(t),M(t[0]||""),S([]),v(""),B(null);let a=!1;return(async()=>{try{const x=await V.getUnderlyings(y);if(a)return;x.status==="success"&&x.underlyings.length>0&&(H(x.underlyings),x.underlyings.includes(t[0])||M(x.underlyings[0]))}catch{}})(),()=>{a=!0}},[y]),n.useEffect(()=>{if(!h)return;S([]),v(""),B(null);let t=!1;return(async()=>{try{const o=await V.getExpiries(y,h);if(t)return;o.status==="success"&&o.expiries.length>0?(S(o.expiries),v(o.expiries[0])):(S([]),v(""))}catch{if(t)return;S([]),v("")}})(),()=>{t=!0}},[h]);const O=n.useCallback(async()=>{if(!d)return;const t=++C.current;J(!0);try{const a=Y(d),o=await V.getGEXData({underlying:h,exchange:y,expiry_date:a});if(C.current!==t)return;o.status==="success"?B(o):te.error(o.message||"Failed to fetch GEX data")}catch{if(C.current!==t)return;te.error("Failed to fetch GEX data")}finally{C.current===t&&J(!1)}},[h,d,y]);n.useEffect(()=>{d&&O()},[d]),n.useEffect(()=>(I&&d&&(G.current=setInterval(O,Ee)),()=>{G.current&&(clearInterval(G.current),G.current=null)}),[I,O,d]);const r=n.useMemo(()=>({bg:"rgba(0,0,0,0)",paper:"rgba(0,0,0,0)",text:g?"#e0e0e0":"#333333",grid:g?N?"rgba(180,160,255,0.1)":"rgba(255,255,255,0.1)":"rgba(0,0,0,0.08)",ceBar:"#ef4444",peBar:"#22c55e",positiveGex:"#3b82f6",negativeGex:"#f97316",atmLine:g?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.5)",hoverBg:g?N?"#2d2545":"#1e293b":"#ffffff",hoverFont:g?"#e0e0e0":"#333333",hoverBorder:g?N?"#7c3aed":"#475569":"#e2e8f0"}),[g,N]),Q=n.useMemo(()=>({displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["pan2d","select2d","lasso2d","autoScale2d","toggleSpikelines"],responsive:!0}),[]),Z=n.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.lot_size||1,a=s.atm_strike,o=s.chain,x=o.map((c,w)=>w),f=o.map(c=>c.strike.toString()),l=o.map(c=>Math.round(c.ce_oi/t)),u=o.map(c=>Math.round(c.pe_oi/t)),z=Math.max(1,Math.floor(o.length/15)),L=x.filter((c,w)=>w%z===0),$=f.filter((c,w)=>w%z===0),b=[{x,y:l,type:"bar",name:"Call OI (lots)",marker:{color:r.ceBar},hovertemplate:"Strike %{text}<br>CE OI: %{y:,}<extra></extra>",text:f,textposition:"none"},{x,y:u,type:"bar",name:"Put OI (lots)",marker:{color:r.peBar},hovertemplate:"Strike %{text}<br>PE OI: %{y:,}<extra></extra>",text:f,textposition:"none"}],j=a?o.findIndex(c=>c.strike===a):-1,T=j>=0?[{x:j,y:1,yref:"paper",text:`ATM ${a}`,showarrow:!1,font:{color:r.text,size:11},yanchor:"bottom"}]:[],A=j>=0?[{type:"line",x0:j,x1:j,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}}]:[],R=Y(d),p={title:{text:`${h} ${R} - OI Walls`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},barmode:"group",bargap:.15,hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!0,legend:{orientation:"h",x:.5,xanchor:"center",y:-.18,font:{color:r.text,size:11}},margin:{l:60,r:20,t:50,b:80},xaxis:{tickmode:"array",tickvals:L,ticktext:$,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Open Interest (lots)",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:T,shapes:A};return{data:b,layout:p}},[s,r,d,h]),ee=n.useMemo(()=>{if(!s?.chain)return{data:[],layout:{}};const t=s.atm_strike,a=s.chain,o=a.map((p,c)=>c),x=a.map(p=>p.strike.toString()),f=a.map(p=>p.net_gex),l=f.map(p=>p>=0?r.positiveGex:r.negativeGex),u=Math.max(1,Math.floor(a.length/15)),z=o.filter((p,c)=>c%u===0),L=x.filter((p,c)=>c%u===0),$=[{x:o,y:f,type:"bar",name:"Net GEX",marker:{color:l},hovertemplate:"Strike %{text}<br>Net GEX: %{y:,.2f}<extra></extra>",text:x,textposition:"none",showlegend:!1}],b=t?a.findIndex(p=>p.strike===t):-1,j=b>=0?[{x:b,y:1,yref:"paper",text:`ATM ${t}`,showarrow:!1,font:{color:r.text,size:11},yanchor:"bottom"}]:[],T=[{type:"line",x0:0,x1:1,xref:"paper",y0:0,y1:0,line:{color:r.grid,width:1}}];b>=0&&T.push({type:"line",x0:b,x1:b,y0:0,y1:1,yref:"paper",line:{color:r.atmLine,width:1.5,dash:"dash"}});const A=Y(d),R={title:{text:`${h} ${A} - Net GEX Walls`,font:{color:r.text,size:14}},paper_bgcolor:r.paper,plot_bgcolor:r.bg,font:{color:r.text,family:"system-ui, sans-serif"},hovermode:"x unified",hoverlabel:{bgcolor:r.hoverBg,font:{color:r.hoverFont,size:12},bordercolor:r.hoverBorder},showlegend:!1,margin:{l:60,r:20,t:50,b:80},xaxis:{tickmode:"array",tickvals:z,ticktext:L,title:{text:"Strike Price",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid,tickangle:-45},yaxis:{title:{text:"Net GEX (gamma x OI x lot)",font:{color:r.text,size:12}},tickfont:{color:r.text,size:10},gridcolor:r.grid},annotations:j,shapes:T};return{data:$,layout:R}},[s,r,d,h]),P=n.useMemo(()=>{if(!s?.chain)return{topCallOI:[],topPutOI:[],topNetGex:[]};const t=[...s.chain],a=s.lot_size||1,o=[...t].sort((l,u)=>u.ce_oi-l.ce_oi).slice(0,5).map(l=>({strike:l.strike,value:Math.round(l.ce_oi/a)})),x=[...t].sort((l,u)=>u.pe_oi-l.pe_oi).slice(0,5).map(l=>({strike:l.strike,value:Math.round(l.pe_oi/a)})),f=[...t].sort((l,u)=>Math.abs(u.net_gex)-Math.abs(l.net_gex)).slice(0,5).map(l=>({strike:l.strike,value:l.net_gex}));return{topCallOI:o,topPutOI:x,topNetGex:f}},[s]);return e.jsxs("div",{className:"py-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"GEX Dashboard"}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs(se,{value:y,onValueChange:ce,children:[e.jsx(re,{className:"w-[100px]",children:e.jsx(ae,{placeholder:"Exchange"})}),e.jsx(oe,{children:_e.map(t=>e.jsx(ne,{value:t.value,children:t.label},t.value))})]}),e.jsxs(he,{open:W,onOpenChange:K,children:[e.jsx(me,{asChild:!0,children:e.jsxs(D,{variant:"outline",role:"combobox","aria-expanded":W,className:"w-[160px] justify-between",children:[h||"Underlying",e.jsx(ve,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ue,{className:"w-48 p-0",align:"start",children:e.jsxs(fe,{children:[e.jsx(ge,{placeholder:"Search underlying..."}),e.jsxs(ye,{children:[e.jsx(be,{children:"No underlying found"}),e.jsx(je,{children:de.map(t=>e.jsxs(Ne,{value:t,onSelect:()=>{M(t),K(!1)},children:[e.jsx(ke,{className:`mr-2 h-4 w-4 ${h===t?"opacity-100":"opacity-0"}`}),t]},t))})]})]})})]}),e.jsxs(se,{value:d,onValueChange:v,disabled:q.length===0,children:[e.jsx(re,{className:"w-[160px]",children:e.jsx(ae,{placeholder:"Expiry"})}),e.jsx(oe,{children:q.map(t=>e.jsx(ne,{value:t,children:t},t))})]}),e.jsx(D,{variant:I?"default":"outline",size:"sm",onClick:()=>xe(!I),children:I?"Auto: ON":"Auto: OFF"}),e.jsx(D,{variant:"outline",size:"sm",onClick:O,disabled:F,children:F?"Loading...":"Refresh"})]})]}),s&&s.status==="success"&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Spot: ",s.spot_price?.toFixed(1)]}),s.futures_price&&e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Futures: ",s.futures_price.toFixed(1)]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Lot Size: ",s.lot_size]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["PCR: ",s.pcr_oi?.toFixed(2)]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["ATM: ",s.atm_strike]}),e.jsxs(k,{variant:"secondary",className:"text-sm px-3 py-1",children:["Net GEX: ",X(s.total_net_gex||0)]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(_,{children:e.jsx(E,{className:"p-2 sm:p-4",children:F&&!s?e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:"Loading GEX data..."}):s?.chain&&s.chain.length>0?e.jsx(ie,{data:Z.data,layout:Z.layout,config:Q,useResizeHandler:!0,style:{width:"100%",height:"450px"}}):e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:d?"No OI data available":"Select an underlying and expiry to view OI Walls"})})}),e.jsx(_,{children:e.jsx(E,{className:"p-2 sm:p-4",children:F&&!s?e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:"Loading GEX data..."}):s?.chain&&s.chain.length>0?e.jsx(ie,{data:ee.data,layout:ee.layout,config:Q,useResizeHandler:!0,style:{width:"100%",height:"450px"}}):e.jsx("div",{className:"flex items-center justify-center h-[450px] text-muted-foreground",children:d?"No GEX data available":"Select an underlying and expiry to view Net GEX"})})})]}),s?.chain&&s.chain.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Call OI (Resistance)"}),e.jsx("div",{className:"space-y-1",children:P.topCallOI.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsx("span",{className:"font-medium text-red-500",children:X(t.value)})]},t.strike))})]})}),e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Put OI (Support)"}),e.jsx("div",{className:"space-y-1",children:P.topPutOI.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsx("span",{className:"font-medium text-green-500",children:X(t.value)})]},t.strike))})]})}),e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"Top Net GEX Strikes"}),e.jsx("div",{className:"space-y-1",children:P.topNetGex.map((t,a)=>e.jsxs("div",{className:"flex justify-between text-sm py-1 border-b border-border/50 last:border-0",children:[e.jsxs("span",{className:"text-muted-foreground",children:[a+1,". ",t.strike]}),e.jsxs("span",{className:`font-medium ${t.value>=0?"text-blue-500":"text-orange-500"}`,children:[t.value>=0?"+":"",X(t.value)]})]},t.strike))})]})})]}),s?.chain&&s.chain.length>0&&e.jsx(_,{children:e.jsxs(E,{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-sm",children:"GEX Table"}),e.jsx("div",{className:"overflow-x-auto max-h-[500px] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-background z-10",children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left py-2 px-3 font-medium text-muted-foreground",children:"Strike"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Call GEX"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Put GEX"}),e.jsx("th",{className:"text-right py-2 px-3 font-medium text-muted-foreground",children:"Net GEX"})]})}),e.jsx("tbody",{children:s.chain.map(t=>{const a=t.strike===s.atm_strike;return e.jsxs("tr",{className:`border-b border-border/30 ${a?"bg-yellow-500/10 font-semibold":"hover:bg-muted/50"}`,children:[e.jsxs("td",{className:"py-1.5 px-3",children:[t.strike,a&&e.jsx("span",{className:"ml-2 text-xs text-yellow-500",children:"ATM"})]}),e.jsx("td",{className:"py-1.5 px-3 text-right text-red-500",children:t.ce_gex.toFixed(2)}),e.jsx("td",{className:"py-1.5 px-3 text-right text-green-500",children:t.pe_gex.toFixed(2)}),e.jsxs("td",{className:`py-1.5 px-3 text-right font-medium ${t.net_gex>=0?"text-blue-500":"text-orange-500"}`,children:[t.net_gex>=0?"+":"",t.net_gex.toFixed(2)]})]},t.strike)})}),e.jsx("tfoot",{className:"sticky bottom-0 bg-background border-t-2 border-border",children:e.jsxs("tr",{className:"font-semibold",children:[e.jsx("td",{className:"py-2 px-3",children:"Total"}),e.jsx("td",{className:"py-2 px-3 text-right text-red-500",children:(s.total_ce_gex||0).toFixed(2)}),e.jsx("td",{className:"py-2 px-3 text-right text-green-500",children:(s.total_pe_gex||0).toFixed(2)}),e.jsxs("td",{className:`py-2 px-3 text-right ${(s.total_net_gex||0)>=0?"text-blue-500":"text-orange-500"}`,children:[(s.total_net_gex||0)>=0?"+":"",(s.total_net_gex||0).toFixed(2)]})]})})]})})]})})]})}export{Me as default};
