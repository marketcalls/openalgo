import{r as t,j as e}from"./vendor-react-RhKMXzW9.js";import{w as y,t as r,e as b,B as u}from"./index-C8LlWM1c.js";import{A as I,b as H,c as $,d as z,e as Q,f as R,g as J,h as P}from"./alert-dialog-BWinaI8A.js";import{C as x,a as h,b as q,c as G,d as K}from"./card-Bhbdd39G.js";import{D as V,b as W,c as X,d as Y,e as Z,f as ee}from"./dialog-BPo2Liw2.js";import{I as se}from"./input-Dw94pmqa.js";import{L as ae}from"./label-CBaa7YXh.js";import{T as te,a as re,b as v,c as d,d as ne,e as l}from"./table-BfryyWHD.js";import{T as le}from"./textarea-C_VCaJ4G.js";import{A as ie,an as ce,S as oe,B as de,aS as me,a6 as xe,ac as he}from"./vendor-icons-Ca5eNZvr.js";import{L as ge}from"./vendor-router-DdyOoyPF.js";import"./vendor-syntax-CXZqcLdW.js";import"./vendor-radix-gKv__6YA.js";function _e(){const[i,A]=t.useState([]),[j,f]=t.useState([]),[D,T]=t.useState([]),[n,L]=t.useState(""),[F,M]=t.useState(!0),[c,g]=t.useState(null),[m,p]=t.useState(""),[w,C]=t.useState(!1),[o,N]=t.useState(null),[S,U]=t.useState(!1);t.useEffect(()=>{k()},[]),t.useEffect(()=>{if(n){const s=i.filter(a=>a.telegram_username?.toLowerCase().includes(n.toLowerCase())||a.openalgo_username?.toLowerCase().includes(n.toLowerCase())||a.first_name?.toLowerCase().includes(n.toLowerCase()));f(s)}else f(i)},[n,i]);const k=async()=>{try{const s=await y.get("/telegram/api/users"),a=Array.isArray(s.data.data?.users)?s.data.data.users:[],E=Array.isArray(s.data.data?.stats)?s.data.data.stats:[];A(a),f(a),T(E)}catch(s){console.error("Error fetching users:",s),r.error("Failed to load users")}finally{M(!1)}},B=async()=>{if(!c||!m.trim()){r.error("Please enter a message");return}C(!0);try{const s=await y.post("/telegram/send-message",{telegram_id:c.telegram_id,message:m});s.data.status==="success"?(r.success("Message sent successfully"),g(null),p("")):r.error(s.data.message||"Failed to send message")}catch(s){const a=s;r.error(a.response?.data?.message||"Failed to send message")}finally{C(!1)}},O=async()=>{if(o){U(!0);try{const s=await y.post(`/telegram/user/${o.telegram_id}/unlink`);s.data.status==="success"?(r.success("User unlinked successfully"),N(null),k()):r.error(s.data.message||"Failed to unlink user")}catch(s){const a=s;r.error(a.response?.data?.message||"Failed to unlink user")}finally{U(!1)}}},_=s=>s?new Date(s).toLocaleString():"-";return F?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ge,{to:"/telegram",className:"text-muted-foreground hover:text-foreground",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(ce,{className:"h-6 w-6"}),"Telegram Users"]})]}),e.jsx("p",{className:"text-muted-foreground",children:"Manage users linked to the Telegram bot"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Users"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.filter(s=>s.notifications_enabled).length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Notifications On"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:i.filter(s=>s.openalgo_username).length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Linked Accounts"})]})}),e.jsx(x,{children:e.jsxs(h,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-2xl font-bold",children:D.reduce((s,a)=>s+a.count,0)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Commands (30d)"})]})})]}),e.jsxs(x,{children:[e.jsxs(q,{children:[e.jsx(G,{children:"User List"}),e.jsxs(K,{children:[j.length," users total"]})]}),e.jsxs(h,{children:[e.jsx("div",{className:"flex items-center gap-2 mb-4",children:e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(se,{placeholder:"Search by username...",value:n,onChange:s=>L(s.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(te,{children:[e.jsx(re,{children:e.jsxs(v,{children:[e.jsx(d,{children:"Telegram User"}),e.jsx(d,{children:"OpenAlgo Account"}),e.jsx(d,{children:"Notifications"}),e.jsx(d,{children:"Joined"}),e.jsx(d,{children:"Last Active"}),e.jsx(d,{className:"w-[100px]",children:"Actions"})]})}),e.jsx(ne,{children:j.length===0?e.jsx(v,{children:e.jsx(l,{colSpan:6,className:"text-center text-muted-foreground py-8",children:n?"No matching users found":"No users registered yet"})}):j.map(s=>e.jsxs(v,{children:[e.jsx(l,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.telegram_username?`@${s.telegram_username}`:s.first_name||"Unknown"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["ID: ",s.telegram_id]})]})}),e.jsx(l,{children:s.openalgo_username?e.jsx(b,{variant:"outline",children:s.openalgo_username}):e.jsx("span",{className:"text-muted-foreground",children:"Not linked"})}),e.jsx(l,{children:s.notifications_enabled?e.jsxs(b,{className:"bg-green-500 hover:bg-green-600",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"On"]}):e.jsxs(b,{variant:"secondary",children:[e.jsx(me,{className:"h-3 w-3 mr-1"}),"Off"]})}),e.jsx(l,{className:"text-sm",children:_(s.created_at)}),e.jsx(l,{className:"text-sm",children:_(s.last_active)}),e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{size:"icon",variant:"ghost",className:"h-8 w-8",onClick:()=>{g(s),p("")},title:"Send message",children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(u,{size:"icon",variant:"ghost",className:"h-8 w-8 text-destructive hover:text-destructive",onClick:()=>N(s),title:"Unlink user",children:e.jsx(he,{className:"h-4 w-4"})})]})})]},s.telegram_id))})]})})]})]}),e.jsx(V,{open:!!c,onOpenChange:()=>g(null),children:e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Send Message"}),e.jsxs(Z,{children:["Send a message to"," ",c?.telegram_username?`@${c.telegram_username}`:c?.first_name]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(ae,{children:"Message"}),e.jsx(le,{placeholder:"Enter your message...",value:m,onChange:s=>p(s.target.value),rows:4}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[m.length,"/4096 characters"]})]})}),e.jsxs(ee,{children:[e.jsx(u,{variant:"outline",onClick:()=>g(null),children:"Cancel"}),e.jsx(u,{onClick:B,disabled:w||!m.trim(),children:w?"Sending...":"Send Message"})]})]})}),e.jsx(I,{open:!!o,onOpenChange:()=>N(null),children:e.jsxs(H,{children:[e.jsxs($,{children:[e.jsx(z,{children:"Unlink User?"}),e.jsxs(Q,{children:["Are you sure you want to unlink"," ",o?.telegram_username?`@${o.telegram_username}`:o?.first_name,"? They will need to re-register with /start to receive notifications again."]})]}),e.jsxs(R,{children:[e.jsx(J,{children:"Cancel"}),e.jsx(P,{onClick:O,disabled:S,children:S?"Unlinking...":"Unlink"})]})]})})]})}export{_e as default};
