{% extends "layout.html" %}

{% block title %}Kotak Securities Authentication - OpenAlgo{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-8rem)] flex items-center justify-center py-8">
    <div class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-8 lg:gap-16">
            <!-- Right side login form - Shown first on mobile -->
            <div class="card flex-shrink-0 w-full max-w-md shadow-2xl bg-base-100 order-1 lg:order-2">
                <div class="card-body">
                    <div class="flex justify-center mb-6">
                        <img class="h-20 w-auto" src="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}" alt="OpenAlgo">
                    </div>

                    <form action="/kotak/callback" method="POST" class="space-y-6" id="kotakForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Mobile Number Field -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Mobile Number</span>
                                <span class="label-text-alt">
                                    <div class="tooltip" data-tip="Enter your mobile number without +91">
                                        <button class="btn btn-circle btn-xs btn-ghost">?</button>
                                    </div>
                                </span>
                            </label>
                            <div class="flex w-full">
                                <span class="inline-flex items-center px-3 text-sm bg-base-200 border border-r-0 border-base-300 rounded-l-md">
                                    +91
                                </span>
                                <input type="tel"
                                       id="mobilenumber"
                                       name="mobilenumber"
                                       required
                                       class="input input-bordered w-full rounded-l-none"
                                       placeholder="9999955555"
                                       pattern="[0-9]{10}"
                                       title="Please enter a valid 10-digit mobile number" />
                            </div>
                            <label class="label pt-2">
                                <span class="label-text-alt text-info">Your registered mobile number</span>
                            </label>
                        </div>

                        <!-- MPIN Field -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">MPIN</span>
                                <span class="label-text-alt">
                                    <div class="tooltip" data-tip="Your 6-digit trading MPIN">
                                        <button class="btn btn-circle btn-xs btn-ghost">?</button>
                                    </div>
                                </span>
                            </label>
                            <input type="password"
                                   id="mpin"
                                   name="mpin"
                                   required
                                   class="input input-bordered w-full"
                                   placeholder="******"
                                   pattern="[0-9]{6}"
                                   maxlength="6"
                                   title="Enter your 6-digit trading MPIN" />
                            <label class="label pt-2">
                                <span class="label-text-alt text-info">Your 6-digit trading PIN</span>
                            </label>
                        </div>

                        <!-- TOTP Code Field -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">TOTP Code</span>
                                <span class="label-text-alt">
                                    <div class="tooltip" data-tip="6-digit code from Google/Microsoft Authenticator">
                                        <button class="btn btn-circle btn-xs btn-ghost">?</button>
                                    </div>
                                </span>
                            </label>
                            <input type="text"
                                   id="totp"
                                   name="totp"
                                   required
                                   class="input input-bordered w-full"
                                   placeholder="123456"
                                   pattern="[0-9]{6}"
                                   maxlength="6"
                                   title="Enter 6-digit TOTP from your authenticator app" />
                            <label class="label pt-2">
                                <span class="label-text-alt text-info">From Google or Microsoft Authenticator app</span>
                            </label>
                        </div>

                        {% if error_message %}
                        <div class="alert alert-error">
                            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>{{ error_message }}</span>
                        </div>
                        {% endif %}

                        <div class="form-control mt-6">
                            <button type="submit" class="btn btn-primary w-full flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                Connect Account
                            </button>
                        </div>
                    </form>

                    <div class="divider">OR</div>

                    <a href="{{ url_for('auth.broker_login') }}" class="btn btn-outline btn-block flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                        Back to Broker Selection
                    </a>
                </div>
            </div>

            <!-- Left side content - Shown second on mobile -->
            <div class="flex-1 max-w-xl text-center lg:text-left order-2 lg:order-1">
                <h1 class="text-4xl lg:text-5xl font-bold mb-6">Connect <span class="text-primary">Kotak</span></h1>
                <p class="text-lg lg:text-xl mb-8 opacity-80">
                    Authenticate using TOTP-based login to connect your Kotak Securities trading account with OpenAlgo. Your credentials are securely encrypted and stored.
                </p>
                <div class="flex flex-col gap-4">
                    <div class="alert alert-warning shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">TOTP Registration Required</h3>
                            <div class="text-sm">You must register for TOTP in the NEO app before logging in. Go to: Invest → Trade API → API Dashboard → TOTP Registration</div>
                        </div>
                    </div>
                    <div class="alert alert-info shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">What You Need</h3>
                            <div class="text-sm">
                                • Mobile number (registered with Kotak)<br>
                                • MPIN (6-digit trading PIN)<br>
                                • TOTP code (from Google/Microsoft Authenticator)
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center lg:justify-start gap-4">
                        <a href="https://docs.openalgo.in" target="_blank" rel="noopener noreferrer" class="btn btn-outline gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                            Documentation
                        </a>
                        <a href="/auth/broker" class="btn btn-outline gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
                            </svg>
                            Back to Brokers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('kotakForm');
    const mobileInput = document.getElementById('mobilenumber');
    const totpInput = document.getElementById('totp');
    const mpinInput = document.getElementById('mpin');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validate mobile number
        const mobileNumber = mobileInput.value.replace(/\D/g, '');
        if (mobileNumber.length !== 10) {
            alert('Please enter a valid 10-digit mobile number');
            return;
        }

        // Validate MPIN
        const mpin = mpinInput.value.replace(/\D/g, '');
        if (mpin.length !== 6) {
            alert('Please enter a valid 6-digit MPIN');
            return;
        }

        // Validate TOTP
        const totp = totpInput.value.replace(/\D/g, '');
        if (totp.length !== 6) {
            alert('Please enter a valid 6-digit TOTP code');
            return;
        }

        // Add +91 prefix to mobile number
        const formattedNumber = '+91' + mobileNumber;
        mobileInput.value = formattedNumber;

        // Submit form
        this.submit();
    });

    // Clean up mobile number input - remove any non-digits
    mobileInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '');
    });

    // Clean up TOTP input - remove any non-digits and limit to 6
    totpInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').substring(0, 6);
    });

    // Clean up MPIN input - remove any non-digits and limit to 6
    mpinInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').substring(0, 6);
    });
});
</script>
{% endblock %}
