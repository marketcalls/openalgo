{% extends "base.html" %}

{% block head %}
<style>
    .stat-card {
        @apply bg-base-100 rounded-lg shadow-lg p-6 transition-all duration-300;
    }

    .stat-card:hover {
        @apply shadow-xl transform -translate-y-1;
    }

    .table-container {
        @apply overflow-x-auto bg-base-100 rounded-lg shadow-lg;
    }

    .table-header {
        @apply sticky top-0 bg-base-200 z-10;
    }

    .numeric-cell {
        @apply font-mono text-right;
    }

    @keyframes pulse-warning {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .badge-pulse {
        animation: pulse-warning 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full" id="action-center-content">
    <!-- Feature Description -->
    <div class="alert alert-info mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <h3 class="font-bold">OpenAlgo Action Center</h3>
            <div class="text-sm">
                Centralized hub for managing semi-automated trading orders. When Semi-Auto mode is enabled in API Key settings,
                all incoming orders are queued here for manual approval before broker execution. Review, approve, or reject orders
                to maintain full control over your trading decisions.
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold">Action Center</h1>
            <p class="text-base-content/60">Review and manage pending orders</p>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('api_key_bp.manage_api_key') }}" class="btn btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                Toggle Order Mode
            </a>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="tabs tabs-boxed mb-6">
        <a href="{{ url_for('orders_bp.action_center', status='pending') }}"
           class="tab {% if current_filter == 'pending' %}tab-active{% endif %}">
            Pending
            <span class="badge badge-sm ml-2 badge-pulse {% if order_stats.total_pending > 0 %}badge-warning{% else %}badge-ghost{% endif %}">
                {{ order_stats.total_pending }}
            </span>
        </a>
        <a href="{{ url_for('orders_bp.action_center', status='approved') }}"
           class="tab {% if current_filter == 'approved' %}tab-active{% endif %}">
            Approved
            <span class="badge badge-sm ml-2 {% if order_stats.total_approved > 0 %}badge-success{% else %}badge-ghost{% endif %}">
                {{ order_stats.total_approved }}
            </span>
        </a>
        <a href="{{ url_for('orders_bp.action_center', status='rejected') }}"
           class="tab {% if current_filter == 'rejected' %}tab-active{% endif %}">
            Rejected
            <span class="badge badge-sm ml-2 {% if order_stats.total_rejected > 0 %}badge-error{% else %}badge-ghost{% endif %}">
                {{ order_stats.total_rejected }}
            </span>
        </a>
        <a href="{{ url_for('orders_bp.action_center', status='all') }}"
           class="tab {% if current_filter == 'all' %}tab-active{% endif %}">
            All Orders
        </a>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <!-- Pending Orders -->
        <div class="stat-card">
            <div class="stat">
                <div class="stat-title">Pending Approval</div>
                <div class="stat-value text-warning">{{ order_stats.total_pending }}</div>
                <div class="stat-desc mt-2">
                    <div class="badge badge-warning {% if order_stats.total_pending > 0 %}badge-pulse{% endif %}">Awaiting Action</div>
                </div>
            </div>
        </div>

        <!-- Buy Orders -->
        <div class="stat-card">
            <div class="stat">
                <div class="stat-title">Buy Orders</div>
                <div class="stat-value text-success">{{ order_stats.total_buy_orders }}</div>
                <div class="stat-desc mt-2">
                    <div class="badge badge-success">Long</div>
                </div>
            </div>
        </div>

        <!-- Sell Orders -->
        <div class="stat-card">
            <div class="stat">
                <div class="stat-title">Sell Orders</div>
                <div class="stat-value text-error">{{ order_stats.total_sell_orders }}</div>
                <div class="stat-desc mt-2">
                    <div class="badge badge-error">Short</div>
                </div>
            </div>
        </div>

        <!-- Approved Orders -->
        <div class="stat-card">
            <div class="stat">
                <div class="stat-title">Approved</div>
                <div class="stat-value text-success">{{ order_stats.total_approved }}</div>
                <div class="stat-desc mt-2">
                    <div class="badge badge-success">Executed</div>
                </div>
            </div>
        </div>

        <!-- Rejected Orders -->
        <div class="stat-card">
            <div class="stat">
                <div class="stat-title">Rejected</div>
                <div class="stat-value text-error">{{ order_stats.total_rejected }}</div>
                <div class="stat-desc mt-2">
                    <div class="badge badge-error">Declined</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div id="action-center-table-container" class="table-container">
        <table class="table w-full">
            <thead class="table-header">
                <tr>
                    <th>Strategy</th>
                    <th>Symbol</th>
                    <th>Exchange</th>
                    <th>Action</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Order Type</th>
                    <th>Product</th>
                    <th>Created At (IST)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if order_data %}
                    {% for order in order_data %}
                    <tr class="hover:bg-base-200">
                        <!-- Strategy -->
                        <td>
                            <div class="badge badge-outline badge-sm">{{ order.strategy }}</div>
                            <div class="text-xs opacity-50 mt-1">{{ order.api_type }}</div>
                        </td>

                        <!-- Symbol -->
                        <td class="font-medium">{{ order.symbol }}</td>

                        <!-- Exchange -->
                        <td>
                            {% set exchange_colors = {
                                'NSE': 'badge-accent',
                                'BSE': 'badge-neutral',
                                'NFO': 'badge-secondary',
                                'MCX': 'badge-primary'
                            } %}
                            <div class="badge {{ exchange_colors.get(order.exchange, 'badge-ghost') }}">
                                {{ order.exchange }}
                            </div>
                        </td>

                        <!-- Action (BUY/SELL) -->
                        <td>
                            <div class="badge {% if order.action == 'BUY' %}badge-success{% else %}badge-error{% endif %} gap-2">
                                {% if order.action == 'BUY' %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                                </svg>
                                {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                                {% endif %}
                                {{ order.action }}
                            </div>
                        </td>

                        <!-- Quantity -->
                        <td class="numeric-cell">{{ order.quantity }}</td>

                        <!-- Price -->
                        <td class="numeric-cell">{{ order.price if order.price else 0 }}</td>

                        <!-- Order Type -->
                        <td>
                            {% set order_type_colors = {
                                'MARKET': 'badge-primary',
                                'LIMIT': 'badge-info',
                                'SL': 'badge-warning',
                                'SL-M': 'badge-warning'
                            } %}
                            <div class="badge {{ order_type_colors.get(order.price_type, 'badge-ghost') }}">
                                {{ order.price_type }}
                            </div>
                        </td>

                        <!-- Product Type -->
                        <td>
                            {% set product_type_colors = {
                                'CNC': 'badge-secondary',
                                'MIS': 'badge-accent',
                                'NRML': 'badge-neutral'
                            } %}
                            <div class="badge {{ product_type_colors.get(order.product_type, 'badge-ghost') }}">
                                {{ order.product_type }}
                            </div>
                        </td>

                        <!-- Created At with relative time -->
                        <td>
                            <div class="font-mono text-sm">{{ order.created_at_ist }}</div>
                            <div class="text-xs opacity-60" data-timestamp="{{ order.created_at_ist }}"></div>
                        </td>

                        <!-- Actions -->
                        <td>
                            <div class="flex gap-2 flex-wrap">
                                <!-- Details Button -->
                                <button class="btn btn-ghost btn-sm btn-square btn-toggle-details"
                                        data-order-id="{{ order.id }}"
                                        title="View order details">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>

                                {% if order.status == 'pending' %}
                                    <button class="btn btn-success btn-sm btn-approve-order"
                                            data-order-id="{{ order.id }}"
                                            title="Approve and execute order">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                        </svg>
                                        Approve
                                    </button>
                                    <button class="btn btn-error btn-sm btn-reject-order"
                                            data-order-id="{{ order.id }}"
                                            title="Reject order">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                        Reject
                                    </button>
                                {% else %}
                                    <button class="btn btn-ghost btn-sm btn-delete-order"
                                            data-order-id="{{ order.id }}"
                                            title="Delete order">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                        Delete
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    <!-- Details Row (Initially Hidden) -->
                    <tr id="details-{{ order.id }}" class="hidden bg-base-200">
                        <td colspan="10" class="p-4">
                            <div class="card bg-base-100 shadow-sm">
                                <div class="card-body p-4">
                                    <h3 class="card-title text-sm mb-3">Order Details</h3>

                                    {% if order.api_type == 'basketorder' and order.raw_order_data.orders %}
                                        <!-- Basket Order - Show each order separately -->
                                        <div class="space-y-4">
                                            <!-- Common Basket Info -->
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pb-3 border-b border-base-300">
                                                {% for key, value in order.raw_order_data.items() %}
                                                    {% if key != 'orders' %}
                                                    <div class="form-control">
                                                        <label class="label py-1">
                                                            <span class="label-text text-xs font-semibold opacity-70">{{ key }}</span>
                                                        </label>
                                                        <div class="bg-base-200 rounded px-3 py-2 text-sm break-all">
                                                            {{ value }}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>

                                            <!-- Individual Orders in Basket -->
                                            <div class="space-y-3">
                                                <h4 class="font-semibold text-sm">Orders in Basket ({{ order.raw_order_data.orders|length }})</h4>
                                                {% for basket_order in order.raw_order_data.orders %}
                                                <div class="card bg-base-200 shadow-sm">
                                                    <div class="card-body p-3">
                                                        <div class="flex items-center gap-2 mb-2">
                                                            <span class="badge badge-sm">Order {{ loop.index }}</span>
                                                            <span class="font-semibold">{{ basket_order.symbol }}</span>
                                                            <div class="badge badge-sm {{ 'badge-success' if basket_order.action == 'BUY' else 'badge-error' }}">
                                                                {{ basket_order.action }}
                                                            </div>
                                                        </div>
                                                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                                            {% for key, value in basket_order.items() %}
                                                            <div>
                                                                <div class="text-xs opacity-60">{{ key }}</div>
                                                                <div class="text-sm font-medium">{{ value }}</div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>

                                    {% elif order.api_type == 'placeorder' %}
                                        <!-- Regular Place Order -->
                                        <div class="space-y-4">
                                            <!-- Order Header -->
                                            <div class="flex items-center gap-3 pb-3 border-b border-base-300">
                                                <h4 class="text-lg font-bold">{{ order.raw_order_data.symbol }}</h4>
                                                <div class="badge badge-lg {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                    {{ order.raw_order_data.action }}
                                                </div>
                                                <div class="badge badge-outline">{{ order.raw_order_data.exchange }}</div>
                                            </div>

                                            <!-- Order Details Sections -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Trading Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Trading Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Symbol</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.symbol }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Exchange</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.exchange }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Action</span>
                                                                <span class="badge badge-sm {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                                    {{ order.raw_order_data.action }}
                                                                </span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Quantity</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.quantity }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Price Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Price Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Order Type</span>
                                                                <span class="badge badge-sm badge-primary">{{ order.raw_order_data.get('price_type', order.raw_order_data.get('pricetype', 'MARKET')) }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Trigger Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('trigger_price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Product</span>
                                                                <span class="badge badge-sm badge-secondary">{{ order.raw_order_data.get('product_type', order.raw_order_data.get('product', '')) }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Additional Parameters -->
                                            {% set additional_params = [] %}
                                            {% for key, value in order.raw_order_data.items() %}
                                                {% if key not in ['symbol', 'exchange', 'action', 'quantity', 'price', 'trigger_price', 'price_type', 'pricetype', 'product_type', 'product'] %}
                                                    {% set _ = additional_params.append((key, value)) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if additional_params %}
                                            <div class="card bg-base-200">
                                                <div class="card-body p-3">
                                                    <h5 class="font-semibold text-sm mb-2">Additional Parameters</h5>
                                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                        {% for key, value in additional_params %}
                                                        <div>
                                                            <div class="text-xs opacity-60">{{ key }}</div>
                                                            <div class="text-sm font-medium break-all">{{ value }}</div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>

                                    {% elif order.api_type == 'smartorder' %}
                                        <!-- Smart Order -->
                                        <div class="space-y-4">
                                            <!-- Order Header -->
                                            <div class="flex items-center gap-3 pb-3 border-b border-base-300">
                                                <div class="badge badge-primary badge-lg">SMART ORDER</div>
                                                <h4 class="text-lg font-bold">{{ order.raw_order_data.symbol }}</h4>
                                                <div class="badge badge-lg {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                    {{ order.raw_order_data.action }}
                                                </div>
                                                <div class="badge badge-outline">{{ order.raw_order_data.exchange }}</div>
                                            </div>

                                            <!-- Order Details Sections -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Trading Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Trading Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Symbol</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.symbol }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Exchange</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.exchange }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Action</span>
                                                                <span class="badge badge-sm {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                                    {{ order.raw_order_data.action }}
                                                                </span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Quantity</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.quantity }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Price Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Price Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Order Type</span>
                                                                <span class="badge badge-sm badge-primary">{{ order.raw_order_data.get('pricetype', order.raw_order_data.get('price_type', 'MARKET')) }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Trigger Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('trigger_price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Product</span>
                                                                <span class="badge badge-sm badge-secondary">{{ order.raw_order_data.get('product', order.raw_order_data.get('product_type', '')) }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Additional Parameters -->
                                            {% set additional_params = [] %}
                                            {% for key, value in order.raw_order_data.items() %}
                                                {% if key not in ['symbol', 'exchange', 'action', 'quantity', 'price', 'trigger_price', 'price_type', 'pricetype', 'product_type', 'product'] %}
                                                    {% set _ = additional_params.append((key, value)) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if additional_params %}
                                            <div class="card bg-base-200">
                                                <div class="card-body p-3">
                                                    <h5 class="font-semibold text-sm mb-2">Additional Parameters</h5>
                                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                        {% for key, value in additional_params %}
                                                        <div>
                                                            <div class="text-xs opacity-60">{{ key }}</div>
                                                            <div class="text-sm font-medium break-all">{{ value }}</div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>

                                    {% elif order.api_type == 'splitorder' %}
                                        <!-- Split Order -->
                                        <div class="space-y-4">
                                            <!-- Order Header -->
                                            <div class="flex items-center gap-3 pb-3 border-b border-base-300">
                                                <div class="badge badge-warning badge-lg">SPLIT ORDER</div>
                                                <h4 class="text-lg font-bold">{{ order.raw_order_data.symbol }}</h4>
                                                <div class="badge badge-lg {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                    {{ order.raw_order_data.action }}
                                                </div>
                                                <div class="badge badge-outline">{{ order.raw_order_data.exchange }}</div>
                                            </div>

                                            <!-- Split Info Alert -->
                                            <div class="alert alert-info">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <div>
                                                    <div class="font-semibold">Split Configuration</div>
                                                    <div class="text-sm">Total Quantity: <strong>{{ order.raw_order_data.quantity }}</strong> | Split Size: <strong>{{ order.raw_order_data.splitsize }}</strong></div>
                                                </div>
                                            </div>

                                            <!-- Order Details Sections -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Trading Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Trading Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Symbol</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.symbol }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Exchange</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.exchange }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Action</span>
                                                                <span class="badge badge-sm {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                                    {{ order.raw_order_data.action }}
                                                                </span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Total Quantity</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.quantity }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Split Size</span>
                                                                <span class="badge badge-warning">{{ order.raw_order_data.splitsize }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Price Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Price Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Order Type</span>
                                                                <span class="badge badge-sm badge-primary">{{ order.raw_order_data.get('pricetype', order.raw_order_data.get('price_type', 'MARKET')) }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Trigger Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('trigger_price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Product</span>
                                                                <span class="badge badge-sm badge-secondary">{{ order.raw_order_data.get('product', order.raw_order_data.get('product_type', '')) }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Additional Parameters -->
                                            {% set additional_params = [] %}
                                            {% for key, value in order.raw_order_data.items() %}
                                                {% if key not in ['symbol', 'exchange', 'action', 'quantity', 'splitsize', 'price', 'trigger_price', 'price_type', 'pricetype', 'product_type', 'product'] %}
                                                    {% set _ = additional_params.append((key, value)) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if additional_params %}
                                            <div class="card bg-base-200">
                                                <div class="card-body p-3">
                                                    <h5 class="font-semibold text-sm mb-2">Additional Parameters</h5>
                                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                        {% for key, value in additional_params %}
                                                        <div>
                                                            <div class="text-xs opacity-60">{{ key }}</div>
                                                            <div class="text-sm font-medium break-all">{{ value }}</div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>

                                    {% elif order.api_type == 'optionsorder' %}
                                        <!-- Options Order -->
                                        <div class="space-y-4">
                                            <!-- Order Header -->
                                            <div class="flex items-center gap-3 pb-3 border-b border-base-300">
                                                <div class="badge badge-accent badge-lg">OPTIONS ORDER</div>
                                                <h4 class="text-lg font-bold">{{ order.raw_order_data.underlying }}</h4>
                                                <div class="badge badge-lg {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                    {{ order.raw_order_data.action }}
                                                </div>
                                                <div class="badge badge-outline">{{ order.raw_order_data.exchange }}</div>
                                            </div>

                                            <!-- Options Details Alert -->
                                            <div class="alert alert-info">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <div>
                                                    <div class="font-semibold">Option Details</div>
                                                    <div class="text-sm">
                                                        <strong>{{ order.raw_order_data.underlying }}</strong> |
                                                        Offset: <strong>{{ order.raw_order_data.offset }}</strong> |
                                                        Type: <strong>{{ order.raw_order_data.option_type }}</strong>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Order Details Sections -->
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <!-- Option Specifications -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Option Specifications</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Underlying</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.underlying }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Option Type</span>
                                                                <span class="badge badge-sm badge-accent">{{ order.raw_order_data.option_type }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Offset</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.offset }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Exchange</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.exchange }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Trading Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Trading Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Action</span>
                                                                <span class="badge badge-sm {{ 'badge-success' if order.raw_order_data.action == 'BUY' else 'badge-error' }}">
                                                                    {{ order.raw_order_data.action }}
                                                                </span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Quantity</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.quantity }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Order Type</span>
                                                                <span class="badge badge-sm badge-primary">{{ order.raw_order_data.get('pricetype', 'MARKET') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Product</span>
                                                                <span class="badge badge-sm badge-secondary">{{ order.raw_order_data.get('product', '') }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Price Details -->
                                                <div class="card bg-base-200">
                                                    <div class="card-body p-3">
                                                        <h5 class="font-semibold text-sm mb-2">Price Details</h5>
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('price', '0') }}</span>
                                                            </div>
                                                            <div class="flex justify-between">
                                                                <span class="text-xs opacity-60">Trigger Price</span>
                                                                <span class="text-sm font-medium">{{ order.raw_order_data.get('trigger_price', '0') }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Additional Parameters -->
                                            {% set additional_params = [] %}
                                            {% for key, value in order.raw_order_data.items() %}
                                                {% if key not in ['underlying', 'option_type', 'offset', 'exchange', 'action', 'quantity', 'price', 'trigger_price', 'pricetype', 'product'] %}
                                                    {% set _ = additional_params.append((key, value)) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if additional_params %}
                                            <div class="card bg-base-200">
                                                <div class="card-body p-3">
                                                    <h5 class="font-semibold text-sm mb-2">Additional Parameters</h5>
                                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                                        {% for key, value in additional_params %}
                                                        <div>
                                                            <div class="text-xs opacity-60">{{ key }}</div>
                                                            <div class="text-sm font-medium break-all">{{ value }}</div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>

                                    {% else %}
                                        <!-- Fallback for Unknown Order Types -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                            {% for key, value in order.raw_order_data.items() %}
                                            <div class="form-control">
                                                <label class="label py-1">
                                                    <span class="label-text text-xs font-semibold opacity-70">{{ key }}</span>
                                                </label>
                                                <div class="bg-base-200 rounded px-3 py-2 text-sm break-all">
                                                    {% if value is mapping %}
                                                        <pre class="text-xs">{{ value|tojson(indent=2) }}</pre>
                                                    {% elif value is iterable and value is not string %}
                                                        <pre class="text-xs">{{ value|tojson(indent=2) }}</pre>
                                                    {% else %}
                                                        {{ value }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="12" class="text-center py-8">
                            <div class="flex flex-col items-center gap-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <div>
                                    <div class="text-lg font-medium opacity-70">No orders found</div>
                                    <div class="text-sm opacity-50">Enable Semi-Auto mode in <a href="{{ url_for('api_key_bp.manage_api_key') }}" class="link link-hover">API Key settings</a> to queue orders here</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reject Modal -->
<input type="checkbox" id="reject-modal" class="modal-toggle" />
<div class="modal" role="dialog">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-error">Reject Order</h3>
        <p class="py-4">Please provide a reason for rejecting this order:</p>
        <textarea id="reject-reason" class="textarea textarea-bordered w-full"
                  placeholder="Enter rejection reason..."></textarea>
        <div class="modal-action">
            <label for="reject-modal" class="btn">Cancel</label>
            <button id="reject-confirm-btn" onclick="confirmReject()" class="btn btn-error">Reject Order</button>
        </div>
    </div>
    <label class="modal-backdrop" for="reject-modal"></label>
</div>

<script>
let currentOrderIdForReject = null;

// Calculate relative time
function getRelativeTime(istTimestamp) {
    if (!istTimestamp) return '';

    try {
        const now = new Date();
        const orderTime = new Date(istTimestamp.replace(' IST', ''));
        const diffMs = now - orderTime;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'Just now';
        if (diffMins === 1) return '1 minute ago';
        if (diffMins < 60) return `${diffMins} minutes ago`;

        const diffHours = Math.floor(diffMins / 60);
        if (diffHours === 1) return '1 hour ago';
        if (diffHours < 24) return `${diffHours} hours ago`;

        const diffDays = Math.floor(diffHours / 24);
        if (diffDays === 1) return 'Yesterday';
        return `${diffDays} days ago`;
    } catch (e) {
        return '';
    }
}

// Update relative times on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-timestamp]').forEach(el => {
        const timestamp = el.getAttribute('data-timestamp');
        el.textContent = getRelativeTime(timestamp);
    });

    // Update every minute
    setInterval(() => {
        document.querySelectorAll('[data-timestamp]').forEach(el => {
            const timestamp = el.getAttribute('data-timestamp');
            el.textContent = getRelativeTime(timestamp);
        });
    }, 60000);

    // Add event listeners for buttons
    document.addEventListener('click', function(e) {
        // Toggle details button
        if (e.target.closest('.btn-toggle-details')) {
            const btn = e.target.closest('.btn-toggle-details');
            const orderId = btn.getAttribute('data-order-id');
            if (orderId) toggleDetails(orderId);
        }

        // Approve order button
        if (e.target.closest('.btn-approve-order')) {
            const btn = e.target.closest('.btn-approve-order');
            const orderId = btn.getAttribute('data-order-id');
            if (orderId) approveOrder(orderId);
        }

        // Reject order button
        if (e.target.closest('.btn-reject-order')) {
            const btn = e.target.closest('.btn-reject-order');
            const orderId = btn.getAttribute('data-order-id');
            if (orderId) showRejectModal(orderId);
        }

        // Delete order button
        if (e.target.closest('.btn-delete-order')) {
            const btn = e.target.closest('.btn-delete-order');
            const orderId = btn.getAttribute('data-order-id');
            if (orderId) deleteOrder(orderId);
        }
    });
});

// Toggle order details
function toggleDetails(orderId) {
    const detailsRow = document.getElementById(`details-${orderId}`);
    if (detailsRow) {
        detailsRow.classList.toggle('hidden');
    }
}

// Approve order
function approveOrder(orderId) {
    fetch(`/action-center/approve/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Order approved and executed', 'success');
            // Socket event will handle the refresh
        } else {
            showToast(data.message || data.error, data.status === 'warning' ? 'warning' : 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to approve order', 'error');
    });
}

// Show reject modal
function showRejectModal(orderId) {
    currentOrderIdForReject = orderId;
    document.getElementById('reject-reason').value = '';
    document.getElementById('reject-modal').checked = true;
}

// Confirm reject
function confirmReject() {
    const reason = document.getElementById('reject-reason').value;

    if (!reason.trim()) {
        showToast('Please provide a rejection reason', 'warning');
        return;
    }

    document.getElementById('reject-modal').checked = false;

    fetch(`/action-center/reject/${currentOrderIdForReject}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Order rejected', 'success');
            // Socket event will handle the refresh
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to reject order', 'error');
    });
}

// Delete order
function deleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order?')) {
        return;
    }

    fetch(`/action-center/delete/${orderId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('Order deleted', 'success');
            // Socket event will handle the refresh
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to delete order', 'error');
    });
}

// Socket.IO event listener for pending orders
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh for pending orders
    const currentFilter = '{{ current_filter }}';
    if (currentFilter === 'pending') {
        setInterval(() => {
            location.reload();
        }, 30000); // Refresh every 30 seconds
    }
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

    // Function to refresh page and update counters
    function refreshActionCenter() {
        // Update badge count
        fetch('/action-center/count')
            .then(res => res.json())
            .then(countData => {
                const badge = document.getElementById('action-center-badge');
                if (badge) {
                    if (countData.count > 0) {
                        badge.textContent = countData.count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });

        // Refresh the page content
        setTimeout(() => {
            if (typeof refreshCurrentPageContent === 'function') {
                refreshCurrentPageContent();
            } else {
                location.reload();
            }
        }, 500);
    }

    // Listen for new pending orders
    socket.on('pending_order_created', function(data) {
        showToast('New order queued for approval', 'info');
        refreshActionCenter();
    });

    // Listen for order updates (approve/reject/delete)
    socket.on('pending_order_updated', function(data) {
        // Just refresh, toast already shown by the action function
        refreshActionCenter();
    });
});
</script>
{% endblock %}
