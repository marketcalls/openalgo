{% extends "base.html" %}

{% block main_class %}{% endblock %}

{% block content_wrapper %}
<div class="w-full flex flex-col bg-base-200" style="height: calc(100vh - 4rem);">
  <!-- Top Bar -->
  <div class="top-bar-gradient border-b border-base-300 px-6 py-4 shadow-lg">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="sidebarToggle" class="btn btn-square btn-ghost btn-sm lg:hidden" aria-label="Toggle sidebar">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
          </svg>
        </button>

        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>

        <div class="flex items-center gap-4">
          <h1 class="text-2xl font-bold text-base-content bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">API Playground</h1>
          <p class="text-xs text-base-content/60 mt-0.5">Interact with OpenAlgo REST APIs in the Playground</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="glass-effect rounded-xl px-4 py-2 flex items-center gap-3">
          <span class="text-xs text-base-content/60 font-medium">API Key:</span>
          <input type="password" id="globalApiKey" readonly class="input input-sm input-bordered w-64 font-mono text-xs bg-base-100/50" placeholder="Loading...">
          <button id="apiKeyToggle" class="btn btn-sm btn-ghost btn-circle" title="Toggle visibility" aria-label="Toggle API key visibility">
            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
          </button>
          <button id="copyApiKeyBtn" class="btn btn-sm btn-ghost btn-circle" title="Copy API key" aria-label="Copy API key">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </button>
        </div>

        <a href="/apikey" class="btn btn-sm btn-primary btn-modern gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
          Manage Keys
        </a>
      </div>
    </div>

    <div id="apiKeyWarning" class="alert alert-warning mt-3 shadow-lg hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span class="text-sm">No API key found. <a href="/apikey" class="link link-hover font-semibold underline">Generate one here</a>.</span>
    </div>
  </div>

  <!-- Main Content Area - Three Panel Layout -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Left Sidebar - Endpoints -->
    <div class="sidebar relative w-64 min-w-[200px] max-w-[400px] bg-base-100 border-r border-base-300 overflow-y-auto" style="flex:0 0 auto;">
      <div class="p-3">
        <div class="relative mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="searchEndpoints" placeholder="Search requests..." class="input input-xs input-bordered w-full pl-9 bg-base-200/50">
        </div>

        <div id="endpointsList" class="space-y-3">
          <!-- Endpoints will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Middle Panel - Request Body -->
    <div class="flex-1 flex flex-col overflow-hidden border-r border-base-300 bg-base-100" id="requestSection">
      <!-- URL Bar -->
      <div class="flex items-center gap-2 p-3 border-b border-base-300 bg-base-200/30">
        <select id="requestMethod" class="select select-xs select-bordered w-24 font-semibold">
          <option value="GET">GET</option>
          <option value="POST" selected>POST</option>
        </select>
        <input type="text" id="requestUrl" placeholder="http://127.0.0.1:5000/api/v1/endpoint" class="input input-xs input-bordered flex-1 font-mono text-xs bg-base-100">
        <button id="sendButton" class="btn btn-xs btn-primary gap-1 px-3">
          <span id="buttonText">Send</span>
          <span id="buttonSpinner" class="hidden">
            <span class="loading loading-spinner loading-xs"></span>
          </span>
          <svg id="buttonIcon" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>

      <!-- Request Tabs -->
      <div class="flex items-center gap-1 px-3 py-2 border-b border-base-300 bg-base-200/20">
        <button class="tab-btn text-xs px-3 py-1 rounded bg-base-300 font-semibold" data-tab="body">Body</button>
        <button class="tab-btn text-xs px-3 py-1 rounded hover:bg-base-300" data-tab="headers">Headers</button>
        <div class="flex-1"></div>
        <select id="bodyType" class="select select-xs select-bordered w-20">
          <option value="json">JSON</option>
          <option value="text">Text</option>
        </select>
        <button id="prettifyBtn" class="btn btn-xs btn-ghost">Prettify</button>
      </div>

      <!-- Headers Content (hidden by default) -->
      <div id="headersTab" class="hidden flex-1 p-3 bg-base-200/30 overflow-auto">
        <div class="text-xs font-mono">
          <div class="flex items-center gap-2 py-1">
            <span class="text-base-content/60">Content-Type:</span>
            <span class="text-base-content">application/json</span>
          </div>
        </div>
      </div>

      <!-- Body Editor with Line Numbers -->
      <div id="bodyEditorWrapper" class="flex-1 flex overflow-hidden bg-base-200/30">
        <div id="lineNumbers" class="line-numbers bg-base-200/50 text-base-content/40 text-xs font-mono py-3 px-2 text-right select-none overflow-hidden border-r border-base-300">
          1
        </div>
        <textarea id="requestBody" class="flex-1 p-3 font-mono text-xs bg-transparent border-none outline-none resize-none leading-relaxed" placeholder='{"apikey": ""}'></textarea>
      </div>

      <!-- Reset Button -->
      <div class="flex items-center justify-between px-3 py-2 border-t border-base-300 bg-base-200/20">
        <div id="getRequestHint" class="text-xs text-info hidden items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>GET: JSON â†’ query params</span>
        </div>
        <button id="resetBodyBtn" class="btn btn-xs btn-ghost gap-1" title="Reset to default">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reset
        </button>
      </div>
    </div>

    <!-- Right Panel - Response -->
    <div class="flex-1 flex flex-col overflow-hidden bg-base-100" id="responseSection">
      <!-- Response Header -->
      <div class="flex items-center justify-between px-3 py-2 border-b border-base-300 bg-base-200/30">
        <div class="flex items-center gap-3">
          <span class="text-xs font-semibold">Response</span>
          <div id="responseLoading" class="hidden items-center gap-1 text-xs text-info">
            <span class="loading loading-spinner loading-xs"></span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="responseStatusText" class="text-xs font-mono"></span>
          <span id="responseTimeText" class="text-xs text-base-content/60 font-mono"></span>
          <span id="responseSizeText" class="text-xs text-base-content/60 font-mono"></span>
        </div>
      </div>

      <!-- Response Tabs -->
      <div class="flex items-center gap-1 px-3 py-2 border-b border-base-300 bg-base-200/20">
        <button class="resp-tab-btn text-xs px-3 py-1 rounded bg-base-300 font-semibold" data-tab="response">Response</button>
        <div class="flex-1"></div>
        <button id="copyCurlButton" class="btn btn-xs btn-ghost gap-1" title="Copy as cURL">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
          </svg>
        </button>
        <button id="copyResponseButton" class="btn btn-xs btn-ghost gap-1" title="Copy response">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </button>
      </div>

      <!-- Response Content with Line Numbers -->
      <div id="responseContainer" class="flex-1 flex overflow-hidden bg-base-200/30">
        <div id="responseLineNumbers" class="line-numbers bg-base-200/50 text-base-content/40 text-xs font-mono py-3 px-2 text-right select-none overflow-hidden border-r border-base-300">
          1
        </div>
        <div id="responseContent" class="flex-1 overflow-auto p-3">
          <div id="emptyState" class="flex flex-col items-center justify-center h-full text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-base-content/20 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <p class="text-base-content/40 text-xs">No response yet</p>
          </div>
          <pre id="responseData" class="json-viewer hidden font-mono text-xs leading-relaxed"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden elements for compatibility -->
  <div class="hidden">
    <div id="successDot"></div>
    <div id="errorDot"></div>
    <div id="responseStatusBadge"><span id="responseStatus"></span></div>
    <div id="horizontalResizeHandle"></div>
  </div>
</div>

<!-- Mobile FAB -->
<div class="lg:hidden">
  <div id="mobileFab" class="mobile-fab btn btn-primary btn-circle shadow-lg" title="Quick send">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
    </svg>
  </div>
</div>

<!-- Mobile toolbar -->
<div class="lg:hidden mobile-toolbar fixed bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2">
  <select id="mobileRequestMethod" class="request-method-select select select-sm select-bordered">
    <option value="GET">GET</option><option value="POST">POST</option>
  </select>
  <button id="mobileSend" class="btn btn-sm btn-primary gap-1">Send</button>
</div>

<script src="{{ url_for('static', filename='js/playground.js') }}"></script>
{% endblock %}

{% block head %}
<style>
/* Cleaned & consolidated styles */
* { scrollbar-width: thin; scrollbar-color: rgba(155,155,155,0.3) transparent; }
*::-webkit-scrollbar { width: 8px; height: 8px; }
*::-webkit-scrollbar-thumb { background: rgba(155,155,155,0.3); border-radius: 4px; }
*::-webkit-scrollbar-thumb:hover { background: rgba(155,155,155,0.5); }

/* Sidebar transitions */
.sidebar { transition: transform 0.3s ease, width 0.3s ease; }

/* Mobile sidebar styles */
@media (max-width: 1023px) {
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 40;
    transform: translateX(-100%);
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    height: 100vh;
  }
  .sidebar.open { transform: translateX(0); }
}

/* Overlay for mobile when sidebar is open */
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 30;
}
.sidebar-overlay.open { display: block; }

/* Draggable divider styles */
.resize-handle {
  width: 6px; height: 100%; cursor: col-resize;
  background: transparent; position: absolute; right: -3px; top: 0;
  z-index: 20; transition: background-color 0.2s;
}
.resize-handle.horizontal { width: 100%; height: 6px; top: auto; bottom: -3px; left: 0; right: 0; cursor: row-resize; }
.resize-handle:hover, .resize-handle.active { background-color: rgba(99,102,241,0.08); }
.resize-handle::after { content: ''; position: absolute; top: 0; bottom: 0; left: 2px; width: 1px; background: rgba(148,163,184,0.12); }
.resize-handle.horizontal::after { width: 100%; height: 1px; left: 0; top: 2px; bottom: auto; }

/* Request/Response sections - Three panel layout */
#requestSection { min-width: 300px; overflow: hidden; display:flex; flex-direction:column; }
#responseSection { min-width: 300px; flex:1; display:flex; flex-direction:column; overflow:hidden; }
#responseContainer { flex:1; overflow:hidden; display:flex; }
#requestBody { min-height:100px; resize:none; }

/* Line numbers */
.line-numbers {
  min-width: 40px;
  line-height: 1.6;
  font-size: 12px;
  white-space: pre-line;
  word-break: break-all;
}
#requestBody, #responseData {
  line-height: 1.6;
}

/* Sync scroll for line numbers */
#requestBody {
  overflow-y: auto;
}
#lineNumbers, #responseLineNumbers {
  overflow-y: hidden;
}

/* Prevent text selection during resize */
.noselect { -webkit-touch-callout:none; -webkit-user-select:none; -khtml-user-select:none; -moz-user-select:none; -ms-user-select:none; user-select:none; }

/* Prevent overflow issues */
.flex-1 { min-width: 0; }
#responseContainer pre { white-space: pre-wrap; word-break: break-word; }
.w-80 { min-width: 18rem; }
#requestUrl { min-width: 0; }

/* Utility */
.json-viewer { font-family: 'Monaco','Menlo','Ubuntu Mono', monospace; font-size:13px; line-height:1.6; color:var(--color-text, #e2e8f0); }
.response-success { border-left:4px solid #22c55e; background:linear-gradient(90deg, rgba(34,197,94,0.05) 0%, transparent 100%); }
.response-error { border-left:4px solid #ef4444; background:linear-gradient(90deg, rgba(239,68,68,0.05) 0%, transparent 100%); }
.loading-spinner { border:3px solid rgba(255,255,255,0.1); border-top:3px solid currentColor; border-radius:50%; width:16px; height:16px; animation:spin .8s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Glass effect for modern UI */
.glass-effect {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
[data-theme="light"] .glass-effect {
  background: rgba(0, 0, 0, 0.02);
  border: 1px solid rgba(0, 0, 0, 0.08);
}

/* Top bar gradient */
.top-bar-gradient {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.03) 0%, rgba(168, 85, 247, 0.03) 100%);
}
[data-theme="light"] .top-bar-gradient {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
}

/* Modern button style */
.btn-modern {
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
}
.btn-modern:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}
.btn-modern:active {
  transform: translateY(0);
}

/* Mobile FAB */
.mobile-fab {
  position: fixed;
  bottom: 5rem;
  right: 1rem;
  z-index: 40;
}

/* Mobile toolbar */
.mobile-toolbar {
  background: rgba(30, 41, 59, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  padding: 0.5rem 1rem;
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}
[data-theme="light"] .mobile-toolbar {
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Pulse dot animation */
.pulse-dot {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Toast animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Method badges */
.method-badge { font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px; text-transform:uppercase; letter-spacing:0.5px; }
.method-get { background: rgba(59,130,246,0.1); color:#3b82f6; }
.method-post { background: rgba(16,185,129,0.1); color:#10b981; }
.method-put { background: rgba(234,179,8,0.1); color:#eab308; }
.method-delete { background: rgba(239,68,68,0.1); color:#ef4444; }

/* Dark theme tokens (kept minimal) */
[data-theme="dark"] {
  --b1: 15 23 42;
  --b2: 30 41 59;
  --bc: 226 232 240;
  --bc-muted: 148 163 184;
}
.kbd-hint { font-family: monospace; font-size:12px; color:rgba(226,232,240,0.6); }

/* JSON highlighting (simple) */
.json-key { color: #60a5fa; }
.json-string { color: #4ade80; }
.json-number { color: #fb923c; }
.json-boolean { color: #a78bfa; }
.json-null { color: #f87171; }

/* Collapsible category styles */
.category-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.25rem;
  font-weight: 600;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--bc, #64748b);
  background: rgba(99, 102, 241, 0.05);
  border-radius: 0.375rem;
  cursor: pointer;
  user-select: none;
  transition: all 0.2s ease;
}
.category-header:hover {
  background: rgba(99, 102, 241, 0.1);
}
.category-header .chevron {
  width: 12px;
  height: 12px;
  transition: transform 0.3s ease;
  color: var(--bc, #64748b);
  flex-shrink: 0;
}
.category-header.collapsed .chevron {
  transform: rotate(-90deg);
}
.category-content {
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.2s ease;
  max-height: 2000px;
  opacity: 1;
}
.category-content.collapsed {
  max-height: 0;
  opacity: 0;
  margin-bottom: 0;
}
.category-item {
  margin-bottom: 0.5rem;
}

/* Endpoint item active state */
.endpoint-item.active {
  background: rgba(99, 102, 241, 0.15);
  border: 1px solid rgba(99, 102, 241, 0.3);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}
.endpoint-item {
  border: 1px solid transparent;
  transition: all 0.2s ease;
}

</style>
{% endblock %}
